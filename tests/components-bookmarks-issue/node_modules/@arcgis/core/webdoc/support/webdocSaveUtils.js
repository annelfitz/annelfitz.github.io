/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import e from"../../core/Error.js";import{MultiOriginJSONSupport as t}from"../../core/MultiOriginJSONSupport.js";import{whenOnce as r}from"../../core/reactiveUtils.js";import{hasSameCanonicalPortal as a,urlToObject as o}from"../../core/urlUtils.js";import{updateOrigins as i}from"../../core/accessorSupport/originUtils.js";import n from"../../geometry/SpatialReference.js";import{equals as s}from"../../geometry/support/spatialReferenceUtils.js";import{webMercatorToGeographic as l}from"../../geometry/support/webMercatorUtils.js";import{isServerOrServicesAGOLUrl as p}from"../../layers/support/arcgisLayerUrl.js";import{isLayerWithFeatureLayerSource as c,isFeatureCollectionLayer as m}from"../../layers/support/layerUtils.js";import u from"../../portal/Portal.js";import f from"../../portal/PortalItem.js";import{createForItemWrite as d}from"../../portal/support/jsonContext.js";import{typeKeyword as w,removeTypeKeyword as y,addTypeKeyword as g,hasTypeKeyword as h}from"../../portal/support/portalItemUtils.js";import{project as _}from"../../rest/geometryService/project.js";import b from"../../rest/support/ProjectParameters.js";import{hasDeveloperBasemapLayer as v,findSpatialReference as R,isDeveloperBasemapLayer as j}from"../../support/basemapUtils.js";import{saveResources as P}from"./resourceUtils.js";import{validateSaveAPIKey as I}from"./saveAPIKeyUtils.js";import{beforeSave as W,evaluateWriteErrors as S}from"./saveUtils.js";const A=["NatGeo_World_Map","Ocean_Basemap","USA_Topo_Maps","World_Imagery","World_Street_Map","World_Terrain_Base","World_Topo_Map","World_Hillshade","Canvas/World_Light_Gray_Base","Canvas/World_Light_Gray_Reference","Canvas/World_Dark_Gray_Base","Canvas/World_Dark_Gray_Reference","Ocean/World_Ocean_Base","Ocean/World_Ocean_Reference","Reference/World_Boundaries_and_Places","Reference/World_Reference_Overlay","Reference/World_Transportation"].map((e=>e.toLowerCase()));async function O(e,t,a){a??={},T(e,t),await r((()=>!t.updatingFromView)),await t.load(),await L(t),await W(t),await D(e,t);const o=t.portalItem,i=d(o,"web-map",!0),n=t.write({},i);return await Promise.all(i.resources.pendingOperations),S(i,{errorName:`${e.name}:save`},a),await V(t,o),await we(e,t,o,n,i),await Promise.all([t.updateItemThumbnail(),P(t.resourceReferences,i)]),o}async function U(e,t,a,o){o??={};const i=E(e,a);await r((()=>!t.updatingFromView)),await t.load(),C(e,t),await L(t),await W(t),await D(e,t);const n=d(i,"web-map",!0),s=t.write({},n);await Promise.all(n.resources.pendingOperations),S(n,{errorName:`${e.name}:save`},o),await Y(t,i);const l=t.getThumbnailState();return await ye(e,t,i,s,n,o)&&(t.resourceReferences.portalItem=i),t.restoreThumbnailFromState(l),await Promise.all([t.updateItemThumbnail(),P(t.resourceReferences,n)]),i}function T(t,r){if(!r.portalItem)throw new e(`${t.name}:portal-item-not-set`,"Portal item to save to has not been set on the WebMap");I(r.portalItem),M(t,r.portalItem)}function M(t,r){if(r.type!==t.itemType)throw new e(`${t.name}:portal-item-wrong-type`,`Portal item needs to have type "${t.itemType}"`)}function C(t,r){const a=r.allLayers.filter((e=>"unsupported"===e.type&&"KnowledgeGraphLayer"===e.resourceInfo?.layerType));if(a.length)throw new e(`${t.name}:save-as-invalid-configuration`,`Failed to save a copy of ${t.name} to prevent persisting invalid configuration. See 'details.layers'`,{layers:a.toArray()})}async function D(t,a){if(!a.basemap?.baseLayers.length)throw new e(`${t.name}:save`,"Map does not have a valid basemap with a base layer.");let o=null;if(await r((()=>{const e=R(a.initialViewProperties,a.basemap);return o=e.spatialReference,!e.updating})),!s(o,a.initialViewProperties.spatialReference))throw new e(`${t.name}:save`,"The spatial reference of the basemap is not compatible with the one from the map.",{expected:a.initialViewProperties.spatialReference,actual:o})}function E(e,t){let r=f.from(t);return r.id&&(r=r.clone(),r.id=null),r.type||(r.type=e.itemType),r.portal||(r.portal=u.getDefault()),I(r),M(e,r),r}function L(e){const t=[];return e.basemap&&t.push(e.basemap.load()),e.ground&&t.push(e.ground.load()),Promise.allSettled(t).then((()=>{}))}async function V(e,t){t.extent=await ce(e.portalItem,e.initialViewProperties.viewpoint.targetGeometry),await Z(e,t)}const G=w.JSAPI,$="CollectorDisabled",k="Collector",B="Data Editing",N="OfflineDisabled",x="Offline",K="Workforce Project",F="Workforce Worker",H="Workforce Dispatcher",J="Offline Map Areas",q="FieldMapsDisabled",z=w.DEVELOPER_BASEMAP,Q="UtilityNetwork",X="IPS";async function Y(e,t){y(t,$),y(t,q),y(t,w.METADATA),y(t,N),y(t,J),y(t,H),y(t,K),y(t,F),await V(e,t)}async function Z(e,t){g(t,G),await ee(e),oe(e,t),ie(e,t),ne(e,t),se(e,t),le(e,t),pe(e,t),t.typeKeywords&&(t.typeKeywords=t.typeKeywords.filter(((e,t,r)=>r.indexOf(e)===t)))}function ee(e){const t=te(e).map((e=>e.load())).toArray();return Promise.allSettled(t).then((()=>{}))}function te(e){return e.allLayers.concat(e.allTables)}function re(e){return te(e).some((e=>e.loaded&&c(e)&&e.capabilities.operations.supportsEditing&&e.editingEnabled&&("subtype-group"!==e.type||e.sublayers.some((e=>e.editingEnabled)))))}function ae(e){return te(e).filter((e=>"group"!==e.type)).every((t=>t.loaded&&fe(e,t)))}function oe(e,t){h(t,$)||h(t,K)||h(t,F)||h(t,H)||!re(e)?y(t,k):g(t,k)}function ie(e,t){re(e)?g(t,B):y(t,B)}function ne(e,t){!h(t,N)&&ae(e)?g(t,x):y(t,x)}function se(e,t){v(e.basemap)?g(t,z):y(t,z)}function le(e,t){e.utilityNetworks?.length?g(t,Q):y(t,Q)}function pe(e,t){e.ipsInfo?g(t,X):y(t,X)}async function ce(e,t){const r=t.clone().normalize();let a;if(r.length>1)for(const o of r)a?o.width>a.width&&(a=o):a=o;else a=r[0];return me(e,a)}async function me(e,t){const r=t.spatialReference;if(r.isWGS84)return t.clone();if(r.isWebMercator)return l(t);const{getGeometryServiceURL:a}=await import("../../portal/support/geometryServiceUtils.js"),o=await a(e),i=new b({geometries:[t],outSpatialReference:n.WGS84});return(await _(o,i))[0]}function ue(e){return m(e)||"map-notes"===e.type||"route"===e.type}function fe(e,t){return c(t)&&t.capabilities.operations.supportsSync||ue(t)&&!t.portalItem||("tile"===t.type||"vector-tile"===t.type)&&(t.capabilities.operations.supportsExportTiles||de(t)||j(t))&&t.spatialReference.equals(e.initialViewProperties.spatialReference)}function de(e){return"tile"===e.type&&(p(e.url)&&A.some((t=>e.url?.toLowerCase().includes("/"+t+"/"))))}async function we(e,t,r,a,o){await r.update({data:a}),_e(e,t,r,a,o)}async function ye(t,r,a,o,i,n){const s=r.portalItem,l={item:s,authenticated:!(!s?.id||!s.portal.user)},p=a.portal;await p.signIn();const{copyAllowed:c,itemReloaded:m}=await ge(l,p);if(l.authenticated||=m,!c)throw new e(`${t.name}:save-as-copy-not-allowed`,"Owner of this map does not allow others to save a copy");const u=await he(a,l,o,n);return r.portalItem=a,_e(t,r,a,o,i),u}async function ge(e,t){const{item:r,authenticated:a}=e;return r?.id&&r.typeKeywords?.includes("useOnly")?r.portal.portalHostname!==t.portalHostname?{copyAllowed:!1,itemReloaded:!1}:(a||await r.reload(),{copyAllowed:"admin"===r.itemControl||"update"===r.itemControl,itemReloaded:!0}):{copyAllowed:!0,itemReloaded:!1}}async function he(e,t,r,o){const i=e.portal,{item:n}=t,{folder:s,copyAllResources:l}=o;let p=!1;if(l&&n?.id&&a(n.portal.url,i.url)&&parseInt(n.portal.currentVersion,10)>=2023){const{total:e}=await n.fetchResources();p=!!e}if(p){const t=await n.copy({copyResources:"all",folder:s});e.id=t.id,e.portal=t.portal;const a=e.toJSON();await e.load(),e.read(a),await e.update({data:r})}else await(i.user?.addItem({item:e,folder:s,data:r}));return p}function _e(e,r,a,n,s){t.prototype.read.call(r,{version:n.version,authoringApp:n.authoringApp,authoringAppVersion:n.authoringAppVersion},{origin:e.origin,ignoreDefaults:!0,url:a.itemUrl?o(a.itemUrl):void 0}),i(s),r.resourceInfo=n}export{O as save,U as saveAs};
