/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import has from"../../../../../../core/has.js";import{getMetersPerUnitForSR as t}from"../../../../../../core/unitUtils.js";import{maxRepresentableInt as e,tileSize as i}from"../../definitions.js";import{FeatureSelection as o}from"../../enums.js";import{CompareFunction as r,StencilOperation as s}from"../../../../../webgl/enums.js";const n={color:{write:[!0,!0,!0,!0],blendMode:"composite"},depth:!1,stencil:{write:!1,test:{ref:t=>t.stencilRef,compare:r.EQUAL,mask:255,op:{fail:s.KEEP,zFail:s.KEEP,zPass:s.REPLACE}}}},l={color:{write:[!0,!0,!0,!0],blendMode:"additive"},depth:!1,stencil:!1},a={...n,color:{write:[!0,!0,!0,!0],blendMode:"delete"}};function c({pixelRatio:e,state:i,displayLevel:o,requiredLevel:r},s){const n=1/2**(o-s.key.level),l=1/2**(r-s.key.level);return{displayMat3:Array.from(i.displayMat3),displayViewMat3:Array.from(i.displayViewMat3),displayViewScreenMat3:Array.from(s.transforms.displayViewScreenMat3),viewMat3:Array.from(i.viewMat3),tileMat3:Array.from(s.transforms.tileMat3),displayZoomFactor:n,requiredZoomFactor:l,tileOffset:[s.x,s.y],currentScale:i.scale,currentZoom:o,metersPerSRUnit:t(i.spatialReference),rotation:i.rotation,pixelRatio:e}}function f(t){return"highlight"===t.passOptions?.type}function m(t){return"hittest"===t.passOptions?.type}function p(t){if(!m(t))return null;const{position:e}=t.passOptions,i=t.pixelRatio,o=has("esri-mobile");return{position:e,distance:has(o?"hittest-2d-mobile-tolerance":"hittest-2d-desktop-tolerance")*i,smallSymbolDistance:has(o?"hittest-2d-mobile-tolerance":"hittest-2d-small-symbol-tolerance")*i,smallSymbolSizeThreshold:has("hittest-2d-small-symbol-tolerance-threshold")}}function u(t){if(!f(t))return null;const{activeReasons:e,highlightAll:i}=t.passOptions;return{activeReasons:e,highlightAll:i?1:0}}function d(t,e,i){const o={};for(const r in i)i[r]instanceof Function?o[r]=i[r](t,e):o[r]=i[r];return o}function h(t,e){const{attributeView:i,context:o}=t;return{storage:i.getUniforms(o),view:c(t,e),hittestRequest:p(t),highlight:u(t)}}function y(t){return{inside:t.selection===o.InsideEffect,outside:t.selection===o.OutsideEffect}}function M(t){return m(t)?l:f(t)&&"clear"===t.passOptions.stepType?a:n}function w(t){const{row:o,col:r}=t.key,s=r*i,n=o*i;return{tileOffsetFromLocalOrigin:[s%e,n%e],maxIntsToLocalOrigin:[Math.floor(s/e),Math.floor(n/e)]}}export{M as getFeaturePipelineState,h as getFeatureUniforms,w as getLocalTileOffset,y as getSelectionDefines,c as getViewUniforms,f as isHighlight,m as isHittest,d as resolveDynamicUniforms};
