/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import"../../../../geometry.js";import e from"../../../../Viewpoint.js";import"../../tiling/TileInfoView.js";import t from"../../tiling/TileKey.js";import"../../tiling/TileQueue.js";import"../../tiling/TileStrategy.js";import s from"../../ViewState.js";import{StyleLayerType as i}from"./style/StyleDefinition.js";import{RenderableTile as r}from"../webgl/RenderableTile.js";import{TileReshuffleManager as n}from"../webgl/TileReshuffleManager.js";import{CompareFunction as l,StencilOperation as a}from"../../../webgl/enums.js";import o from"../../../../geometry/Point.js";const d=.125;class c{constructor(){this._renderParams={reshuffleManager:new n,context:null,drawPhase:1,state:new s({viewpoint:new e({targetGeometry:new o(0,0),scale:1,rotation:0}),size:[256,256]}),stationary:!0,pixelRatio:1,displayLevel:-1,requiredLevel:-1,globalOpacity:1,renderPass:"background",styleLayer:null,styleLayerUID:-1,painter:null,glyphMosaic:null,spriteMosaic:null,profiler:null,renderingOptions:null,requestRender:null,allowDelayedRender:!1,deltaTime:-1,timeline:null,time:0,hasClipping:!1,blendMode:null,dataUploadCounter:0,effects:null,inFadeTransition:!1,requireFBO:!1,highlightGradient:null,stencilSymbols:!0,is3D:!0,backgroundColor:null},this._backgroundTile=new r(new t(0,0,0,0),0,0,0,512,512,4096,4096)}dispose(){this._renderParams=null}renderBackground(e,t,s,i,r,n,l,a,o,d){const c=this._backgroundTile;this._updateRenderParameters(e,t,c,s,r,n,l,a,o,d),this._renderParams.stencilSymbols=!1,s.drawBackground(this._renderParams,c,i)}renderContent(e,t,s,i,r,n,a,o,d,c,m,u){this._stencilSymbols(e,t,s,i,r,n,a,Math.round(1/o),d,c,m,u);let p=1;s.stencilRef=p++,e.setStencilFunction(l.EQUAL,s.stencilRef,255),this._render(e,t,s,r,n,a,o,d,c,m,u),i.forAll((t=>{t.sourceLayerInfo.data.stencilRef=p++,this._renderSymbols(e,t.sourceLod,t.sourceLayerInfo.data,r,n,a,Math.round(1/o),t.offset,c,m,u)}))}_stencilSymbols(e,t,s,i,r,n,o,d,c,m,u,p){let f=1;s.stencilRef=f++,e.setDepthTestEnabled(!1),e.setDepthWriteEnabled(!1),e.setStencilTestEnabled(!0),e.setBlendingEnabled(!1),e.setColorMask(!1,!1,!1,!1),e.setStencilOp(a.KEEP,a.KEEP,a.REPLACE),e.setStencilWriteMask(255),e.setStencilFunction(l.ALWAYS,s.stencilRef,255),this._stencilTileSymbols(e,t,s,r,n,o,d,c,m,u,p);for(const a of i.toArray()){const{sourceLod:t,offset:s,sourceLayerInfo:i}=a;i.data.stencilRef=f++,e.setStencilFunction(l.ALWAYS,i.data.stencilRef,255),this._stencilTileSymbols(e,t,i.data,r,n,o,d,s,m,u,p)}e.setStencilWriteMask(0),e.setBlendingEnabled(!0),e.setDepthTestEnabled(!0),e.setColorMask(!0,!0,!0,!0)}_renderSymbols(e,t,s,r,n,a,o,d,c,m,u){e.setStencilFunction(l.EQUAL,s.stencilRef,255),this._render(e,t,s,r,n,a,o,d,c,m,u,i.SYMBOL)}_render(e,t,s,i,r,n,l,a,o,d,c,m){this._updateRenderParameters(e,t,s,i,n,l,a,o,d,c),this._renderParams.stencilSymbols=!1,i.drawTile(this._renderParams,s,r,m)}_stencilTileSymbols(e,t,s,i,r,n,l,a,o,d,c){this._updateRenderParameters(e,t,s,i,n,l,a,o,d,c),this._renderParams.stencilSymbols=!0,s.triangleCount=0,i.drawSymbols(this._renderParams,s,r)}_updateRenderParameters(e,t,s,i,r,n,l,a,o,c){"type"in s&&"vector-tile"===s.type&&!s.stage&&s.attachWithContext(e);const m=t[0]-r.getLevelShift(t[0]),u=this._renderParams;u.context=e,u.painter=i,u.glyphMosaic=i.glyphMosaic,u.spriteMosaic=i.spriteMosaic,u.pixelRatio=o*c,u.displayLevel=m,u.requiredLevel=m;const p=r.getScale(t[0]),[f,h]=r.getOffset(t,n*p),y=d*n*p/a,g=s.transforms.displayViewScreenMat3;g[0]=y,g[4]=-y,g[6]=-1-f-l[0]*n*2,g[7]=1+h+(1-l[1])*n*2-2,u.state.size[0]=a/c,u.state.size[1]=a/c,u.state.pixelRatio=c}}export{c as VectorTileRendererHelper3D};
