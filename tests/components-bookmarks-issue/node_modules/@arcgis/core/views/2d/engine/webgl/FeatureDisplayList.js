/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import"../../../../core/has.js";import{FeatureBatchingStrategy as t,FeatureSymbologyDrawOrder as e}from"./enums.js";import{List as n}from"./cpuMapped/FreeList.js";function a(t,e){return t<<16|255&e}function i(t){return 255&t}class s{constructor(t,e,n,a,i){this.instance=t,this.materialKey=e,this.target=n,this.start=a,this.count=i}get textureKey(){return i(this.materialKey)}get indexEnd(){return this.start+this.count}extend(t){this.count+=t}render(t){this.instance.techniqueRef.render(t,this)}}class r{constructor(){this._length=0,this._minOrderedLength=0,this._materialKeys=new Set}static fromDisplayEntities(t,e,n,i){const s=new r;for(const r of t.values())for(const t of r.records){const r=n.getInstance(t.instanceId),d=a(r.instanceId,t.textureKey);s.addRecord(r,d,t.indexStart,t.indexCount,t.vertexStart,t.vertexCount,e,i)}return s}get length(){return this._length}get minOrderedLength(){return this._minOrderedLength}get minUnorderedLength(){return this._materialKeys.size}render(t){const{drawPhase:e}=t;for(const n of this.infos())n.instance.techniqueRef.drawPhase&e&&n.render(t)}addRecord(a,i,r,d,h,l,o,c){let u=r,_=d;if(_||(u=h,_=l),!_)return;if(null==this._head){const t=new s(a,i,o,u,_);return this._head=new n(t),this._tail=this._head,this._length++,void this._minOrderedLength++}if(c===t.STRICT_ORDER)return this._insert(a,i,o,u,_,this._tail,null);let f=null,g=this._head;const m=a.instanceId,y=a.techniqueRef.symbologyPlane;if(c===t.STRICT_MARKERS_AND_TEXT&&(y===e.MARKER||y===e.TEXT))return this._insert(a,i,o,u,_,this._tail,null);for(;g;){const t=g.data.instance,e=t.instanceId,n=t.techniqueRef.symbologyPlane,s=f?.data.instance.instanceId;if(y<n||m===s&&m!==e)return this._insert(a,i,o,u,_,f,g);f=g,g=g.next}this._insert(a,i,o,u,_,f,null)}*infos(){if(null!=this._head)for(const t of this._head.values())yield t}_insert(t,e,a,i,r,d,h){if(null==d&&null==h){const d=new s(t,e,a,i,r);return this._head=new n(d),this._tail=this._head,this._length++,void this._minOrderedLength++}return e!==this._tail.data.materialKey&&this._minOrderedLength++,this._materialKeys.add(e),null==d&&null!=h?this._insertAtHead(t,e,a,i,r,h):null!=d&&null==h?this._insertAtEnd(t,e,a,i,r,d):null!=d&&null!=h?this._insertAtMiddle(t,e,a,i,r,d,h):void 0}_insertAtHead(t,e,a,i,r,d){const h=i+r;if(e===d.data.materialKey&&a===d.data.target&&h===d.data.start)d.data.start=i,d.data.count+=r;else{const h=new s(t,e,a,i,r);this._head=new n(h),this._head.next=d,this._length++}}_insertAtEnd(t,e,a,i,r,d){if(d.data.materialKey===e&&d.data.indexEnd===i)d.data.count+=r;else{const h=new s(t,e,a,i,r);this._tail=new n(h),d.next=this._tail,this._length++}}_insertAtMiddle(t,e,a,i,r,d,h){const l=i+r;if(d.data.materialKey===e&&d.data.target===a&&d.data.indexEnd===i)d.data.count+=r,d.data.materialKey===h.data.materialKey&&d.data.target===h.data.target&&d.data.indexEnd===h.data.start&&(d.data.count+=h.data.count,d.next=h.next,this._length--);else if(e===h.data.materialKey&&a===h.data.target&&l===h.data.start)h.data.start=i,h.data.count+=r;else{const l=new s(t,e,a,i,r),o=new n(l);d.next=o,o.next=h,this._length++}}}export{r as DisplayList,s as DisplayListInfo};
