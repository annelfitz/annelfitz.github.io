/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import e from"./TileCoverage.js";import i from"./TileKey.js";const t=1e-6;class l{constructor(e){this._tiles=new Map,this.buffer=0,this.acquireTile=e.acquireTile,this.releaseTile=e.releaseTile,this.tileInfoView=e.tileInfoView,this.buffer=e.buffer}destroy(){}clear(){this._tiles.forEach((e=>this._releaseTile(e)))}tileKeys(){const e=[];return this._tiles.forEach(((i,t)=>e.push(t))),e}update(t){const l=this.tileInfoView.getTileCoverage(t.state,this.buffer,!0,"closest"),{spans:s,lodInfo:r}=l,{level:a}=r,o=[],d=[],h=new Set,n=new Set;for(const{row:e,colFrom:c,colTo:f}of s)for(let t=c;t<=f;t++){const l=i.getId(a,e,r.normalizeCol(t),r.getWorldForColumn(t)),s=this._getOrAcquireTile(o,l);h.add(l),s.isReady?s.visible=!0:n.add(s.key)}n.forEach((e=>this._addPlaceholders(h,e))),this._tiles.forEach((e=>{h.has(e.key.id)||(d.push(e.key.id),this._releaseTile(e))})),e.pool.release(l);return{hasMissingTiles:n.size>0,added:o,removed:d}}_getOrAcquireTile(e,t){if(!this._tiles.has(t)){const l=this.acquireTile(new i(t));e.push(t),this._tiles.set(t,l),l.visible=!1}return this._tiles.get(t)}_getTile(e){return this._tiles.get(e)}_releaseTile(e){this._tiles.delete(e.key.id),this.releaseTile(e)}_addPlaceholders(e,i){const l=this._addPlaceholderChildren(e,i);if(!(Math.abs(1-l)<t)){if(!this._addPlaceholderParent(e,i)){this._getTile(i.id).visible=!0}}}_addPlaceholderChildren(e,i){let t=0;return this._tiles.forEach((l=>{t+=this._addPlaceholderChild(e,l,i)})),t}_addPlaceholderChild(e,i,t){if(i.key.level<=t.level||!i.hasData||!t.contains(i.key))return 0;i.visible=!0,e.add(i.key.id);return 1/(1<<2*(i.key.level-t.level))}_addPlaceholderParent(e,i){let t=i.getParentKey(),l=0,s=null;for(;null!=t;){if(e.has(t.id))return!0;const i=this._getTile(t.id);if(i?.isReady){for(const i of e){const e=this._getTile(i);e&&t.contains(e.key)&&(e.visible=!1)}return i.visible=!0,e.add(i.key.id),!0}i?.hasData&&i.patchCount>l&&(l=i.patchCount,s=i),t=t.getParentKey()}return!!s&&(s.visible=!0,e.add(s.key.id),!0)}}export{l as TileManager};
