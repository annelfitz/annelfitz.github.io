/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{pt2px as e}from"../../../../../../core/screenUtils.js";import r from"../../../../../../layers/support/OrderByInfo.js";import{createLabelMatcherSchema as t}from"./LabelMatcherSchema.js";import{createMatcherSchema as s}from"./MatcherSchema.js";import{createStorageSchema as i}from"./StorageSchema.js";import{createVisualVariableUniforms as n}from"./VisualVariablesSchema.js";async function l(e,r){const i=r.renderer,l=n(i);return{symbology:await s(e,i),labels:await t(e,r,l)}}async function a(e,r,t,s){const n=t.featureReduction;if(n)switch(n.type){case"binning":return u(n,e,r,t,s);case"cluster":return f(n,e,r,t,s)}const a=d(t.orderBy,t.renderer,t.objectIdField);return{storage:i(t.renderer,r.filters),mesh:{displayRefreshVersion:s,strategy:{type:"feature"},factory:await l(e,t),sortKey:a,timeZone:r.timeZone}}}function o(e,r){return e.fields.map((e=>({...e.toJSON(),type:c(e,r)})))}function c(e,r){const{onStatisticExpression:t,onStatisticField:s,statisticType:i}=e;switch(i){case"min":case"max":case"avg":case"avg_angle":case"sum":case"count":return"esriFieldTypeDouble";case"mode":{if(t){const{returnType:e}=t;return e?"string"===e?"esriFieldTypeString":"esriFieldTypeDouble":"esriFieldTypeString"}const e=r.find((e=>e.name===s));return e?e.type:"esriFieldTypeString"}}}async function u(e,r,l,a,c){const u=o(e,a.fields),f=e.renderer,d=await s(r,f),y=i(f,[null,null]),p=n(f),m=await t(r,{geometryType:"polygon",labelingInfo:e.labelingInfo,labelsVisible:e.labelsVisible},p);return{storage:y,mesh:{displayRefreshVersion:c,strategy:{type:"binning",fields:u,fixedBinLevel:e.fixedBinLevel,featureFilter:l.filters[0]},factory:{labels:m,symbology:d},sortKey:null,timeZone:l.timeZone}}}async function f(r,l,a,c,u){const f=o(r,c.fields),d={type:"cluster",feature:await s(l,r.effectiveFeatureRenderer),cluster:await s(l,r.effectiveClusterRenderer)},y=n(r.effectiveFeatureRenderer),p={type:"cluster",feature:await t(l,c,y),cluster:await t(l,{geometryType:"point",labelingInfo:r.labelingInfo,labelsVisible:r.labelsVisible},y)};return{storage:i(r.effectiveFeatureRenderer,[null,null]),mesh:{displayRefreshVersion:u,strategy:{type:"cluster",fields:f,featureFilter:a.filters[0],clusterRadius:e(r.clusterRadius/2)},factory:{labels:p,symbology:d},sortKey:null,timeZone:a.timeZone}}}function d(e,t,s){const i=null!=t&&"unique-value"===t.type&&t.orderByClassesEnabled;if("default"!==e||i||(e=[new r({field:s,order:"descending"})]),"default"!==e&&e.length){e.length;const r=e[0],t="ascending"===r.order?"asc":"desc";return r.field?{field:r.field,order:t}:r.valueExpression?{expression:r.valueExpression,order:t}:null}if(i){return{byRenderer:!0,order:"asc"}}return null}export{a as createSimpleProcessorSchema,o as getAggregateFields};
