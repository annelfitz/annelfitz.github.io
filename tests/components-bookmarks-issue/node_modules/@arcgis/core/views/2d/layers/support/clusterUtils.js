/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import"../../../../renderers/ClassBreaksRenderer.js";import"../../../../renderers/DictionaryRenderer.js";import"../../../../renderers/DotDensityRenderer.js";import"../../../../renderers/HeatmapRenderer.js";import"../../../../renderers/PieChartRenderer.js";import"../../../../renderers/Renderer.js";import e from"../../../../renderers/SimpleRenderer.js";import"../../../../renderers/UniqueValueRenderer.js";import"../../../../renderers/support/jsonUtils.js";import r from"../../../../core/Logger.js";import"../../../../symbols.js";import s from"../../../../core/Error.js";import has from"../../../../core/has.js";import{createMD5Hash as n}from"../../../../core/MD5.js";import i from"../../../../layers/support/AggregateField.js";import t from"../../../../layers/support/ExpressionInfo.js";import o from"../../../../renderers/support/AuthoringInfo.js";import a from"../../../../symbols/SimpleMarkerSymbol.js";const l=()=>r.getLogger("esri.views.2d.layers.support.clusterUtils");has.add("esri-cluster-arcade-enabled",!0);const u=has("esri-cluster-arcade-enabled"),p=new Set(["simple-line","simple-fill","picture-fill"]);function d(r,s){let n=s.clone();if(!c(n))return n;if(s.getSymbols().some((e=>p.has(e.type)))&&(n=new e({symbol:new a})),n.authoringInfo||(n.authoringInfo=new o),n.authoringInfo.isAutoGenerated=!0,"visualVariables"in n){const e=(n.visualVariables||[]).filter((e=>"$view.scale"!==e.valueExpression));e.forEach((e=>{"rotation"===e.type?e.field?e.field=g(r,e.field,"avg_angle","number"):e.valueExpression&&(e.field=b(r,e.valueExpression,"avg_angle","number"),e.valueExpression=null):e.normalizationField?(e.field=g(r,e.field,"avg_norm","number",e.normalizationField),e.normalizationField=null):e.field?e.field=g(r,e.field,"avg","number"):e.valueExpression&&(e.field=b(r,e.valueExpression,"avg","number"),e.valueExpression=null)})),n.visualVariables=e}switch(n.type){case"simple":break;case"pie-chart":for(const e of n.attributes)e.field?e.field=g(r,e.field,"sum","number"):e.valueExpression&&(e.field=b(r,e.valueExpression,"sum","number"),e.valueExpression=null);break;case"unique-value":n.field?n.field=g(r,n.field,"mode","string"):n.valueExpression&&(n.field=b(r,n.valueExpression,"mode","string"),n.valueExpression=null);break;case"class-breaks":n.normalizationField?(n.field=g(r,n.field,"avg_norm","number",n.normalizationField),n.normalizationField=null):n.field?n.field=g(r,n.field,"avg","number"):n.valueExpression&&(n.field=b(r,n.valueExpression,"avg","number"),n.valueExpression=null)}return n}const m=e=>{for(const r of e)if("size"===r.type)return r;return null},f=e=>{for(const r of e)if("cluster_count"===r.field)return!0;return!1},c=e=>{const r=r=>l().error(new s("Unsupported-renderer",r,{renderer:e}));if(!e)return!1;switch(e.type){case"unique-value":if(e.field2||e.field3)return r("FeatureReductionCluster does not support multi-field UniqueValueRenderers"),!1;break;case"class-breaks":if(e.normalizationField){const s=e.normalizationType;if("field"!==s)return r(`FeatureReductionCluster does not support a normalizationType of ${s}`),!1}break;case"simple":case"pie-chart":break;default:return r(`FeatureReductionCluster does not support renderers of type ${e.type}`),!1}if(!u){if("valueExpression"in e&&e.valueExpression)return r("FeatureReductionCluster does not currently support renderer.valueExpression. Support will be added in a future release"),!1;if(("visualVariables"in e&&e.visualVariables||[]).some((e=>!(!("valueExpression"in e)||!e.valueExpression))))return r("FeatureReductionCluster does not currently support visualVariables with a valueExpression. Support will be added in a future release"),!1}return!0};function v(e,r,s){switch(e){case"sum":return`cluster_sum_${r}`;case"avg":case"avg_angle":return`cluster_avg_${r}`;case"mode":return`cluster_type_${r}`;case"avg_norm":{const e=s,i="field",t=r.toLowerCase()+",norm:"+i+","+e.toLowerCase();return"cluster_avg_"+n(t)}}}function b(e,r,s,o){const a=n(r),l="mode"===s?`cluster_type_${a}`:"sum"===s?`cluster_sum_${a}`:`cluster_avg_${a}`;return e.some((e=>e.name===l))||e.push(new i({name:l,isAutoGenerated:!0,onStatisticExpression:new t({expression:r,returnType:o}),statisticType:s})),l}function g(e,r,s,n,o){if("cluster_count"===r||e.some((e=>e.name===r)))return r;const a=v(s,r,o);return e.some((e=>e.name===a))||("avg_norm"===s?e.push(new i({name:a,isAutoGenerated:!0,onStatisticExpression:new t({expression:`$feature.${r} / $feature.${o}`,returnType:n}),statisticType:"avg"})):e.push(new i({name:a,isAutoGenerated:!0,onStatisticField:r,statisticType:s}))),a}export{d as createInferredClusterRenderer,m as findSizeVV,f as hasClusterCountVV,c as isClusterCompatibleRenderer};
