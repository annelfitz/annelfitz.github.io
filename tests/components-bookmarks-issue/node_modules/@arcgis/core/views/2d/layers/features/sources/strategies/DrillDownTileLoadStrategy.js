/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import has from"../../../../../../core/has.js";import{throwIfAborted as t,onAbort as e}from"../../../../../../core/promiseUtils.js";import{ATileLoadStrategy as s}from"./ATileLoadStrategy.js";import{DrillDownTileSourceChunk as o}from"./chunks/DrillDownTileSourceChunk.js";import{FeatureSetReaderJSON as i}from"../../support/FeatureSetReaderJSON.js";class r{constructor(t,s){this.subscription=t,this._tileIdToResult=new Map,this._controller=new AbortController,e(t.options,(()=>this._controller.abort())),e(s,(()=>this._controller.abort()))}get(t){return this._tileIdToResult.get(t)}set(t,e){this._tileIdToResult.set(t,e)}get options(){return{signal:this._controller.signal}}}class n extends s{constructor(){super(...arguments),this._loadStates=new Map}get about(){return{willQueryAllFeatures:!1,willQueryFullResolutionGeometry:!1}}async load(e){this._loadStates.has(e.key.id)||this._loadStates.set(e.key.id,new r(e,this._options));const s=this._loadStates.get(e.key.id);let n;try{for await(const i of this._fetchChunkInfos(s,e.tile,0)){const{queryJSON:s,reader:r,sourceTile:n,sourceTileDepth:l,tile:a}=i,u=new o(r,s,a,n,l,!1);t(e.options),this._addChunk(u)}}catch(a){n=a}const l=new o(i.empty(this._metadata),null,e.tile,null,-1,!0);if(this._addChunk(l),n)throw n}unload(t){super.unload(t),this._loadStates.delete(t.key.id)}async*_fetchChunkInfos(t,e,s){let o=t.get(e.id);const i=!!o;if(o||(o=await this._fetchChunkInfo(t,e,s),t.set(e.id,o)),o.reader.exceededTransferLimit&&s<has("featurelayer-query-max-depth"))for(const r of e.createChildTiles())yield*this._fetchChunkInfos(t,r,s+1);else i||(yield o)}async _fetchChunkInfo(t,e,s){const o=t.subscription.tile.getQuantizationParameters(),i=this._queryInfo.createTileQuery(e,{returnExceededLimitFeatures:!1,quantizationParameters:o});return{reader:await this._fetch(i,t.subscription.options),queryJSON:i.inner.toJSON(),tile:t.subscription.tile,sourceTile:e,sourceTileDepth:s}}}export{n as DrillDownTileLoadStrategy};
