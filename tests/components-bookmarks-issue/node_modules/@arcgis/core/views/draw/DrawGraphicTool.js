/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import t from"../../Graphic.js";import i from"../../core/Evented.js";import{makeHandle as o}from"../../core/handleUtils.js";import{destroyMaybe as r}from"../../core/maybe.js";import{createLength as n,zeroMeters as s,zeroSquareMeters as a,zeroDegreesGeographic as l,createAngle as c,createScalar as p,valueInUnit as u}from"../../core/quantityUtils.js";import{watch as h,syncAndInitial as d}from"../../core/reactiveUtils.js";import{getMetersPerVerticalUnitForSR as m}from"../../core/unitUtils.js";import{property as y}from"../../core/accessorSupport/decorators/property.js";import"../../core/has.js";import"../../core/Logger.js";import"../../core/RandomLCG.js";import{subclass as g}from"../../core/accessorSupport/decorators/subclass.js";import v from"../../layers/GraphicsLayer.js";import{pointEquals as f}from"../../layers/graphics/dehydratedFeatureComparison.js";import{absoluteHeightElevationInfo as _,getConvertedElevationFromXYZ as w}from"../../support/elevationInfoUtils.js";import{createCircle as O,createEllipse as x,createSquare as k,createRectangle as V,createPolygon as G,createPolyline as T,createMultipoint as C}from"./support/createUtils.js";import{getDrawHelpMessage as b}from"./support/helpMessageUtils.js";import{createViewAlignedCoordinateSystem as S}from"./support/surfaceCoordinateSystems.js";import{InteractiveToolBase as I}from"../interactive/InteractiveToolBase.js";import{tooltipKeys as E}from"../interactive/keybindings.js";import{getConstraintContext as j}from"../interactive/sketch/constraintUtils.js";import U from"../interactive/sketch/SketchOptions.js";import{DrawPointTooltipInfo as z,DrawPolylineTooltipInfo as M,DrawPolygonTooltipInfo as R,DrawMeshTooltipInfo as A,DrawRectangleTooltipInfo as H,DrawCircleTooltipInfo as P}from"../interactive/tooltip/DrawTooltipInfos.js";import{Tooltip as D}from"../interactive/tooltip/Tooltip.js";import{directionForVertices as L}from"../support/angularMeasurementUtils.js";import{autoArea2D as Z}from"../support/automaticAreaMeasurementUtils.js";import{autoLength2D as F,autoDistanceBetweenPoints2D as N}from"../support/automaticLengthMeasurementUtils.js";import{elevationFromPoint as q,elevationFromZ as B}from"../support/euclideanLengthMeasurementUtils.js";import{supportsGeodesicMeasurement as J}from"../support/geodesicMeasurementUtils.js";import{autorun as K}from"../../core/accessorSupport/trackingUtils.js";class Q{constructor(){this.committedVertices=null,this.cursorVertex=null,this.full=null,this.outline=null,this.cursorEdge=null,this.circle=null,this.rectangle=null}}let W=class extends(i.EventedMixin(I)){constructor(e){super(e),this._graphic=null,this._createOperationGeometry=null,this.defaultZ=0,this.directionOptions=null,this.geometryType=null,this.hasZ=!0,this.geometryToPlace=null,this.mode=null,this.snappingManager=null,this.snapToScene=!1,this.sketchOptions=new U}initialize(){this.internalGraphicsLayer=new v({listMode:"hide",internal:!0}),this.view.map.layers.add(this.internalGraphicsLayer);const e=this.drawOperation=this.makeDrawOperation(),{sketchOptions:t}=this,i=this.view.type;this.tooltipInfos={point:new z({sketchOptions:t,viewType:i}),polyline:new M({sketchOptions:t,viewType:i}),polygon:new R({sketchOptions:t,viewType:i}),mesh:new A({sketchOptions:t,viewType:i}),rectangle:new H({sketchOptions:t}),circle:new P({sketchOptions:t})},this.tooltip=new D({view:this.view}),this._initializeConstraints(),this.addHandles([e.on("vertex-add",(e=>this.onVertexAdd(e))),e.on("vertex-remove",(e=>this.onVertexRemove(e))),e.on("vertex-update",(e=>this.onVertexUpdate(e))),e.on("cursor-update",(e=>this.onCursorUpdate(e))),e.on("cursor-remove",(()=>this._updateGraphic())),e.on("complete",(e=>this.onComplete(e))),h((()=>this.cursor),(t=>e.cursor=t),d),K((()=>this._updateTooltipInfo())),K((()=>{e.constraintZ=this._constraintZ}))]),this.finishToolCreation()}destroy(){this.drawOperation=r(this.drawOperation),this.tooltip=r(this.tooltip),this._destroyAllVisualizations(),this.view.map.remove(this.internalGraphicsLayer),this.internalGraphicsLayer=r(this.internalGraphicsLayer),this._set("view",null)}get _defaultElevation(){const e=m(this._drawSpatialReference);return n(this.defaultZ*e,"meters")}get _inputModeAvailable(){const{inputEnabled:e,visibleElements:t}=this.sketchOptions.tooltips;return e&&!0===this.activeTooltipInfo?.editableFields.some((({name:e})=>"longitude"===e||"latitude"===e||"x"===e||"y"===e?t.coordinate:t[e]))}get _drawSpatialReference(){return this.drawOperation.coordinateHelper.spatialReference}get canRedo(){return this.drawOperation.canRedo}get canUndo(){return this.drawOperation.canUndo}set centered(e){this._set("centered",e),this._updateGraphic()}get cursor(){return this._get("cursor")}set cursor(e){this._set("cursor",e)}set enabled(e){this.drawOperation.interactive=e,this._set("enabled",e)}set forceUniformSize(e){this._set("forceUniformSize",e),this._updateGraphic()}get graphic(){return this._graphic}set graphicSymbol(e){this._set("graphicSymbol",e),null!=this._graphic&&(this._graphic.symbol=e)}get updating(){return this.drawOperation?.updating??!1}completeCreateOperation(){this.drawOperation.complete()}onInputEvent(e){if(!this.destroyed)return"key-down"===e.type&&e.key===E.enterInputMode&&this._inputModeAvailable?(this.tooltip.enterInputMode(),void e.stopPropagation()):void this.drawOperation.onInputEvent(e)}redo(){this.drawOperation.redo()}reset(){}undo(){this.drawOperation.undo(),0===this.drawOperation.numCommittedVertices&&this._initializeConstraints()}_destroyAllVisualizations(){this.removeHandles(Y.outline),this.removeHandles(Y.regularVertices),this.removeHandles(Y.activeVertex),this.removeHandles(Y.activeEdge),this.removeHandles(X)}_createOrUpdateGraphic(e){if(null!=this._graphic)return this.updateGraphicGeometry(e),this._graphic;const i=new t({...this.graphicProperties,symbol:this.graphicSymbol});return this._graphic=i,this.updateGraphicGeometry(e),this.internalGraphicsLayer.add(i),this.addHandles(this.initializeGraphic(i)),this.notifyChange("graphic"),this.addHandles(o((()=>{this.internalGraphicsLayer.remove(i),this._graphic===i&&(this._graphic=null)})),X),i}updateGraphicGeometry(e){this._graphic.geometry=e}_getCreateOperationGeometry(e={operationComplete:!1}){if(null==this.drawOperation)return;const{coordinateHelper:t,view:i,visualizationCursorVertex:o,lastVertex:r,committedVertices:n,geometryIncludingUncommittedVertices:s,numCommittedVertices:a}=this.drawOperation;if(!(a>0||null!=o))return;const l=e.operationComplete?n:s,c=l.length,p=null!=o?t.pointToArray(o):null,u=this._drawSpatialReference,h="3d"===i.type&&"global"===i.viewingMode,d=new Q;d.committedVertices=n,d.cursorVertex=p;const{geometryType:m}=this;switch(m){case"point":case"mesh":d.full=t.arrayToPoint(l[0]);break;case"multipoint":d.full=c>0?C(l,u):null;break;case"polyline":case"polygon":c>0&&(d.full="polygon"===m?G([l],u,h,!0):T([l],u,h),d.cursorEdge=null!=p&&r&&!f(o,r)?T([[p,t.pointToArray(r)]],u,h):null,d.outline=c>1?d.full:null);break;case"circle":case"rectangle":{if(d.committedVertices=d.cursorVertex=null,!c)break;const t=S(i,l[0]),o=l[0],r=t.makeMapPoint(o[0]+ee*i.resolution,o[1]);"circle"===m?1===c&&e.operationComplete?d.circle=O([o,r],t,!0):2===c&&(this.forceUniformSize?d.circle=O(l,t,this.centered):d.rectangle=x(l,t,this.centered)):1===c&&e.operationComplete?d.rectangle=k([o,r],t,!0):2===c&&(d.rectangle=this.forceUniformSize?k(l,t,this.centered):V(l,t,this.centered)),d.full=null!=d.circle?d.circle.geometry:d.rectangle?.geometry,d.outline="polygon"===d.full?.type?d.full:null;break}default:return null}return d}initializeGraphic(e){return o()}onComplete(e){if(!this.drawOperation)return;this._updateGraphic();let t=null;if(this.drawOperation.isCompleted){const e=this._getCreateOperationGeometry({operationComplete:!0});null!=e&&(t=this._createOrUpdateGraphic(e.full))}this._createOperationGeometry=null,this.emit("complete",{graphic:t,...e})}onCursorUpdate(e){this._updateGraphic(),this.emit("cursor-update",e)}onDeactivate(){const{drawOperation:e}=this;e&&(e.isCompleted||e.cancel())}onOutlineChanged(e){return o()}onCursorEdgeChanged(e){return o()}onVertexAdd(e){this._unlockConstraintsOnVertexAddOrRemove(),this._updateGraphic(),this._lockElevationOnVertexAdd(e.vertices.at(0)?.coordinates),this.emit("vertex-add",e)}onVertexRemove(e){this._unlockConstraintsOnVertexAddOrRemove(),this._updateGraphic(),this.emit("vertex-remove",e)}onVertexUpdate(e){this._updateGraphic(),this.emit("vertex-update",e)}_updateGraphic(){const e=this._getCreateOperationGeometry();this._createOperationGeometry=e,null!=e?(null!=e.cursorEdge?this.addHandles(this.onCursorEdgeChanged(e.cursorEdge),Y.activeEdge):this.removeHandles(Y.activeEdge),null!=e.outline?this.addHandles(this.onOutlineChanged(e.outline),Y.outline):this.removeHandles(Y.outline),null!=e.committedVertices?this.addHandles(this.onRegularVerticesChanged(e.committedVertices),Y.regularVertices):this.removeHandles(Y.regularVertices),null!=e.cursorVertex?this.addHandles(this.onActiveVertexChanged(e.cursorVertex),Y.activeVertex):this.removeHandles(Y.activeVertex),null!=e.full?this._createOrUpdateGraphic(e.full):this.removeHandles(X)):this._destroyAllVisualizations()}get activeTooltipInfo(){const{drawOperation:e,graphic:t,view:i}=this;if(!e)return null;const o=this.tooltipInfos,r=t?.geometry?.type;switch(this.geometryType){case"point":return"2d"===i.type&&0===this.defaultZ?null:"point"===r?o.point:null;case"polyline":return"polyline"===r?o.polyline:null;case"polygon":return"polygon"===r?o.polygon:null;case"rectangle":return"polygon"===r?o.rectangle:null;case"circle":return"polygon"===r?o.circle:null;case"mesh":return"mesh"===r?o.mesh:null;default:return null}}_updateTooltipInfo(){const{activeTooltipInfo:e,tooltip:t,sketchOptions:i}=this;switch(e?.type){case"draw-point":this._updateDrawPointTooltipInfo(e);break;case"draw-polyline":this._updateDrawPolylineTooltipInfo(e);break;case"draw-polygon":this._updateDrawPolygonTooltipInfo(e);break;case"draw-rectangle":this._updateDrawRectangleTooltipInfo(e);break;case"draw-circle":this._updateDrawCircleTooltipInfo(e);break;case"draw-mesh":this.updateDrawMeshTooltipInfo(e)}t.view=this.view,t.info=i.tooltips.effectiveEnabled?e:null}_updateDrawPointTooltipInfo(e){const{drawOperation:t,graphic:i,view:o,sketchOptions:r}=this,{coordinateHelper:n,cursorVertex:s}=t,a=i?.geometry;if("point"!==a?.type)return;if(e.sketchOptions=r,e.viewType=o.type,e.helpMessage=b("point",a),this.updateLocation(e,a),this.updateElevation(e.elevation),!s)return void(t.constraints=void 0);const l=j(s,o,this._drawSpatialReference,this._constraintElevationInfo,n.hasZ(),r.values.effectiveDirectionMode);t.constraints={context:l,x:e.x.committed,y:e.y.committed,longitude:e.longitude.committed,latitude:e.latitude.committed,elevation:e.elevation.committed}}_updateDrawPolylineTooltipInfo(e){const t=this._createOperationGeometry,i=null!=t?t.full:null;"polyline"===i?.type&&(this._updatePolylineOrPolygonCommon(e),e.totalLength.actual=this.drawOperation.lastVertex?F(i)??s:null,e.sketchOptions=this.sketchOptions,e.viewType=this.view.type,e.helpMessage=b("polyline",i))}_updateDrawPolygonTooltipInfo(e){const t=this._createOperationGeometry,i=null!=t?t.full:null;"polygon"===i?.type&&(this._updatePolylineOrPolygonCommon(e),e.area.actual=this.drawOperation.lastVertex?Z(i)??a:null,e.sketchOptions=this.sketchOptions,e.viewType=this.view.type,e.helpMessage=b("polygon",i))}_updatePolylineOrPolygonCommon(e){const{view:t,drawOperation:i,sketchOptions:o}=this,{coordinateHelper:r,cursorVertex:n,lastVertex:a,secondToLastVertex:c}=i,p=o.values.effectiveDirectionMode,u=a&&n?N(a,n)??s:null;if(e.distance.actual=u,e.distance.readOnly=null==a,e.direction.actual=null,e.direction.readOnly=!0,a&&n&&("absolute"===p||c)){const t=L(c,a,n,p);e.direction.actual=t??l,e.direction.readOnly=!1}this.updateElevation(e.elevation);const h=n??a;if(h){const o=j(h,t,this._drawSpatialReference,this._constraintElevationInfo,r.hasZ(),p);i.constraints={context:o,distance:e.distance.committed,direction:e.direction.committed,elevation:e.elevation.committed}}else i.constraints=void 0}updateDrawMeshTooltipInfo(e){}_updateDrawRectangleTooltipInfo(e){e.sketchOptions=this.sketchOptions,e.xSize=this._xSize??s,e.ySize=this._ySize??s,e.area=this._fullGeometryArea??a}_updateDrawCircleTooltipInfo(e){const{forceUniformSize:t}=this;e.sketchOptions=this.sketchOptions,e.radius=t?this._circleRadius??s:null,e.xSize=t?null:this._xSize??s,e.ySize=t?null:this._ySize??s,e.area=this._fullGeometryArea??a}get _circleRadius(){const e=this._createOperationGeometry;return null!=e?.circle?.center&&null!=e.circle.edge?N(e.circle.center,e.circle.edge):null}get _xSize(){const e=this._createOperationGeometry?.rectangle?.midpoints;return null!=e?N(e.left,e.right):null}get _ySize(){const e=this._createOperationGeometry?.rectangle?.midpoints;return null!=e?N(e.top,e.bottom):null}get _fullGeometryArea(){const e=this._createOperationGeometry?.full;return"polygon"!==e?.type?null:Z(e)}updateLocation(e,t){J(t.spatialReference)?(e.geographic=!0,e.latitude.actual=c(t.latitude??0,"degrees","geographic"),e.longitude.actual=c(t.longitude??0,"degrees","geographic")):(e.geographic=!1,e.x.actual=p(t.x),e.y.actual=p(t.y))}updateElevation(e){const{drawOperation:t,_drawSpatialReference:i}=this,o=t?.cursorVertex??t?.lastVertex;e.actual=q(o)??this._defaultElevation,e.visible="3d"===this.view.type&&this.hasZ,e.readOnly=!1,e.showAsZ=!J(i)}get _constraintElevationInfo(){return this.drawOperation?.elevationInfo??_}get _constraintZ(){const{geometryType:e}=this;switch(e){case"point":case"mesh":case"polyline":case"polygon":{const t=this.tooltipInfos[e].elevation.committed;if(!t)return;return u(t,"meters")/m(this._drawSpatialReference)}default:return}}_initializeConstraints(){const{directionOptions:e,drawOperation:t,geometryType:i,tooltipInfos:o,sketchOptions:r}=this,n=e=>{const i=t.elevationInfo?.mode,r=o[e].elevation;"relative-to-ground"===i||"relative-to-scene"===i||"on-the-ground"===i?r.lock(this._defaultElevation):r.unlock()},s=t=>{if(e){const i=o[t].direction;i.committed=e.angle,i.unlockOnVertexPlacement=!1,r.values.directionMode=e.mode}};switch(i){case"polygon":case"polyline":n(i),s(i);break;case"point":case"mesh":n(i)}}_lockElevationOnVertexAdd(e){const{activeTooltipInfo:t,drawOperation:i,view:o}=this,r=this._constraintElevationInfo;if("2d"===o.type||!e||"absolute-height"!==r.mode||1!==i?.numCommittedVertices||!t||"draw-polyline"!==t.type&&"draw-polygon"!==t.type||t.elevation.locked)return;const[n,s,a]=e,l=this._getConvertedVertexElevation(n,s,a,r);null!=l&&t.elevation.lock(l)}_unlockConstraintsOnVertexAddOrRemove(){this.activeTooltipInfo?.allFields.forEach((e=>{e.unlockOnVertexPlacement&&e.unlock()}))}_getConvertedVertexElevation(e,t,i,o){const{view:r,drawOperation:n}=this;if("3d"!==r.type||!n)return;const s=this._drawSpatialReference;i??=0;const a=n.elevationInfo,l=w(r,e,t,i,s,a,o);return B(l,s)??this._defaultElevation}};e([y()],W.prototype,"_createOperationGeometry",void 0),e([y()],W.prototype,"_defaultElevation",null),e([y()],W.prototype,"_inputModeAvailable",null),e([y({value:!0})],W.prototype,"centered",null),e([y()],W.prototype,"cursor",null),e([y({nonNullable:!0})],W.prototype,"defaultZ",void 0),e([y({constructOnly:!0})],W.prototype,"directionOptions",void 0),e([y()],W.prototype,"drawOperation",void 0),e([y({value:!0})],W.prototype,"enabled",null),e([y({value:!0})],W.prototype,"forceUniformSize",null),e([y({constructOnly:!0})],W.prototype,"geometryType",void 0),e([y()],W.prototype,"graphic",null),e([y({constructOnly:!0})],W.prototype,"graphicProperties",void 0),e([y()],W.prototype,"graphicSymbol",null),e([y({constructOnly:!0})],W.prototype,"hasZ",void 0),e([y({constructOnly:!0})],W.prototype,"geometryToPlace",void 0),e([y({constructOnly:!0})],W.prototype,"mode",void 0),e([y()],W.prototype,"snappingManager",void 0),e([y()],W.prototype,"snapToScene",void 0),e([y()],W.prototype,"tooltip",void 0),e([y()],W.prototype,"tooltipInfos",void 0),e([y({constructOnly:!0,type:U})],W.prototype,"sketchOptions",void 0),e([y()],W.prototype,"updating",null),e([y({constructOnly:!0,nonNullable:!0})],W.prototype,"view",void 0),e([y()],W.prototype,"activeTooltipInfo",null),e([y()],W.prototype,"_circleRadius",null),e([y()],W.prototype,"_xSize",null),e([y()],W.prototype,"_ySize",null),e([y()],W.prototype,"_fullGeometryArea",null),e([y()],W.prototype,"_constraintElevationInfo",null),e([y()],W.prototype,"_constraintZ",null),W=e([g("esri.views.draw.DrawGraphicTool")],W);const X=Symbol("create-operation-graphic"),Y={outline:Symbol("outline-visual"),regularVertices:Symbol("regular-vertices-visual"),activeVertex:Symbol("active-vertex-visual"),activeEdge:Symbol("active-edge-visual")};function $(e){switch(e){case"point":case"polyline":case"polygon":case"multipoint":return e;case"circle":case"rectangle":return"segment";case"mesh":return"point"}}const ee=48;export{Q as CreateOperationGeometry,W as DrawGraphicTool,$ as geometryTypeToDrawOperationGeometryType};
