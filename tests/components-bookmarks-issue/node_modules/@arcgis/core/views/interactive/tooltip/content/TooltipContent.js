/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{_ as t}from"../../../../chunks/tslib.es6.js";import{prefersReducedMotion as e}from"../../../../core/a11yUtils.js";import{memoize as o}from"../../../../core/memoize.js";import{throwIfNotAbortError as i,throwIfAborted as s,after as n}from"../../../../core/promiseUtils.js";import{waitTick as r}from"../../../../core/scheduling.js";import{unitName as a}from"../../../../core/unitFormatUtils.js";import{defaultLengthUnit as l,defaultVerticalLengthUnit as c,defaultAreaUnit as p}from"../../../../core/unitUtils.js";import{property as d}from"../../../../core/accessorSupport/decorators/property.js";import"../../../../core/has.js";import"../../../../core/Logger.js";import"../../../../core/RandomLCG.js";import{subclass as u}from"../../../../core/accessorSupport/decorators/subclass.js";import{getDefaultUnitForView as m}from"../../../../support/getDefaultUnitForView.js";import{tooltipKeys as h}from"../../keybindings.js";import{helpMessage as f,table as g,contentHeader as _,contentHeaderSpacer as y,contentHeaderActions as b,contentInputMode as v,content as w,drawContentHeaderActions as j}from"../css.js";import{getFormatters as U}from"../fields/parsingAndFormattingUtils.js";import k from"../../../../widgets/Widget.js";import{loadCalciteComponents as A}from"../../../../widgets/support/componentsUtils.js";import{classes as F}from"../../../../widgets/support/widgetUtils.js";import{messageBundle as x}from"../../../../widgets/support/decorators/messageBundle.js";import{tsx as C,tsxFragment as I}from"../../../../widgets/support/jsxFactory.js";let T=class extends k{constructor(){super(...arguments),this._focusAbortController=new AbortController,this._transition=null,this._mode="feedback",this._getFormatters=o(U),this._onDiscard=()=>{this.exitInputMode()},this._onCommit=(t,e)=>{if("commit-and-exit"===e)return void this.exitInputMode();const o=this._getFocusableElements(),i=o.length,s=o.indexOf(t);if(-1===s)return void this.exitInputMode();const n=((s+("commit-and-next"===e?1:-1))%i+i)%i;M(o.at(n))},this._handleTab=t=>{if(t.code!==h.next)return;const e=this._getFocusableElements(),o=e.at(0),i=e.at(-1);o&&i&&(t.shiftKey?document.activeElement===o&&(t.preventDefault(),M(i)):document.activeElement===i&&(t.preventDefault(),M(o)))}}get mode(){return this._mode}get _displayUnits(){const t=m(this.tooltip.view);return{length:t,verticalLength:t,area:t,angle:"degrees"}}get _inputUnitInfos(){const t=this._messagesUnits,e=e=>({unit:e,abbreviation:a(t,e,"abbr")}),o=m(this.tooltip.view),i=e(l(o)),s=e(c(o)),n=e(p(o)),r=e("degrees");return{length:i,lengthRelative:i,verticalLength:s,verticalLengthRelative:s,area:n,direction:r,orientation:r,rotation:r,longitudeLatitude:r}}get _formatters(){return this._getFormatters(this._messagesUnits,this._displayUnits)}get fieldContext(){return{formatters:this._formatters,inputUnitInfos:this._inputUnitInfos,messages:this._messagesTooltip,sketchOptions:this.info.sketchOptions,onCommit:this._onCommit,onDiscard:this._onDiscard}}render(){const t=D(this._renderContent()),{visibleElements:e}=this.info.sketchOptions.tooltips,o=e.helpMessage?this._getHelpMessage():null,i=t.length>0,s=i||!!o,n="input"===this.mode,r=D(this._renderActions());return C("div",{class:F(w,n&&v),onkeydown:this._handleTab},n&&s&&e.header?C("div",{class:_,key:"header"},C("calcite-button",{appearance:"transparent",iconFlipRtl:"both",iconStart:"chevron-left",key:"discard-button",kind:"neutral",onclick:this._onDiscard,scale:"s",tabIndex:-1}),r.length>0?C(I,null,C("div",{class:y,key:"spacer"}),C("div",{class:b,key:"actions"},r)):null):null,i?C("div",{class:g,key:"content"},...t):null,o?C("div",{class:f,key:"help-message"},o):null)}_renderActions(){return null}loadDependencies(){return A({button:()=>import("@esri/calcite-components/dist/components/calcite-button.js"),icon:()=>import("@esri/calcite-components/dist/components/calcite-icon.js"),input:()=>import("@esri/calcite-components/dist/components/calcite-input.js")})}async enterInputMode(t){try{await this._transitionTo("input"),await this._focusField(t)}catch(e){i(e)}}async exitInputMode(){try{await this._transitionTo("feedback"),document.querySelector(".esri-view-surface").focus()}catch(t){i(t)}}_getHelpMessage(t){const{info:e}=this,{helpMessage:o,viewType:i}=e,s=t??o,n="3d"===i?"helpMessages3d":"helpMessages2d";return s?this._messagesTooltip?.sketch?.[n]?.[s]:void 0}async _focusField(t){this._focusAbortController?.abort(),this._focusAbortController=new AbortController;const{signal:e}=this._focusAbortController;await this._waitForInputs(),s(e);const o=this._getFocusableInputs();M(t?o.find((e=>e.getAttribute("data-field-name")===t)):o.at(0))}async _transitionTo(t){if(this._mode===t)return;const o=()=>{this._mode=t,this.tooltip.positionMode="input"===t?"fixed":"follow-cursor"};if(!this.domNode?.firstChild||!document.startViewTransition||e())return void o();this.autoRenderingEnabled=!1,this._transition?.skipTransition();const i=this._transition=document.startViewTransition((()=>{if(!this.destroyed)return this.autoRenderingEnabled=!0,o(),this.renderNow(),r()}));try{await this._transition.finished}finally{i===this._transition&&(this._transition=null)}}async _waitForInputs(){const t=Date.now(),e=()=>Array.from(this.domNode?.querySelectorAll("calcite-input")??[]);for(;0===e().length;)if(await n(E),Date.now()-t>S)return}_getFocusableInputs(){return Array.from(this.domNode?.querySelectorAll("calcite-input:not([read-only]):not([disabled])")??[])}_getFocusableElements(){const t=this.domNode?.querySelector(`.${j}`);return[...Array.from(t?.querySelectorAll("calcite-action:not([disabled])")??[]),...this._getFocusableInputs()]}};function M(t){t?.setFocus()}function D(t){return(Array.isArray(t)?t:[t]).flat(10).filter((t=>!!t))}t([x("esri/core/t9n/Units"),d()],T.prototype,"_messagesUnits",void 0),t([x("esri/views/interactive/tooltip/t9n/Tooltip"),d()],T.prototype,"_messagesTooltip",void 0),t([d()],T.prototype,"info",void 0),t([d()],T.prototype,"tooltip",void 0),t([d()],T.prototype,"_mode",void 0),t([d()],T.prototype,"mode",null),t([d()],T.prototype,"_displayUnits",null),t([d()],T.prototype,"_inputUnitInfos",null),t([d()],T.prototype,"_formatters",null),t([d()],T.prototype,"fieldContext",null),T=t([u("esri.views.interactive.tooltip.content.TooltipContent")],T);const E=50,S=1e3;export{T as TooltipContent};
