/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{isSome as t,equals as e}from"../../../core/arrayUtils.js";import{asinClamped as s}from"../../../core/mathUtils.js";import{dot as r,subtract as n,exactEquals as i,set as o,equals as c,squaredDistance as u}from"../../../core/libs/gl-matrix-2/math/vec2.js";import{create as a}from"../../../core/libs/gl-matrix-2/factories/vec2f64.js";import{r as h,j as l,a as f,z as d,p,s as m,c as g,f as _,G as L,k,b as M,n as x}from"../../../chunks/vec32.js";import{clone as y,create as P,fromValues as z,UNIT_Z as v}from"../../../core/libs/gl-matrix-2/factories/vec3f64.js";import{s as T,g as q}from"../../../chunks/vec42.js";import{create as w}from"../../../core/libs/gl-matrix-2/factories/vec4f64.js";import{toRadians as j}from"../../../geometry/support/geodesicConstants.js";import{directGeodeticSolver as A,inverseGeodeticSolver as D,InverseGeodeticSolverResult as b}from"../../../geometry/support/geodesicUtils.js";import{create as E,intersectLine as R,signedDistance as N,projectPoint as U,fromPositionAndNormal as Z,fromPoints as I,distance as G,getNormal as S}from"../../../geometry/support/plane.js";import{k as C,l as O,p as F,g as H,m as V}from"../../../chunks/sphere.js";import{tangentFrame as Y}from"../../3d/support/mathUtils.js";import{fromVec3 as B,clone as J,fromValues as K,asVec2 as Q,create as W}from"./normalizedPoint.js";import{vectorsHaveCloseZ as X,isClose as $,intersectVerticalPlaneAndVerticalCylinder as tt,isPointInsidePlane as et,projectPointToLineLike as st,projectPointToVerticalCylinder as rt,projectPointToVerticalPlane as nt,VerticalPlaneType as it,intersectLineLikes as ot,intersectVerticalPlaneAndLineLike as ct,intersectLineLikeAndVerticalCylinder as ut,intersectLineLikeAndCircle as at,intersectVerticalPlanes as ht,intersectVerticalCylinders as lt,pointsInsidePlane as ft,intersectVerticalPlaneAndPoint as dt}from"../../support/geometry3dUtils.js";import{LineType as pt}from"../../support/geometry2dUtils.js";class mt{intersect(t){return Ht(this,t)}closestPoints(t){return[this.closestTo(t)]}}class gt extends mt{constructor(t){super(),this.point=t}equals(t){return this===t||Le(t)&&l(this.point,t.point)}closestTo(){return J(this.point)}}class _t extends mt{constructor(t,e,s){super(),this.start=t,this.end=e,this.lineLike={start:t,end:e,type:s}}equals(t){return this===t||ke(t)&&this.lineLike.type===t.lineLike.type&&l(this.start,t.start)&&l(this.end,t.end)}closestTo(t){const e=st(t,this.lineLike);return B(e)}}class Lt extends _t{constructor(t,e){super(t,e,pt.LINE)}}class kt extends _t{constructor(t,e){super(t,e,pt.RAY)}}class Mt extends mt{constructor(t){super(),this.constraints=t}equals(t){return this===t||_e(t)&&e(this.constraints,t.constraints,((t,e)=>t.equals(e)))}closestTo(t){let e,s=1/0;for(const r of this.constraints){const n=r.closestTo(t),i=f(t,n);i<s&&(s=i,e=n)}return e?J(e):t}closestPoints(t){return this.constraints.flatMap((e=>e===this?[]:e.closestPoints(t)))}}class xt extends mt{constructor(t,e){super(),this.center=t,this.radius=e}equals(t){return this===t||ye(t)&&this.center[0]===t.center[0]&&this.center[1]===t.center[1]&&this.radius===t.radius}closestTo(t){const e=rt(t,this.center,this.radius);return B(e)}}class yt extends mt{constructor(t,e){super(),this.center=t,this.radius=e}equals(t){return this===t||Pe(t)&&l(this.center,t.center)&&this.radius===t.radius}closestTo(t){const e=rt(t,this.center,this.radius);return e[2]=this.center[2],B(e)}asCircle(){return new Pt(J(this.center),this.radius,K(0,0,1))}}class Pt extends mt{constructor(t,e,s,r=void 0){super(),this.center=t,this.radius=e,this.normal=s,this.slicePlane=r}equals(t){return this===t||ze(t)&&l(this.center,t.center)&&l(this.normal,t.normal)&&this.radius===t.radius}closestTo(t){const{center:e,radius:s}=this;U(this.getPlane(vt),t,zt);const r=d(zt,zt,e),n=p(r);if($(n,0))return J(t);const i=s/Math.sqrt(n),o=h(P(),e,r,i),{slicePlane:c}=this;if(c&&!et(c,o)){const e=Jt(c,this);return e?.closestTo(t)??J(t)}return B(o)}getPlane(t=E()){return Z(this.center,this.normal,t)}}const zt=P(),vt=E();class Tt extends mt{constructor(t){super(),this.z=t}equals(t){return this===t||Me(t)&&this.z===t.z}closestTo(t){return B(z(t[0],t[1],this.z))}getPlane(t=E()){return m(qt,0,0,this.z),Z(qt,v,t)}}const qt=P();class wt extends mt{constructor(t,e,s){super(),this.start=t,this.end=e,this.planeLike={start:Q(t),end:Q(e),type:s}}equals(t){return this===t||xe(t)&&this.planeLike.type===t.planeLike.type&&l(this.start,t.start)&&l(this.end,t.end)}closestTo(t){return B(nt(t,this.planeLike))}closestEndTo(t){const{start:e,end:s}=this.planeLike;return Math.sign(r(n(jt,s,e),n(At,Q(t),e)))>0?this.end:this.start}getPlane(t=E()){const e=g(Dt,this.end);return e[2]+=1,I(this.start,this.end,e,t)}getSlicePlane(t=E()){const{start:e,end:s,type:r}=this.planeLike;if(r===it.PLANE)return;const n=m(Dt,e[0],e[1],0),i=m(bt,s[0],s[1],0),o=_(bt,i,n);return Z(n,o,t),t}}const jt=a(),At=a(),Dt=P(),bt=P();class Et extends wt{constructor(t,e){super(t,e,it.HALF_PLANE)}}class Rt extends wt{constructor(t,e){super(t,e,it.PLANE)}}class Nt extends mt{constructor(t,e){super(),this.sphere=C(t,e)}equals(t){return this===t||ve(t)&&O(this.sphere,t.sphere)}closestTo(t){const e=F(this.sphere,t,P());return B(e)}get center(){return H(this.sphere)}get radius(){return this.sphere[3]}}class Ut extends mt{constructor(t,e,s){super(),this.start=t,this.end=e,this.getZ=s,this.planeLike={start:Q(t),end:Q(e),type:it.PLANE}}equals(t){return this===t||Te(t)&&l(this.start,t.start)&&l(this.end,t.end)&&this.getZ===t.getZ}closestTo(t){return Ft(this,t)}addIfOnTheGround(t,e){for(const s of e){const e=this.getZ(s[0],s[1])??0;$(s[2],e)&&(s[2]=e,t.push(s))}}}class Zt extends mt{constructor(t,e,s){super(),this._x=t,this._y=e,this._z=s}equals(t){return this===t||we(t)&&this._x===t._x&&this._y===t._y&&this._z===t._z}closestTo([t,e,s]){return W(this._x??t,this._y??e,this._z??s)}}class It extends mt{constructor(t,e,s,r,n){super(),this._origin=t,this._spatialReference=e,this._distanceMeters=s,this._elevationMeters=r,this._directionDegrees=n}equals(t){return this===t||qe(t)&&i(this._origin,t._origin)&&this._spatialReference===t._spatialReference&&this._distanceMeters===t._distanceMeters&&this._elevationMeters===t._elevationMeters&&this._directionDegrees===t._directionDegrees}closestTo([t,e,s]){return o(Gt,t,e),c(Gt,this._origin)||this._applyDirectionAndDistance(Gt),W(Gt[0],Gt[1],this._elevationMeters??s)}_applyDirectionAndDistance(t){if(null!=this._directionDegrees&&null!=this._distanceMeters)A(t,this._origin,this._directionDegrees,this._distanceMeters,this._spatialReference);else if(null!=this._directionDegrees)Ct(t,this._origin,this._directionDegrees,t,this._spatialReference);else if(null!=this._distanceMeters){const{azimuth:e}=D(St,this._origin,t,this._spatialReference);A(t,this._origin,e??0,this._distanceMeters,this._spatialReference)}}}const Gt=[0,0],St=new b;function Ct(t,e,s,r,n){let{azimuth:i,distance:o}=D(Ot,e,r,n);i??=0;let c=o*Math.cos((i-s)*j);c=Math.max(0,c),A(t,e,s,c,n)}const Ot=new b;function Ft(t,e){const s=nt(e,t.planeLike);return s[2]=t.getZ(s[0],s[1])??je,B(s)}function Ht(t,e){if(_e(t)){const s=[];for(const r of t.constraints){const t=r.intersect(e);t&&s.push(t)}return ge(s)}if(_e(e))return Ht(e,t);if(Te(t))return fe(t,e);if(Te(e))return fe(e,t);if(Le(t)){const{point:s}=t;if(Le(e))return l(s,e.point)?t:void 0;const r=e.closestTo(s);return L(r,s)?t:void 0}if(ke(t)){if(Le(e))return Ht(e,t);if(ke(e))return pe(ot(t.lineLike,e.lineLike));if(Me(e))return Vt(t,e);if(xe(e))return pe(ct(e.planeLike,t.lineLike));if(ye(e))return pe(ut(t.lineLike,e.center,e.radius));if(ze(e))return pe(at(t.lineLike,e));if(Pe(e))return Yt(t,e);if(ve(e))return Bt(t,e)}else if(Me(t)){if(Le(e)||ke(e))return Ht(e,t);if(Me(e))return Kt(t,e);if(xe(e))return Qt(t,e);if(ye(e))return Wt(t,e);if(ze(e))return $t(t,e);if(Pe(e))return Xt(t,e);if(ve(e))return te(t,e)}else if(xe(t)){if(Le(e)||ke(e)||Me(e))return Ht(e,t);if(xe(e))return de(ht(t.planeLike,e.planeLike));if(ye(e))return de(tt(t.planeLike,e.center,e.radius));if(ze(e))return se(t,e);if(Pe(e))return ee(t,e);if(ve(e))return re(t,e)}else if(ye(t)){if(Le(e)||ke(e)||Me(e)||xe(e))return Ht(e,t);if(ye(e))return de(lt(Q(t.center),t.radius,Q(e.center),e.radius));if(ze(e))return ne();if(Pe(e))return ie(t,e);if(ve(e))return oe()}else if(ze(t)){if(Le(e)||ke(e)||Me(e)||xe(e)||ye(e))return Ht(e,t);if(ze(e))return ce();if(Pe(e))return ce(e.asCircle());if(ve(e))return ue()}else if(Pe(t)){if(Le(e)||ke(e)||Me(e)||xe(e)||ye(e)||ze(e))return Ht(e,t);if(Pe(e))return ae(e,t);if(ve(e))return he()}else if(ve(t)){if(Le(e)||ke(e)||Me(e)||xe(e)||ye(e)||Pe(e))return Ht(e,t);if(ve(e))return le()}}const Vt=(()=>{const t=E();return(e,s)=>{const{start:r,end:n}=e;if(X(r,n)&&$(r[2],s.z))return e;const i=P();return R(s.getPlane(t),r,n,i)?new gt(B(i)):void 0}})();function Yt({lineLike:t},{center:e,radius:s}){const r=e[2];return pe(ut(t,e,s).filter((t=>$(t[2],r))))}function Bt({lineLike:t},{sphere:e}){return pe(V(e,t.start,t.end))}const Jt=(()=>{const t=w(),e=P(),r=P();return(n,i,o)=>{const{normal:c,center:u,radius:a}=i;Y(c,e,r);const l=S(n),f=a*k(l,e),d=a*k(l,r);T(t,u[0],u[1],u[2],1);const p=q(n,t),m=Math.hypot(f,d),g=$(m,0);if($(G(n,u),0)){if(g)return i;if($(a,0))return!o||et(o,u)?new gt(J(u)):void 0;M(e,l,c),x(e,e);const t=new Array,s=y(u);h(s,s,e,a),o&&!et(o,s)||t.push(s);const r=y(u);return h(r,r,e,-a),o&&!et(o,r)||t.push(r),pe(t)}if(g)return;const _=-p/m;if(Math.abs(_)>1||$(_,1))return;const L=Math.atan(f/d),z=s(_)-L,v=Math.PI-z,w=new Array,j=P();h(j,u,e,a*Math.cos(z)),h(j,j,r,a*Math.sin(z)),w.push(j);const A=P();return h(A,u,e,a*Math.cos(v)),h(A,A,r,a*Math.sin(v)),w.push(A),pe(o?ft(o,w):w)}})();function Kt(t,e){return $(t.z,e.z)?t:void 0}function Qt({z:t},{planeLike:e}){const[s,r]=e.start,[n,i]=e.end,o=K(s,r,t),c=K(n,i,t);return e.type===it.PLANE?new Lt(o,c):new kt(o,c)}function Wt(t,e){const[s,r]=e.center;return new yt(K(s,r,t.z),e.radius)}function Xt(t,e){return $(e.center[2],t.z)?e:void 0}const $t=(()=>{const t=E();return(e,s)=>Jt(e.getPlane(t),s,s.slicePlane)})();function te(t,{center:e,radius:s}){const r=Math.abs(e[2]-t.z);if(r>s&&!$(r,s))return;const n=K(e[0],e[1],t.z),i=Math.sqrt(s**2-r**2);return $(i,0)?void 0:new yt(n,i)}const ee=(()=>{const t=E();return(e,{center:s,radius:r})=>{const n=tt(e.planeLike,s,r),i=s[2];e.getSlicePlane(t);const o=new Array;for(const[c,u]of n){const e=[c,u,i];et(t,e)&&o.push(e)}return pe(o)}})(),se=(()=>{const t=E(),e=E();return(s,r)=>Jt(s.getPlane(t),r,s.getSlicePlane(e))})(),re=(()=>{const t=E();return(e,{center:s,radius:r})=>{const n=e.getPlane(t),i=N(n,s),o=Math.abs(i);if(o>r&&!$(o,r))return;const c=y(S(n)),u=h(P(),s,c,i),a=Math.sqrt(r**2-i**2);return $(a,0)?new gt(B(U(n,s,P()))):new Pt(B(u),a,c,e.getSlicePlane())}})();function ne(t,e){}function ie(t,e){const s=u(Q(t.center),Q(e.center));if($(s,0)&&$(t.radius,e.radius))return e;return me(lt(Q(t.center),t.radius,Q(e.center),e.radius),e.center[2])}function oe(t,e){}function ce(t,e){}function ue(t,e){}function ae(t,e){if(!X(t.center,e.center))return;const s=u(Q(t.center),Q(e.center));if($(s,0)&&$(t.radius,e.radius))return t;return me(lt(Q(t.center),t.radius,Q(e.center),e.radius),t.center[2])}function he(t,e){}function le(t,e){}function fe(t,e){const{planeLike:s,getZ:r}=t,n=new Array;if(Le(e))t.addIfOnTheGround(n,dt(s,e.point));else if(ke(e))t.addIfOnTheGround(n,ct(s,e.lineLike));else if(ye(e))for(const[i,o]of tt(s,e.center,e.radius)){const t=r(i,o);null!=t&&n.push(z(i,o,t))}else if(xe(e)||Te(e))for(const[i,o]of ht(s,e.planeLike)){const t=r(i,o)??je;n.push(z(i,o,t))}return pe(n)}function de(t){return ge(t.map((([t,e])=>{const s=K(t,e,0),r=K(t,e,1);return new Lt(s,r)})))}function pe(t){return ge(t.map((t=>t?new gt(B(t)):void 0)))}function me(t,e){return pe(t.map((([t,s])=>[t,s,e])))}function ge(e){if(0!==e.length)return 1===e.length?e[0]??void 0:new Mt(e.filter(t))}function _e(t){return t instanceof Mt}function Le(t){return t instanceof gt}function ke(t){return t instanceof _t}function Me(t){return t instanceof Tt}function xe(t){return t instanceof wt}function ye(t){return t instanceof xt}function Pe(t){return t instanceof yt}function ze(t){return t instanceof Pt}function ve(t){return t instanceof Nt}function Te(t){return t instanceof Ut}function qe(t){return t instanceof It}function we(t){return t instanceof Zt}const je=0;export{Pt as CircleConstraint,mt as Constraint,Zt as CoordinateConstraint,Ut as DrapedLineConstraint,It as GeodesicConstraint,yt as HorizontalCircleConstraint,Tt as HorizontalPlaneConstraint,Lt as LineConstraint,_t as LineLikeConstraint,gt as PointConstraint,kt as RayConstraint,Mt as SetConstraint,Nt as SphereConstraint,xt as VerticalCylinderConstraint,Et as VerticalHalfPlaneConstraint,Rt as VerticalPlaneConstraint,wt as VerticalPlaneLikeConstraint,ge as constraintOrSet,Le as isPoint};
