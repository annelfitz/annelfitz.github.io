/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import"../../../../core/has.js";import e from"../../../../core/Logger.js";import{s as t,l as n}from"../../../../chunks/vec32.js";import{ZEROS as r,fromValues as l}from"../../../../core/libs/gl-matrix-2/factories/vec3f64.js";import{create as a,center as c,height as s}from"../../../../geometry/support/aaBoundingBox.js";import{labelMarginPx as o}from"./constants.js";import{getGraphics3DSymbol as i}from"./graphicSymbolUtils.js";import{LabelPlacement as f}from"./LabelParameters.js";import{textVerticalPaddingPx as m}from"../../webgl-engine/lib/TextRenderer.js";import{HUDMaterial as p}from"../../webgl-engine/materials/HUDMaterial.js";const u=()=>e.getLogger("esri.views.3d.layers.graphics.labelPlacement");class h{constructor(e,t,n,r=null){this.graphics3DGraphic=e,this.labelSymbol=t,this.labelClass=n,this.disablePlacement=r}}function b(e){const t=C(e);if(null==t)return null;const n=g(e,t);if(null==n)return null;const r=n.anchor,l=!!t.hasLabelVerticalOffset,a=t.verticalOffset;return P(new f(a,r,l),n,e)}function g(e,t){if(t.anchor)return t;const n=e.labelClass.labelPlacement,r=V[n],l=r||y(e);return n&&!r&&u().warnOncePerTick(`the requested label placement '${n}' is currently unsupported in SceneView.`),d(l,e)}function O(e){const t=e.graphics3DGraphic.graphics3DSymbol,n=i(t);return null!=n?n.symbol.symbolLayers.at(0):null}function d(e,t){const n=t.graphics3DGraphic.graphic.geometry;if(null==n)return null;if(null!=t.disablePlacement){return t.labelClass.labelPlacement?(u().warnOncePerTick(v(e?.placement,t.disablePlacement.logEntityDescription)),y(t)):e}const r=n.type;switch(r){case"polyline":case"polygon":case"extent":case"multipoint":if(t.labelClass.labelPlacement)return u().warnOncePerTick(v(e?.placement,`'${r}' geometries`)),y(t);break;case"point":case"mesh":return e}return e}function v(e,t){return`the requested label placement '${e}' is currently unsupported for ${t} in SceneView.`}function y(e){const t=e.graphics3DGraphic.graphic.geometry;if(null==t)return null;switch(t.type){case"polyline":case"extent":case"multipoint":return{placement:"center-center",normalizedOffset:r,anchor:"center"};case"polygon":{const t=O(e);return null!=t&&"extrude"===t.type?V["above-center"]:{placement:"center-center",normalizedOffset:r,anchor:"center"}}case"point":case"mesh":return V["above-center"];default:return}}function P(e,t,n){const r=n.graphics3DGraphic.graphic.geometry;if(null==r)return null;switch(r.type){case"point":case"mesh":z(e,t,n);break;case"polygon":w(e,t,n)}const l=o-m;return e.screenOffset[0]+=l*t.normalizedOffset[0],e.screenOffset[1]+=l*t.normalizedOffset[1],e}function w(e,n,r){const l=O(r);if(null!=l)switch(l.type){case"extrude":{const l=r.graphics3DGraphic.layers[0];null!=l?(l.getBoundingBoxObjectSpace(B),c(B,e.translation),e.translation[2]=s(B)/2):t(e.translation,0,0,0),j(e,n,l);break}}}function z(e,n,r){const l=O(r);if(null==l)return;const a=r.graphics3DGraphic.layers[0];switch(null!=a?a.getCenterObjectSpace(e.translation):t(e.translation,0,0,0),l.type){case"icon":case"text":L(e,n,r,a);break;case"object":case"fill":j(e,n,a)}}function L(e,t,n,r){const{graphics3DGraphic:l}=n,a=null!=r?r.getScreenSize():null;if(l.isDraped||null==a)e.hasLabelVerticalOffset||"center"===e.anchor||(V[n.labelClass.labelPlacement]&&u().warnOncePerTick(`the requested placement '${t.placement}' is currently unsupported for draped graphics`),e.anchor="center");else{const r=S(n);e.screenOffset[0]=a[0]/2*(t.normalizedOffset[0]-r[0]);const l=a[1]/2*(t.normalizedOffset[1]-r[1]);e.hasLabelVerticalOffset?(e.centerOffset[1]=l,e.centerOffsetUnits="screen"):e.screenOffset[1]=l}}function S(e,t=G){const{graphics3DGraphic:n}=e,r=n.layers[0],l=r?.stageObject.geometries[0].material??null;if(l&&l instanceof p){const e=l.parameters.anchorPosition;t[0]=2*(e[0]-.5),t[1]=2*(e[1]-.5)}else t[0]=0,t[1]=0;return t}function j(e,t,r){const a=null!=r?r.getBoundingBoxObjectSpace(B):B,c=l(a[3]-a[0],a[4]-a[1],a[5]-a[2]),s=Math.sqrt(c[0]*c[0]+c[1]*c[1]);e.centerOffset[0]=s/2*t.normalizedOffset[0];const o=e.translation[2],i=c[2]/2*t.normalizedOffset[1];e.translation[2]=0,e.elevationOffset=o+i;const f=n(c);e.centerOffset[2]=f/2*t.normalizedOffset[2]}function D(e){return"above-center"===e}function C(e){const t=e.labelClass.labelPlacement,{labelSymbol:n,graphics3DGraphic:r}=e,l=i(r.graphics3DSymbol),a="point-3d"===l?.symbol.type?l.symbol:null,c=V[t]||y(e);return null!=a&&a.supportsCallout()&&a.hasVisibleVerticalOffset()&&!r.isDraped?{placement:null,hasLabelVerticalOffset:!1,verticalOffset:x(a.verticalOffset),anchor:null,normalizedOffset:null}:!n||!n.hasVisibleVerticalOffset()||null!=a&&a.supportsCallout()&&a.verticalOffset&&!r.isDraped?{placement:null,verticalOffset:null,anchor:null,normalizedOffset:null,hasLabelVerticalOffset:!1}:c&&D(c.placement)?{placement:"above-center",verticalOffset:x(n.verticalOffset),anchor:"bottom",normalizedOffset:[0,c.normalizedOffset[1],0],hasLabelVerticalOffset:!0}:(u().errorOncePerTick("Callouts and vertical offset on labels are currently only supported with 'above-center' label placement (not with "+t+" placement)"),null)}function x(e){const{screenLength:t,minWorldLength:n,maxWorldLength:r}=e;return{screenLength:t,minWorldLength:n,maxWorldLength:r}}const V={"above-center":{placement:"above-center",normalizedOffset:[0,1,0],anchor:"bottom"},"above-left":{placement:"above-left",normalizedOffset:[-1,1,0],anchor:"bottom-right"},"above-right":{placement:"above-right",normalizedOffset:[1,1,0],anchor:"bottom-left"},"below-center":{placement:"below-center",normalizedOffset:[0,-1,2],anchor:"top"},"below-left":{placement:"below-left",normalizedOffset:[-1,-1,0],anchor:"top-right"},"below-right":{placement:"below-right",normalizedOffset:[1,-1,0],anchor:"top-left"},"center-center":{placement:"center-center",normalizedOffset:[0,0,1],anchor:"center"},"center-left":{placement:"center-left",normalizedOffset:[-1,0,0],anchor:"right"},"center-right":{placement:"center-right",normalizedOffset:[1,0,0],anchor:"left"}},k={"above-center":["default","esriServerPointLabelPlacementAboveCenter"],"above-left":["esriServerPointLabelPlacementAboveLeft"],"above-right":["esriServerPointLabelPlacementAboveRight"],"below-center":["esriServerPointLabelPlacementBelowCenter"],"below-left":["esriServerPointLabelPlacementBelowLeft"],"below-right":["esriServerPointLabelPlacementBelowRight"],"center-center":["esriServerPointLabelPlacementCenterCenter"],"center-left":["esriServerPointLabelPlacementCenterLeft"],"center-right":["esriServerPointLabelPlacementCenterRight"]};for(const T in k){const e=k[T],t=V[T];e.forEach((e=>{V[e]=t}))}Object.freeze&&(Object.freeze(V),Object.keys(V).forEach((e=>{Object.freeze(V[e]),Object.freeze(V[e]?.normalizedOffset)})));const G=[0,0],B=a();export{h as LabelInfo,b as getLabelPlacement};
