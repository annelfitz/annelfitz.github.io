/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../chunks/tslib.es6.js";import r from"../../../../core/Accessor.js";import{destroyMaybe as t}from"../../../../core/maybe.js";import{throwIfAborted as s,createAbortError as o}from"../../../../core/promiseUtils.js";import{difference as u}from"../../../../core/SetUtils.js";import{property as i}from"../../../../core/accessorSupport/decorators/property.js";import"../../../../core/has.js";import"../../../../core/Logger.js";import"../../../../core/RandomLCG.js";import{subclass as a}from"../../../../core/accessorSupport/decorators/subclass.js";import{fromFeatureSetJSON as l}from"../../../../layers/graphics/dehydratedFeatures.js";import{runQuery as n,executeQuery as y}from"../../../../rest/query/operations/query.js";import{PBFDecoder as c}from"../../support/PBFDecoder.js";let p=class extends r{constructor(e){super(e)}get implicitFields(){const e=this.layer.outFields?.includes("*");if(!e)return new Set;const r=new Set(this.layerView.requiredFields),t=new Set(this.layerView.availableFields);return u(t,r)}get queryFeaturesDehydrated(){const{layer:e}=this,r=e.capabilities,t=r&&r.query,u=t&&t.supportsFormatPBF,i=e.parsedUrl;if(u){null==this._decoder&&(this._decoder=new c(this.controller));const r={sourceSpatialReference:e.spatialReference?.toJSON()??null,applyTransform:!0,maxStringAttributeFields:this.implicitFields,maxStringAttributeLength:f};return(e,t)=>n(i,e,"pbf",this._createRequestOptions(t)).then((e=>(s(t),null!=this._decoder?this._decoder.invoke({buffer:e.data,options:r},t.signal):Promise.reject(o()))))}return(r,t)=>y(i,r,e.spatialReference,this._createRequestOptions(t)).then((e=>l(e.data,{maxStringAttributeFields:this.implicitFields,maxStringAttributeLength:f})))}queryFeatureCount(e,r){return this.layer.queryFeatureCount(e,r)}destroy(){this._decoder=t(this._decoder)}_createRequestOptions(e){return{...e,query:{...this.layer.customParameters,token:this.layer.apiKey,...e?.query}}}};e([i({constructOnly:!0})],p.prototype,"layer",void 0),e([i({constructOnly:!0})],p.prototype,"layerView",void 0),e([i({constructOnly:!0})],p.prototype,"controller",void 0),e([i({readOnly:!0})],p.prototype,"implicitFields",null),e([i({readOnly:!0})],p.prototype,"queryFeaturesDehydrated",null),p=e([a("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileServiceQuery3D")],p);let d=class extends r{constructor(e){super(e)}queryFeaturesDehydrated(e,r){return this.layer.queryFeatures(e,r)}queryFeatureCount(e,r){return this.layer.queryFeatureCount(e,r)}};e([i({constructOnly:!0})],d.prototype,"layer",void 0),e([i({readOnly:!0})],d.prototype,"queryFeaturesDehydrated",null),d=e([a("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileServiceMeshQuery3D")],d);let m=class extends r{constructor(e){super(e)}queryFeaturesDehydrated(e,r){return this.layer.queryFeatures(e,r)}};e([i({constructOnly:!0})],m.prototype,"layer",void 0),m=e([a("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileOGCServiceQuery3D")],m);let h=class extends r{constructor(e){super(e)}queryFeaturesDehydrated(e,r){return this.source.queryFeaturesJSON(e,r).then(l,(t=>{if(t&&"query-features-json:unsupported"===t.name)return this.layer.queryFeatures(e,r);throw t}))}queryFeatureCount(e,r){return this.layer.queryFeatureCount(e,r)}};function F(e,r){const{layer:t}=e;return"feature"===t.type&&"feature-layer"===t.source.type?null!=t.infoFor3D?new d({layer:t}):new p({layer:t,layerView:e,controller:r}):"feature"===t.type&&"memory"===t.source.type||"csv"===t.type||"geojson"===t.type||"oriented-imagery"===t.type||"wfs"===t.type?new h({layer:t,source:t.source}):"ogc-feature"===t.type?new m({layer:t}):null}e([i({constructOnly:!0})],h.prototype,"layer",void 0),e([i({constructOnly:!0})],h.prototype,"source",void 0),h=e([a("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileClientQuery3D")],h);const f=1024;export{F as createFeatureTileQuery3D};
