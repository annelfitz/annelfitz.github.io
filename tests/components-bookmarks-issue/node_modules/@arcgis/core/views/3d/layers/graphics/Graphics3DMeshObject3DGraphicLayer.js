/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{getTranslation as t,multiply as e,invert as a,copy as r,fromTranslation as s}from"../../../../core/libs/gl-matrix-2/math/mat4.js";import{IDENTITY as o,create as i}from"../../../../core/libs/gl-matrix-2/factories/mat4f64.js";import{h as n}from"../../../../chunks/vec32.js";import{create as m}from"../../../../core/libs/gl-matrix-2/factories/vec3f64.js";import{perObjectElevationAligner as f}from"./ElevationAligners.js";import{evaluateElevationInfoAtPoint as l}from"./elevationAlignmentUtils.js";import{setContextFeature as c}from"./featureExpressionInfoUtils.js";import{Graphics3DObject3DGraphicLayer as d}from"./Graphics3DObject3DGraphicLayer.js";class g extends d{constructor(){super(...arguments),this._originalGeometries=[],this._fastTransformUpdatesEnabled=!1}get fastTransformUpdatesEnabled(){return this._fastTransformUpdatesEnabled}enableFastTransformUpdates(e,a){if(this._fastTransformUpdatesEnabled)return;this._fastTransformUpdatesEnabled=!0;const{stageObject:r}=this,s=r.geometries.slice();r.removeAllGeometries();const o=t(h,r.transformation),i=a.getOrigin(o);for(const t of s){const a=e(t.material),s=t.instantiate({material:a});s.localOrigin=i,r.addGeometry(s)}this._originalGeometries=s}disableFastTransformUpdates(t){if(!this._fastTransformUpdatesEnabled)return;this._fastTransformUpdatesEnabled=!1;const{stageObject:e}=this,a=e.geometries.map((e=>t(e.material)));e.removeAllGeometries();for(let r=0;r<this._originalGeometries.length;r++){const t=this._originalGeometries[r],s=a[r];s.setParameters({modelTransformation:null}),s===t.material?e.addGeometry(t):e.addGeometry(t.instantiate({material:s}))}this._originalGeometries.length=0}updateFastLocalOrigin(e,a,r){if(!this._fastTransformUpdatesEnabled)return;const{stageObject:s}=this;if(0===s.geometries.length)return;const i=s.geometries[0].localOrigin,n=t(h,e),m=r.getOrigin(n);if(m===i)return;const f=a?.localMatrix??o;s.shaderTransformation=null,s.transformation=e,s.geometries.forEach((t=>{t.transformation=f,t.localOrigin=m}))}updateTransform(t,r,s){const{stageObject:i}=this,n=r?.localMatrix??o;if(!this._fastTransformUpdatesEnabled)return i.shaderTransformation=null,i.transformation=t,i.geometries.forEach((t=>t.transformation=n)),void this._updateEdgeTransform(s);const m=i.transformation,f=i.geometries[0].transformation,l=t,c=n,d=e(p,m,f),g=e(T,l,c),h=e(b,g,a(b,f));i.shaderTransformation=h,this._setFastMaterialTransformation({matA:d,matB:g}),this._updateEdgeTransform(s)}alignWithElevation(t,a,s,o){if(!this._fastTransformUpdatesEnabled)return void super.alignWithElevation(t,a,s,o);null!=s&&c(this.elevationContext.featureExpressionInfoContext,s);const i=(e,r)=>l(e,t,this.elevationContext,a,r),{stageObject:n}=this;if(!n.geometries[0].material.parameters.modelTransformation)return;const m=n.transformation,d=n.geometries[0].transformation,g=e(p,m,d),h=n.effectiveTransformation,b=r(u,h);this.alignedSampledElevation=f(this,this.elevationContext,t.spatialReference,i,a,b),n.shaderTransformation=b;const E=n.geometries[0].transformation,_=e(T,b,E);this._setFastMaterialTransformation({matA:g,matB:_}),this._updateEdgeTransform(o)}_setFastMaterialTransformation({matA:t,matB:r}){const{stageObject:o}=this;if(0===o.geometries.length)return;const i=o.geometries[0].localOrigin,m=s(j,n(h,i.vec3,-1)),f=e(E,m,t),l=e(_,m,r),c=a(E,f),d=e(_,l,c);for(const e of o.geometries)e.material.setParameters({modelTransformation:d})}_updateEdgeTransform(t){const{stageObject:e,_stageLayer:a}=this;a.stage.renderer.withEdgeView((a=>{a.fastUpdateObject3DEdgesTransform(e)||this.resetEdgeObject(t)}))}}const h=m(),p=i(),T=i(),u=i(),b=i(),E=i(),_=i(),j=i();export{g as Graphics3DMeshObject3DGraphicLayer};
