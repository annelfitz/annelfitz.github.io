/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{create as e}from"../../../../core/libs/gl-matrix-2/factories/mat4f64.js";import{e as t,s as i}from"../../../../chunks/vec32.js";import{create as n}from"../../../../core/libs/gl-matrix-2/factories/vec3f64.js";import{empty as s,expandWithVec3 as a,create as r,isPoint as o,center as l,offset as h}from"../../../../geometry/support/aaBoundingBox.js";import{evaluateElevationInfoAtPoint as c}from"./elevationAlignmentUtils.js";import{setContextFeature as d}from"./featureExpressionInfoUtils.js";import{demResolutionForBoundingBox as g}from"./graphicUtils.js";import{Object3DState as m}from"../../webgl-engine/lib/basicInterfaces.js";import{Object3DStateID as f}from"../../webgl-engine/lib/Object3DStateID.js";class p{constructor(e,t,i,n){this.graphics3DSymbolLayer=e,this.instanceIndex=t,this.elevationAligner=i,this.elevationContext=n,this.type="lod-instance",this._highlights=new Set,this.alignedSampledElevation=0,this.isElevationSource=!1,this.needsElevationUpdates=!1}initialize(){}setVisibility(e){const t=this._lodRenderer.instanceData;e!==t.getVisible(this.instanceIndex)&&t.setVisible(this.instanceIndex,e)}destroy(){null!=this.instanceIndex&&(this._lodRenderer.instanceData.removeInstance(this.instanceIndex),this.graphics3DSymbolLayer.notifyDestroyGraphicLayer(this))}alignWithElevation(e,t,i){if(this.elevationAligner){d(this.elevationContext.featureExpressionInfoContext,i);const n=(i,n)=>c(i,e,this.elevationContext,t,n),s=this.elevationAligner(this,this.elevationContext,e.spatialReference,n,t);null!=s&&(this.alignedSampledElevation=s)}}getCenterObjectSpace(e=n()){return this._lodRenderer.instanceData.getCombinedLocalTransform(this.instanceIndex,I),t(e,this._lodRenderer.baseBoundingSphere.center,I)}getBoundingBoxObjectSpace(e=r()){this._lodRenderer.instanceData.getCombinedLocalTransform(this.instanceIndex,I);const n=this._lodRenderer.baseBoundingBox;s(e);for(let s=0;s<8;++s)i(x,1&s?n[3]:n[0],2&s?n[4]:n[1],4&s?n[5]:n[2]),t(x,x,I),a(e,x);return e}computeAttachmentOrigin(e){this._lodRenderer.instanceData.getGlobalTransform(this.instanceIndex,I),e.render.origin[0]+=I[12],e.render.origin[1]+=I[13],e.render.origin[2]+=I[14],e.render.num++}async getProjectedBoundingBox(e,i,n,a,r){const c=this.getBoundingBoxObjectSpace(r),d=b,m=o(c)?1:d.length;this._lodRenderer.instanceData.getGlobalTransform(this.instanceIndex,I);for(let s=0;s<m;s++){const e=d[s];x[0]=c[e[0]],x[1]=c[e[1]],x[2]=c[e[2]],t(x,x,I),u[3*s]=x[0],u[3*s+1]=x[1],u[3*s+2]=x[2]}if(!e(u,0,m))return null;s(c);let f=null;this.calculateRelativeScreenBounds&&(f=this.calculateRelativeScreenBounds());for(let t=0;t<3*m;t+=3){for(let e=0;e<3;e++)c[e]=Math.min(c[e],u[t+e]),c[e+3]=Math.max(c[e+3],u[t+e]);f&&n.push({location:u.slice(t,t+3),screenSpaceBoundingRect:f})}if(i&&(l(c,v),"absolute-height"!==this.elevationContext.mode)){let e;const t=g(c,i.service.spatialReference,i);try{e=await i.service.queryElevation(v[0],v[1],a,t,"ground")}catch(p){}null!=e&&h(c,0,0,-this.alignedSampledElevation+e)}return c}addObjectState(e,t){if(e===m.Highlight){const i=new f(e);this._addHighlightId(i),t.addExternal((e=>{this._removeHighlightId(e)}),i)}}removeObjectState(e){this._highlights.forEach((t=>e.remove(t)))}_addHighlightId(e){this._highlights.add(e),this._lodRenderer.instanceData.setHighlight(this.instanceIndex,!0)}_removeHighlightId(e){this._highlights.delete(e),this._lodRenderer.instanceData.setHighlight(this.instanceIndex,this._highlights.size>0)}get _lodRenderer(){return this.graphics3DSymbolLayer.lodRenderer}}const u=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],x=n(),v=n(),b=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]],I=e();export{p as Graphics3DLodInstanceGraphicLayer};
