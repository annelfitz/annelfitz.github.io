/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{createScreenPointArray as e,createRenderScreenPointArray3 as t}from"../../../../core/screenUtils.js";import{c as r,h as i,r as s}from"../../../../chunks/vec32.js";import{create as o}from"../../../../core/libs/gl-matrix-2/factories/vec3f64.js";import{create as n,fromValues as c,distance as a,empty as l,expandPointInPlace as m,expand as h}from"../../../../geometry/support/aaBoundingRect.js";import{PlaneIndex as u}from"../../../../geometry/support/frustum.js";import{signedDistance as p}from"../../../../geometry/support/plane.js";import{areaPoints2d as _}from"../../../../geometry/support/triangle.js";import{ViewingMode as d}from"../../../ViewingMode.js";import{Visibility as f}from"./FeatureTileDescriptor3D.js";import{FeatureTileVisibility3D as S,globalTileLevelThreshold as g,isConvexHullOutsideOfFrustum as b}from"./FeatureTileVisibility3D.js";import v from"../../webgl/RenderCamera.js";class R{constructor(e){this._camera=new v,this._focusOnMap=[0,0],this._screenRect=n(),this._tileSize=e.tileSize,this._renderCoordsHelper=e.renderCoordsHelper,this._tilingScheme=e.tilingScheme,this._visibility=new S(e.renderCoordsHelper)}begin(e,t,r){this._camera.copyFrom(e),this._surfaceElevation=r,this._focusOnMap[0]=t.x,this._focusOnMap[1]=t.y,c(0,0,e.fullWidth,e.fullHeight,this._screenRect),this._visibility.begin(this._camera,r)}end(){this._visibility.end()}updateTile(e){e.measures.visibility=this._visibility.calculate(e),e.measures.distance=a(e.extent,this._focusOnMap),e.measures.visibility!==f.INVISIBLE&&this._updateScreenMeasure(e)}_updateScreenMeasure(e){const t=T,r=1<<t,i=e.measures.screenRect;l(i);let s=0;const o=e.lij,n=o[0],c=n+t,a=o[1]<<t,h=o[2]<<t,u=this._tileSizeWithBias(e),p=u*u,_=this._camera,{frustum:f,viewport:S}=_;if(this._renderCoordsHelper.viewingMode===d.Local||n>g){const t=C;this._tilingScheme.getExtent(o[0],o[1],o[2],t);const r=y,i=H,s=l();for(let e=0;e<4;++e)this._toRenderCoords(t,w[e][0],w[e][1],i[e]),_.projectToScreen(i[e],r[e]),m(s,r[e]);const n=b(f,i,4),c=s[0]>S[2]||s[1]>S[3]||s[2]<S[0]||s[3]<S[1];if(n||c)return void(e.measures.shouldSplit=!1)}for(let l=0;l<r;l++)for(let t=0;t<r;t++)if(s+=this._computeScreenArea(c,a+l,h+t,i),s>p)return void(e.measures.shouldSplit=!0);e.measures.shouldSplit=!1}_tileSizeWithBias(e){return e.measures.visibility===f.VISIBLE_WHEN_EXTENDED?this._tileSize*j:this._tileSize}_computeScreenArea(e,t,r,i){this._tilingScheme.ensureMaxLod(e);const s=C;this._tilingScheme.getExtent(e,t,r,s);const o=A;this._toRenderCoords(s,0,3,o[0]),this._toRenderCoords(s,2,3,o[1]),this._toRenderCoords(s,2,1,o[2]),this._toRenderCoords(s,0,1,o[3]);return this._computeTriangleScreenArea([o[0],o[1],o[2]],i)+this._computeTriangleScreenArea([o[2],o[1],o[3]],i)}_computeTriangleScreenArea(e,t){const i=this._camera.frustum[u.NEAR];let s=0,o=-1,n=-1;for(let r=0;r<3;++r){p(i,e[r])>0?(s++,-1===o&&(o=r)):-1===n&&(n=r)}if(0===s)return this._computeTriangleScreenAreaInside(e,t);if(1===s){const s=I,n=(o+1)%3,c=(o+2)%3,a=o;r(s[0],e[n]),r(s[1],e[c]),x(s[2],e[c],e[a],i);const l=this._computeTriangleScreenAreaInside(s,t);x(s[1],e[n],e[a],i);return l+this._computeTriangleScreenAreaInside(s,t)}if(2===s){const s=I,o=n;r(s[0],e[o]);const c=(n+1)%3,a=(n+2)%3;return x(s[1],e[o],e[c],i),x(s[2],e[o],e[a],i),this._computeTriangleScreenAreaInside(s,t)}return 0}_computeTriangleScreenAreaInside(e,t){for(let r=0;r<3;r++)this._camera.projectToRenderScreen(e[r],E),this._camera.renderToScreen(E,y[r]),h(t,y[r],t);return _(y[0],y[1],y[2])}_toRenderCoords(e,t,r,i){return M[0]=e[t],M[1]=e[r],M[2]=this._surfaceElevation,this._renderCoordsHelper.toRenderCoords(M,this._tilingScheme.spatialReference,i),i}}const T=2,j=5,y=[e(),e(),e(),e()],C=n(),M=o(),A=[o(),o(),o(),o()],E=t(),I=[o(),o(),o()];function x(e,t,r,o){const n=p(o,t),c=p(o,r),a=Math.abs(c-n);i(e,t,Math.abs(c)/a),s(e,e,r,Math.abs(n)/a)}const H=[o(),o(),o(),o()],w=[[0,3],[2,3],[2,1],[0,1]];export{R as FeatureTileMeasurements3D};
