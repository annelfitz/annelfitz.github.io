/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import t from"../../../../core/PooledArray.js";import{create as e,copy as r,area as s,expand as n,contains as o,containsPoint as i}from"../../../../geometry/support/aaBoundingRect.js";import{noBudget as h}from"../../../support/Scheduler.js";const a=.05;class l{constructor(){this._extents=new t({allocator:t=>t||e()}),this._tmpExtent=e(),this._dirty=!1}get empty(){return 0===this._extents.length}get size(){return this._extents.length}clear(){this._extents.clear()}add(t){this._contains(t)||(this._removeContained(t),r(this._extents.pushNew(),t),this._dirty=!0)}pop(){return this._dirty&&this._mergeTight(),this._extents.pop()}merge(t){return this._mergeTight(t),t.hasProgressed}_mergeTight(t=h){const e=this._extents,o=new Set;let i=0;for(;i!==e.length;){e.sort(((t,e)=>t[0]-e[0])),i=e.length,o.clear();for(let i=0;i<e.length;++i){if(t.done)return;const h=e.at(i);if(h){for(let t=i+1;t<e.length;++t){const r=e.at(t);if(null==r||r[0]>=h[2])break;o.add(r)}o.forEach((i=>{if(h===i)return;if(i[2]<=h[0])return void o.delete(i);const l=s(h),_=s(i),c=this._tmpExtent;n(h,i,c);const d=l+_;(s(c)-d)/d<a&&(r(h,c),o.delete(i),e.remove(i),t.madeProgress())})),o.add(h)}}}this._dirty=!1}_contains(t){return this._extents.some((e=>o(e,t)))}_removeContained(t){this._extents.filterInPlace((e=>!o(t,e)))}get test(){const t=this;return{containsPoint:e=>t._extents.some((t=>i(t,e)))}}}export{l as ExtentSet};
