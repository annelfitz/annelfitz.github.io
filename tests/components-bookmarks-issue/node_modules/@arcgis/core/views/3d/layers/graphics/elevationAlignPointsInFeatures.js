/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import"../../../../geometry.js";import{throwIfAborted as e}from"../../../../core/promiseUtils.js";import{create as o}from"../../../../core/libs/gl-matrix-2/factories/vec3f64.js";import{projectPointToVectorAsync as t}from"../../../../geometry/projection/projectPointToVector.js";import{makeDehydratedPoint as r}from"../../../../layers/graphics/dehydratedPoint.js";import{getGeometryEffectiveElevationInfo as i}from"../../../../support/elevationInfoUtils.js";import{evaluateElevationInfoAtPoint as n,SampleElevationInfo as s}from"./elevationAlignmentUtils.js";import{ElevationContext as a}from"./ElevationContext.js";import{extractExpressionInfo as p,createContext as f}from"./featureExpressionInfoUtils.js";import c from"../../../../geometry/SpatialReference.js";async function m(m,l,d,j,u){const{elevationProvider:v,renderCoordsHelper:g}=m,{elevationInfo:y}=l,{pointsInFeatures:I,spatialReference:x}=j,h=c.fromJSON(x),w=p(y,!0),R=await f(w,h,u);e(u);const S=[],b=new Set,z=new Set,E=new a,P=r(0,0,0,c.WGS84),U=new s,C=o();P.spatialReference=h;const F=m.elevationProvider.spatialReference??m.spatialReference;for(const{objectId:e,points:o}of I){const r=d(e);if(null==r){for(const e of o)S.push(e.z??0);b.add(e);continue}r.isDraped&&z.add(e);const s=r.graphic.geometry;E.setFromElevationInfo(i(s,y)),E.updateFeatureExpressionInfoContext(R,r.graphic,l);for(const{x:e,y:i,z:a}of o)P.x=e,P.y=i,P.z=a??0,await t(P,C,F,0,{signal:u}),n(C,v,E,g,U),S.push(U.z)}return{elevations:S,drapedObjectIds:z,failedObjectIds:b}}export{m as elevationAlignPointsInFeatures};
