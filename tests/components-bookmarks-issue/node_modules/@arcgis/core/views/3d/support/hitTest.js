/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import"../../../geometry.js";import e from"../../../Graphic.js";import{isIterable as n}from"../../../core/iteratorUtils.js";import{createScreenPointArray as r,screenPointObjectToArray as i}from"../../../core/screenUtils.js";import{create as t}from"../../../core/libs/gl-matrix-2/factories/vec3f64.js";import{projectVectorToVector as s}from"../../../geometry/projection/projectVectorToVector.js";import{fallbackObjectIDAttribute as o}from"../../../layers/LayerConstants.js";import{isIntegratedMeshLayer as l}from"../../../layers/support/layerUtils.js";import{debugFlags as c}from"./debugFlags.js";import{getElevationAtPoint as a}from"./ElevationProvider.js";import{newIntersector as u}from"../webgl-engine/lib/Intersector.js";import{StoreResults as d,IntersectorType as p}from"../webgl-engine/lib/IntersectorInterfaces.js";import{isValidIntersectorResult as m}from"../webgl-engine/lib/intersectorUtils.js";import{toOwner as f,toHit as g}from"../webgl-engine/lib/intersectorUtilsConversions.js";import{terrainId as y}from"../webgl-engine/lib/verticalOffsetUtils.js";import h from"../../../geometry/SpatialReference.js";import E from"../../../geometry/Point.js";async function U(e,n,i,t){const s=i?R(e,i):t,o=r(n.x,n.y);s.requiresGroundFeedback=!0,s.enableDraped=!0;const a=u(e.state.viewingMode);a.options.selectionMode=!0,a.options.store=d.ALL,e.sceneIntersectionHelper.intersectIntersectorScreen(o,a,s);const p=b(e,a.results.all,s.graphics),g=a.results.ground,y=f(g,e),h=null!=y&&"type"in y&&l(y.type)?y:null,E={screenPoint:n,results:p,ground:{mapPoint:j(e,g),distance:m(g)?g.distanceInRenderSpace:0,layer:h}};return c.SCENEVIEW_HITTEST_RETURN_INTERSECTOR&&(E.intersector=a),E}function I(e,n,r,t){const s=r?R(e,r):t,o=!(!s.graphics?.include&&!s.graphics?.exclude),l=!(!s.mediaElements?.include&&!s.mediaElements?.exclude),c=i(n);s.enableDraped=s.include&&!s.include.has(y)||s.exclude&&s.exclude.has(y);const a=e.sceneIntersectionHelper,p=u(e.state.viewingMode);if(p.options.selectionMode=!0,p.options.store=o||l?d.ALL:d.MIN,p.options.hud=!r?.excludeHud,a.intersectIntersectorScreen(c,p,s),o||l){for(const n of p.results.all){const r=g(n,e);if(null==r)return j(e,n);if(o&&("graphic"!==r.type||S(s.graphics,r.graphic)))return j(e,n);if(l&&("media"!==r.type||x(s.mediaElements,r.element)))return j(e,n)}return null}return j(e,p.results.min)}function b(e,n,r){const i=new Array;let t=null;for(let s=0;s<n.length;s++){const o=n[s],c=f(o,e);if(null!=c&&(c===e.map.ground||"type"in c&&l(c.type)))break;const a=g(o,e);if(null==a)continue;if("graphic"===a.type){if(null==t&&s!==n.length-1&&(t=new Set),null!=t){const e=w(a.graphic);if(t.has(e))continue;t.add(e)}if(!S(r,a.graphic))continue}const u=j(e,o),d=o.distanceInRenderSpace;if("media"===a.type){const e=a.element.toSource(u);i.push({...a,mapPoint:u,distance:d,sourcePoint:e})}else i.push({...a,mapPoint:u,distance:d})}return i}function j(e,n,r){return n.getIntersectionPoint(T)?(r=L(e,T,r),n.intersector===p.TERRAIN&&e.basemapTerrain&&(r.z=a(e.basemapTerrain,r)??0),r):null}function w(e){const n=e.sourceLayer,r=e.layer,i=n&&"objectIdField"in n?n:r&&"objectIdField"in r?r:n;if(i){const n=i.objectIdField??o,r=e.attributes?.[n];if(r)return`o-${i.id}-${r}`}return`u-${e.uid}`}function S(e,n){return x(e,w(n))}function x(e,n){return null==e||(null==e.include||e.include.has(n))&&(null==e.exclude||!e.exclude.has(n))}function L(e,n,r){let i=e.spatialReference||h.WGS84;return s(n,e.renderSpatialReference,T,i)?n=T:(i=h.WGS84,s(n,e.renderSpatialReference,T,i)&&(n=T)),r?(r.x=n[0],r.y=n[1],r.z=n[2],r.spatialReference=i):r=new E(n,i),r}function R(e,n){const r=C(e,n.include,P.INCLUDE),i=C(e,n.exclude,P.EXCLUDE);return{include:r.layerUids,exclude:i.layerUids,graphics:{include:r.graphicUids,exclude:i.graphicUids},mediaElements:{include:r.mediaElements,exclude:i.mediaElements}}}function C(r,i,t,s={layerUids:void 0,graphicUids:void 0,mediaElements:void 0}){if(!i)return s;if(i instanceof e)D(s,w(i)),t===P.INCLUDE&&(null!=r.graphicsView&&i.layer===r?v(s,r.graphicsView.processor.layer.id):i.layer&&v(s,i.layer.uid));else if("layer"in i&&"element"in i)N(s,i.element),t===P.INCLUDE&&v(s,i.layer.uid);else if(n(i))for(const e of i)e===r.graphics&&null!=r.graphicsView?v(s,r.graphicsView.processor.layer.id):e===r.map.ground?v(s,y):C(r,e,t,s);else"uid"in i&&v(s,i.uid);return s}function v(e,n){e.layerUids||(e.layerUids=new Set),e.layerUids.add(n)}function D(e,n){e.graphicUids||(e.graphicUids=new Set),e.graphicUids.add(n)}function N(e,n){e.mediaElements||(e.mediaElements=new Set),e.mediaElements.add(n)}const T=t();var P;!function(e){e[e.INCLUDE=0]="INCLUDE",e[e.EXCLUDE=1]="EXCLUDE"}(P||(P={}));export{L as computeMapPointFromVec3d,R as externalToInternalIntersectOptions,w as getGraphicFilterUid,U as hitTest,j as intersectResultToMapPoint,I as toMap};
