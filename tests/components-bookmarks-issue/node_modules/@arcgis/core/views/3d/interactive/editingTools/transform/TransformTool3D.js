/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{_ as t}from"../../../../../chunks/tslib.es6.js";import{isSome as e}from"../../../../../core/arrayUtils.js";import i from"../../../../../core/Evented.js";import{makeHandle as o}from"../../../../../core/handleUtils.js";import{destroyMaybe as a}from"../../../../../core/maybe.js";import{zeroMeters as n,scale as s}from"../../../../../core/quantityUtils.js";import{watch as l,syncAndInitial as r}from"../../../../../core/reactiveUtils.js";import{property as p}from"../../../../../core/accessorSupport/decorators/property.js";import"../../../../../core/has.js";import"../../../../../core/Logger.js";import{subclass as c}from"../../../../../core/accessorSupport/decorators/subclass.js";import{UpdatingHandles as h}from"../../../../../core/support/UpdatingHandles.js";import m from"../../../../../geometry/Point.js";import{ViewingMode as u}from"../../../../ViewingMode.js";import{Manipulator3D as d}from"../../Manipulator3D.js";import{placeAtObject as v}from"../../manipulatorUtils.js";import{SnappingVisualizer3D as _}from"../../SnappingVisualizer3D.js";import{manipulatedObjectGeometry as f}from"../manipulatedObjectUtils.js";import{canMoveZOperations as g}from"../manipulatorUtils.js";import{meshTransformFastUpdateHandles as M}from"../meshFastUpdateUtils.js";import{createVisualElements as b}from"../visualElementUtils.js";import{alignArrowsScaleThreshold as j}from"../manipulations/config.js";import{MoveManipulation as y,ManipulationType as R}from"../manipulations/MoveManipulation.js";import{axisConstrainedDragSign as S}from"../manipulations/moveUtils.js";import{ScaleRotateMeshAdapter as w}from"./ScaleRotateMeshAdapter.js";import{ScaleRotateObjectSymbol3DAdapter as A}from"./ScaleRotateObjectSymbol3DAdapter.js";import{ScaleRotateTransform as O}from"./ScaleRotateTransform.js";import{createGraphicGeometryUndoRecord as T}from"./undoRecords.js";import{sceneSnappingAtProjectedLocation as x}from"../../../../interactive/dragEventPipeline.js";import{InteractiveToolBase as k}from"../../../../interactive/InteractiveToolBase.js";import{EditGeometryOperations as I}from"../../../../interactive/editGeometry/EditGeometryOperations.js";import E from"../../../../interactive/sketch/SketchOptions.js";import{SnappingContext as U}from"../../../../interactive/snapping/SnappingContext.js";import{createSnapDragEventPipelineStep as G}from"../../../../interactive/snapping/SnappingDragPipelineStep.js";import{Tooltip as H}from"../../../../interactive/tooltip/Tooltip.js";import{TranslateZTooltipInfo as z,TranslateXYTooltipInfo as Z,TranslateTooltipInfo as L}from"../../../../interactive/tooltip/TranslateTooltipInfos.js";import{autoDistanceBetweenPoints2D as C}from"../../../../support/automaticLengthMeasurementUtils.js";import{verticalSignedDistanceBetweenPoints as X}from"../../../../support/euclideanLengthMeasurementUtils.js";let D=class extends k{constructor(t){super(t),this.events=new i,this.enableZ=!0,this.enableRotation=!0,this.enableScaling=!0,this.sketchOptions=new E,this.type="transform-3d",this.tooltip=null,this._updatingHandles=new h,this._scaleRotate=null,this._translateGraphicTooltipInfo=null,this._translateGraphicXYTooltipInfo=null,this._translateGraphicZTooltipInfo=null}initialize(){const{object:t,view:i}=this;this.addHandles(l((()=>this.sketchOptions.tooltips.effectiveEnabled),(t=>{this.tooltip=t?new H({view:i}):a(this.tooltip)}),r)),this._moveManipulation=new y({tool:this,view:i,snapToScene:this.snapToScene,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZ&&g(t.operations,t.elevationInfo),radius:y.radiusForSymbol(t.graphic?.symbol)}),this._moveManipulation.forEachManipulator((t=>this.addHandles(t.events.on("immediate-click",(t=>{this.events.emit("immediate-click",{...t,object:this.object}),t.stopPropagation()})))));const n=t=>e=>{this.addHandles(e.events.on("focus-changed",(({action:e})=>{const i=this.tooltip;null!=i&&("focus"===e?this._updateMoveTooltip(t):i.clear())})))};this._moveManipulation.xyManipulation.forEachManipulator(n(R.XY)),this._moveManipulation.xyAxisManipulation.forEachManipulator(n(R.XY_AXIS)),this._moveManipulation.zManipulation.forEachManipulator(n(R.Z));const s=t.elevationInfo;if(this._moveManipulation.elevationInfo=s,this.addHandles(M(t,i)),this._moveManipulation.createManipulatedObjectDragPipeline(((e,o,a,n,l)=>{if(e===R.XY){const{snappingStep:e,cancelSnapping:o}=G({snappingContext:new U({elevationInfo:s,pointer:l,editGeometryOperations:I.fromGeometry(new m({spatialReference:t.operations?.data.spatialReference}),i.state.viewingMode),visualizer:new _,excludeFeature:t.graphic}),snappingManager:this.snappingManager,updatingHandles:this._updatingHandles,useZ:!1});n=n.next(o),a=a.next(x(this.view,s)).next(...e)}return{steps:a=a.next((t=>(this._updateMoveTooltip(e,t),t))),cancel:n}}),t,(t=>{const{action:e,object:i,dxScreen:o,dyScreen:a}=t,n={object:i,dxScreen:o,dyScreen:a};switch(e){case"start":this.events.emit("translate-start",n),this.events.emit("record-undo",{record:this._createGeometryUndoRecord()});break;case"update":this.events.emit("translate",n);break;case"end":this.events.emit("translate-stop",n)}})),this._moveManipulation.angle=null!=this._scaleRotate?this._scaleRotate.angle:0,this._scaleRotateAdapter=this._createScaleRotateAdapter(),this.addHandles(l((()=>this._scaleRotateAdapter.angle),(()=>this._updateMoveAngle()))),this.enableScaling||this.enableRotation){const t=this.enableScaling&&this.enableRotation?null:this.enableScaling?"scale":"rotate";this._scaleRotate=new O({tool:this,mode:t,adapter:this._scaleRotateAdapter,sketchOptions:this.sketchOptions}),this.addHandles(this._scaleRotate.events.on("scale-changed",(()=>this._onScaleChanged())))}this.addHandles([b({view:this.view,object:this.object,forEachManipulator:t=>this._forEachManipulator(t),onManipulatorsChanged:()=>o()}),this.object.on("committed",(()=>this._onGeometryChanged())),this._hideManipulatorsForObjectState(),l((()=>i.scale),(()=>this._updateMoveAngle()))].filter(e)),this._onGeometryChanged(),this._updateMoveAngle(),this._forEachManipulator((t=>{t instanceof d&&this.addHandles(t.events.on("grab-changed",(()=>this._updateManipulatorsInteractive())))})),this.finishToolCreation()}destroy(){this.tooltip=a(this.tooltip),this._moveManipulation.destroy(),this._scaleRotate=a(this._scaleRotate),this._scaleRotateAdapter=a(this._scaleRotateAdapter),this._updatingHandles.destroy(),this._set("view",null),this._set("object",null)}_updateManipulatorsInteractive(){null!=this._scaleRotate&&(this._scaleRotate.interactive=!this._moveManipulation.grabbing,this._moveManipulation.interactive=!this._scaleRotate.grabbing)}_createScaleRotateAdapter(){const t=f(this.object);return"mesh"===t?.type?new w({object:this.object,geometry:t,viewingMode:this.view.state.viewingMode}):new A({graphic:this.object.graphic,sizeFilter:t=>this._enforceNonZeroSize(t),findLayerView:()=>this.view.allLayerViews.find((t=>t.layer===this.object.graphic?.layer)),sizeAxis:this.sketchOptions?.tooltips?.visualVariables?.size?.axis??null})}_forEachManipulator(t){this._moveManipulation?.forEachManipulator(t),this._scaleRotate?.forEachManipulator(t)}_hideManipulatorsForObjectState(){return l((()=>this.object.visible),(t=>{this._forEachManipulator((e=>e.available=t)),this._moveManipulation.zManipulation.available=t&&this.enableZ&&g(this.object.operations,this.object.elevationInfo)}))}_createGeometryUndoRecord(){return T(this.object)}set snapToScene(t){this._moveManipulation&&(this._moveManipulation.snapToScene=t),this._set("snapToScene",t)}get updating(){return this._updatingHandles.updating||!!this._scaleRotate?.updating}set location(t){this._moveManipulation.location=t,this._scaleRotate&&(this._scaleRotate.location=t)}set elevationAlignedLocation(t){this._moveManipulation.elevationAlignedLocation=t,this._scaleRotate&&(this._scaleRotate.elevationAlignedLocation=t)}reset(){}onHide(){this._scaleRotate?.cancelActiveAnimation()}_onScaleChanged(){null!=this._scaleRotate&&(this._moveManipulation.displayScale=this._scaleRotate.getScale())}_updateMoveAngle(){this.view.state.viewingMode===u.Local||this.view.scale<j?this._moveManipulation.angle=this._scaleRotateAdapter.angle:this._moveManipulation.angle=0}_onGeometryChanged(){v(this,this.object)}_enforceNonZeroSize(t){return t||this.view.state.camera.computeRenderPixelSizeAt(this._moveManipulation.renderLocation)}_updateMoveTooltip(t,e){const{sketchOptions:i,tooltip:o}=this;if(null!=o){switch(o.clear(),t){case R.XY:o.info=this._translateGraphicTooltipInfo??=new L({sketchOptions:i}),Y(o.info,e,((t,e)=>C(t,e)));break;case R.XY_AXIS:o.info=this._translateGraphicXYTooltipInfo??=new Z({sketchOptions:i}),Y(o.info,e,((t,i)=>s(C(t,i),S(e))));break;case R.Z:o.info=this._translateGraphicZTooltipInfo??=new z({sketchOptions:i}),Y(o.info,e,X)}o.info.sketchOptions=i}}get test(){return{discManipulator:this._moveManipulation.xyManipulation.test.discManipulator,zManipulator:this._moveManipulation.zManipulation.test.manipulator,ringManipulator:null!=this._scaleRotate?this._scaleRotate.test.ringManipulator:null,arrowManipulators:this._moveManipulation.xyAxisManipulation.test.arrowManipulators,setRingIndicatorDelayMs:t=>null!=this._scaleRotate?this._scaleRotate.test.setRingIndicatorDelayMs(t):null,scaleRotateAdapter:this._scaleRotateAdapter,scaleRotateTransform:this._scaleRotate}}};function Y(t,e,i){if(null!=e&&"end"!==e.action){const{mapStart:o,mapEnd:a}=e,s=i(o,a);t.distance=null!=s?s:n}else t.distance=n}t([p({constructOnly:!0,nonNullable:!0})],D.prototype,"view",void 0),t([p({constructOnly:!0,nonNullable:!0})],D.prototype,"object",void 0),t([p({constructOnly:!0,nonNullable:!0})],D.prototype,"enableZ",void 0),t([p()],D.prototype,"enableRotation",void 0),t([p()],D.prototype,"enableScaling",void 0),t([p({constructOnly:!0,type:E})],D.prototype,"sketchOptions",void 0),t([p({value:!1})],D.prototype,"snapToScene",null),t([p({constructOnly:!0})],D.prototype,"snappingManager",void 0),t([p({readOnly:!0})],D.prototype,"type",void 0),t([p({readOnly:!0})],D.prototype,"updating",null),t([p()],D.prototype,"tooltip",void 0),D=t([c("esri.views.3d.interactive.editingTools.transform.TransformTool3D")],D);export{D as TransformTool3D};
