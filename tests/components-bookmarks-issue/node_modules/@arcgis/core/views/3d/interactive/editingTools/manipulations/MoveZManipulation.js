/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import t from"../../../../../Color.js";import{darken as e}from"../../../../../core/colorUtils.js";import i from"../../../../../core/Evented.js";import{makeHandle as r}from"../../../../../core/handleUtils.js";import{clamp as a}from"../../../../../core/mathUtils.js";import{removeMaybe as o}from"../../../../../core/maybe.js";import{watch as s}from"../../../../../core/reactiveUtils.js";import{translate as n,rotateX as l,scale as c}from"../../../../../core/libs/gl-matrix-2/math/mat4.js";import{create as m}from"../../../../../core/libs/gl-matrix-2/factories/mat4f64.js";import{o as u,f as d,n as p,k as h,b as f,h as _}from"../../../../../chunks/vec32.js";import{create as j,fromValues as w}from"../../../../../core/libs/gl-matrix-2/factories/vec3f64.js";import{Manipulator3D as v}from"../../Manipulator3D.js";import{createManipulatorMaterial as g}from"../../manipulatorUtils.js";import{RenderObject as M}from"../../RenderObject.js";import{screenToZConstrained as U}from"../dragEventPipeline3D.js";import{ManipulatorType as b}from"../ManipulatorType.js";import{Settings as O}from"../settings.js";import{discRadius as y}from"./config.js";import{Manipulation as P}from"./Manipulation.js";import{createManipulatedMoveDragPipeline as T}from"./moveUtils.js";import{createTubeGeometry as z,createConeGeometry as F}from"../../../webgl-engine/lib/GeometryUtil.js";import{RenderOccludedFlag as x}from"../../../webgl-engine/lib/Material.js";import{createManipulatorDragEventPipeline as A,addScreenDelta as E}from"../../../../interactive/dragEventPipeline.js";import{ManipulatorStateFlags as R}from"../../../../interactive/interfaces.js";class C extends P{constructor(t){super(),this._radius=y,this.events=new i,this._tool=t.tool,this._view=t.view;const e=new O({getTheme:()=>this._view.effectiveTheme});this._settings=e,null!=t.radius&&(this._radius=t.radius);const r=this._view.effectiveTheme.accentColor;this._materials={materialUnfocused:g(D(r,1,.25),x.Occlude),materialFocused:g(D(r,1,0),x.Occlude),materialOccludedUnfocused:g(D(r,.7,0),e.zManipulator.renderOccluded),materialOccludedFocused:g(D(r,.85,0),e.zManipulator.renderOccluded)},this._themeHandle=s((()=>this._view.effectiveTheme.accentColor),(t=>{const e=D(t,1,.25),i=D(t,1,0),r=D(t,.7,0),a=D(t,.85,0),{materialUnfocused:o,materialFocused:s,materialOccludedUnfocused:n,materialOccludedFocused:l}=this._materials;o.setParameters({color:e}),s.setParameters({color:i}),n.setParameters({color:r}),l.setParameters({color:a})})),this._createManipulator(),this.forEachManipulator((t=>this._tool.manipulators.add(t)))}destroy(){this._themeHandle=o(this._themeHandle),this._manipulator.applyObjectTransform=I,this.forEachManipulator((t=>{this._tool.manipulators.remove(t),t.destroy()}))}forEachManipulator(t){t(this._manipulator,b.TRANSLATE_Z)}createManipulatedObjectDragPipeline(t,e,i){if(!e.operations)return r();const a=e.operations.data.spatialReference;return T(e,i,(e=>this.createDragPipeline(((i,r,a,o,s)=>(({steps:r,cancel:a}=t(i,r,a,o,s)),e(i,r,a))),a)))}createDragPipeline(t,e){const i=this._view;return A(this._manipulator,((r,a,o,s,n)=>{const l=a.next((t=>({...t,manipulatorType:b.TRANSLATE_Z}))).next(U(i,r.renderLocation,e)).next(E());t(r,l,o,s,n)}))}get radius(){return this._radius}set radius(t){t!==this._radius&&(this._radius=t,this._updateManipulator())}_updateManipulator(){const t=this._settings,e=this._radius/y,i=t.zManipulator.height*e,r=t.zManipulator.coneHeight*e,a=t.zManipulator.coneWidth*e,o=t.zManipulator.width*e,s=[w(0,0,0),w(0,0,i)],u=[w(0,0,0),w(0,0,i+r)],d=t=>{const e=m();if(n(e,e,[0,0,i]),l(e,e,Math.PI/2),t){const i=1+2*t/a;c(e,e,[i,i,i])}return e},p=d(0),{materialUnfocused:h,materialFocused:f,materialOccludedUnfocused:_,materialOccludedFocused:j}=this._materials,v=z(h,s,o/2,16,!1),g=F(h,r,a/2,16,!1);g.transformation=p,this._manipulator.renderObjects=[new M(g,R.Unfocused),new M(v,R.Unfocused),new M(g.instantiate({material:f}),R.Focused),new M(v.instantiate({material:f}),R.Focused),new M(g.instantiate({material:_}),R.Unfocused),new M(v.instantiate({material:_}),R.Unfocused),new M(g.instantiate({material:j}),R.Focused),new M(v.instantiate({material:j}),R.Focused)],this._manipulator.radius=o/2+2,this._manipulator.collisionType={type:"line",paths:[u]}}_createManipulator(){const t=this._view,e=new v({view:t,autoScaleRenderObjects:!1,worldSized:!1,selectable:!1,cursor:"ns-resize",elevationInfo:this.elevationInfo,worldOriented:!0,collisionPriority:1.6});e.applyObjectTransform=e=>{const i=t.state.camera,r=H;t.renderCoordsHelper.toRenderCoords(this._manipulator.elevationAlignedLocation,r);const o=u(i.eye,r),s=i.computeRenderPixelSizeAtDist(o),n=d(S,r,i.eye);p(n,n);const l=L;t.renderCoordsHelper.worldUpAtPosition(H,l);const c=Math.abs(h(n,l)),m=f(S,n,l),j=f(S,m,l),w=a(c,.01,1),v=1-Math.sqrt(1-w*w)/w/i.fullWidth,g=this._settings,M=this._radius/y,U=g.zManipulator.width*M;_(j,p(j,j),(1/v-1)*o+s*U),e[12]-=S[0],e[13]-=S[1],e[14]-=S[2]},this._manipulator=e,this._updateManipulator()}get test(){return{manipulator:this._manipulator}}}function D(i,r,a){const o=e(i,a);return o.a*=r,t.toUnitRGBA(o)}const H=j(),S=j(),L=j(),I=()=>{};export{C as MoveZManipulation};
