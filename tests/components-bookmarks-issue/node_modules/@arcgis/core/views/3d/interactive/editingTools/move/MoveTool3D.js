/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{_ as t}from"../../../../../chunks/tslib.es6.js";import e from"../../../../../core/Collection.js";import i from"../../../../../core/Evented.js";import{makeHandle as o}from"../../../../../core/handleUtils.js";import{destroyMaybe as n}from"../../../../../core/maybe.js";import{zeroMeters as s,scale as a}from"../../../../../core/quantityUtils.js";import{watch as l,syncAndInitial as r}from"../../../../../core/reactiveUtils.js";import{property as p}from"../../../../../core/accessorSupport/decorators/property.js";import"../../../../../core/has.js";import"../../../../../core/Logger.js";import"../../../../../core/RandomLCG.js";import{subclass as c}from"../../../../../core/accessorSupport/decorators/subclass.js";import{UpdatingHandles as h}from"../../../../../core/support/UpdatingHandles.js";import{makeDehydratedPoint as u}from"../../../../../layers/graphics/dehydratedPoint.js";import{getConvertedElevation as m}from"../../../../../support/elevationInfoUtils.js";import{SnappingVisualizer3D as d}from"../../SnappingVisualizer3D.js";import{orientation as f}from"../geometryUtils.js";import{SupportedObjectResult as v}from"../isSupportedObjectUtils.js";import{manipulatedObjectGeometry as g}from"../manipulatedObjectUtils.js";import{canMoveZOperations as _}from"../manipulatorUtils.js";import{meshTransformFastUpdateHandles as j}from"../meshFastUpdateUtils.js";import{createVisualElements as M}from"../visualElementUtils.js";import{discRadius as b}from"../manipulations/config.js";import{ManipulationType as y,MoveManipulation as T}from"../manipulations/MoveManipulation.js";import{axisConstrainedDragSign as w}from"../manipulations/moveUtils.js";import{MoveXYObjectManipulation as I}from"../manipulations/MoveXYObjectManipulation.js";import{isSupportedObject as x}from"./isSupportedObject.js";import{OutlineVisualElement as O}from"../../visualElements/OutlineVisualElement.js";import{dragManipulatedObjectMany as E,resetManipulatedObjectMany as S}from"../../../../interactive/dragEventPipeline.js";import{InteractiveToolBase as H}from"../../../../interactive/InteractiveToolBase.js";import{EditGeometryOperations as X}from"../../../../interactive/editGeometry/EditGeometryOperations.js";import U from"../../../../interactive/sketch/SketchOptions.js";import{SnappingContext as k}from"../../../../interactive/snapping/SnappingContext.js";import{createSnapDragEventPipelineStep as Y}from"../../../../interactive/snapping/SnappingDragPipelineStep.js";import{Tooltip as z}from"../../../../interactive/tooltip/Tooltip.js";import{TranslateZTooltipInfo as A,TranslateXYTooltipInfo as P,TranslateTooltipInfo as D}from"../../../../interactive/tooltip/TranslateTooltipInfos.js";import{autoDistanceBetweenPoints2D as R}from"../../../../support/automaticLengthMeasurementUtils.js";import{verticalSignedDistanceBetweenPoints as Z}from"../../../../support/euclideanLengthMeasurementUtils.js";class C{constructor(t){this.objects=t,this.type="move-start"}}class F{constructor(t,e,i){this.dx=t,this.dy=e,this.objects=i,this.type="move"}}class G{constructor(t){this.objects=t,this.type="move-stop"}}const V="manipulators";let L=class extends H{constructor(t){super(t),this._infos=new Map,this.events=new i,this.objects=new e,this.enableZ=!0,this.sketchOptions=new U,this.type="move-3d",this.tooltip=null,this._updatingHandles=new h,this._moveManipulation=null,this._latestTooltipInfo=null,this._translateTooltipInfo=null,this._translateXYTooltipInfo=null,this._translateZTooltipInfo=null}initialize(){const{view:t}=this;this.addHandles([this.objects.on("change",(t=>{t.removed.forEach((t=>this.removeHandles(t))),this._updateObjectInfos(t),this._setupFastTransformUpdates(t.added),this._refreshManipulators()})),l((()=>this.sketchOptions.tooltips.effectiveEnabled),(e=>{this.tooltip=e?new z({info:this._latestTooltipInfo,view:t}):n(this.tooltip)}),r)]);const e=this.objects.toArray();this._updateObjectInfos({added:e,removed:[]}),this._setupFastTransformUpdates(e),this._refreshManipulators(),this.finishToolCreation()}destroy(){this.tooltip=n(this.tooltip),this._moveManipulation=n(this._moveManipulation),this._set("view",null),this._updatingHandles.destroy()}get updating(){return this._updatingHandles.updating}reset(){}_updateObjectInfos({added:t,removed:e}){for(const i of t){if(x(i)!==v.SUPPORTED)continue;const t=new N(i);this._infos.set(i,t)}for(const i of e)this._infos.delete(i)}_setupFastTransformUpdates(t){const{view:e}=this;for(const i of t){const t=this._infos.get(i);this.addHandles(j(t.object,e),i)}}_refreshManipulators(){if(this.removeHandles(V),this._moveManipulation=n(this._moveManipulation),this.manipulators.removeAll(),0===this._infos.size)return;const t=Array.from(this._infos.values());this._createManipulators(t),this._createVisualElements(t),this._updateMoveManipulation(t)}_createManipulators(t){for(const e of t){const i=e.object;e.manipulationXY=new I({tool:this,view:this.view,object:i}),e.manipulationXY.forEachManipulator((t=>{this.addHandles([t.events.on("immediate-click",(t=>{this.events.emit("immediate-click",{...t,object:i}),t.stopPropagation()})),t.events.on("grab-changed",(({action:t})=>{"start"===t?this._showTooltip(y.XY):this._hideTooltip()}))],V)})),this.addHandles(e.manipulationXY.createDragPipeline(((e,i,o,n)=>this._buildDragEventPipeline(t,y.XY,e,i,o,n))),V)}this._createMoveManipulation(t)}_createMoveManipulation(t){const e=new T({tool:this,view:this.view,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:1===t.length?T.radiusForSymbol(t[0].object.graphic?.symbol):b});this._moveManipulation=e,e.elevationInfo={mode:"absolute-height",offset:0},e.forEachManipulator((t=>{this.addHandles(t.events.on("immediate-click",(i=>{const o=this.objects.at(0);!e.zManipulation.hasManipulator(t)&&1===this.objects.length&&o&&this.events.emit("immediate-click",{...i,object:o}),i.stopPropagation()})),V)}));const i=t=>e=>{this.addHandles([e.events.on("focus-changed",(({action:e})=>{"focus"===e?this._showTooltip(t):this._hideTooltip()})),e.events.on("grab-changed",(()=>{this._latestTooltipInfo&&(this._latestTooltipInfo.distance=s)}))],V)};this._moveManipulation.xyManipulation.forEachManipulator(i(y.XY)),this._moveManipulation.xyAxisManipulation.forEachManipulator(i(y.XY_AXIS)),this._moveManipulation.zManipulation.forEachManipulator(i(y.Z));const o=()=>this._updateMoveManipulation(t);for(const s of t)this.addHandles([s.object.on("committed",o),l((()=>s.object.visible),o)],V);const n=t[t.length-1];this.addHandles(n.object.on("committed",(()=>this._updateMoveManipulationAngle(n))),V);const{object:a}=n,{operations:r}=a;if(r){const i=a.graphic;this.addHandles(e.createDragPipeline(((e,i,o,n,s)=>this._buildDragEventPipeline(t,e,i,o,n,s)),a.elevationInfo,r.data.spatialReference,i),V)}this._updateMoveManipulationAngle(n)}_createVisualElements(t){for(const e of t){const i=e.object,n=M({view:this.view,object:i,forEachManipulator:t=>{e.manipulationXY?.forEachManipulator(t),this._moveManipulation?.forEachManipulator(t)},onManipulatorsChanged:()=>o()});null!=n&&(e.geometryRepresentation=n.visualElement,e.geometryRepresentation instanceof O&&this.addHandles([e.geometryRepresentation.events.on("attachment-origin-changed",(()=>{e.object.isDraped||this._updateMoveManipulation(t)})),l((()=>e.object.isDraped),(()=>this._updateMoveManipulation(t)))],V),this.addHandles(n,V))}}_updateMoveManipulationAngle(t){this._moveManipulation&&(this._moveManipulation.angle=f(g(t.object)))}_updateMoveManipulation(t){const e=u(0,0,0,this.view.spatialReference);let i=0,o=!1;const n=this._moveManipulation;if(n){for(const n of t){if(!n.object.visible)continue;this.enableZ&&_(n.object.operations,n.object.elevationInfo)&&(o=!0);const t=n.geometryRepresentation instanceof O&&!n.object.isDraped?n.geometryRepresentation.attachmentOrigin:n.object.origin;if(null!=t){const{x:o,y:n,z:s}=t;e.x+=o,e.y+=n,s&&(e.z??=0,e.z+=s),i++}}i>0?(e.x/=i,e.y/=i,e.z??=0,e.z/=i,n.location=e,n.xyManipulation.available=!0,n.xyAxisManipulation.available=!0,n.zManipulation.available=o):n.available=!1}}_buildDragEventPipeline(t,e,i,o,n,s){const a=[],l=[];let r=null,p=null;const c=()=>{for(const t of a)t.dragging=!1;a.length=0,l.length=0,r=null,p=null,this._moveManipulation&&(this._moveManipulation.interactive=!0)};if(1===t.length&&e===y.XY){const e=t[0].object;({steps:o,cancel:n}=this._buildSnappingPipelineSteps(e,e.elevationInfo,o,n,s))}return n=n.next((t=>p?.(t))).next((()=>(l.length&&this.events.emit("move-stop",new G(l)),this.destroyed||c(),null))),{steps:o=o.next((e=>{if("start"===e.action){a.length=0,l.length=0;for(const e of t)e.dragging||!e.manipulationXY?.hasManipulator(i)&&e.manipulationXY?.grabbing||(a.push(e),l.push(e.object),e.dragging=!0);if(0!==l.length&&(this._moveManipulation&&(this._moveManipulation.interactive=!1),r=E(l),p=S(l),this.events.emit("move-start",new C(l)),this.destroyed))return null}return 0!==l.length?e:null})).next((t=>r?.(t))).next((t=>(this._updateMoveTooltip(e,t),t))).next((t=>{switch(t.action){case"start":case"update":if(t.translationX||t.translationY||t.translationZ){const e=this.view.toScreen(t.mapStart),i=this.view.toScreen(t.mapEnd),o=i.x-e.x,n=i.y-e.y;if(this.events.emit("move",new F(o,n,l)),this.destroyed)return null}break;case"end":if(this.events.emit("move-stop",new G(l)),this.destroyed)return null;c()}return null})),cancel:n}}_showTooltip(t){this._updateMoveTooltip(t),this._latestTooltipInfo&&(this._latestTooltipInfo.distance=s)}_hideTooltip(){this.tooltip?.clear(),this._latestTooltipInfo=null}_updateMoveTooltip(t,e){const{sketchOptions:i,tooltip:o}=this;switch(t){case y.XY:this._latestTooltipInfo=this._translateTooltipInfo??=new D({sketchOptions:i}),q(this._latestTooltipInfo,e,((t,e)=>R(t,e)));break;case y.XY_AXIS:this._latestTooltipInfo=this._translateXYTooltipInfo??=new P({sketchOptions:i}),q(this._latestTooltipInfo,e,((t,i)=>a(R(t,i),w(e))));break;case y.Z:this._latestTooltipInfo=this._translateZTooltipInfo??=new A({sketchOptions:i}),q(this._latestTooltipInfo,e,Z)}this._latestTooltipInfo.sketchOptions=i,o&&(o.info=this._latestTooltipInfo)}_buildSnappingPipelineSteps(t,e,i,o,n){const s=g(t);if(null==s||"point"!==s.type&&"mesh"!==s.type)return{steps:i,cancel:o};const a=("point"===s.type?s:s.anchor).clone(),l=new k({elevationInfo:e,pointer:n,editGeometryOperations:X.fromGeometry(a,this.view.state.viewingMode),visualizer:new d,excludeFeature:t.graphic}),r=this.snappingManager,{snappingStep:p,cancelSnapping:c}=Y({snappingContext:l,snappingManager:r,updatingHandles:this._updatingHandles});return o=o.next(c),{steps:i=i.next((e=>{a.z=m(this.view,a,t.elevationInfo,{mode:"absolute-height",offset:0});return{...e,snapOrigin:l.coordinateHelper.pointToVector(a)}})).next(...p),cancel:o}}};t([p({constructOnly:!0,nonNullable:!0})],L.prototype,"view",void 0),t([p()],L.prototype,"objects",void 0),t([p({constructOnly:!0,nonNullable:!0})],L.prototype,"enableZ",void 0),t([p({constructOnly:!0,type:U})],L.prototype,"sketchOptions",void 0),t([p({constructOnly:!0})],L.prototype,"snappingManager",void 0),t([p()],L.prototype,"type",void 0),t([p()],L.prototype,"updating",null),t([p()],L.prototype,"tooltip",void 0),L=t([c("esri.views.3d.interactive.editingTools.move.MoveTool3D")],L);class N{constructor(t){this.object=t,this.geometryRepresentation=null,this.manipulationXY=null,this.dragging=!1}}function q(t,e,i){if(null==e||"end"===e.action)return;const{mapStart:o,mapEnd:n}=e,a=i(o,n);t.distance=null!=a?a:s}export{F as MoveEvent,C as MoveStartEvent,G as MoveStopEvent,L as MoveTool3D};
