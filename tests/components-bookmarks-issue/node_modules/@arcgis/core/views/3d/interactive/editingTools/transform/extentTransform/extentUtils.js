/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{on as s}from"../../../../../../core/reactiveUtils.js";import{getMetersPerCartesianUnitForSR as t,getMetersPerUnitForSR as o}from"../../../../../../core/unitUtils.js";import{scale as i}from"../../../../../../core/libs/gl-matrix-2/math/vec2.js";import{g as e,f as a,m as n,b as r,n as p,h as d,k as c,l,r as u}from"../../../../../../chunks/vec32.js";import{create as m}from"../../../../../../core/libs/gl-matrix-2/factories/vec3f64.js";import{a as g,c as h,u as b}from"../../../../../../chunks/boundedPlane.js";import{sv3d as f}from"../../../../../../geometry/support/vectorStacks.js";import{mainAxis as B}from"../../geometryUtils.js";import{manipulatedObjectGeometry as y}from"../../manipulatedObjectUtils.js";import{evaluateElevationAlignmentAtPoint as j}from"../../../../layers/graphics/elevationAlignmentUtils.js";import{ElevationContext as v}from"../../../../layers/graphics/ElevationContext.js";import{apply as _,applyInverse as R,calculateOrientedBounds as C}from"../../../../../interactive/editGeometry/support/editPlaneUtils.js";import{autoSize2D as M}from"../../../../../support/extentUtils.js";class x{constructor(t,o){this._tool=t,this.mapBounds=g(),this.mapBoundsStart=g(),this.displayBounds=g(),t.addHandles(s((()=>t.object),"modified-externally",(()=>this._resetMapBounds()),{onListenerAdd:()=>this._resetMapBounds()})),this._onDisplayBoundsChanged=o}get displayBoundsMargin(){const{view:s,object:t}=this._tool,o=y(t),i=s.pointsOfInterest?.centerOnSurfaceFrequent.location??o?.extent?.center;return i?D*s.pixelSizeAt(i):0}backupMapBounds(){h(this.mapBounds,this.mapBoundsStart)}updateDisplayBounds(){this._calculateDisplayBounds(),this._onDisplayBoundsChanged?.()}updateMapBoundsFromOperation(s){_(s,this.mapBounds),this.updateDisplayBounds()}updateMapBoundsFromOperationInverse(s){R(s,this.mapBounds),this.updateDisplayBounds()}_resetMapBounds(){this._calculateMapBounds(),this.updateDisplayBounds()}_calculateMapBounds(){const{view:s,attachmentOrigin:e,object:a}=this._tool,n=a.operations?.data;if(!n)return;const r=n.geometry;this.spatialReference=r.spatialReference;const p=B(r);i(p,p,-1);const d=s.spatialReference,c=r.spatialReference,l=e?s.pixelSizeAt(e)*t(d)/o(c):0;C(p,n,O*l,this.mapBounds)}_calculateDisplayBounds(){const{view:s,attachmentOrigin:t}=this._tool,o=t?.z??j(this.mapBounds.origin,s.elevationProvider,v.fromElevationInfo(this._tool.object.elevationInfo),s.renderCoordsHelper),i=h(this.mapBounds);i.origin[2]=o??0,U(i,s.renderCoordsHelper,this.spatialReference,this.displayBoundsMargin,this.displayBounds)}}const D=10,O=80;function U(s,t,o,i=0,u){u||(u=g()),t.toRenderCoords(s.origin,o,u.origin);const m=f.get();e(m,s.origin,s.basis1),e(m,m,s.basis2),t.toRenderCoords(m,o,m);const h=f.get();e(h,s.origin,s.basis1),a(h,h,s.basis2),t.toRenderCoords(h,o,h);const B=f.get();a(B,s.origin,s.basis1),a(B,B,s.basis2),t.toRenderCoords(B,o,B);const y=f.get();a(y,s.origin,s.basis1),e(y,y,s.basis2),t.toRenderCoords(y,o,y);const j=n(f.get(),m,h,.5);a(j,j,u.origin);const v=n(f.get(),B,y,.5);a(v,u.origin,v),n(u.basis1,j,v,.5);const _=n(f.get(),y,m,.5);a(_,_,u.origin);const R=n(f.get(),h,B,.5);a(R,u.origin,R),n(u.basis2,_,R,.5);const C=r(f.get(),u.basis1,u.basis2),M=r(C,C,u.basis1);return p(M,M),d(u.basis2,M,c(u.basis2,M)),d(u.basis1,u.basis1,1+i/l(u.basis1)),d(u.basis2,u.basis2,1+i/l(u.basis2)),b(u),u}function S(s,t,o){return a(w,a(w,s.origin,s.basis1),s.basis2),u(I,w,s.basis1,2),u(A,I,s.basis2,2),u(k,w,s.basis2,2),w[2]=I[2]=A[2]=k[2]=t,M({topLeft:k,topRight:A,bottomRight:I,bottomLeft:w,spatialReference:o})}const k=m(),A=m(),I=m(),w=m();export{x as TransformBounds,S as mapPlaneAutoSize2D};
