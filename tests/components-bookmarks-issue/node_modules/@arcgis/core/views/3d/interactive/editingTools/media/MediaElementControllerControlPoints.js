/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../../chunks/tslib.es6.js";import"../../../../../geometry.js";import t from"../../../../../core/Accessor.js";import{isSome as o}from"../../../../../core/arrayUtils.js";import{destroyHandle as r}from"../../../../../core/handleUtils.js";import{initial as n}from"../../../../../core/reactiveUtils.js";import{property as i}from"../../../../../core/accessorSupport/decorators/property.js";import"../../../../../core/has.js";import"../../../../../core/Logger.js";import{subclass as s}from"../../../../../core/accessorSupport/decorators/subclass.js";import{UpdatingHandles as a}from"../../../../../core/support/UpdatingHandles.js";import{initializeProjection as p,project as l}from"../../../../../geometry/projection.js";import{EditGeometryOperations as c}from"../../../../interactive/editGeometry/EditGeometryOperations.js";import d from"../../../../../geometry/Polygon.js";import m from"../../../../../geometry/Point.js";let h=class extends t{get operations(){return this._operations}get updating(){return this._updatingHandles.updating}constructor(e){super(e),this._updatingHandles=new a}initialize(){this.addHandles([r(this._updatingHandles),this._updatingHandles.add((()=>{const e=this.element.georeference;return"control-points"===e?.type?e.controlPoints:null}),(e=>this._elementControlPointsChanged(e)),n)])}_elementControlPointsChanged(e){if(this._updatedElementControlPoints===e)return;const t=e?.map((({mapPoint:e})=>e)).filter(o),r=this.view.spatialReference;this._updatingHandles.addPromise(this._whenProjected(t,r,(e=>{if(!e)return void this._replaceOperations(null);const{_operations:t}=this,o=new d({rings:[e.map((({x:e,y:t})=>[e,t]))],spatialReference:r});t?.trySetGeometry(o)?this.onModifiedExternally():this._replaceOperations(c.fromGeometry(o,this.view.state.viewingMode))})))}_operationsGeometryChanged(){const{element:{georeference:e},_operations:t}=this;if(!t||!e||"control-points"!==e.type||!e.controlPoints)return;const r=t.data.geometry,n=e.controlPoints.map((({mapPoint:e})=>e)).filter(o);if(r.rings[0]?.length!==n.length)return void this._updateElementControlPoints(null);const i=r.rings[0].map((([e,t])=>new m({x:e,y:t,spatialReference:r.spatialReference}))),s=n.map((({spatialReference:e})=>e));this._updatingHandles.addPromise(this._whenProjected(i,s,(e=>this._updateElementControlPoints(e))))}_updateElementControlPoints(e){const{georeference:t}=this.element;if(!t||!e||"control-points"!==t.type||t.controlPoints?.length!==e?.length)return;e||(t.controlPoints=null);const o=t.controlPoints;if(o?.length===e.length)for(let r=0;r<o.length;r++)o[r].mapPoint=e[r]}async _whenProjected(e,t,o){if(!e)return void o(e);const{_operations:r,element:{georeference:n}}=this,i=e.map((({spatialReference:e})=>e)),s=Array.isArray(t)?t:new Array(i.length).fill(t);await p(Array.from(i).map(((e,t)=>({source:e,dest:s[t]}))));const a=e.map(((e,t)=>l(e,s[t])));r===this._operations&&n===this.element.georeference&&o(a)}_replaceOperations(e){this._operations&&(this.removeHandles(this._operations),this._operations.destroy()),this._operations=e,e&&this.addHandles(e.data.on("change",(()=>this._operationsGeometryChanged())),e)}};e([i({constructOnly:!0})],h.prototype,"view",void 0),e([i({constructOnly:!0})],h.prototype,"layer",void 0),e([i({constructOnly:!0})],h.prototype,"element",void 0),e([i({constructOnly:!0})],h.prototype,"onModifiedExternally",void 0),e([i()],h.prototype,"_operations",void 0),e([i()],h.prototype,"operations",null),e([i()],h.prototype,"updating",null),h=e([s("esri.views.3d.interactive.editingTools.media.MediaElementControllerControlPoints")],h);export{h as MediaElementControllerControlPoints};
