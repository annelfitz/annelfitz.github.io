/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{TextureUpdate as e}from"./interfaces.js";import{progressiveLoadingModulo as t}from"./TerrainConst.js";import{getLayerWithExtentRange as s}from"./terrainUtils.js";import{fallsWithinLayer as i}from"./tileUtils.js";class l{get updating(){return!!this._tileRequested}init(e,t,s,i){this.tile=e,this._layerIdx=t,this._layerClass=s,this._suspended=i,this._tileLayerInfo=e.getLayerInfo(t,s),this._tileRequested=null;const l=this._findAncestorWithData();this._setUpsampleTile(l)}startLoading(){return this._requestNext()}dispose(){this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null),this.tile=null,this._tileLayerInfo=null}setSuspension(e){e!==this._suspended&&(this._suspended=e,e?this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null):this._tileLayerInfo.data||this.update())}update(){const e=this._findAncestorWithData();return this._setUpsampleTile(e),this._requestNext()}dataArrived(t,s){this._setUpsampleTile(t,s),this._tileRequested=null,t===this.tile?this.tile.updateRenderData(this._layerClass,e.FADING,s):this._requestNext()}dataMissing(){this._tileRequested=null,this._tileLayerInfo.data=null,this._requestNext()}_agentDone(){this.tile.agentDone(this._layerIdx,this._layerClass),this.dispose()}_requestNext(){if(this._suspended)return!0;const e=this._findNextDownload();if(this._tileRequested){if(e===this._tileRequested)return!0;this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null}return null!=e?e.requestLayerData(this._layerIdx,this._layerClass,this)&&(this._tileRequested=e):this._agentDone(),!!this._tileRequested}_findNextDownload(){const e=this._layerIdx,l=this._layerClass,a=this.tile.surface.layerViewByIndex(e,l),n=s(a),{minLevel:r,maxLevel:h}=a.dataLevelRange,d=this._desiredMinLevelDelta,o=this._progressiveLevelModulo+d,u=this._scaleRangeEnabled?i:()=>!0;let _=this.tile;const p=_.level;let f;const y=this._tileLayerInfo.upsampleInfo,v=null!=y?y.tile.level:-1,I=null!=y&&v-p>=d,c=n?.tilemapCache,q="vector-tile-3d"===a.type?a.schemaHelper:null;for(;_&&u(_,n,!1)&&_.level>=r;){const s=_.level,i=p-s,a=_.layerInfo[l][e];if(a.data&&i>=d){(!I||s>v)&&this._setUpsampleTile(_),a.dataInvalidated&&(f=_);break}const n=q?.getLevelRowColumn(_.lij)??_.lij;if("unavailable"!==c?.getAvailability(n[0],n[1],_.lij[2])&&s<=h&&!a.data&&!a.dataMissing&&((!f||_.level===r||s%t==0||p-f.level<d)&&(f=_),i>=o))break;_=_.parent}if(null!=f&&p-f.level<d)if(y)f=null;else{const t=this._findAncestorWithData();if(null!=t){this._setUpsampleTile(t);f=t.layerInfo[l][e].dataInvalidated?t:null}}return f}_findAncestorWithData(){const e=this.tile.elevationLevel,t=this._desiredMinLevelDelta;let s;for(let i=this.tile;i;i=i.parent)if(i.hasLayerData(this._layerIdx,this._layerClass)){if(e-i.level>=t)return i;s=i}return s}_setUpsampleTile(t,s){this._tileLayerInfo.setUpsampleInfo(this.tile,t),this.tile.updateRenderData(this._layerClass,e.FADING,s)}get test(){return{findNextDownload:()=>this._findNextDownload(),tileLayerInfo:this._tileLayerInfo}}}class a extends l{get _desiredMinLevelDelta(){throw n}get _progressiveLevelModulo(){throw n}dispose(){}}const n=new Error("Abstract method called on TileAgent"),r=new a;export{l as TileAgent,r as tileAgentDone};
