/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import e from"../../../../core/Logger.js";import{NestedMap as r}from"../../../../core/NestedMap.js";import{fromValues as o}from"../../../../core/libs/gl-matrix-2/factories/vec4f64.js";import{BufferViewVec4u8 as t}from"../../../../geometry/support/buffer/BufferView.js";class i{constructor(){this.declaredClass="esri.views.3d.webgl-engine.lib.ObjectAndLayerIdRenderHelper",this.colorZero=new t(new ArrayBuffer(4)),this._layerToOidToColor=new r,this._colorToUID=new Map,this._layerUidToGraphicsUidToObjectId=new r,this._layerUidToId=new Map,this._layerUidToPopupEnabled=new Map}setUidToObjectAndLayerId(e,r,o,t,i,d=null,a=null,s=null){e&&r&&o&&t&&(this._layerUidToId.set(t,o),this._layerUidToPopupEnabled.set(t,i),i&&this._layerUidToGraphicsUidToObjectId.set(t,r,{objectId:e,attributeNodeId:d,attributeIndex:a,subLayerId:s}))}getObjectAndLayerIdColor(e){const r=this.getObjectAndLayerIdColorArray(e);return o(r.get(0,1),r.get(0,2),r.get(0,3),255)}getObjectAndLayerIdColorArray(r){if(!r.layerUid||!r.graphicUid)return this.colorZero;const o=this._layerUidToPopupEnabled.get(r.layerUid);if(void 0===o)return e.getLogger(this).warn("popupEnabled is undefined for layerUid "+r.layerUid),this.colorZero;if(!1===o)return this.colorZero;const i=this._layerUidToGraphicsUidToObjectId.get(r.layerUid,r.graphicUid)?.objectId;if(!i)return this.colorZero;let d=this._layerToOidToColor.get(r.layerUid,i);if(!d){for(;!d;){const e=Math.floor(16777214*Math.random())+1;this._colorToUID.has(e)||(d=e)}if(d>16777215)throw new Error("Object ID Overflow");this._layerToOidToColor.set(r.layerUid,i,d),this._colorToUID.set(d,r)}const a=new ArrayBuffer(4);new DataView(a).setUint32(0,d,!1);return new t(a)}getColorToObjectAndLayerIdMapping(){const r=new Map;for(const[o,t]of this._colorToUID.entries()){const i=this._layerUidToGraphicsUidToObjectId.get(t.layerUid,t.graphicUid);i||e.getLogger(this).warn("getColorMapping: no entry found for graphicsId "+t.graphicUid);const d=this._layerUidToId.get(t.layerUid);d||e.getLogger(this).warn("no layerId found for uid "+t.layerUid),i&&d&&r.set(o,i.attributeNodeId?{type:"object-and-layer-and-i3s-id",oid:i.objectId,lid:d,attrId:i.attributeNodeId,attrIdx:i.attributeIndex,subLayerId:i.subLayerId}:{type:"object-and-layer-id",oid:i.objectId,lid:d})}return r}}export{i as ObjectAndLayerIdRenderHelper};
