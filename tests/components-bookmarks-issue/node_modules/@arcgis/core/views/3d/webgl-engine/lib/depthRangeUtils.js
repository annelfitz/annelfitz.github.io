/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{unpackFloatRGBA as e}from"../../../../core/floatRGBA.js";import t from"../../../../core/PooledArray.js";import{multiply as r,copy as i}from"../../../../core/libs/gl-matrix-2/math/mat4.js";import{create as n}from"../../../../core/libs/gl-matrix-2/factories/mat4f64.js";import{e as s}from"../../../../chunks/vec32.js";import{l as a}from"../../../../chunks/vec42.js";import{create as o}from"../../../../core/libs/gl-matrix-2/factories/vec4f64.js";import{intersectsSphere as h,create as f,copy as c}from"../../../../geometry/support/frustum.js";import{g as l,c as u}from"../../../../chunks/sphere.js";import{maxScale as _}from"../../support/mathUtils.js";import{empty as d,union as m,set as g,DepthRange as p}from"./depthRange.js";import b from"./Octree.js";import{assert as w}from"./Util.js";const v=1e4,R=100,j=500,C=500,A=.1;function B(t,r,i){return e(r,t)*(i[1]-i[0])+i[0]}function M(e,t,r){let i=0;if(!t.some((e=>!!e.materialReference&&(i+=e.numGeometries,i>=v))))return Q.compute(e,t);const n=d();return r.forAll((t=>m(n,O(e,t)))),n}function O(e,t){if(!t.visible)return;const r=d(),i=t.getSpatialQueryAccelerator();return i?x(r,e,i):D(r,e,t.objects),r}function x(e,t,r){const i=t.eye,n=t.viewForward,s=t.frustum,a=e=>e.visible,o=r.objectCount;if(o<j)g(G,t.near,Math.min(e.near,t.far)),r.forEachInDepthRange(i,n,b.DepthOrder.FRONT_TO_BACK,G,((r,i)=>{T(e,t,r),G.far=e.near,i.setRange(G)}),s,a),g(G,Math.max(e.far,t.near),t.far),r.forEachInDepthRange(i,n,b.DepthOrder.BACK_TO_FRONT,G,((r,i)=>{T(e,t,r),G.near=e.far,i.setRange(G)}),s,a);else{const i=Math.max(Math.min(o,C),Math.ceil(o*A)),h=r.findClosest(n,b.DepthOrder.FRONT_TO_BACK,s,a,i),f=r.findClosest(n,b.DepthOrder.BACK_TO_FRONT,s,a,i);h&&f&&(I(e,t,h.boundingVolumeWorldSpace.bounds),I(e,t,f.boundingVolumeWorldSpace.bounds))}}function D(e,t,r){U.clear(),r.forAll((e=>{e.visible&&0!==e.geometries.length&&U.add(e)})),U.empty||(U.sort(t),g(G,t.near,Math.min(e.near,t.far)),U.forEachInDepthRange(G,b.DepthOrder.FRONT_TO_BACK,((r,i)=>{i<e.near&&T(e,t,r)})),g(G,Math.max(e.far,t.near),t.far),U.forEachInDepthRange(G,b.DepthOrder.BACK_TO_FRONT,((t,r,i)=>{e.far=Math.max(e.far,i)})))}function T(e,t,i){if(!i.visible)return;if(!h(t.frustum,i.boundingVolumeWorldSpace.bounds))return;const n=i.transformation,s=k;i.geometries.forEach((i=>{r(s,n,i.transformation);const a=_(s);F(e,t,i.boundingInfo,s,a)}))}function F(e,t,r,i,n){if(null==r)return;s(l(V),r.center,i);const{eye:a,viewForward:o}=t,f=o[0]*(V[0]-a[0])+o[1]*(V[1]-a[1])+o[2]*(V[2]-a[2]);if(V[3]=r.radius*n,!(f-V[3]>e.near&&f+V[3]<e.far)&&h(t.frustum,V))if(r.radius>R&&r.getChildren())for(const s of r.getChildren())F(e,t,s,i,n);else q.unionDepthRangeWithAABB(e,t.viewProjectionMatrix,i,r.bbMin,r.bbMax)}function I(e,t,r){const i=t.eye,n=t.viewForward,s=(r[0]-i[0])*n[0]+(r[1]-i[1])*n[1]+(r[2]-i[2])*n[2];e.near=Math.min(e.near,s-r[3]),e.far=Math.max(e.far,s+r[3])}class y{constructor(){this._items=new t({allocator:e=>e||{object:null,distance:0,near:0,far:0},deallocator:e=>(e.object=null,e.distance=0,e.near=0,e.far=0,e)})}get length(){return this._items.length}get empty(){return 0===this._items.length}clear(){this._items.clear()}add(e){this._items.pushNew().object=e}sort(e){const t=e.eye,r=e.viewForward;this._items.forAll((e=>{const i=e.object.boundingVolumeWorldSpace.bounds,n=(i[0]-t[0])*r[0]+(i[1]-t[1])*r[1]+(i[2]-t[2])*r[2];e.distance=n,e.near=n-i[3],e.far=n+i[3]})),this._items.sort(((e,t)=>e.distance-t.distance))}forEachInDepthRange(e,t,r){if(t===b.DepthOrder.FRONT_TO_BACK)for(let i=0;i<this._items.length;++i){const t=this._items.data[i];t.far<e.near||t.near>e.far||r(t.object,t.near,t.far)}else for(let i=this._items.length-1;i>=0;--i){const t=this._items.data[i];t.far<e.near||t.near>e.far||r(t.object,t.near,t.far)}}}class P{constructor(){this._view=n(),this._viewProj=n(),this._frustum=f(),this._geometries=new Array,this._near=[],this._far=[],this._nearCandidates=[],this._farCandidates=[],this._looseRange={near:0,far:0}}compute(e,t){this._reset(),i(this._view,e.viewMatrix),r(this._viewProj,e.projectionMatrix,this._view),c(this._frustum,e.frustum);const n=this._view,s=n[2],a=n[6],o=n[10],h=n[14];t.forAll((e=>{e.materialReference&&e.forEachGeometry&&e.forEachGeometry((e=>{if(!e.visible||!e.castShadow)return;const t=e.boundingSphere,r=s*t[0]+a*t[1]+o*t[2]+h,i=r-t[3],n=r+t[3];this._geometries.push(e),this._near.push(-n),this._far.push(-i)}))}));const f=new p;if(0===this._geometries.length)return f;for(let r=0;r<this._geometries.length;++r)this._near[r]>f.far&&(f.far=this._near[r]),this._near[r]>2&&this._far[r]<f.near&&(f.near=this._far[r]);const l=this._looseRange;l.near=Math.max(.5*f.near,2),l.far=2*f.far;let u=0,_=0;for(let r=0;r<this._geometries.length;++r)this._near[r]<f.near&&(this._near[r]>=l.near?f.near=this._near[r]:this._nearCandidates[u++]=r),this._far[r]>f.far&&(this._far[r]<=l.far?f.far=this._far[r]:this._farCandidates[_++]=r);if(0===this._nearCandidates.length&&0===this._farCandidates.length)return f;this._nearCandidates.sort(((e,t)=>this._near[e]<this._near[t]?-1:this._near[e]>this._near[t]?1:0)),this._farCandidates.sort(((e,t)=>this._far[e]<this._far[t]?1:this._far[e]>this._far[t]?-1:0));for(let r=0;r<this._nearCandidates.length;++r){const e=this._nearCandidates[r];if(this._near[e]<f.near){const t=this._geometries[e],r=t.boundingInfo;this._includeNearBoundingInfoRec(r,t.shaderTransformation,f)}}for(let r=0;r<this._farCandidates.length;++r){const e=this._farCandidates[r];if(this._far[e]>f.far){const t=this._geometries[e],r=t.boundingInfo;this._includeFarBoundingInfoRec(r,t.shaderTransformation,f)}}return this._reset(),f}_reset(){this._geometries.length=0,this._near.length=0,this._far.length=0,this._nearCandidates.length=0,this._farCandidates.length=0}_includeNearBoundingInfoRec(e,t,r){if(null==e)return;const i=e.center;s(l(V),i,t);const n=_(t),a=V[0],o=V[1],h=V[2],f=e.radius*n,c=this._frustum;if(c[0][0]*a+c[0][1]*o+c[0][2]*h+c[0][3]>f||c[1][0]*a+c[1][1]*o+c[1][2]*h+c[1][3]>f||c[2][0]*a+c[2][1]*o+c[2][2]*h+c[2][3]>f||c[3][0]*a+c[3][1]*o+c[3][2]*h+c[3][3]>f)return;const u=this._view[2]*a+this._view[6]*o+this._view[10]*h+this._view[14],d=u+f;if(!(-(u-f)<2||-d>=r.near))if(-d>this._looseRange.near)r.near=-d;else{if(f>R){const i=e.getChildren();if(void 0!==i){for(const e of i)this._includeNearBoundingInfoRec(e,t,r);return}}q.unionDepthRangeWithAABB(r,this._viewProj,t,e.bbMin,e.bbMax)}}_includeFarBoundingInfoRec(e,t,r){if(null==e)return;let i=e.radius;const n=e.center;s(l(V),n,t);const a=_(t),o=V[0],h=V[1],f=V[2];i*=a;const c=this._frustum;if(c[0][0]*o+c[0][1]*h+c[0][2]*f+c[0][3]>i||c[1][0]*o+c[1][1]*h+c[1][2]*f+c[1][3]>i||c[2][0]*o+c[2][1]*h+c[2][2]*f+c[2][3]>i||c[3][0]*o+c[3][1]*h+c[3][2]*f+c[3][3]>i)return;const u=this._view[2]*o+this._view[6]*h+this._view[10]*f+this._view[14]-i;if(!(-u<=r.far))if(-u<this._looseRange.far)r.far=-u;else{if(i>R){const i=e.getChildren();if(void 0!==i){for(const e of i)this._includeFarBoundingInfoRec(e,t,r);return}}q.unionDepthRangeWithAABB(r,this._viewProj,t,e.bbMin,e.bbMax)}}}class N{constructor(){this._modelViewProj=n(),this._clipPosition=[o(),o(),o(),o(),o(),o(),o(),o()]}unionDepthRangeWithAABB(e,t,i,n,s){const a=this._modelViewProj;r(a,t,i);let o=!1;for(let r=0;r<8;++r){const e=this._clipPosition[r],t=0===r||3===r||4===r||7===r?n[0]:s[0],i=0===r||1===r||4===r||5===r?n[1]:s[1],o=r<4?n[2]:s[2];e[0]=a[0]*t+a[4]*i+a[8]*o+a[12],e[1]=a[1]*t+a[5]*i+a[9]*o+a[13],e[2]=a[2]*t+a[6]*i+a[10]*o+a[14],e[3]=a[3]*t+a[7]*i+a[11]*o+a[15]}for(let r=0;r<12;++r){const t=E(this._clipPosition[S[r][0]],this._clipPosition[S[r][1]],this._clipPosition[S[r][2]]);let i=!0;for(let e=0;e<t.length;++e){if(t[e][3]>=2){i=!1;break}}if(!i){o=!0;for(let r=0;r<t.length;++r){const i=t[r][3];Number.isFinite(i)&&(e.near=Math.min(i,e.near),e.far=Math.max(i,e.far))}}}return o}}function E(e,t,r){let i=[e,t,r];for(let n=0;n<4;++n){const e=i;i=[];for(let t=0;t<e.length;++t){const r=e[t],s=e[(t+1)%e.length];W(s,n)?(W(r,n)||i.push(K(r,s,n)),i.push(s)):W(r,n)&&i.push(K(r,s,n))}}return i}function W(e,t){return 0===t?e[0]>=-e[3]:1===t?e[1]>=-e[3]:2===t?e[0]<=e[3]:3===t?e[1]<=e[3]:void w(!1)}function K(e,t,r){let i=0;return 0===r?i=(-e[3]-e[0])/(t[0]-e[0]+t[3]-e[3]):1===r?i=(-e[3]-e[1])/(t[1]-e[1]+t[3]-e[3]):2===r?i=(e[3]-e[0])/(t[0]-e[0]-t[3]+e[3]):3===r&&(i=(e[3]-e[1])/(t[1]-e[1]-t[3]+e[3])),a(o(),e,t,i)}const S=[[0,1,3],[2,3,1],[1,5,2],[6,2,5],[5,4,6],[7,6,4],[4,0,7],[3,7,0],[3,2,7],[6,7,2],[4,5,0],[1,0,5]],V=u(),k=n(),G=d(),U=new y,Q=new P,q=new N;export{P as DepthRangeFromRenderGeometries,O as depthRangeFromLayer,M as depthRangeFromScene,B as textureToDepth};
