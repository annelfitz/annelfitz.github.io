/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import t from"../../../../../core/PooledArray.js";import{fromQuat as e,scale as r}from"../../../../../core/libs/gl-matrix-2/math/mat3.js";import{create as o}from"../../../../../core/libs/gl-matrix-2/factories/mat3f64.js";import{conjugate as n}from"../../../../../core/libs/gl-matrix-2/math/quat.js";import{create as a}from"../../../../../core/libs/gl-matrix-2/factories/quatf64.js";import{k as s,z as c,u as l,s as f,m as i,c as u,t as m,g as b}from"../../../../../chunks/vec32.js";import{create as h}from"../../../../../core/libs/gl-matrix-2/factories/vec3f64.js";import{signedDistance as p}from"../../../../../geometry/support/plane.js";import{empty as g,within as d,union as j}from"../../lib/depthRange.js";function w(t,e){const r=g(),{eye:o,frustum:n,viewForward:a}=t;e.forAll((t=>{const e=null!=t.offsetObb?t.offsetObb:t.obb,l=s(c(C,e.center,o),a),f=e.projectedRadius(a);if(d(r,l-f)&&d(r,l+f))return;const i=M(e,n);if(-1===i)return;if(0===i)return k.far=l+f,k.near=l-f,void j(r,k);const u=x.pushNew();u.near=l-f,u.far=l+f,u.mask=i,u.object=t}));for(let l=0;l<x.length;l++){const t=x.data[l];if(d(r,t.near)&&d(r,t.far))continue;k.far=t.far,k.near=1/0;const e=R(null!=t.object.offsetObb?t.object.offsetObb:t.object.obb,o,y,(e=>{let r=O;for(let o=0;o<F&&e.length>0;o++){if(!(t.mask&1<<o))continue;z(n[o],e,r);const a=e;e=r,r=a}for(let t=0;t<e.length;t+=3){f(q,e.data[t],e.data[t+1],e.data[t+2]);const r=s(c(q,q,o),a);k.near=Math.min(k.near,r)}}));0===e&&(k.near=0),j(r,k)}return x.length=0,r}const x=new t({allocator:t=>t||{near:1/0,far:-1/0,mask:0,object:null},deallocator:t=>(t.object=null,t)}),k=g(),q=h(),v=h(),y=new t({deallocator:null}),O=new t({deallocator:null});function z(t,e,r){r.length=0;const o=e.length-3;A(q,e,o);const n=p(t,q);n<=0&&(r.push(q[0]),r.push(q[1]),r.push(q[2]));let a=0,s=n;for(;a<o;a+=3){A(v,e,a);const o=p(t,v);if(s*o<0){i(q,v,q,o/(o-s)),P(r,q)}o<=0&&P(r,v),s=o,u(q,v)}if(s*n<0){A(v,e,o);i(q,v,q,n/(n-s)),P(r,q)}}function A(t,e,r){return f(t,e.data[r],e.data[r+1],e.data[r+2])}function P(t,e){t.push(e[0]),t.push(e[1]),t.push(e[2])}function R(t,o,a,s){n(B,t.quaternion),c(C,o,t.center),l(C,C,B);const i=t.halfSize,u=8*((C[0]<-i[0]?-1:C[0]>i[0]?1:0)+3*(C[1]<-i[1]?-1:C[1]>i[1]?1:0)+9*(C[2]<-i[2]?-1:C[2]>i[2]?1:0)+13),h=S[u];if(0===h)return h;e(N,t.quaternion),r(N,N,t.halfSize);const p=(e,r)=>{const o=S[u+r+1];return f(e,((1&o)<<1)-1,(2&o)-1,((4&o)>>1)-1),m(e,e,N),b(e,t.center,e)};return a.length=0,P(a,p(D,0)),P(a,p(E,1)),P(a,p(C,2)),P(a,p(G,3)),s(a),1===h?h:(a.length=0,P(a,D),P(a,G),P(a,p(C,4)),P(a,p(H,5)),s(a),2===h||(a.length=0,P(a,D),P(a,H),P(a,p(C,6)),P(a,E),s(a)),h)}const S=(()=>{const t=new Array(216);let e=0;const r=r=>{for(let o=0;o<r.length;o++)t[e+o]=r[o];e+=8};return r([3,0,6,2,3,1,5,4]),r([2,0,2,3,1,5,4,0]),r([3,1,0,2,3,7,5,4]),r([2,0,1,3,2,6,4,0]),r([1,0,1,3,2,0,0,0]),r([2,1,5,7,3,2,0,0]),r([3,2,0,1,3,7,6,4]),r([2,2,0,1,3,7,6,0]),r([3,3,0,1,5,7,6,2]),r([2,0,1,5,4,6,2,0]),r([1,0,1,5,4,0,0,0]),r([2,1,3,7,5,4,0,0]),r([1,0,2,6,4,0,0,0]),r([0,0,0,0,0,0,0,0]),r([1,1,3,7,5,0,0,0]),r([2,2,3,7,6,4,0,0]),r([1,2,3,7,6,0,0,0]),r([2,3,1,5,7,6,2,0]),r([3,4,0,1,5,7,6,2]),r([2,5,7,6,4,0,1,0]),r([3,5,0,1,3,7,6,4]),r([2,4,5,7,6,2,0,0]),r([1,4,5,7,6,0,0,0]),r([2,5,1,3,7,6,4,0]),r([3,6,0,2,3,7,5,4]),r([2,6,2,3,7,5,4,0]),r([3,7,6,2,3,1,5,4]),t})(),F=4;function M(t,e){let r=0;for(let o=0;o<F;o++){const n=t.intersectPlane(e[o]);if(n>0)return-1;0===n&&(r|=1<<o)}return r}const N=o(),B=a(),C=h(),D=h(),E=h(),G=h(),H=h();export{w as computeDepthRange};
