/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import has from"../../../../core/has.js";import{secondsFromMilliseconds as e}from"../../../../core/time.js";import{fromValues as t}from"../../../../core/libs/gl-matrix-2/factories/vec2f64.js";import{create as r}from"../../../../core/libs/gl-matrix-2/factories/vec3f64.js";import{fromValues as a}from"../../../../core/libs/gl-matrix-2/factories/vec4f64.js";import{isColorOrAlpha as i,isOIDorHighlight as s,ShaderOutput as n}from"../core/shaderLibrary/ShaderOutput.js";import{AnimationTimer as o}from"../lib/AnimationTimer.js";import{MaterialParameters as h}from"../lib/Material.js";import{OITPolygonOffsetLimit as m}from"../lib/OrderIndependentTransparency.js";import{RenderSlot as c}from"../lib/RenderSlot.js";import{DefaultBufferWriter as l}from"./DefaultBufferWriter.js";import{PositionUVLayoutObjectAndLayerId as p,PositionUVLayout as f}from"./DefaultLayouts.js";import{TriangleMaterial as u}from"./TriangleMaterial.js";import{WaterGLMaterial as d}from"./WaterGLMaterial.js";import{WaterTechniqueConfiguration as g}from"./WaterTechnique.js";class _ extends u{constructor(e){super(e,new S),this._configuration=new g,this._animation=new o,this.produces=new Map([[c.OPAQUE_MATERIAL,e=>i(e)&&!this.parameters.transparent||s(e)],[c.TRANSPARENT_MATERIAL,e=>i(e)&&this.parameters.transparent||s(e)],[c.DRAPED_MATERIAL,e=>this.parameters.draped&&e===n.Color||s(e)],[c.DRAPED_WATER,e=>e===n.Normal]])}getConfiguration(e,t){return this._configuration.output=e,this._configuration.writeDepth=!0,this._configuration.receiveShadows=this.parameters.receiveShadows,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this.parameters.transparent,this._configuration.hasScreenSpaceReflections=this.parameters.hasScreenSpaceReflections,this._configuration.hasCloudsReflections=this.parameters.hasCloudsReflections,this._configuration.draped=this.parameters.draped,this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.enableOffset=t.camera.relativeElevation<m,this._configuration.multipassEnabled=t.multipassEnabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration}update(t){const r=Math.min(t.camera.relativeElevation,t.camera.distance);this._animation.enabled=Math.sqrt(this.parameters.waveTextureRepeat/this.parameters.waveStrength)*r<b;const a=this._animation.advance(t);return this.setParameters({timeElapsed:e(this._animation.time)*this.parameters.animationSpeed},!1),this._animation.enabled&&a}createGLMaterial(e){return new d(e)}createBufferWriter(){return new l(has("enable-feature:objectAndLayerId-rendering")?p:f)}get test(){return{animationEnabled:this._animation.enabled}}}class S extends h{constructor(){super(...arguments),this.waveStrength=.06,this.waveTextureRepeat=32,this.waveDirection=t(1,0),this.waveVelocity=.05,this.flowStrength=.015,this.flowOffset=-.5,this.animationSpeed=.35,this.timeElapsed=0,this.color=a(0,0,0,0),this.transparent=!0,this.hasSlicePlane=!1,this.draped=!1,this.receiveShadows=!0,this.hasScreenSpaceReflections=!1,this.hasCloudsReflections=!1,this.origin=r(),this.modelTransformation=null}}const b=35e3;export{_ as WaterMaterial,S as WaterMaterialParameters};
