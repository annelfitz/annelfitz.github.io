/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{z as t,s as n,c as o,b as e,n as i}from"../../../../chunks/vec32.js";import{create as s}from"../../../../core/libs/gl-matrix-2/factories/vec3f64.js";import{create as c,setMin as r,setMax as a}from"../../../../geometry/support/aaBoundingBox.js";import{ContentObjectType as f}from"./ContentObjectType.js";import{assert as u}from"./Util.js";import{VertexAttribute as l}from"./VertexAttribute.js";class p{constructor(t=!1,n=!0){this.isVerticalRay=t,this.normalRequired=n}}const m=c();function h(n,o,e,i,s,c){if(!n.visible)return;const r=t(P,i,e),a=(t,n,o)=>{c(t,o,n,!1)},m=new p(!1,o.options.normalRequired);if(n.boundingInfo){u(n.type===f.Mesh);const t=o.tolerance;b(n.boundingInfo,e,r,t,s,m,a)}else{const t=n.attributes.get(l.POSITION),o=t.indices;V(e,r,0,o.length/3,o,t.data,t.stride,s,m,a)}}const d=s();function b(t,n,o,e,i,s,c){if(null==t)return;const f=C(o,d);if(r(m,t.bbMin),a(m,t.bbMax),null!=i&&i.applyToAabb(m),k(m,n,f,e)){const{primitiveIndices:r,position:a}=t,f=r?r.length:a.indices.length/3;if(f>z){const r=t.getChildren();if(void 0!==r){for(const t of r)b(t,n,o,e,i,s,c);return}}g(n,o,0,f,a.indices,a.data,a.stride,r,i,s,c)}}const M=s();function x(n,o,e,i,s,c,r,a,f){const{data:u,stride:l}=c;V(n,t(P,o,n),e,i,s,u,l,r,a,f)}function y(t,n,o,e,i,s,c,r,a,f,u){const l=t[0],p=t[1],m=t[2],h=n[0],d=n[1],b=n[2],{normalRequired:x}=r;for(let y=o;y<e;++y){const t=f[y]+u,n=3*t,o=c*i[n],e=s[o],r=s[o+1],T=s[o+2],g=c*i[n+1],V=s[g],j=s[g+1],R=s[g+2],q=c*i[n+2],I=V-e,O=j-r,A=R-T,B=s[q]-e,C=s[q+1]-r,k=s[q+2]-T,w=d*k-C*b,z=b*B-k*h,P=h*C-B*d,S=I*w+O*z+A*P;if(Math.abs(S)<=N)continue;const U=l-e,D=p-r,E=m-T,F=U*w+D*z+E*P;if(S>0){if(F<0||F>S)continue}else if(F>0||F<S)continue;const G=D*A-O*E,H=E*I-A*U,J=U*O-I*D,K=h*G+d*H+b*J;if(S>0){if(K<0||F+K>S)continue}else if(K>0||F+K<S)continue;const L=(B*G+C*H+k*J)/S;if(L>=0){a(L,t,x?v(I,O,A,B,C,k,M):null)}}}function T(t,n,o,e,i,s,c,r,a,f){const u=t[0],l=t[1],p=t[2],m=n[0],h=n[1],d=n[2],{normalRequired:b}=a;for(let x=o;x<e;++x){const t=3*x,n=c*i[t],o=s[n],e=s[n+1],a=s[n+2],y=c*i[t+1],T=s[y],g=s[y+1],V=s[y+2],j=c*i[t+2],R=s[j],q=s[j+1],I=s[j+2],[O,A,B]=r.applyToVertex(o,e,a,x),[C,k,w]=r.applyToVertex(T,g,V,x),[z,P,S]=r.applyToVertex(R,q,I,x),U=C-O,D=k-A,E=w-B,F=z-O,G=P-A,H=S-B,J=h*H-G*d,K=d*F-H*m,L=m*G-F*h,Q=U*J+D*K+E*L;if(Math.abs(Q)<=N)continue;const W=u-O,X=l-A,Y=p-B,Z=W*J+X*K+Y*L;if(Q>0){if(Z<0||Z>Q)continue}else if(Z>0||Z<Q)continue;const $=X*E-D*Y,_=Y*U-E*W,tt=W*D-U*X,nt=m*$+h*_+d*tt;if(Q>0){if(nt<0||Z+nt>Q)continue}else if(nt>0||Z+nt<Q)continue;const ot=(F*$+G*_+H*tt)/Q;if(ot>=0){f(ot,x,b?v(U,D,E,F,G,H,M):null)}}}function g(t,n,o,e,i,s,c,r,a,f,u){const l=t[0],p=t[1],m=t[2],h=n[0],d=n[1],b=n[2],{normalRequired:x}=f;for(let y=o;y<e;++y){const t=r[y],n=3*t,o=c*i[n];let e=s[o],f=s[o+1],T=s[o+2];const g=c*i[n+1];let V=s[g],j=s[g+1],R=s[g+2];const q=c*i[n+2];let I=s[q],O=s[q+1],A=s[q+2];null!=a&&([e,f,T]=a.applyToVertex(e,f,T,y),[V,j,R]=a.applyToVertex(V,j,R,y),[I,O,A]=a.applyToVertex(I,O,A,y));const B=V-e,C=j-f,k=R-T,w=I-e,z=O-f,P=A-T,S=d*P-z*b,U=b*w-P*h,D=h*z-w*d,E=B*S+C*U+k*D;if(Math.abs(E)<=N)continue;const F=l-e,G=p-f,H=m-T,J=F*S+G*U+H*D;if(E>0){if(J<0||J>E)continue}else if(J>0||J<E)continue;const K=G*k-C*H,L=H*B-k*F,Q=F*C-B*G,W=h*K+d*L+b*Q;if(E>0){if(W<0||J+W>E)continue}else if(W>0||J+W<E)continue;const X=(w*K+z*L+P*Q)/E;if(X>=0){u(X,t,x?v(B,C,k,w,z,P,M):null)}}}function V(e,i,s,c,r,a,f,u,l,p){const m=i,h=S,d=Math.abs(m[0]),b=Math.abs(m[1]),M=Math.abs(m[2]),x=d>=b?d>=M?0:2:b>=M?1:2,y=x,T=m[y]<0?2:1,g=(x+T)%3,V=(x+(3-T))%3,v=m[g]/m[y],O=m[V]/m[y],A=1/m[y],B=j,C=R,k=q,{normalRequired:w}=l;for(let j=s;j<c;++j){const i=3*j,s=f*r[i];n(h[0],a[s+0],a[s+1],a[s+2]);const c=f*r[i+1];n(h[1],a[c+0],a[c+1],a[c+2]);const l=f*r[i+2];n(h[2],a[l+0],a[l+1],a[l+2]),u&&(o(h[0],u.applyToVertex(h[0][0],h[0][1],h[0][2],j)),o(h[1],u.applyToVertex(h[1][0],h[1][1],h[1][2],j)),o(h[2],u.applyToVertex(h[2][0],h[2][1],h[2][2],j))),t(B,h[0],e),t(C,h[1],e),t(k,h[2],e);const m=B[g]-v*B[y],d=B[V]-O*B[y],b=C[g]-v*C[y],M=C[V]-O*C[y],x=k[g]-v*k[y],T=k[V]-O*k[y],R=x*M-T*b,q=m*T-d*x,z=b*d-M*m;if((R<0||q<0||z<0)&&(R>0||q>0||z>0))continue;const N=R+q+z;if(0===N)continue;const P=R*(A*B[y])+q*(A*C[y])+z*(A*k[y]);if(P*Math.sign(N)<0)continue;const S=P/N;if(S>=0){p(S,j,w?I(h):null)}}}const j=s(),R=s(),q=s();function v(t,o,s,c,r,a,f){return n(O,t,o,s),n(A,c,r,a),e(f,O,A),i(f,f),f}function I(n){return t(O,n[1],n[0]),t(A,n[2],n[0]),e(M,O,A),i(M,M),M}const O=s(),A=s();function B(t,o,e){return n(e,1/(o[0]-t[0]),1/(o[1]-t[1]),1/(o[2]-t[2]))}function C(t,o){return n(o,1/t[0],1/t[1],1/t[2])}function k(t,n,o,e){return w(t,n,o,e,1/0)}function w(t,n,o,e,i){const s=(t[0]-e-n[0])*o[0],c=(t[3]+e-n[0])*o[0];let r=Math.min(s,c),a=Math.max(s,c);const f=(t[1]-e-n[1])*o[1],u=(t[4]+e-n[1])*o[1];if(a=Math.min(a,Math.max(f,u)),a<0)return!1;if(r=Math.max(r,Math.min(f,u)),r>a)return!1;const l=(t[2]-e-n[2])*o[2],p=(t[5]+e-n[2])*o[2];return a=Math.min(a,Math.max(l,p)),!(a<0)&&(r=Math.max(r,Math.min(l,p)),!(r>a)&&r<i)}const z=1e3,N=1e-7,P=s(),S=[s(),s(),s()];export{p as MeshIntersectionOptions,B as computeInvDir,C as computeInvDirFromDirection,v as computeNormalFromBarycentric,k as intersectAabbInvDir,w as intersectAabbInvDirBefore,y as intersectRayTriangles,T as intersectRayTrianglesWithDisplacement,h as intersectTriangleGeometry,x as intersectTriangles};
