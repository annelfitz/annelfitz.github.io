/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{lerp as e,deg2rad as t,clamp as a}from"../../../../core/mathUtils.js";import{ViewingMode as r}from"../../../ViewingMode.js";function n(e,t){return new h(e,v,t)}function i(e,t){const{curvatureDependent:a,scaleStart:r,scaleFallOffRange:n}=v;return new h(e,{curvatureDependent:{min:{curvature:a.min.curvature,tiltAngle:a.min.tiltAngle,scaleFallOffFactor:d.curvatureDependent.min.scaleFallOffFactor},max:{curvature:a.max.curvature,tiltAngle:a.max.tiltAngle,scaleFallOffFactor:d.curvatureDependent.max.scaleFallOffFactor}},scaleStart:r,scaleFallOffRange:n,minPixelSize:d.minPixelSize},t)}function c(e){return Math.abs(e*e*e)}function l(e,t,a){const r=a.parameters;return F.scale=Math.min(r.divisor/(t-r.offset),1),F.factor=c(e),F}function s(t,a){return e(t*Math.max(a.scale,a.minScaleFactor),t,a.factor)}function o(e,t,a){const r=l(e,t,a);return r.minScaleFactor=0,s(1,r)}function u(e,t,a,r){r.scale=o(e,t,a),r.factor=0,r.minScaleFactor=a.minScaleFactor}function f(e,t,a=[0,0]){const r=Math.min(Math.max(t.scale,t.minScaleFactor),1);return a[0]=e[0]*r,a[1]=e[1]*r,a}function m(e,t,a,r){return s(e,l(t,a,r))}class h{get minScaleFactor(){return null!=this._fontHeight?Math.min(this._description.minPixelSize/this._fontHeight,1):0}constructor(e,t,a,n=p(),i){this._viewingMode=e,this._description=t,this._ellipsoidRadius=a,this.parameters=n,this._fontHeight=i,this._viewingMode===r.Local?(this._coverageCompensation=this._surfaceCoverageCompensationLocal,this._calculateCurvatureDependentParameters=this._calculateCurvatureDependentParametersLocal):(this._coverageCompensation=this._surfaceCoverageCompensationGlobal,this._calculateCurvatureDependentParameters=this._calculateCurvatureDependentParametersGlobal)}update(e){return(!this.parameters||this.parameters.camera.fovY!==e.fovY||this.parameters.camera.distance!==e.distance)&&(this._calculateParameters(e,this._ellipsoidRadius,this.parameters),!0)}overrideFontHeight(e){return e!==this._fontHeight?new h(this._viewingMode,this._description,this._ellipsoidRadius,this.parameters,e):this}_calculateParameters(e,t,a){const{scaleStart:r,scaleFallOffRange:n}=this._description,{fovY:i,distance:c}=e,l=this._calculateCurvatureDependentParameters(e,t),s=this._coverageCompensation(e,t,l),{tiltAngle:o,scaleFallOffFactor:u}=l,f=Math.sin(o)*c,m=.5*Math.PI-o-i*(.5-r*s),h=f/Math.cos(m),v=m+i*n*s,d=(h-u*(f/Math.cos(v)))/(1-u);return a.camera.fovY=e.fovY,a.camera.distance=e.distance,a.offset=d,a.divisor=h-d,a}_calculateCurvatureDependentParametersLocal(e,t,a=g){return a.tiltAngle=this._description.curvatureDependent.min.tiltAngle,a.scaleFallOffFactor=this._description.curvatureDependent.min.scaleFallOffFactor,a}_calculateCurvatureDependentParametersGlobal(t,r,n=g){const i=this._description.curvatureDependent,c=1+t.distance/r,l=Math.sqrt(c*c-1),[s,o]=[i.min.curvature,i.max.curvature],u=a((l-s)/(o-s),0,1),[f,m]=[i.min,i.max];return n.tiltAngle=e(f.tiltAngle,m.tiltAngle,u),n.scaleFallOffFactor=e(f.scaleFallOffFactor,m.scaleFallOffFactor,u),n}_surfaceCoverageCompensationLocal(e,t,a){return(e.fovY-a.tiltAngle)/e.fovY}_surfaceCoverageCompensationGlobal(e,t,a){const r=t*t,n=a.tiltAngle+.5*Math.PI,{fovY:i,distance:c}=e,l=c*c+r-2*Math.cos(n)*c*t,s=Math.sqrt(l),o=Math.sqrt(l-r);return(Math.acos(o/s)-Math.asin(t/(s/Math.sin(n)))+.5*i)/i}}const v={curvatureDependent:{min:{curvature:t(10),tiltAngle:t(12),scaleFallOffFactor:.5},max:{curvature:t(70),tiltAngle:t(40),scaleFallOffFactor:.8}},scaleStart:.3,scaleFallOffRange:.65,minPixelSize:0},d={curvatureDependent:{min:{scaleFallOffFactor:.7},max:{scaleFallOffFactor:.95}},minPixelSize:14};function p(){return{camera:{distance:0,fovY:0},divisor:0,offset:0}}const F={scale:0,factor:0,minScaleFactor:0},g={tiltAngle:0,scaleFallOffFactor:0};export{f as applyPrecomputedScaleFactor,s as applyScaleFactor,i as getLabelSettings,n as getSettings,u as precomputeScaleFactor,m as scale};
