/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../../chunks/tslib.es6.js";import{disposeMaybe as t,abortMaybe as r}from"../../../../../core/maybe.js";import{throwIfAborted as s,createAbortError as i}from"../../../../../core/promiseUtils.js";import{watch as o,syncAndInitial as a}from"../../../../../core/reactiveUtils.js";import{property as n}from"../../../../../core/accessorSupport/decorators/property.js";import"../../../../../core/has.js";import"../../../../../core/Logger.js";import"../../../../../core/RandomLCG.js";import{subclass as l}from"../../../../../core/accessorSupport/decorators/subclass.js";import{requestImage as u}from"../../../../../support/requestImageUtils.js";import{ColorFormat as h}from"../../../webgl/formats.js";import{SyncRenderPlugin as c,ConsumesCompositeColor as d}from"../RenderPlugin.js";import{SMAABlendWeightsTechnique as m}from"./SMAABlendWeightsTechnique.js";import{SMAABlurTechnique as _}from"./SMAABlurTechnique.js";import{SMAAEdgeDetectTechnique as p}from"./SMAAEdgeDetectTechnique.js";import{SMAAPassParameters as b}from"./SMAAPassParameters.js";import{RenderFeature as x}from"../../lib/RenderFeature.js";import{RenderSlot as T}from"../../lib/RenderSlot.js";import{PixelFormat as f,TextureSamplingMode as g,ClearBufferBit as q,TextureWrapMode as w}from"../../../../webgl/enums.js";import{Texture as C}from"../../../../webgl/Texture.js";import{TextureDescriptor as j}from"../../../../webgl/TextureDescriptor.js";let A=class extends c{constructor(e){super(e),this._context=null,this._areaTexture=null,this._searchTexture=null,this._isEnabled=!1,this._smaaParameters=new b,this.produces=new Map([[T.ANTIALIASING,()=>this._isEnabled&&null!=this._context]])}consumes(){return d}get updating(){return null!=this._abortController}initializeRenderContext(e){this._context=e,this.addHandles([o((()=>this.view.qualitySettings.antialiasingEnabled),(()=>this.renderFeatureChanged()),a)])}renderFeatureChanged(){this.view.qualitySettings.antialiasingEnabled||this._context?.isFeatureEnabled(x.Antialiasing)?this.enable():this.disable()}uninitializeRenderContext(){this.disable(),this._context=null}async enable(){if(this._isEnabled||!this._context||this._abortController)return;if(this._edgeTechnique??=this._context.techniqueRepository.acquire(p),this._blendTechnique??=this._context.techniqueRepository.acquire(m),this._blurTechnique??=this._context.techniqueRepository.acquire(_),this._areaTexture&&this._searchTexture)return void(this._isEnabled=!0);this._abortController=new AbortController;const e=this._abortController.signal;try{const t=await import("./SMAAData.js");await this._loadTextures(this._context,t,e),this._context?.requestRender()}catch{}this._abortController=null}async _loadTextures(e,t,r){if(s(r),!e)throw i();const[o,a]=await Promise.allSettled([u(t.areaTexture,{signal:r}),u(t.searchTexure,{signal:r})]);s(r),"fulfilled"===o.status&&"fulfilled"===a.status&&(this._areaTexture=R(e.fbos.rctx,g.LINEAR,f.RGB,o.value),this._searchTexture=R(e.fbos.rctx,g.NEAREST,f.LUMINANCE,a.value),this._isEnabled=!0)}_disposeTextures(){this._areaTexture=t(this._areaTexture),this._searchTexture=t(this._searchTexture)}disable(){this._abortController=r(this._abortController),this._isEnabled=!1}destroy(){this.disable(),this._disposeTextures()}renderNode(e,t,r,s){const i=r?.get("composite-color")?.getTexture();if(!(this._isEnabled&&this._context&&r&&i))return s;if(!(this._edgeTechnique?.compiled&&this._blendTechnique?.compiled&&this._blurTechnique?.compiled))return this._context.requestRender(),s;const o=i.descriptor.width,a=i.descriptor.height,n=this._context.fbos,l=e.rctx;l.setViewport(0,0,o,a);const u=n.acquire(o,a,"smaa edges",h.RG);l.unbindTexture(u.fbo.colorTexture),l.bindFramebuffer(u.fbo),l.setClearColor(0,0,0,1),l.clear(q.COLOR_BUFFER_BIT),this._smaaParameters.color=i,l.bindTechnique(this._edgeTechnique,null,this._smaaParameters),l.screen.draw();const c=n.acquire(o,a,"smaa blend");return l.unbindTexture(c.fbo.colorTexture),l.bindFramebuffer(c.fbo),l.setClearColor(0,0,1,1),l.clear(q.COLOR_BUFFER_BIT),this._smaaParameters.inputTexture=u.getTexture(),this._smaaParameters.areaTexture=this._areaTexture,this._smaaParameters.searchTexture=this._searchTexture,l.bindTechnique(this._blendTechnique,null,this._smaaParameters),l.screen.draw(),l.bindFramebuffer(s?.fbo),u.release(),l.setClearColor(0,1,0,1),l.clear(q.COLOR_BUFFER_BIT),this._smaaParameters.inputTexture=c.getTexture(),l.bindTechnique(this._blurTechnique,null,this._smaaParameters),l.screen.draw(),c.release(),s}};function R(e,t,r,s){const i=new j;return i.pixelFormat=r,i.wrapMode=w.CLAMP_TO_EDGE,i.width=s.width,i.height=s.height,i.samplingMode=t,new C(e,i,s)}e([n()],A.prototype,"view",void 0),e([n()],A.prototype,"_context",void 0),e([n()],A.prototype,"_abortController",void 0),e([n({readOnly:!0})],A.prototype,"updating",null),A=e([l("esri.views.3d.webgl-engine.effects.smaa.SMAA")],A);export{A as SMAA};
