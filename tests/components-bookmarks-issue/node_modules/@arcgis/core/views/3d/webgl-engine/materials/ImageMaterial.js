/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{BufferViewFloat as t}from"../../../../geometry/support/buffer/BufferView.js";import{ShaderOutput as e,isColorOrAlpha as r,isColorAlphaOrHighlight as s}from"../core/shaderLibrary/ShaderOutput.js";import{CullFaceOptions as a}from"../lib/basicInterfaces.js";import{GLTextureMaterial as i}from"../lib/GLTextureMaterial.js";import{MaterialParameters as n}from"../lib/Material.js";import{OITPolygonOffsetLimit as o}from"../lib/OrderIndependentTransparency.js";import{RenderSlot as p}from"../lib/RenderSlot.js";import{assert as u}from"../lib/Util.js";import{VertexAttribute as c}from"../lib/VertexAttribute.js";import{DefaultBufferWriter as l}from"./DefaultBufferWriter.js";import{PositionUVLayout as h}from"./DefaultLayouts.js";import{TriangleMaterial as m}from"./TriangleMaterial.js";import{writeBufferFloat as f,writeDefaultAttribute as d}from"./internal/bufferWriterUtils.js";import{vertexAttributeLocations as _,ImageMaterialTechniqueConfiguration as g,ImageMaterialTechnique as E}from"../shaders/ImageMaterialTechnique.js";class T extends m{constructor(t){super(t,new A),this.supportsEdges=!0,this.produces=new Map([[p.OPAQUE_MATERIAL,t=>t===e.Highlight||r(t)&&!this.parameters.transparent],[p.TRANSPARENT_MATERIAL,t=>r(t)&&this.parameters.transparent&&this.parameters.writeDepth],[p.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,t=>r(t)&&this.parameters.transparent&&!this.parameters.writeDepth],[p.DRAPED_MATERIAL,t=>s(t)]]),this._vertexAttributeLocations=_,this._configuration=new g}getConfiguration(t,e){return this._configuration.output=t,this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this.parameters.transparent,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.transparencyPassType=e.transparencyPassType,this._configuration.enableOffset=e.camera.relativeElevation<o,this._configuration.multipassEnabled=e.multipassEnabled,this._configuration.cullAboveGround=e.multipassTerrain.cullAboveGround,this._configuration.perspectiveInterpolation=this.parameters.perspectiveInterpolation,this._configuration}createGLMaterial(t){return new I(t)}createBufferWriter(){const t=h.clone();return this.parameters.perspectiveInterpolation&&t.f32(c.PERSPECTIVEDIVIDE),new b(t)}}class I extends i{constructor(t){super({...t,...t.material.parameters})}_updateParameters(t){return this.updateTexture(this._material.parameters.textureId),this._material.setParameters(this.textureBindParameters),this.ensureTechnique(E,t)}_updateOccludeeState(t){t.hasOccludees!==this._material.parameters.hasOccludees&&(this._material.setParameters({hasOccludees:t.hasOccludees}),this._updateParameters(t))}beginSlot(t){return this._output!==e.Color&&this._output!==e.Alpha||this._updateOccludeeState(t),this._updateParameters(t)}}class b extends l{write(e,r,s,a,i){for(const n of this.vertexBufferLayout.fields.keys()){const o=s.attributes.get(n);if(o)if(n===c.PERSPECTIVEDIVIDE){u(1===o.size);const e=a.getField(n,t);e&&f(o,e,i)}else d(n,o,e,r,a,i)}}}class A extends n{constructor(){super(...arguments),this.transparent=!1,this.writeDepth=!0,this.hasSlicePlane=!1,this.cullFace=a.None,this.hasOccludees=!1,this.opacity=1,this.textureId=null,this.initTextureTransparent=!0,this.perspectiveInterpolation=!1}}export{T as ImageMaterial,A as Parameters};
