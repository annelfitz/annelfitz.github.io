/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{s as e,G as t,e as r}from"../../../../chunks/vec32.js";import{create as a}from"../../../../core/libs/gl-matrix-2/factories/vec3f64.js";import{newLayout as i}from"../../support/buffer/InterleavedLayout.js";import{ShaderOutput as s,isColorOrAlpha as n,isColorAlphaHighlightOrDepth as o}from"../core/shaderLibrary/ShaderOutput.js";import{GLTextureMaterial as h}from"../lib/GLTextureMaterial.js";import{Material as c,RenderOccludedFlag as u}from"../lib/Material.js";import{RenderSlot as p}from"../lib/RenderSlot.js";import{VertexAttribute as l}from"../lib/VertexAttribute.js";import{VisualVariablePassParameters as m}from"./VisualVariablePassParameters.js";import{vertexAttributeLocations as d,LineMarkerTechnique as T}from"../shaders/LineMarkerTechnique.js";import{LineMarkerTechniqueConfiguration as _,LineMarkerSpace as f,LineMarkerAnchor as A}from"../shaders/LineMarkerTechniqueConfiguration.js";import{CapType as E}from"../shaders/RibbonLineTechniqueConfiguration.js";class v extends c{constructor(e){super(e,new S),this.produces=new Map([[p.OPAQUE_MATERIAL,e=>e===s.Highlight||n(e)&&this.parameters.renderOccluded===u.OccludeAndTransparentStencil],[p.OPAQUE_NO_SSAO_DEPTH,e=>e===s.LinearDepth],[p.OCCLUDER_MATERIAL,e=>o(e)&&this.parameters.renderOccluded===u.OccludeAndTransparentStencil],[p.TRANSPARENT_OCCLUDER_MATERIAL,e=>o(e)&&this.parameters.renderOccluded===u.OccludeAndTransparentStencil],[p.TRANSPARENT_MATERIAL,e=>n(e)&&this.parameters.writeDepth],[p.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,e=>n(e)&&!this.parameters.writeDepth],[p.DRAPED_MATERIAL,e=>e===s.Color||e===s.Highlight]]),this._vertexAttributeLocations=d,this._configuration=new _,this._layout=this.createLayout()}getConfiguration(e,t){return this._configuration.output=e,this._configuration.space=t.slot===p.DRAPED_MATERIAL?f.Draped:this.parameters.worldSpace?f.World:f.Screen,this._configuration.hideOnShortSegments=this.parameters.hideOnShortSegments,this._configuration.hasCap=this.parameters.cap!==E.BUTT,this._configuration.anchor=this.parameters.anchor,this._configuration.hasTip=this.parameters.hasTip,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.vvSize=!!this.parameters.vvSize,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.vvOpacity=!!this.parameters.vvOpacity,this._configuration.occluder=this.parameters.renderOccluded===u.OccludeAndTransparentStencil,this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.multipassEnabled=t.multipassEnabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration}intersect(){}createLayout(){const e=i().vec3f(l.POSITION).vec3f(l.PREVPOSITION).vec2f(l.UV0);return this.parameters.worldSpace&&e.vec3f(l.NORMAL),this.parameters.vvSize?e.f32(l.SIZEFEATUREATTRIBUTE):e.f32(l.SIZE),this.parameters.vvColor?e.f32(l.COLORFEATUREATTRIBUTE):e.vec4f(l.COLOR),this.parameters.vvOpacity&&e.f32(l.OPACITYFEATUREATTRIBUTE),e}createBufferWriter(){return new g(this._layout,this.parameters)}createGLMaterial(e){return new O(e)}}class O extends h{constructor(){super(...arguments),this._markerPrimitive=null}dispose(){super.dispose(),this._markerTextureRepository.release(this._markerPrimitive),this._markerPrimitive=null}_updateParameters(e){const t=this._material.parameters.markerPrimitive;return t!==this._markerPrimitive&&(this._material.setParameters({markerTexture:this._markerTextureRepository.swap(t,this._markerPrimitive)}),this._markerPrimitive=t),this._material.setParameters(this.textureBindParameters),this.ensureTechnique(T,e)}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}beginSlot(e){return this._output!==s.Color&&this._output!==s.Alpha||this._updateOccludeeState(e),this._updateParameters(e)}}class S extends m{constructor(){super(...arguments),this.width=0,this.color=[1,1,1,1],this.markerPrimitive="arrow",this.placement="end",this.cap=E.BUTT,this.anchor=A.Center,this.hasTip=!1,this.worldSpace=!1,this.hideOnShortSegments=!1,this.writeDepth=!0,this.hasSlicePlane=!1,this.vvFastUpdate=!1,this.hasOccludees=!1,this.markerTexture=null}}class g{constructor(e,t){this.vertexBufferLayout=e,this._parameters=t}elementCount(){return"begin-end"===this._parameters.placement?12:6}write(a,i,s,n,o){const h=s.attributes.get(l.POSITION).data,c=h.length/3;let u=[1,0,0];const p=s.attributes.get(l.NORMAL);this._parameters.worldSpace&&null!=p&&(u=p.data);let m=1,d=0;this._parameters.vvSize?d=s.attributes.get(l.SIZEFEATUREATTRIBUTE).data[0]:s.attributes.has(l.SIZE)&&(m=s.attributes.get(l.SIZE).data[0]);let T=[1,1,1,1],_=0;this._parameters.vvColor?_=s.attributes.get(l.COLORFEATUREATTRIBUTE).data[0]:s.attributes.has(l.COLOR)&&(T=s.attributes.get(l.COLOR).data);let f=0;this._parameters.vvOpacity&&(f=s.attributes.get(l.OPACITYFEATUREATTRIBUTE).data[0]);const A=new Float32Array(n.buffer);let E=o*(this.vertexBufferLayout.stride/4);const v=(e,t,r,a)=>{if(A[E++]=e[0],A[E++]=e[1],A[E++]=e[2],A[E++]=t[0],A[E++]=t[1],A[E++]=t[2],A[E++]=r[0],A[E++]=r[1],this._parameters.worldSpace&&(A[E++]=u[0],A[E++]=u[1],A[E++]=u[2]),this._parameters.vvSize?A[E++]=d:A[E++]=m,this._parameters.vvColor)A[E++]=_;else{const e=Math.min(4*a,T.length-4);A[E++]=T[e],A[E++]=T[e+1],A[E++]=T[e+2],A[E++]=T[e+3]}this._parameters.vvOpacity&&(A[E++]=f)};let O;!function(e){e[e.ASCENDING=1]="ASCENDING",e[e.DESCENDING=-1]="DESCENDING"}(O||(O={}));const S=(i,s)=>{const n=e(R,h[3*i],h[3*i+1],h[3*i+2]),o=P;let u=i+s;do{e(o,h[3*u],h[3*u+1],h[3*u+2]),u+=s}while(t(n,o)&&u>=0&&u<c);a&&(r(n,n,a),r(o,o,a)),v(n,o,[-1,-1],i),v(n,o,[1,-1],i),v(n,o,[1,1],i),v(n,o,[-1,-1],i),v(n,o,[1,1],i),v(n,o,[-1,1],i)},g=this._parameters.placement;"begin"!==g&&"begin-end"!==g||S(0,O.ASCENDING),"end"!==g&&"begin-end"!==g||S(c-1,O.DESCENDING)}}const R=a(),P=a();export{v as LineMarkerMaterial,S as Parameters};
