/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import e from"../../../../core/Logger.js";import o from"../../../../core/PooledArray.js";import{hasFeatureFlagWebGLDebug as s}from"../../../webgl/checkWebGLError.js";class r{constructor(e){this._context=e,this._nodes=new o}destroy(){this._nodes.forEach((e=>e.destroy())),this._nodes.clear()}add(e){this._nodes.push(e),s&&console.log(`Registered render nodes: ${this._nodes.map((({declaredClass:e})=>e)).join(", ")}`)}remove(e){this._nodes.remove(e),s&&console.log(`Registered render nodes: ${this._nodes.map((({declaredClass:e})=>e)).join(", ")}`)}produces(e){return this._nodes.some((({produces:o})=>o===e))}require(e,o){return this._nodes.reduce(((s,{consumes:r,produces:t})=>s+(r.required.includes(e)&&t===o?1:0)),0)}optional(e,o){return this._nodes.reduce(((s,{consumes:r,produces:t})=>s+(r.optional?.includes(e)&&t===o?1:0)),0)}updateAnimation(){return this._nodes.reduce(((e,o)=>o.updateAnimation()||e),!1)}render(o,s,r){const t=o.name,n=this._nodes.filter((({produces:e})=>e===t));return 0===n.length||(n.forEach((n=>{const c=[o];for(const e of n.consumes.required){if(e===t)continue;const o=s.get(e);if(!o)return void r(c);c.push(o)}if(n.consumes.optional)for(const e of n.consumes.optional){if(e===t)continue;const o=s.get(e);o&&c.push(o)}try{const e=n.doRender(c,this._context);e&&e!==o&&(o.release(),o=e,s.set(t,o))}catch(d){e.getLogger(n).errorOnce(d)}r(c)})),this._context.rctx.enforceState()),o}}export{r as RenderNodes};
