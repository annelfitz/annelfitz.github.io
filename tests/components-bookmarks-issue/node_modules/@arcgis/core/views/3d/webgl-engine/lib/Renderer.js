/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../chunks/tslib.es6.js";import{update as r}from"../../../../core/arrayUtils.js";import{createTask as t}from"../../../../core/asyncUtils.js";import{unitRGBAFromColor as s}from"../../../../core/colorUtils.js";import has from"../../../../core/has.js";import{removeMaybe as i,abortMaybe as a,destroyMaybe as n,releaseMaybe as h}from"../../../../core/maybe.js";import o from"../../../../core/PooledArray.js";import{throwIfAborted as d}from"../../../../core/promiseUtils.js";import{watch as l,syncAndInitial as _,initial as p,sync as u}from"../../../../core/reactiveUtils.js";import{signal as c}from"../../../../core/signal.js";import{property as m}from"../../../../core/accessorSupport/decorators/property.js";import"../../../../core/Logger.js";import"../../../../core/accessorSupport/interfaces.js";import"../../../../core/accessorSupport/tracking/Flags.js";import"../../../../core/Warning.js";import"../../../../core/Error.js";import{equals as g,invert as f,multiply as T}from"../../../../core/libs/gl-matrix-2/math/mat4.js";import{IDENTITY as E,create as A}from"../../../../core/libs/gl-matrix-2/factories/mat4f64.js";import{s as b}from"../../../../chunks/vec42.js";import{fromValues as R,ZEROS as P}from"../../../../core/libs/gl-matrix-2/factories/vec4f64.js";import{a as S}from"../../../../chunks/boundedPlane.js";import{debugFlags as C}from"../../support/debugFlags.js";import{TransparencyMode as w}from"../../terrain/TerrainRenderer.js";import{DepthFormat as I,ColorFormat as O}from"../../webgl/formats.js";import{FBOCache as y}from"../core/FBOCache.js";import{RenderPassManager as D}from"../core/renderPasses/RenderPassManager.js";import{ShaderOutput as N}from"../core/shaderLibrary/ShaderOutput.js";import{HUDRenderStyle as L}from"../core/shaderLibrary/hud/HUDRenderStyle.js";import{RenderNodes as H}from"../effects/RenderNodes.js";import{isPrepareRenderPlugin as M}from"../effects/RenderPlugin.js";import{RenderPluginManager as x}from"../effects/RenderPluginManager.js";import{Blit as v}from"../effects/blit/Blit.js";import{Highlight as F}from"../effects/highlight/Highlight.js";import{ShadowHighlight as U}from"../effects/highlight/ShadowHighlight.js";import{SMAA as q}from"../effects/smaa/SMAA.js";import{SSAO as j}from"../effects/ssao/SSAO.js";import{AnimationTimeStep as G}from"./AnimationTimeStep.js";import{Decorations as B,RenderRequestType as V,StencilBits as Q}from"./basicInterfaces.js";import{BoundingInfo as k}from"./BoundingInfo.js";import{zero as W,union as X}from"./depthRange.js";import{depthRangeFromScene as Y}from"./depthRangeUtils.js";import{RenderOccludedFlag as z}from"./Material.js";import{OffscreenRendering as J}from"./OffscreenRendering.js";import{RenderContext as K,defaultRenderOccludedMask as Z}from"./RenderContext.js";import{splitRenderGeometryChangeSetByMaterial as $,RendererTarget as ee}from"./rendererUtils.js";import{setupFeatureDefaults as re,RenderFeature as te}from"./RenderFeature.js";import{RenderSlot as se}from"./RenderSlot.js";import{ShadowAccumulator as ie}from"./ShadowAccumulator.js";import{ShadowMap as ae,SnapshotSlot as ne}from"./ShadowMap.js";import he from"./SliceHelper.js";import{TransparencyPassType as oe}from"./TransparencyPassType.js";import{Transparency as de}from"./edgeRendering/interfaces.js";import{MergedRenderer as le}from"../materials/renderers/MergedRenderer.js";import{AlphaMode as _e}from"../shaders/CompositingTechniqueConfiguration.js";import{RendererPerformanceInfo as pe,PerformanceCategory as ue}from"../statistics/RendererPerformanceInfo.js";import{RenderState as ce}from"../../../support/RenderState.js";import{PixelFormat as me,PixelType as ge,ClearBufferBit as fe,DepthStencilAttachment as Te}from"../../../webgl/enums.js";class Ee{constructor(e,r,t,i,a,n,h,o){this._stage=e,this._techniqueRepository=i,this._rctx=a,this._compositingHelper=n,this._magnifierHelper=h,this._requestRender=o,this._pluginsHas={hudElements:!1,water:!1},this._hasOverlayWater=!1,this.renderOverlay=e=>{},this._isRendering=!1,this._backgroundColor=R(0,0,0,1),this._sliceHelper=new he,this._state=c(ce.IDLE),this._highQualityTransparencyEnabled=!0,this._terrainTransparency=w.Opaque,this._ssrEnabled=!1,this._hasAnimations=!1,this._animationTimestep=new G,this._loadEdgeViewTask=null,this._edgeViewCallbacks=[],this._reprojectionMatrixVersion=c(0),this._renderHiddenTransparentEdges=()=>{},this._pluginInput=new Map,this._releaseNormals=e=>{e.find((({name:e})=>"normals"===e))?.release()&&this._pluginInput.delete("normals")},this._debugLinearDepth=!1,this.fboCache=new y(a),this._renderStateFeatures=c(re(!has("disable-feature:high-quality-idle"),e.view.qualityProfile)),this._offscreen=new J(this.fboCache,this._compositingHelper),this.performanceInfo=new pe(this._rctx),this._shadowMap=new ae(this.fboCache,e.viewingMode),this._highlight=new F({view:e.view}),this._shadowHighlight=new U({view:e.view,viewingMode:e.viewingMode}),this._shadowAccumulator=new ie(this.fboCache,i,e,(e=>{const r=this.shadowsEnabled;this._shadowMap.enabled=!0,this._ensureBindParametersCamera(e.camera,e.contentCamera),this._plugins.prepareRender(),this._shadowMap.enabled=r}),((e,r,t)=>{const s=this._stage.view.qualitySettings.maximumPixelRatio;e.shadowMap.start(e.camera,r,t,!0,s),this._renderShadowCascades(N.Shadow,e.shadowMap),e.shadowMap.finish(),e.camera.setGLViewport(this._rctx),this._ensureBindParametersCamera(e.camera,e.contentCamera)}),o),this._ssao=new j({view:this._stage.view}),this._renderContext=new K(this._rctx,this._offscreen,this._shadowMap,this._sliceHelper),this._nodes=new H(this._renderContext),this._plugins=new x({renderContext:this._renderContext,techniqueRepository:i,textureRepository:t,materialRepository:r,requestRender:o,controller:e,fbos:this.fboCache,isFeatureEnabled:e=>this.isFeatureEnabled(e)}),this.renderPassManager=new D,this._plugins.add(this.renderPassManager),this._smaa=new q({view:this._stage.view}),this._plugins.add(this._smaa),this._blit=new v({opacity:1,alphaMode:_e.None}),this._plugins.add(this._blit),this._plugins.add(this._ssao),this._plugins.add(this._highlight),this._plugins.add(this._shadowHighlight),this._handles=[l((()=>this._stage.view.state.camera),(()=>o()),_),l((()=>C.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES),(e=>{this._renderHiddenTransparentEdges=e?()=>this._renderEdges(de.TRANSPARENT):()=>{},o()}),p),l((()=>this._stage.view.environment.background?.color),(e=>{const r=e?s(e):P;b(this._backgroundColor,r[0]*r[3],r[1]*r[3],r[2]*r[3],r[3]),o()}),_)]}destroy(){this._handles.forEach((e=>e.remove())),this._gpuTimerHandle=i(this._gpuTimerHandle),this._nodes.destroy(),this._offscreen.dispose(),this._shadowMap.dispose(),this._highlight.dispose(),this._shadowAccumulator.dispose(),this._loadEdgeViewTask=a(this._loadEdgeViewTask),this._edgeView=n(this._edgeView),this.renderPassManager.dispose(),this._releaseFBOs(),this._disposeOffscreenBuffers(),this.fboCache.destroy(),this._plugins.destroy(),k.prune()}get _bindParameters(){return this._renderContext.bindParameters}updateRenderFeatures(e=null,r=!has("disable-feature:high-quality-idle")){this._renderStateFeatures.value=re(r,e),this._plugins.renderFeatureChanged(),this._requestRender()}isFeatureEnabled(e,r=this._state.value){return this._renderStateFeatures.value.get(r,e)??!1}setFeatureEnabled(e,r,t){this._renderStateFeatures.mutate((s=>s.set(r,e,t))),this._requestRender()}get _highQualityTransparency(){return this._highQualityTransparencyEnabled||this.isFeatureEnabled(te.HighQualityTransparency)}get hasReflections(){return(this._pluginsHas.water||this._hasOverlayWater)&&(this._ssrEnabled||this.isFeatureEnabled(te.WaterReflection))}get hasDecorations(){return this._plugins.hasDecorations}get hasHighlights(){return this._plugins.produces(se.OPAQUE_MATERIAL,N.Highlight)||this._plugins.produces(se.TRANSPARENT_MATERIAL,N.Highlight)||this._plugins.produces(se.DRAPED_MATERIAL,N.Highlight)}get _magnifierEnabled(){return this._bindParameters.decorations===B.ON&&this._magnifierHelper.enabled}get fullResolutionAtmosphere(){return this._stage.view.qualitySettings.highResolutionAtmosphere||this.isFeatureEnabled(te.HighResolutionAtmosphere)}_releaseFBOs(){this._bindParameters.ssr.lastFrameColor=h(this._bindParameters.ssr.lastFrameColor),this._bindParameters.multipassTerrain.linearDepth=h(this._bindParameters.multipassTerrain.linearDepth),this._bindParameters.multipassGeometry.linearDepth=h(this._bindParameters.multipassGeometry.linearDepth)}_disposeOffscreenBuffers(){this._offscreen.dispose(),this._disposeBindBuffers()}_disposeBindBuffers(){this._shadowMap.disposeOffscreenBuffers(),this._bindParameters.linearDepth=h(this._bindParameters.linearDepth),this._bindParameters.hudVisibility=h(this._bindParameters.hudVisibility)}get updating(){return this._smaa.updating||null!=this._edgeView&&this._edgeView.updating||this._shadowAccumulator.running||this._plugins.updating||!this.isCameraFinal}loadEdgeView(){return this._loadEdgeViewTask||(this._loadEdgeViewTask=t((async e=>{const{EdgeView:r}=await import("./edgeRendering/EdgeView.js");d(e);const t=this._edgeView=new r({rctx:this._rctx,renderSR:this._stage.view.renderSpatialReference,viewingMode:this._stage.viewingMode,techniqueRepository:this._techniqueRepository,setNeedsRender:()=>this._requestRender(),schedule:Ie(this._stage.view.resourceController)});return this._handles.push(l((()=>t.updating),(()=>this._requestRender()),u)),this._requestRender(),this._edgeViewCallbacks.forEach((e=>e(t))),this._edgeViewCallbacks.length=0,t}))),this._loadEdgeViewTask.promise}withEdgeView(e){this.loadEdgeView(),null==this._edgeView?this._edgeViewCallbacks.push(e):e(this._edgeView)}get edgeView(){return this._edgeView}get isCameraFinal(){return this._reprojectionMatrixVersion.value>=0&&g(this._bindParameters.ssr.reprojectionMatrix,E)}set _reprojectionMatrix(e){r(this._bindParameters.ssr.reprojectionMatrix,e)&&this._reprojectionMatrixVersion.value++}get shadowsEnabled(){return!!this._shadowMap?.enabled}setParameters(e){const{_shadowMap:r,_bindParameters:t}=this;if(void 0!==e.qualitySettings?.reflections&&this._ssrEnabled!==e.qualitySettings.reflections&&(this._ssrEnabled=e.qualitySettings.reflections,this._requestRender()),void 0!==e.shadowMap&&this._shadowMap.enabled!==e.shadowMap&&(this._shadowMap.enabled=e.shadowMap,this._requestRender()),void 0!==e.shadowMapMaxCascades&&r.maxCascades!==e.shadowMapMaxCascades&&(r.maxCascades=e.shadowMapMaxCascades,this._requestRender()),null!=e.environment){null!=e.environment.weather&&(this._bindParameters.weather=e.environment.weather,this._bindParameters.weatherVisible=!!e.weatherVisible);const r="virtual"!==e.environment.lighting.type;t.enableFillLights!==r&&(t.enableFillLights=r,this._requestRender())}void 0!==e.highQualityTransparency&&this._highQualityTransparencyEnabled!==e.highQualityTransparency&&(this._highQualityTransparencyEnabled=e.highQualityTransparency,this._requestRender()),void 0!==e.hasOverlayWater&&this._hasOverlayWater!==e.hasOverlayWater&&(this._hasOverlayWater=e.hasOverlayWater,this._requestRender()),void 0!==e.slicePlane&&this._sliceHelper.plane!==e.slicePlane&&(this._sliceHelper.plane=e.slicePlane,this._requestRender()),void 0!==e.terrainTransparency&&this._terrainTransparency!==e.terrainTransparency&&(this._terrainTransparency=e.terrainTransparency,this._requestRender()),void 0!==e.shadowCastOptions&&this._shadowAccumulator.setOptions(e.shadowCastOptions)}get hasSlicePlane(){return!!this._sliceHelper.plane}get plugins(){return this._plugins}get _hasOITSupport(){return this._rctx.driverTest.floatBufferBlend.result}get _oitEnabled(){return this._highQualityTransparency&&this._hasOITSupport}modify(e,r){this._isRendering&&console.warn("Renderer.modify called while rendering");const{adds:t,removes:s,updates:i}=e;if(0===t.length&&0===s.length&&0===i.length)return;const a=$(e);let n=!1;a.forEach(((t,s)=>{if(r.done)return;let i=this._plugins.getMaterialRenderer(s);if(null==i&&t.adds.length>0){const e=new le({material:s});e.initializeRenderContext(this._plugins._context),i=e,this._plugins.add(i)}i&&(i.modify(t),0===i.numGeometries&&(n=!0)),t.removes.forEach((r=>e.removes.removeUnordered(r))),t.adds.forEach((r=>e.adds.removeUnordered(r))),t.updates.forEach((r=>e.updates.removeUnordered(r))),r.madeProgress()})),n&&this._plugins.removeEmptyMaterialRenderers(),this._updateHasFlags(),this._requestRender()}_updateHasFlags(){const has=this._pluginsHas;has.hudElements=this._plugins.produces(se.LINE_CALLOUTS_HUD_DEPTH)||this._plugins.produces(se.HUD_MATERIAL)||this._plugins.produces(se.LABEL_MATERIAL),has.water=this._plugins.produces(se.DRAPED_WATER,N.Normal),this._bindParameters.hasOccludees=this._plugins.hasOccludees}updateAnimation(e){const r=this._hasAnimations;return this._hasAnimations=this._plugins.updateAnimation(e),this._hasAnimations=this._nodes.updateAnimation()||this._hasAnimations,this._hasAnimations!==r&&(this._gpuTimerHandle=r?i(this._gpuTimerHandle):this.performanceInfo.enableGPUPerformanceInfo()),this._hasAnimations}get animationTimestep(){return this._animationTimestep.value}get animationTimeDilation(){return this._animationTimestep.timeDilation}resetAnimation(){this._animationTimestep.clear()}tick(){this.fboCache.clean()}render(e,r,t=ee.Default,s=B.ON){this._isRendering=!0,this.performanceInfo.startFrame(),this.fboCache.frameStart(),this._disposeBindBuffers();const i=this._offscreen,{camera:a,contentCamera:n,mode:o,alignPixelEnabled:d}=e;this._state.value=o,this._bindParameters.overlay=this.renderOverlay(r),this.performanceInfo.advance(ue.OVERLAY),this._renderContext.time=r,this._bindParameters.transparencyPassType=oe.NONE,this._bindParameters.alignPixelEnabled=d,this._bindParameters.decorations=s,this._bindParameters.mainColor=this._bindParameters.mainDepth=null;const l=S(this._sliceHelper.plane);s===B.OFF&&(this._sliceHelper.plane=null),a.setGLViewport(this._rctx);const _=i.initializeFrame(a,this._backgroundColor,t);this.hasReflections?this._bindParameters.ssr.lastFrameColor=_:_?.release(),this._ensureBindParametersCamera(a,n),this._plugins.prepareRender(),this.performanceInfo.advance(ue.PREPARE);const p=this._computeDepthRange(a);this._renderShadowMap(a,this._bindParameters.lighting.mainLight.direction,p),this.performanceInfo.advance(ue.SHADOW_MAP),this._ensureBindParametersCamera(a,n);const u=this._plugins.produces(se.OPAQUE_TERRAIN)&&(this._terrainTransparency===w.Semitransparent||this._terrainTransparency===w.TransparentWithDraped),c=this._highQualityTransparency&&u,m=this._plugins.produces(se.TRANSPARENT_MATERIAL,N.Color);this._prepareShaders(c,m),this._pluginInput.set("normals",this._renderNormals()),this.performanceInfo.advance(ue.NORMALS),this._renderSSAO(),this.performanceInfo.advance(ue.SSAO),this._renderLinearDepth(),this.performanceInfo.advance(ue.LINEAR_DEPTH),this._renderShadowAccumulation(p,a,n),this.performanceInfo.advance(ue.ACCUMULATED_SHADOWS),this._ensureBindParametersSSR(r),this._renderContext.output=N.Color,i.bindFbo(),this._bindParameters.mainColor=i.colorTexture,this._bindParameters.mainDepth=i.depthTexture,this._renderOpaqueGeometry(),this._offscreen.updateColor((e=>this._invokeRenderNodes(e)),"opaque-color"),this._plugins.render(se.ENVIRONMENT_OPAQUE),this.performanceInfo.advance(ue.OPAQUE),this.fboCache.debugCallback&&this.fboCache.debugCallback("opaque-color",this._offscreen.color.fbo),this._renderTerrainLinearDepth(c),this._setMultipassTerrain(c),this._renderEdges(de.OPAQUE),this.performanceInfo.advance(ue.OPAQUE_EDGES),i.bindFbo(),this._plugins.render(se.VOXEL),this.performanceInfo.advance(ue.VOXEL),this._renderHiddenTransparentEdges(),m&&(this._oitEnabled?this._renderOITPass(Ae.Geometry):this._renderTransparentMaterial()),this._offscreen.updateColor((e=>this._invokeRenderNodes(e)),"transparent-color"),this.performanceInfo.advance(ue.TRANSPARENT);const g=this._renderGeometryLinearDepth(c);this._renderHUDVisibility(g),c||this._plugins.render(se.LINE_CALLOUTS),this.performanceInfo.advance(ue.HUD_VISIBILITY);const f=t===ee.ObjectAndLayerID?this._renderObjectAndLayerIdColor():null;this.performanceInfo.advance(ue.OBJECT_AND_LAYER_ID_COLOR),this._renderEdges(de.TRANSPARENT,g),g?.release(),this.performanceInfo.advance(ue.TRANSPARENT_EDGES);const T=u?this._renderTransparentTerrain():null;T&&this._bindParameters.hudVisibility&&(c?this._renderLineCallouts(L.Occluded):i.compositeToHUDVisibility(this._bindParameters,T.getTexture()),this._renderHUD(L.Occluded,i.color),this.performanceInfo.advance(ue.HUD_OCCLUDED)),this.performanceInfo.advance(ue.TRANSPARENT_TERRAIN),this._setTerrainCulling(!1),T&&(i.compositeToFramebuffer(this._bindParameters,T.getTexture(),_e.PremultipliedAlpha,1),T.release(),c&&(this._renderEdges(de.OPAQUE),this.performanceInfo.advance(ue.OPAQUE_EDGES),m&&(this._oitEnabled?this._renderOITPass(Ae.Geometry):this._renderTransparentMaterial()),this.performanceInfo.advance(ue.TRANSPARENT),this._renderEdges(de.TRANSPARENT),this.performanceInfo.advance(ue.TRANSPARENT_EDGES))),this._bindParameters.ssao=h(this._bindParameters.ssao),c&&this._renderLineCallouts(L.NotOccluded),this._setMultipassEnabled(!1),this._shadowAccumulator.render(this._bindParameters),i.bindFbo(),this._plugins.render(se.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL),this._plugins.render(se.ENVIRONMENT_TRANSPARENT),this.performanceInfo.advance(ue.ENVIRONMENT),this._renderLaserlines(),this.performanceInfo.advance(ue.LASER_LINES),this._renderOccluded(),this.performanceInfo.advance(ue.OCCLUDED);let E=this._renderHighlightPrepass();E&&this._renderShadowHighlights(E,this._bindParameters);const A=this._magnifierEnabled&&t===ee.Default?this.fboCache.acquire(this._offscreen.width,this._offscreen.height,"magnifier"):null,b=t!==ee.Default?this.fboCache.acquire(this._offscreen.width,this._offscreen.height,"screenshot"):null,R=this._renderComposite(A??b,E)??b;return this.performanceInfo.advance(ue.ANTIALIASING),this._renderHUD(L.NotOccluded,R),this.performanceInfo.advance(ue.HUD),E&&(this._renderHighlights(R,E,this._bindParameters),E=h(E)),this.performanceInfo.advance(ue.HIGHLIGHTS),this._magnifierEnabled&&this._magnifierHelper.render(this._rctx,this._bindParameters),R!==b&&(this._rctx.bindFramebuffer(b?.fbo),this._compositingHelper.composite(this._bindParameters,A?.getTexture(),_e.None)),t===ee.Default&&A?.release(),this.onPostRender&&this.onPostRender(),this._releaseFBOs(),this._offscreen.releaseBuffers(),this._renderContext.lastFrameCamera.copyFrom(this._bindParameters.camera),this._sliceHelper.plane=l,this._isRendering=!1,this.fboCache.frameEnd(),this.performanceInfo.finishFrame(),t!==ee.Default&&(this._releaseFBOs(),this._disposeOffscreenBuffers()),{screen:b,oid:f}}_prepareShaders(e,r){this._renderContext.output=N.Color,this._prepareOpaqueGeometry(),this._setMultipassTerrain(e),this._plugins.prepare(se.TRANSPARENT_TERRAIN),this._setMultipassTerrain(!1),e||this._plugins.prepare(se.LINE_CALLOUTS),r&&this._prepareTransparencySlots(),this._plugins.prepare(se.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL),this._plugins.prepare(se.ENVIRONMENT_TRANSPARENT),this._plugins.prepare(se.LASERLINES),this._rctx.gl.flush()}_renderObjectAndLayerIdColor(){if(!has("enable-feature:objectAndLayerId-rendering"))return;const e=this._renderContext.output,r=this.fboCache.acquire(this._offscreen.width,this._offscreen.height,"oid");return r.acquireDepth(I.DEPTH_STENCIL_TEXTURE),this._rctx.bindFramebuffer(r.fbo),this.fboCache.rctx.clearFramebuffer([0,0,0,0],!0,!0),this._renderAllGeometry(N.ObjectAndLayerIdColor),this._rctx.bindFramebuffer(r.fbo),this.fboCache.rctx.clearFramebuffer(void 0,!0,!0),this._bindParameters.hudRenderStyle=L.NotOccluded,this._plugins.render(se.HUD_MATERIAL),this._renderContext.output=e,r}finish(e){this._hasAnimations||this._animationTimestep.clear();const r=this.performanceInfo.gpuSamplingEnabled,t=e===V.BACKGROUND;if(t||r){const e=t?this.performanceInfo.elapsedTime:0,s=r?this.performanceInfo.totalGPUTimeSampler.last:this._rctx.gl.getError(),i=Math.max(e,s);this._animationTimestep.frame(i,t)}}readDepthPixels(e,r,t){const s=this._bindParameters.linearDepth?.fbo;if(s?.colorTexture)return void s.readPixels(r[0],r[1],r[2],r[3],me.RGBA,ge.UNSIGNED_BYTE,t);const i=this.fboCache.acquire(this._offscreen.width,this._offscreen.height,"depth").acquireDepth(I.DEPTH16_BUFFER);this._rctx.bindFramebuffer(i.fbo),this._ensureBindParametersCamera(e,e),this._bindParameters.camera.setGLViewport(this._rctx),this._rctx.setClearColor(0,0,0,0);const a=fe.COLOR_BUFFER_BIT|fe.DEPTH_BUFFER_BIT|fe.STENCIL_BUFFER_BIT;this._rctx.clear(a),this._renderAllGeometry(N.LinearDepth),i.fbo.readPixels(r[0],r[1],r[2],r[3],me.RGBA,ge.UNSIGNED_BYTE,t),i.release()}readHUDVisibility(e,r,t,s,i){this._bindParameters.hudVisibility?.fbo.readPixels(e,r,t,s,me.RGBA,ge.UNSIGNED_BYTE,i)}readAccumulatedShadow(e){return this._shadowAccumulator.readAccumulatedShadow(e[0],e[1])}_setMultipassTerrain(e){this._setMultipassEnabled(e),this._setTerrainCulling(e)}_setMultipassEnabled(e){this._bindParameters.multipassEnabled=e}_setTerrainCulling(e){this._bindParameters.multipassTerrain.cullAboveGround=e}_renderEdges(e,r){const t=this._edgeView;if(t?.shouldRender()){const{width:s,height:i,depth:a}=this._offscreen,n=this.fboCache.acquire(s,i,"edges"),h=()=>t.render(this._bindParameters,e);this._offscreen.renderToTargets(h,n,r??a,Re),this._offscreen.compositeToFramebuffer(this._bindParameters,n.getTexture(),_e.Alpha,1),n.release()}}_renderShadowMap(e,r,t){const s=this._shadowMap;s.enabled&&(s.start(e,r,t,this.isFeatureEnabled(te.HighResolutionShadows),this._stage.view.qualitySettings.maximumPixelRatio),this._shadowHighlight.updateParameters(e,r),this._needsShadowHighlight?(this._renderShadowCascades(N.ShadowHighlight,this._shadowMap),s.moveSnapshot(ne.Highlight),this._renderShadowCascades(N.ShadowExcludeHighlight,this._shadowMap),s.copySnapshot(ne.ExcludeHighlight),this._renderShadowCascades(N.ShadowHighlight,this._shadowMap)):this._renderShadowCascades(N.Shadow),s.finish(),e.setGLViewport(this._rctx))}_renderShadowCascades(e,r=this._shadowMap){for(const t of r.cascades)t.camera.setGLViewport(this._rctx),this._ensureBindParametersCamera(t.camera,t.camera),this._renderAllGeometry(e)}get _needsLinearDepth(){return this._plugins.consumes(N.LinearDepth)||this.hasReflections||this._needsShadowHighlight||this._needsShadowCast||this._debugLinearDepth}_renderLinearDepth(){this._needsLinearDepth?(this._bindParameters.linearDepth=this._offscreen.renderToCachedFBO(this._bindParameters.linearDepth,"linear-depth",(()=>this._renderAllGeometry(N.LinearDepth)),[0,0,0,0],O.RGBA,I.DEPTH_STENCIL_TEXTURE),this._bindParameters.linearDepth.detachDepth()):this._bindParameters.linearDepth=h(this._bindParameters.linearDepth)}_renderTerrainLinearDepth(e){if(e){const e=this._renderContext.output;this._renderContext.output=N.LinearDepth,this._bindParameters.multipassTerrain.linearDepth=this._offscreen.renderToCachedFBO(this._bindParameters.multipassTerrain.linearDepth,"terrain depth",(()=>this._renderTransparentTerrain()),[-1e10,-1e10,-1e10,1]),this._bindParameters.multipassTerrain.linearDepth.detachDepth(),this._renderContext.output=e}else this._bindParameters.multipassTerrain.linearDepth=h(this._bindParameters.multipassTerrain.linearDepth)}_renderGeometryLinearDepth(e){if(!e)return void(this._bindParameters.multipassGeometry.linearDepth=h(this._bindParameters.multipassGeometry.linearDepth));const r=this._renderContext.output;this._bindParameters.multipassGeometry.linearDepth=this._offscreen.renderToCachedFBO(this._bindParameters.multipassGeometry.linearDepth,"geometry depth",(()=>this._renderOpaqueGeometryAndTransparentMaterial(N.LinearDepth)),[1,1,1,1]),this._renderContext.output=r;const t=this._bindParameters.multipassGeometry.linearDepth.getAttachment(Te);return t?.retain(),this._bindParameters.multipassGeometry.linearDepth.detachDepth(),t}get _needsDepthRange(){return this._shadowMap.enabled||this._needsShadowCast}_computeDepthRange(e){if(!this._needsDepthRange)return W;const r=Y(e,this._plugins.plugins,this._stage.layers);return X(r,this._plugins.queryDepthRange(e)),r.near=Math.max(e.near,r.near),r.far=Math.min(e.far,r.far),r}_renderNormals(){const e=this._plugins.produces(se.SSAO),r=this._nodes.require("normals","composite-color")+this._nodes.require("normals","opaque-color")+this._nodes.require("normals","transparent-color");let t=(e?1:0)+r+(e||r>0?this._nodes.optional("normals","composite-color")+this._nodes.optional("normals","opaque-color")+this._nodes.optional("normals","transparent-color"):0);if(0===t)return;const s=this._offscreen.renderToCachedFBO(null,"normals",(()=>this._renderGeometryForSSAO(N.Normal)),[0,0,0,0],O.RGBA,I.DEPTH_STENCIL_TEXTURE);for(;--t>0;)s.retain();return s}_renderSSAO(){const e=this._pluginInput.get("normals");this._plugins.produces(se.SSAO)&&e&&(this._bindParameters.ssao=this._plugins.render(se.SSAO,this._pluginInput),e.detachDepth(),e.release()&&this._pluginInput.delete("normals"))}_renderAllGeometry(e){this._renderContext.output=e,this._plugins.prepare(se.TRANSPARENT_TERRAIN),this._renderOpaqueGeometryAndTransparentMaterial(e),this._renderTransparentTerrain()}_renderOpaqueGeometryAndTransparentMaterial(e){this._renderContext.output=e,this._plugins.prepare(se.TRANSPARENT_MATERIAL),this._plugins.prepare(se.TRANSPARENT_NO_SSAO_DEPTH),this._renderOpaqueGeometry(),this._renderTransparentMaterial()}_renderGeometryForSSAO(e){this._renderContext.output=e,this._plugins.render(se.INTEGRATED_MESH),this._plugins.render(se.OPAQUE_TERRAIN),this._plugins.render(se.OPAQUE_MATERIAL),this._plugins.render(se.TRANSPARENT_MATERIAL),this._renderTransparentTerrain()}_prepareOpaqueGeometry(){this._plugins.prepare(se.INTEGRATED_MESH),this._plugins.prepare(se.OPAQUE_TERRAIN),this._plugins.prepare(se.OPAQUE_MATERIAL),this._plugins.prepare(se.OPAQUE_NO_SSAO_DEPTH),this._plugins.prepare(se.ENVIRONMENT_OPAQUE)}_renderOpaqueGeometry(){this._plugins.render(se.INTEGRATED_MESH),this._plugins.render(se.OPAQUE_TERRAIN),this._plugins.render(se.OPAQUE_MATERIAL),this._plugins.render(se.OPAQUE_NO_SSAO_DEPTH)}_renderTransparentMaterial(){this._plugins.render(se.TRANSPARENT_MATERIAL),this._plugins.render(se.TRANSPARENT_NO_SSAO_DEPTH)}_renderTransparentTerrain(){if(!this._plugins.produces(se.TRANSPARENT_TERRAIN))return;const e=()=>this._plugins.render(se.TRANSPARENT_TERRAIN,null);if(this._renderContext.output!==N.Color)return void e();const{width:r,height:t,depth:s}=this._offscreen,i=this.fboCache.acquire(r,t,"transparent terrain");return this._offscreen.renderToTargets(e,i,s,[0,0,0,0]),i}_renderHUDVisibility(e){this._plugins.produces(se.OCCLUSION_PIXELS)?(this._bindParameters.hudVisibility=this._offscreen.renderHUDVisibility(this._bindParameters.hudVisibility,(()=>this._plugins.render(se.OCCLUSION_PIXELS)),e),this._offscreen.bindFbo()):this._bindParameters.hudVisibility=h(this._bindParameters.hudVisibility)}_renderLineCallouts(e){if(this._bindParameters.hudRenderStyle=e,e===L.Occluded){const e=()=>{this._plugins.render(se.LINE_CALLOUTS)},{width:r,height:t,color:s}=this._offscreen,i=this.fboCache.acquireDepth(I.DEPTH16_BUFFER,r,t,"line callouts");this._offscreen.renderToTargets(e,s,i,void 0,!0,!0),i.release()}else this._plugins.render(se.LINE_CALLOUTS)}_renderLaserlines(){if(this._plugins.render(se.LASERLINES),this._plugins.produces(se.LASERLINES_CONTRAST_CONTROL)){const e=this._offscreen,{width:r,height:t,depth:s}=e,i=this.fboCache.acquire(r,t,"laser lines"),a=()=>this._plugins.render(se.LASERLINES_CONTRAST_CONTROL);e.renderToTargets(a,i,s,Re),e.compositeToFramebuffer(this._bindParameters,i.getTexture(),_e.PremultipliedAlpha,1),i.release()}}_renderHUD(e,r){if(this._pluginsHas.hudElements)if(this._oitEnabled){const t=this._renderOITPass(Ae.HUD,e);this._rctx.bindFramebuffer(r?.fbo),this._compositingHelper.composite(this._bindParameters,t.getTexture(),_e.PremultipliedAlpha),t.release()}else if(e===L.Occluded){this._renderContext.output=N.Color;const r=()=>this._renderHUDElements(e),{width:t,height:s,color:i}=this._offscreen,a=this.fboCache.acquireDepth(I.DEPTH16_BUFFER,t,s,"hud");this._offscreen.renderToTargets(r,i,a,void 0,!0,!0),a.release()}else this._renderContext.output=N.Color,this._rctx.bindFramebuffer(null),r?.acquireDepth(I.DEPTH16_BUFFER),this._rctx.bindFramebuffer(r?.fbo),this._renderHUDElements(e),r?.detachDepth()}_renderHUDElements(e){this._bindParameters.hudRenderStyle=e,this._plugins.prepare(se.LINE_CALLOUTS_HUD_DEPTH),this._plugins.prepare(se.HUD_MATERIAL),this._plugins.prepare(se.LABEL_MATERIAL),this._plugins.render(se.LINE_CALLOUTS_HUD_DEPTH),this._plugins.render(se.HUD_MATERIAL),this._plugins.render(se.LABEL_MATERIAL)}get _needsShadowHighlight(){return this._shadowMap.enabled&&this._plugins.produces(se.SHADOW_HIGHLIGHT)&&this._plugins.produces(se.OPAQUE_MATERIAL,N.ShadowHighlight)}_renderHighlightPrepass(){if(!this.hasHighlights)return;const e=()=>{this._renderAllGeometry(N.Highlight),this._rctx.clear(fe.DEPTH_BUFFER_BIT),this._renderHUDElements(L.Both)},r=this._offscreen.renderToCachedFBO(null,"highlights",e,[0,0,0,0],O.RGBA4,I.DEPTH_STENCIL_TEXTURE);return r.detachDepth(),r}_renderShadowHighlights(e,r){this.hasHighlights&&r.decorations!==B.OFF&&this._needsShadowHighlight&&this._offscreen.updateColor((r=>(this._pluginInput.set("highlights",e),this._plugins.render(se.SHADOW_HIGHLIGHT,this._pluginInput,r),r)),"transparent-color")}_renderHighlights(e,r,t){this.hasHighlights&&t.decorations!==B.OFF&&this._plugins.produces(se.HIGHLIGHT)&&(this._pluginInput.set("highlights",r),this._plugins.render(se.HIGHLIGHT,this._pluginInput,e))}get _needsShadowCast(){return this._shadowAccumulator.isAccumulating}_renderShadowAccumulation(e,r,t){this._needsShadowCast&&this._bindParameters.linearDepth?.getTexture()&&this._shadowAccumulator.renderAccumulation(this._bindParameters.linearDepth,e,r,t)}_prepareTransparencySlots(){this._renderContext.output=N.Alpha,this._bindParameters.transparencyPassType=oe.Alpha,this._plugins.prepare(se.TRANSPARENT_MATERIAL),this._renderContext.output=N.Color,this._bindParameters.transparencyPassType=oe.Color,this._plugins.prepare(se.TRANSPARENT_MATERIAL),this._bindParameters.transparencyPassType=oe.FrontFace,this._plugins.prepare(se.TRANSPARENT_MATERIAL),this._bindParameters.transparencyPassType=oe.NONE}_renderOITPass(e,r=L.Both){const t=e===Ae.HUD,s=t?this.fboCache.acquire(this._offscreen.width,this._offscreen.height,"oit hud composite"):null,i=t?()=>this._renderHUDElements(r):()=>this._renderTransparentMaterial(),a=this._renderContext.output;this._renderContext.output=N.Alpha,this._bindParameters.transparencyPassType=oe.Alpha;const n=this._offscreen.renderOITPass(i,oe.Alpha,t);this._renderContext.output=N.Color,this._bindParameters.transparencyPassType=oe.Color;const h=this._offscreen.renderOITPass(i,oe.Color,t);this._bindParameters.transparencyPassType=oe.FrontFace;const o=this._offscreen.renderOITPass(i,oe.FrontFace,t);return this._offscreen.compositeTransparentOntoOpaque(this._bindParameters,h,n,o,s),s?.detachDepth(),o.release(),h.release(),n.release(),this._bindParameters.transparencyPassType=oe.NONE,this._renderContext.output=a,s}_renderOccluded(){let e=0;Pe.clear(),this._plugins.plugins.forAll((r=>{if(!r.materialReference)return;r.queryRenderOccludedState(z.OccludeAndTransparentStencil)&&(e|=z.OccludeAndTransparentStencil,Pe.push(r))}));const r=this._offscreen,t=(t,s,i,a,n)=>{if(!(e&s))return;const{width:h,height:o,depth:d}=r,l=this.fboCache.acquire(h,o,"tmp color");r.renderToTargets(i,l,d,[0,0,0,0],a,n),r.compositeToFramebuffer(this._bindParameters,l.getTexture(),_e.PremultipliedAlpha,t),l.release()},s=(e,r)=>{this._bindParameters.slot=e,r.forAll((e=>{if(M(e)){const r=e.prepareTechnique(this._renderContext);r&&e.renderNode(this._renderContext,r)}}))};0!==Pe.length&&(s(se.OCCLUDER_MATERIAL,Pe),t(.5,z.OccludeAndTransparentStencil,(()=>s(se.TRANSPARENT_OCCLUDER_MATERIAL,Pe)),!1,!1)),Pe.clear(),this._plugins.plugins.forAll((r=>{if(!r.materialReference)return;const t=r.queryRenderOccludedState(z.OccludeAndTransparent),s=r.queryRenderOccludedState(z.Transparent),i=r.queryRenderOccludedState(z.Opaque);(t||s||i)&&(e|=t?z.OccludeAndTransparent:s?z.Transparent:z.Opaque,Pe.push(r))}));const i=this._plugins.renderOccludedFlags;if(e|=i,!e)return;const a=e=>{this._renderContext.renderOccludedMask=e,i>z.Occlude&&this._plugins.render(se.OCCLUDED_TERRAIN),s(se.OPAQUE_MATERIAL,Pe),s(se.TRANSPARENT_MATERIAL,Pe),s(se.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,Pe),this._renderContext.renderOccludedMask=Z};this._renderContext.output=N.Color,t(.5,z.OccludeAndTransparent,(()=>a(z.OccludeAndTransparent)),!0,Q.OutlineVisualElementMask),t(.5,z.Transparent,(()=>a(z.Transparent)),!0,Q.OutlineVisualElementMask),t(1,z.Opaque,(()=>a(z.Opaque)),!0,Q.OutlineVisualElementMask),Pe.clear()}_invokeRenderNodes(e){return this._nodes.render(e,this._pluginInput,this._releaseNormals)}_renderComposite(e,r){this._offscreen.updateColor((e=>(this._pluginInput.set("highlights",r),e=this._nodes.render(e,this._pluginInput,this._releaseNormals),this._pluginInput.set(e.name,e),this._pluginInput.delete("highlights"),e)),"composite-color");const t=this._plugins.produces(se.ANTIALIASING);return this._plugins.render(t?se.ANTIALIASING:se.BLIT,this._pluginInput,e)}_ensureBindParametersCamera(e,r){this._bindParameters.camera=e,this._bindParameters.contentCamera=r}_ensureBindParametersSSR(e){if(this._bindParameters.ssr.lastFrameColor){null==this._ssrEnableTime&&(this._ssrEnableTime=e),this._renderContext.lastFrameCamera.equals(this._bindParameters.camera)?this._reprojectionMatrix=E:(f(Ce,this._bindParameters.camera.viewMatrix),f(Se,this._bindParameters.camera.projectionMatrix),T(we,Ce,Se),T(we,this._renderContext.lastFrameCamera.viewMatrix,we),T(we,this._renderContext.lastFrameCamera.projectionMatrix,we),this._reprojectionMatrix=we);const r=this._stage.view.qualitySettings.fadeDuration;this._bindParameters.ssr.fadeFactor=r>0?Math.min(r,e-this._ssrEnableTime)/r:1,this._bindParameters.ssr.fadeFactor<1&&this._requestRender()}else this._reprojectionMatrix=E,this._ssrEnableTime=null}addRenderNode(e){this._nodes.add(e),this._requestRender()}removeRenderNode(e){this._nodes.remove(e),this._requestRender()}get usedMemory(){return{fbos:this.fboCache.usedMemory,plugins:this._plugins.usedMemory,edges:this.edgeView?.usedMemory??0}}get test(){return{offscreen:this._offscreen,shadowMap:this._shadowMap,highlight:this._highlight,lighting:this._bindParameters.lighting,renderPlugins:this._plugins,shadowAccumulator:this._shadowAccumulator,weatherIsFading:this._bindParameters.cloudsFade.isFading,resetRenderStateFeatures:()=>{this._renderStateFeatures.value=re(),this._plugins.renderFeatureChanged(),this._requestRender()},getFramebufferTexture:e=>{switch(e){case be.Color:return this._offscreen.colorTexture;case be.LinearDepth:return this._bindParameters.linearDepth?.getTexture();case be.ShadowMap:return this._shadowMap.depthTexture;case be.HudVisibility:return this._bindParameters.hudVisibility?.getTexture()}},debugLinearDepth:e=>{this._debugLinearDepth=e,this._requestRender()}}}}var Ae,be;e([m({readOnly:!0})],Ee.prototype,"fullResolutionAtmosphere",null),e([m()],Ee.prototype,"_smaa",void 0),e([m()],Ee.prototype,"_blit",void 0),e([m()],Ee.prototype,"_edgeView",void 0),e([m()],Ee.prototype,"updating",null),function(e){e[e.Geometry=0]="Geometry",e[e.HUD=1]="HUD"}(Ae||(Ae={})),function(e){e[e.Color=0]="Color",e[e.LinearDepth=1]="LinearDepth",e[e.ShadowMap=2]="ShadowMap",e[e.HudVisibility=3]="HudVisibility"}(be||(be={}));const Re=[0,0,0,0],Pe=new o,Se=A(),Ce=A(),we=A();function Ie(e){return r=>e.immediate.schedule(r)}export{be as FramebufferId,Ee as Renderer};
