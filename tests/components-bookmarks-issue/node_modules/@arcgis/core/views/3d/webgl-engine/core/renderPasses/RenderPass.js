/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import e from"../../../../../core/PooledArray.js";import{TransparencyPassType as t}from"../../lib/TransparencyPassType.js";import{DataType as r}from"../../../../webgl/enums.js";var i;!function(e){e[e.FrontToBack=0]="FrontToBack",e[e.BackToFront=1]="BackToFront"}(i||(i={}));class a{constructor(t,r,a=i.FrontToBack){this._rctx=t,this._techniqueRepository=r,this._sorting=a,this._draws=new e({initialSize:32,allocator:e=>e||{material:null,geometry:null,geometryRanges:null,bindDrawParams:null,depthSquaredHint:0,indexType:0}}),this._previouslyBoundDraw=new Map}submitDraw(e,t,r,i){const a=this._draws.pushNew();a.geometry=t,a.geometryRanges=r,a.material=e,a.depthSquaredHint=i,a.indexType=(t.indexed?t.vao.indexBuffer.indexType:null)??0}prepare(e,t){return this._draws.map((r=>r.material.prepareTechnique(this._techniqueRepository,e,t,r.geometry.parameters)))}dispatch(e,r,i){const a=this._rctx;this._previouslyBoundDraw.clear();let s=null;const o=this._draws.length;for(let p=0;p<o;p++){const o=i[p];o===s&&o.configuration.transparencyPassType===t.NONE||(a.bindTechnique(o,r,e),s=o);const l=this._draws.data[p],d=l.geometry;a.bindVAO(d.vao),this._previouslyBoundDraw.get(o)!==l.material&&(o.program.bindDraw(l.material,r,e),this._previouslyBoundDraw.set(o,l.material));const c=l.geometryRanges,u=c.length;if(0!==l.indexType){const e=n.get(l.indexType);for(let t=0;t<u;t+=2){const r=c[t],i=c[t+1];a.drawElements(d.primitiveType,i,l.indexType,r*e)}}else for(let e=0;e<u;e+=2){const t=c[e],r=c[e+1];a.drawArrays(d.primitiveType,t,r)}}}prepareSubmit(){this._draws.clear()}finishSubmit(){const e=this._sorting===i.FrontToBack?1:-1;this._draws.sort(((t,r)=>{const i=e*(t.depthSquaredHint-r.depthSquaredHint);return 0!==i?i:t.geometry.vao.byteSize-r.geometry.vao.byteSize}))}get count(){return this._draws.length}}const n=new Map;n.set(r.UNSIGNED_BYTE,1),n.set(r.UNSIGNED_SHORT,2),n.set(r.UNSIGNED_INT,4);export{a as RenderPass,i as RenderPassSorting};
