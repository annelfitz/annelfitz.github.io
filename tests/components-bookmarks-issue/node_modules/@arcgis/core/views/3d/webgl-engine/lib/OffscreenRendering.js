/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import"../../../../core/has.js";import{releaseMaybe as t}from"../../../../core/maybe.js";import{c as e}from"../../../../chunks/vec42.js";import{create as r}from"../../../../core/libs/gl-matrix-2/factories/vec4f64.js";import{ColorFormat as i,DepthFormat as s}from"../../webgl/formats.js";import{RendererTarget as h}from"./rendererUtils.js";import{TransparencyPassType as o}from"./TransparencyPassType.js";import{ClearBufferBit as c}from"../../../webgl/enums.js";import{ensureAttachmentMaxSize as a}from"../../../webgl/FramebufferObject.js";class l{constructor(t,e){this._fbos=t,this.compositingHelper=e,this._width=4,this._height=4,this._clearColor=r()}dispose(){this._color=t(this._color),this.releaseBuffers()}get framebuffer(){return this.color.attachDepth(this.depth),this.color.fbo}get colorTexture(){return this.color.getTexture()}get depthTexture(){return this.depth.attachment}initializeFrame(t,r,i){this._fbos.interactive=i===h.Default;const s=this._fbos.rctx;this._width=t.fullWidth,this._height=t.fullHeight,a(this,s.parameters.maxTextureSize);const o=this._color;return this._color=null,this.releaseBuffers(),e(this._clearColor,r),o}releaseBuffers(){this._color?.detachDepth(),this._depth=t(this._depth)}renderHUDVisibility(t,e,r){return t?.fbo.width===this._width&&t?.fbo.height===this._height||(t?.release(),t=this._fbos.acquire(this._width,this._height,"hud visibility",i.RGBA4)),t.attachDepth(r||this.depth),this._fbos.rctx.bindFramebuffer(t.fbo),this._fbos.rctx.clearFramebuffer(f),e(),t.detachDepth(),t}compositeToHUDVisibility(t,e){this._fbos.rctx.bindFramebuffer(t.hudVisibility?.fbo),this.compositingHelper.compositeHUD(t,e)}renderOITPass(t,e,r){let h,c;const{_width:a,_height:l}=this;switch(e){case o.Color:h=this._fbos.acquire(a,l,r?"oit hud color":"oit color",i.RGBA16F),c=[0,0,0,0];break;case o.Alpha:h=this._fbos.acquire(a,l,r?"oit hud alpha":"oit alpha",i.R16F),c=[1,1,1,1];break;case o.FrontFace:h=this._fbos.acquire(a,l,r?"oit hud front":"oit front"),c=[0,0,0,0]}return r?h.acquireDepth(s.DEPTH16_BUFFER):h.attachDepth(this.depth),this._fbos.rctx.bindFramebuffer(h.fbo),this._fbos.rctx.clearFramebuffer(c,r,r),t(),h.detachDepth(),h}compositeToFramebuffer(t,e,r,i){this.bindFbo(),this.compositingHelper.composite(t,e,r,i)}compositeTransparentOntoOpaque(t,e,r,i,s){s?(this._fbos.rctx.bindFramebuffer(s.fbo),this._fbos.rctx.setClearColor(0,0,0,1e-13),this._fbos.rctx.clear(c.COLOR_BUFFER_BIT)):this.bindFbo(),this.compositingHelper.compositeOIT(t,e.getTexture(),r.getTexture(),i.getTexture())}renderDepthDetached(t){this._bindTarget(this.color),t(),this._bindTarget(this.color,this.depth)}renderToCachedFBO(e,r,h,o,c=i.RGBA,a=s.DEPTH16_BUFFER,l=this._width,f=this._height,_=null){return e?.fbo.width===l&&e?.fbo.height===f||(e=t(e)),e=e??this._fbos.acquire(l,f,r,c),_?.forEach((t=>e.acquireColor(t.attachment,t.format))),null!=a&&e.acquireDepth(a),this._fbos.rctx.bindFramebuffer(e.fbo),this._fbos.rctx.clearFramebuffer(o,!0,!0),h(),e}renderToTargets(t,e,r,i,s=!1,h=!1){this._bindTarget(e,r),this._fbos.rctx.clearFramebuffer(i,s,h),t(),e.detachDepth()}bindFbo(){const t=null==this._color;if(this._bindTarget(this.color,this.depth),t){const t=this._fbos.rctx;t.setClearStencil(0),t.setClearColor(this._clearColor[0],this._clearColor[1],this._clearColor[2],this._clearColor[3]),t.clear(c.COLOR_BUFFER_BIT|c.DEPTH_BUFFER_BIT|c.STENCIL_BUFFER_BIT)}}_bindTarget(t,e){t.attachDepth(e),this._fbos.rctx.bindFramebuffer(t.fbo)}get width(){return this._width}get height(){return this._height}get color(){return this._ensureColor()}_ensureColor(){return this._color||(this._color=this._fbos.acquire(this._width,this._height,"composite-color")),this._color}updateColor(t,e){const r=this._ensureColor();r.attachDepth(this.depth),r.setName(e),this._color=t(r)}get depth(){return this._depth||(this._depth=this._fbos.acquireDepth(s.DEPTH_STENCIL_TEXTURE,this._width,this._height,"depth")),this._depth}}const f=[0,1,0,1];export{l as OffscreenRendering};
