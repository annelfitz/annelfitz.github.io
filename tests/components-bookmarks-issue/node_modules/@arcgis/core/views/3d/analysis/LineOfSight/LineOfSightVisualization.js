/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../chunks/tslib.es6.js";import i from"../../../../Color.js";import t from"../../../../core/Accessor.js";import o from"../../../../core/Handles.js";import{makeHandle as n}from"../../../../core/handleUtils.js";import{destroyMaybe as s}from"../../../../core/maybe.js";import{initial as r}from"../../../../core/reactiveUtils.js";import{property as l}from"../../../../core/accessorSupport/decorators/property.js";import"../../../../core/has.js";import"../../../../core/Logger.js";import"../../../../core/RandomLCG.js";import{subclass as a}from"../../../../core/accessorSupport/decorators/subclass.js";import{create as c}from"../../../../core/libs/gl-matrix-2/factories/mat4f64.js";import{f as d}from"../../../../chunks/vec32.js";import{fromArray as u,create as m}from"../../../../core/libs/gl-matrix-2/factories/vec3f64.js";import{UpdatingHandles as h}from"../../../../core/support/UpdatingHandles.js";import{lineOfSightConfiguration as p}from"./LineOfSightConfiguration.js";import{LineOfSightVisualElement as v}from"./LineOfSightVisualElement.js";import{LineVisualElement as g}from"../../interactive/visualElements/LineVisualElement.js";import{PointVisualElement as f}from"../../interactive/visualElements/PointVisualElement.js";import{RenderOccludedFlag as b}from"../../webgl-engine/lib/Material.js";let O=class extends t{constructor(e){super(e),this._lineOfSightVisualElements=new Array,this._computationHandles=new o,this._updatingHandles=new h}initialize(){this.addHandles(this._connectComputations()),this._createObserverVisualization()}destroy(){this._updatingHandles=s(this._updatingHandles),this._computationHandles=s(this._computationHandles),this._observerVisualElement=s(this._observerVisualElement)}get visible(){return this.analysisViewData.visible}get updating(){return this._updatingHandles.updating}get interactiveAndEditable(){return this.analysisViewData.interactive&&this.analysisViewData.editable}get test(){return{disablePartialOcclusion:()=>{for(const e of this._lineOfSightVisualElements)e.visibleLineVisualElement.renderOccluded=b.Occlude,e.occludedLineVisualElement.renderOccluded=b.Occlude,e.undefinedLineVisualElement.renderOccluded=b.Occlude},visualizations:this._lineOfSightVisualElements}}_createLineOfSightVisualization(){const e=p,t=this.view,o=this.isDecoration,n={view:t,attached:!0,width:e.outerWidth,innerWidth:e.innerWidth,isDecoration:o},s=i.toUnitRGBA(e.visibleOuterColor),r=i.toUnitRGBA(e.visibleInnerColor),l=i.toUnitRGBA(e.occludedOuterColor),a=i.toUnitRGBA(e.occludedInnerColor),c=i.toUnitRGBA(e.undefinedOuterColor),d=i.toUnitRGBA(e.undefinedInnerColor),u=new g({...n,color:s,innerColor:r}),m=new g({...n,color:l,innerColor:a}),h=new g({...n,color:c,innerColor:d}),b=new f({view:t,attached:!0,..._,size:8,isDecoration:o}),O=new v(u,m,h,b);return this._lineOfSightVisualElements.push(O),O}_destroyLineOfSightVisualization(e){e.destroy(),this._lineOfSightVisualElements.splice(this._lineOfSightVisualElements.indexOf(e),1)}_updateLineOfSightVisualization(e,t,o){const n=p,{computationResult:s,inputPoints:r}=e,{start:l,end:a,intersection:c,isValid:m,isTargetVisible:h}=s,{observer:v}=r,g=E;g[12]=v[0],g[13]=v[1],g[14]=v[2];const f=d(V,l,v),b=d(y,a,v),O=d(C,c,v),{visibleLineVisualElement:_,occludedLineVisualElement:A,undefinedLineVisualElement:w,targetVisualElement:L}=t,S=null==this.analysisViewData.elevationAlignedObserver||null==e.elevationAlignedTargetLocation,j=this.visible&&!S;_.visible=j,A.visible=j,w.visible=j,L.visible=j,L.attached=!o.interactiveAndEditable,j&&(_.geometry=null,A.geometry=null,w.geometry=null,L.geometry=e.elevationAlignedTargetLocation,m?h?(_.geometry=[[u(f),u(b)]],_.transform=g,_.color=i.toUnitRGBA(n.visibleOuterColor),L.color=i.toUnitRGBA(n.visibleInnerColor)):(_.geometry=[[u(f),u(O)]],_.transform=g,_.color=i.toUnitRGBA(n.occludedOuterColor),A.geometry=[[u(O),u(b)]],A.transform=g,L.color=i.toUnitRGBA(n.occludedInnerColor)):(w.geometry=[[u(f),u(b)]],w.transform=g,L.color=i.toUnitRGBA(n.undefinedInnerColor)))}_getLineOfSightVisualizationDependencies(e){const{computationResult:i}=e,{occludedOuterColor:t,visibleOuterColor:o}=p;return{computationResult:i,occludedOuterColor:t,visibleOuterColor:o,visible:this.visible,interactiveAndEditable:this.interactiveAndEditable}}_connectComputation(e){const i=this._computationHandles;if(i.has(e))return;const t=this._createLineOfSightVisualization();i.add([this._updatingHandles.add((()=>this._getLineOfSightVisualizationDependencies(e)),(i=>this._updateLineOfSightVisualization(e,t,i)),{initial:!0,equals:()=>!1}),n((()=>this._destroyLineOfSightVisualization(t)))],e)}_disconnectComputation(e){this._computationHandles.remove(e)}_connectComputations(){return this._updatingHandles.addOnCollectionChange((()=>this.analysisViewData.computations),(e=>this._onComputationsCollectionChange(e)),{initial:!0,final:!0})}_onComputationsCollectionChange({added:e,removed:i}){for(const t of i)this._disconnectComputation(t);for(const t of e)this._connectComputation(t)}_createObserverVisualization(){const e=i.toUnitRGBA(p.visibleInnerColor),t=new f({view:this.view,color:e,..._,isDecoration:this.isDecoration});this._observerVisualElement=t,this.addHandles(this._updatingHandles.add((()=>({observer:this.analysisViewData.elevationAlignedObserver,interactiveAndEditable:this.interactiveAndEditable,visible:this.visible})),(({observer:e,interactiveAndEditable:i,visible:o})=>{null!=e&&!i&&o?(t.geometry=e,this._observerVisualElement.attached=!0):t.attached=!1}),r))}};e([l({constructOnly:!0})],O.prototype,"analysis",void 0),e([l({constructOnly:!0})],O.prototype,"analysisViewData",void 0),e([l({constructOnly:!0})],O.prototype,"view",void 0),e([l({readOnly:!0})],O.prototype,"visible",null),e([l({constructOnly:!0})],O.prototype,"isDecoration",void 0),e([l()],O.prototype,"updating",null),e([l()],O.prototype,"interactiveAndEditable",null),e([l()],O.prototype,"test",null),O=e([a("esri.views.3d.analysis.LineOfSight.LineOfSightVisualization")],O);const _={size:6,pixelSnappingEnabled:!1,primitive:"circle",elevationInfo:{mode:"absolute-height",offset:0},outlineSize:0},V=m(),y=m(),C=m(),E=c();export{O as LineOfSightVisualization};
