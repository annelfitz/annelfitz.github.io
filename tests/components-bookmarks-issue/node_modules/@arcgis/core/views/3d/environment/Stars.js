/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{_ as t}from"../../../chunks/tslib.es6.js";import{fetchAsset as e}from"../../../assets.js";import s from"../../../core/Accessor.js";import{createTask as r}from"../../../core/asyncUtils.js";import i from"../../../core/Error.js";import o from"../../../core/Logger.js";import{abortMaybe as a,releaseMaybe as n,disposeMaybe as f}from"../../../core/maybe.js";import{isAbortError as c}from"../../../core/promiseUtils.js";import{initial as u}from"../../../core/reactiveUtils.js";import{property as l}from"../../../core/accessorSupport/decorators/property.js";import"../../../core/has.js";import"../../../core/RandomLCG.js";import{subclass as d}from"../../../core/accessorSupport/decorators/subclass.js";import{copy as m,rotateZ as h,multiply as p}from"../../../core/libs/gl-matrix-2/math/mat4.js";import{fromValues as g}from"../../../core/libs/gl-matrix-2/factories/mat4f64.js";import{UpdatingHandles as b}from"../../../core/support/UpdatingHandles.js";import{StarPassParameters as _,StarsTechnique as v}from"./StarsTechnique.js";import{glLayout as w}from"../support/buffer/glUtil.js";import{newLayout as y}from"../support/buffer/InterleavedLayout.js";import{Default3D as j}from"../webgl-engine/lib/DefaultVertexAttributeLocations.js";import{VertexArrayObject as T}from"../webgl-engine/lib/VertexArrayObject.js";import{VertexAttribute as P}from"../webgl-engine/lib/VertexAttribute.js";import{BufferObject as k}from"../../webgl/BufferObject.js";import{PrimitiveType as q,Usage as D}from"../../webgl/enums.js";let x=class extends s{get updating(){return this._updatingTracking.updating||this.loading}get loading(){return null!=this._loadDataTask&&!this._loadDataTask.finished}constructor(t){super(t),this._loadDataTask=null,this._numPoints=0,this._passParameters=new _,this._updatingTracking=new b}initialize(){this._loadDataTask=this._createLoadDataTask()}destroy(){this._loadDataTask=a(this._loadDataTask),this._updatingTracking.destroy(),this._numPoints=0,this._technique=n(this._technique),this._vao=f(this._vao),F=null}render(t){const{rctx:e}=t;if(this._ensureResources(e),null==this._technique||null==this._vao)return;if(!this._technique.compiled)return void this.requestRender();const s=e.bindTechnique(this._technique,t.bindParameters,this._passParameters);e.bindVAO(this._vao),s.assertCompatibleVertexAttributeLocations(this._vao),e.drawArrays(q.POINTS,0,this._numPoints)}_ensureResources(t){if(null!=this._technique||null==F)return;this._technique=new v({rctx:t,viewingMode:this.view.state.viewingMode}),this._numPoints=F.byteLength/V;const e=new Float32Array(F,0,2*this._numPoints),s=new Uint8Array(F,2*this._numPoints*4,this._numPoints);this._vao=A(t,e,s,this._numPoints),this._updatingTracking.add((()=>"virtual"!==this.view.environment.lighting.type?this.view.environment.lighting.date:null),(t=>this._update(t)),u)}_update(t){if(!t)return;const e=(t.getHours()/12+t.getMinutes()/60*(2/24)+t.getSeconds()/60*(2/1440)-.9972222)%2,s=2*I(t),r=m(this._passParameters.modelMatrix,U);h(r,r,-s*Math.PI),p(r,S,r),h(r,r,-e*Math.PI),this.requestRender()}_createLoadDataTask(){if(null!=F)return null;const t=r((async t=>{const{data:s}=await e("esri/views/3d/environment/resources/stars.wsv",{responseType:"array-buffer",signal:t});L(s),F=s}));return t.promise.catch((t=>{c(t)||o.getLogger(this).error(t)})).then((()=>{this.destroyed||(this.requestRender(),this.notifyChange("updating"))})),t}};function A(t,e,s,r){const i=C.createBuffer(r),o=i.position,a=i.color,n=i.size;for(let f=0;f<r;f++){const t=e[2*f],r=e[2*f+1];o.set(f,0,-Math.cos(t)*Math.sin(r)),o.set(f,1,-Math.sin(t)*Math.sin(r)),o.set(f,2,-Math.cos(r));const i=O(s[f]),c=M(R[i[1]]);a.set(f,0,255*c[0]),a.set(f,1,255*c[1]),a.set(f,2,255*c[2]),a.set(f,3,255),n.set(f,i[0])}return new T(t,j,{geometry:w(C)},{geometry:k.createVertex(t,D.STATIC_DRAW,i.buffer)})}function I(t){const e=t,s=new Date(t.getFullYear(),0,1,11,58,56);return(+e-+s)/(+new Date(t.getFullYear()+1,0,1,11,58,55)-+s)}function L(t){if(!t)throw new i("stars:no-data-received","Failed to create stars because star catalogue is missing");const e=t.byteLength/V;if(e%1!=0||e>5e4||e<5e3)throw new i("stars:invalid-data","Failed to create stars because star catalogue data is invalid")}function M(t){return[parseInt(t.substring(0,2),16),parseInt(t.substring(2,4),16),parseInt(t.substring(4,6),16)]}function O(t){return t>=192?[2.9,t-192]:t>=160?[2.5,t-160]:t>=128?[2,t-128]:t>=96?[1.5,t-96]:t>=64?[1,t-64]:t>=32?[.7,t-32]:[.4,t]}t([l({constructOnly:!0})],x.prototype,"view",void 0),t([l({constructOnly:!0})],x.prototype,"requestRender",void 0),t([l({readOnly:!0})],x.prototype,"updating",null),t([l()],x.prototype,"_loadDataTask",void 0),t([l()],x.prototype,"_updatingTracking",void 0),x=t([d("esri.views.3d.environment.Stars")],x);const R=["9bb2ff","9eb5ff","aabfff","bbccff","ccd8ff ","dae2ff","e4e9ff","eeefff","f8f6ff","fff9fb","fff5ef","fff1e5","ffeddb","ffe9d2","ffe6ca","ffe3c3","ffe0bb","ffddb4","ffdaad","ffd6a5","ffd29c","ffcc8f","ffc178","ffa94b","ff7b00"],S=g(1,0,0,0,0,.9174771405229186,.39778850739794974,0,0,-.39778850739794974,.9174771405229186,0,0,0,0,1),U=g(1,0,0,0,0,.9174771405229186,-.39778850739794974,0,0,.39778850739794974,.9174771405229186,0,0,0,0,1),V=9,C=y().vec3f(P.POSITION).vec4u8(P.COLOR).f32(P.SIZE);let F=null;export{x as Stars};
