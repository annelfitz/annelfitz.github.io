/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{_ as e}from"../../../chunks/tslib.es6.js";import t from"../../../core/Accessor.js";import{lerp as i}from"../../../core/mathUtils.js";import{releaseMaybe as r,disposeMaybe as s}from"../../../core/maybe.js";import{secondsFromMilliseconds as n}from"../../../core/time.js";import{property as o}from"../../../core/accessorSupport/decorators/property.js";import"../../../core/has.js";import"../../../core/Logger.js";import"../../../core/RandomLCG.js";import{subclass as a}from"../../../core/accessorSupport/decorators/subclass.js";import{getReferenceEllipsoid as c}from"../../../geometry/ellipsoidUtils.js";import{PrecipitationPassParameters as h,PrecipitationTechnique as u,attributeLocations as m}from"./PrecipitationTechnique.js";import{PrecipitationTechniqueConfiguration as p,PrecipitationType as _}from"./PrecipitationTechniqueConfiguration.js";import{glLayout as d}from"../support/buffer/glUtil.js";import{newLayout as l}from"../support/buffer/InterleavedLayout.js";import{AnimationTimer as f}from"../webgl-engine/lib/AnimationTimer.js";import{VertexArrayObject as T}from"../webgl-engine/lib/VertexArrayObject.js";import{VertexAttribute as w}from"../webgl-engine/lib/VertexAttribute.js";import{BufferObject as y}from"../../webgl/BufferObject.js";import{PrimitiveType as b,Usage as q}from"../../webgl/enums.js";import{bindVertexBufferLayout as j,unbindVertexBufferLayout as I}from"../../webgl/Util.js";let g=class extends t{constructor(e){super(e),this._numParticles=25e4,this._rainSpeed=.1,this._snowSpeed=.01,this._passParameters=new h,this._animation=new f,this._passParameters.time=0,this._passParameters.radius=c(e.view.spatialReference).radius,this._techniqueRepository=e.context.techniqueRepository}destroy(){this._numParticles=0,this._snowTechniqueCached=r(this._snowTechniqueCached),this._rainTechniqueCached=r(this._rainTechniqueCached),this._vao=s(this._vao),this._instanceIdBuffer=s(this._instanceIdBuffer)}get _rainTechnique(){if(null==this._rainTechniqueCached){const e=new p;e.type=_.Rain,this._rainTechniqueCached=this._techniqueRepository.acquire(u,e)}return this._rainTechniqueCached}get _snowTechnique(){if(null==this._snowTechniqueCached){const e=new p;e.type=_.Snow,this._snowTechniqueCached=this._techniqueRepository.acquire(u,e)}return this._snowTechniqueCached}update(e){return this._animation.advance(e)}render(e,t,r){const s="rainy"===r?this._rainTechnique:this._snowTechnique;if(!s.compiled)return void this.context.requestRender();const o=e.rctx;if(this._ensureResources(o),null==s||null==this._vao||null==this._instanceIdBuffer)return;if(null!=e.bindParameters.cloudsFade.data&&(this._passParameters.opacity=e.bindParameters.cloudsFade.opacity),this._passParameters.opacity<=0)return;const a=.35;t=t<.5?i(0,a,2*t):i(a,1,2*(t-.5)),this._passParameters.time=("rainy"===r?this._rainSpeed:this._snowSpeed)*n(this._animation.time)%1e5;const c=o.bindTechnique(s,e.bindParameters,this._passParameters);o.bindVAO(this._vao),c.assertCompatibleVertexAttributeLocations(this._vao),j(o,m,this._instanceIdBuffer,A,0),o.drawArraysInstanced(b.TRIANGLES,0,3,this._numParticles*t),I(o,m,this._instanceIdBuffer,A)}_ensureResources(e){null==this._vao&&(this._vao=P(e)),null==this._instanceIdBuffer&&(this._instanceIdBuffer=this._createInstanceIndices(e))}_createInstanceIndices(e){const t=[];for(let i=0;i<this._numParticles;i++)t.push(i);return y.createVertex(e,q.STATIC_DRAW,new Float32Array(t))}};function P(e){const t=new Float32Array([-1,0,1,1,0,-1,1,0,1]);return new T(e,m,{geometry:d(v)},{geometry:y.createVertex(e,q.STATIC_DRAW,t)})}e([o({constructOnly:!0})],g.prototype,"context",void 0),e([o({constructOnly:!0})],g.prototype,"view",void 0),g=e([a("esri.views.3d.environment.Precipitation")],g);const v=l().vec3f(w.POSITION),A=d(l().f32(w.INSTANCEFEATUREATTRIBUTE),1);export{g as Precipitation};
