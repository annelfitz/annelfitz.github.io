/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{_ as e}from"../../../chunks/tslib.es6.js";import t from"../../../core/Accessor.js";import{releaseMaybe as r,disposeMaybe as s}from"../../../core/maybe.js";import{property as i}from"../../../core/accessorSupport/decorators/property.js";import"../../../core/has.js";import"../../../core/Logger.js";import"../../../core/RandomLCG.js";import{subclass as o}from"../../../core/accessorSupport/decorators/subclass.js";import{copy as h}from"../../../core/libs/gl-matrix-2/math/vec2.js";import{N as n}from"../../../chunks/NoiseTextureAtlas.glsl.js";import{NoiseTextureRenderMode as a,NoiseTextureAtlasTechniqueConfiguration as c}from"./NoiseTextureAtlasConfiguration.js";import{atlasSize as u}from"./NoiseTextureAtlasDimensions.js";import{NoiseTextureAtlasTechnique as l}from"./NoiseTextureAtlasTechnique.js";import{createQuadVAO as p}from"../webgl-engine/lib/glUtil3D.js";import{FramebufferObject as _}from"../../webgl/FramebufferObject.js";import{TextureDescriptor as m}from"../../webgl/TextureDescriptor.js";let d=class extends t{constructor(e){super(e),this._needsRender=!0,this._passParameters=new n,this._fbo=new _(e.context.renderContext.rctx,new m(u)),this._vao=p(e.context.renderContext.rctx)}get _techniqueRepository(){return this.context.techniqueRepository}get textureAtlas(){return null!=this._texture?null!=this._weatherMapTechnique&&this._weatherMapTechnique.compiled&&this._needsRender&&(this._texture=this._render(a.WeatherMap)):null!=this._fullTechnique&&this._fullTechnique.compiled&&(this._texture=this._render(a.Full)),this._texture}_setDirty(){this._needsRender=!0}updateWeatherMap(e){this._passParameters.weatherTile[0]===e[0]&&this._passParameters.weatherTile[1]===e[1]||(h(this._passParameters.weatherTile,e),this._setDirty())}destroy(){this._fullTechniqueCached=r(this._fullTechniqueCached),this._weatherMapTechniqueCached=r(this._weatherMapTechniqueCached),this._fbo=s(this._fbo),this._vao=s(this._vao)}get _fullTechnique(){if(null==this._fullTechniqueCached){const e=new c;e.mode=a.Full,this._fullTechniqueCached=this._techniqueRepository.acquire(l,e)}return this._fullTechniqueCached}get _weatherMapTechnique(){if(null==this._weatherMapTechniqueCached){const e=new c;e.mode=a.WeatherMap,this._weatherMapTechniqueCached=this._techniqueRepository.acquire(l,e)}return this._weatherMapTechniqueCached}_render(e){if(null==this._vao||null==this._fbo)return null;const t=e===a.Full?this._fullTechnique:this._weatherMapTechnique,r=this.context.renderContext.rctx,s=r.getViewport();r.setViewport(0,0,u,u),r.bindFramebuffer(this._fbo);const i=r.bindTechnique(t,null,this._passParameters);return r.bindVAO(this._vao),i.assertCompatibleVertexAttributeLocations(this._vao),r.gl.drawArrays(r.gl.TRIANGLE_STRIP,0,4),r.setViewport(s.x,s.y,s.width,s.height),this._needsRender=!1,this._fbo.colorTexture}};e([i({constructOnly:!0})],d.prototype,"context",void 0),e([i({readOnly:!0})],d.prototype,"_techniqueRepository",null),d=e([o("esri.views.3d.environment.NoiseTextureAtlas")],d);export{d as NoiseTextureAtlas};
