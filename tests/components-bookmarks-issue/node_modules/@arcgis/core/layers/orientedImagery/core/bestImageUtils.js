/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{earth as t}from"../../../geometry/support/Ellipsoid.js";import{distance as e}from"../../../geometry/support/pointUtils.js";import a from"./ExposurePoint.js";function i(t){const{camera:e,features:a,selectedPoint:i}=t;if(!a.length)return[];t.currentImage??={attributes:{cameraHeading:0,cameraPitch:0}};const s=r(e,i,t.currentImage);return a.map(s)}function r(a,i,r){return i.z??=0,i.elevation??=0,h=>{const{hfovWeight:n,vfovWeight:o,distanceWeight:c}=s(h.attributes,a?"3d":"2d"),l=h.attributes,{cameraHeight:g,cameraHeading:M,cameraPitch:u,farDistance:f,horizontalFieldOfView:b,verticalFieldOfView:d,isOblique:m}=l,v=l.geometry,W=180*Math.atan2(v.y-i.y,v.x-i.x)/Math.PI,p=e(i,v);let y,x,P=b,I=d,q=!1;a?(y=a.heading,x=a.tilt,P=180,I=180,q=!0):!m||u<10?(y=M,x=u,q=!1):(y=r.attributes.cameraHeading,x=u,q=!0,P=180),y>180&&(y-=360);let H=1;v.spatialReference.isWebMercator&&(H=1/Math.cos(Math.PI/2-2*Math.atan(Math.exp(-1*v.y/t.radius))));const O=Math.sqrt((Math.sqrt((i.x-v.x)**2+(i.y-v.y)**2)/H)**2+((i.z??0)-(i.elevation??0)-g)**2),z=90-180*Math.atan2(i.y-v.y,i.x-v.x)/Math.PI;let j=(Math.abs(z-y)>180?Math.abs(360-Math.abs(z-y)):Math.abs(z-y))/P;j=4*j+1;const w=180*Math.acos((l.cameraHeight-(i.z??0)+(i.elevation??0))/O)/Math.PI;let E=Math.abs(w-x)/I;E=4*E+1;let F=O/Math.sqrt(f**2+g**2);F=4*F+1;const S=n*j+o*E+c*F;let V;if(q){const t=M>180?M-360:M;V=n*((Math.abs(z-t)>180?Math.abs(360-Math.abs(z-t)):Math.abs(z-t))/b*4+1)+o*(Math.abs(w-u)/d*4+1)+c*F}else V=S;return{suitability:S,trueSuitability:V,feature:h,angle:W,distance:p,verticalAngle:Math.abs(180*Math.atan(p/g)/Math.PI)}}}function s(t,e){const i="isOblique"in t?t:new a(t),{isOblique:r,isSpherical:s,isNadir:h}=i;return s?{hfovWeight:"2d"===e?0:1,vfovWeight:"2d"===e?0:.6,distanceWeight:"2d"===e?1:.5}:h?{hfovWeight:.25,vfovWeight:1,distanceWeight:1}:r?{hfovWeight:1,vfovWeight:.25,distanceWeight:1}:{hfovWeight:1,vfovWeight:1,distanceWeight:1}}export{i as calculateSuitabilities};
