/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{rad2deg as t,deg2rad as a}from"../../../core/mathUtils.js";import{create as n}from"../../../core/libs/gl-matrix-2/factories/mat3f64.js";import{create as s}from"../../../core/libs/gl-matrix-2/factories/mat4f64.js";import{zeros as h}from"../../../core/libs/gl-matrix-2/factories/vec3f64.js";import{invertOrIdentity as M}from"../../../core/libs/gl-matrix-2/math/mat4.js";import{initializeProjection as i,projectWithZConversion as o}from"../../../geometry/projection.js";import{earth as r}from"../../../geometry/support/Ellipsoid.js";import{isWebMercator as c}from"../../../geometry/support/spatialReferenceUtils.js";import{defaultImageSphereSize as e}from"../../../widgets/PanoramicViewer/constants.js";function z(t,a,n){const[s,h,M,i]=a,[o,r,c,e]=n;return u(t,s,h,M,i,o,r,c,e)}function u(t,a,n,h,i,o,r,c,e){let z=!1;0===a.z&&0===n.z&&0===h.z&&0===i.z&&(a.z=n.z=h.z=i.z=1,t.z=1),a.z=a.z??1,n.z=n.z??1,h.z=h.z??1,i.z=i.z??1,0===o.z&&0===r.z&&0===c.z&&0===e.z&&(z=!0,o.z=r.z=c.z=e.z=1),o.z=o.z??1,r.z=r.z??1,c.z=c.z??1,e.z=e.z??1;const u=m(a,n,h,i),f=m(o,r,c,e),x=M(s(),u),y=s();y[0]=f[0]*x[0]+f[1]*x[4]+f[2]*x[8]+f[3]*x[12],y[1]=f[0]*x[1]+f[1]*x[5]+f[2]*x[9]+f[3]*x[13],y[2]=f[0]*x[2]+f[1]*x[6]+f[2]*x[10]+f[3]*x[14],y[3]=f[0]*x[3]+f[1]*x[7]+f[2]*x[11]+f[3]*x[15],y[4]=f[4]*x[0]+f[5]*x[4]+f[6]*x[8]+f[7]*x[12],y[5]=f[4]*x[1]+f[5]*x[5]+f[6]*x[9]+f[7]*x[13],y[6]=f[4]*x[2]+f[5]*x[6]+f[6]*x[10]+f[7]*x[14],y[7]=f[4]*x[3]+f[5]*x[7]+f[6]*x[11]+f[7]*x[15],y[8]=f[8]*x[0]+f[9]*x[4]+f[10]*x[8]+f[11]*x[12],y[9]=f[8]*x[1]+f[9]*x[5]+f[10]*x[9]+f[11]*x[13],y[10]=f[8]*x[2]+f[9]*x[6]+f[10]*x[10]+f[11]*x[14],y[11]=f[8]*x[3]+f[9]*x[7]+f[10]*x[11]+f[11]*x[15],y[12]=f[12]*x[0]+f[13]*x[4]+f[14]*x[8]+f[15]*x[12],y[13]=f[12]*x[1]+f[13]*x[5]+f[14]*x[9]+f[15]*x[13],y[14]=f[12]*x[2]+f[13]*x[6]+f[14]*x[10]+f[15]*x[14],y[15]=f[12]*x[3]+f[13]*x[7]+f[14]*x[11]+f[15]*x[15];const p=y[0]*t.x+y[1]*t.y+y[2]*t.z+y[3],l=y[4]*t.x+y[5]*t.y+y[6]*t.z+y[7],b=y[8]*t.x+y[9]*t.y+y[10]*t.z+y[11];let g=y[12]*t.x+y[13]*t.y+y[14]*t.z+y[15];return 0===g&&(g=1),{x:p/g,y:l/g,z:z?0:b/g}}function m(t,a,n,s){const h=p([s.x,s.y,s.z,1],M(new Array(16),[t.x,a.x,n.x,0,t.y,a.y,n.y,0,t.z,a.z,n.z,0,1,1,1,1])),i=h[0],o=h[1],r=h[2],c=new Array(16);return c[0]=i*t.x,c[1]=o*a.x,c[2]=r*n.x,c[3]=0,c[4]=i*t.y,c[5]=o*a.y,c[6]=r*n.y,c[7]=0,c[8]=i*t.z,c[9]=o*a.z,c[10]=r*n.z,c[11]=0,c[12]=i,c[13]=o,c[14]=r,c[15]=1,c}function f(t,a,n,s,M=h()){return M[0]=t[0]+a[0]*n,M[1]=t[1]+a[1]*n,M[2]=t[2]+a[2]*(n/s),M}function x(t,a,n){const s=h();return s[0]=t[0]*a,s[1]=t[1]*a,s[2]=t[2]*(a/n),s}function y(t,a){const[n,s,M]=t,i=h();return i[0]=n*a[0]+s*a[3]+M*a[6],i[1]=n*a[1]+s*a[4]+M*a[7],i[2]=n*a[2]+s*a[5]+M*a[8],i}function p(t,a){const[n,s,h,M]=t,i=new Array(4);return i[0]=n*a[0]+s*a[1]+h*a[2]+M*a[3],i[1]=n*a[4]+s*a[5]+h*a[6]+M*a[7],i[2]=n*a[8]+s*a[9]+h*a[10]+M*a[11],i[3]=n*a[12]+s*a[13]+h*a[14]+M*a[15],i}function l(t,a){const s=Math.PI/180,h=n();if("OPK"===t){const t=Number(a[0])*s,n=Number(a[1])*s,M=Number(a[2])*s;h[0]=Math.cos(n)*Math.cos(M),h[1]=Math.cos(t)*Math.sin(M)+Math.sin(t)*Math.sin(n)*Math.cos(M),h[2]=Math.sin(t)*Math.sin(M)-Math.cos(t)*Math.sin(n)*Math.cos(M),h[3]=-Math.cos(n)*Math.sin(M),h[4]=Math.cos(t)*Math.cos(M)-Math.sin(t)*Math.sin(n)*Math.sin(M),h[5]=Math.sin(t)*Math.cos(M)+Math.cos(t)*Math.sin(n)*Math.sin(M),h[6]=Math.sin(n),h[7]=-Math.sin(t)*Math.cos(n),h[8]=Math.cos(t)*Math.cos(n)}else{const t=Number(a[0])*s,n=Number(a[1])*s,M=Number(a[2])*s;h[0]=Math.cos(t)*Math.cos(M)-Math.sin(t)*Math.cos(n)*Math.sin(M),h[1]=Math.sin(t)*Math.cos(M)*-1-Math.cos(t)*Math.cos(n)*Math.sin(M),h[2]=Math.sin(M)*Math.sin(n)*-1,h[3]=Math.cos(t)*Math.sin(M)+Math.sin(t)*Math.cos(n)*Math.cos(M),h[4]=Math.sin(t)*Math.sin(M)*-1+Math.cos(t)*Math.cos(n)*Math.cos(M),h[5]=Math.cos(M)*Math.sin(n),h[6]=Math.sin(t)*Math.sin(n)*-1,h[7]=Math.cos(t)*Math.sin(n)*-1,h[8]=Math.cos(n)}return h}function b(t,a,n){const s=Math.sin(n*Math.PI/180),h=Math.cos(n*Math.PI/180),M=[[t,0],[t,a],[0,a]];M.forEach(((t,a)=>{M[a]=[h*t[0]-s*t[1],s*t[0]+h*t[1]]}));const i={xmin:Math.min(0,M[0][0],M[1][0],M[2][0]),xmax:Math.max(0,M[0][0],M[1][0],M[2][0]),ymin:Math.min(0,M[0][1],M[1][1],M[2][1]),ymax:Math.max(0,M[0][1],M[1][1],M[2][1])};return{hfov:Math.abs(i.xmax-i.xmin),vfov:Math.abs(i.ymax-i.ymin)}}function g(t,a,n,s,h,M){const i=n*(a.x-t.x)+s*(a.y-t.y)+h*(a.z-t.z);if(0===i)return null;const o=-(n*t.x+s*t.y+h*t.z+M)/i;return{x:t.x+o*(a.x-t.x),y:t.y+o*(a.y-t.y),z:t.z+o*(a.z-t.z)}}function j(t,a){const n=Math.PI/180,s=t.y*n,h=t.x*n,M=t.z||0,i=a[0]*n,o=a[1]*n,r=a[2]/Math.sqrt(1-a[3]*Math.sin(i)**2),c=h-o,e=a[2]/Math.sqrt(1-a[3]*Math.sin(s)**2),z=a[3]*(r*Math.sin(i)-e*Math.sin(s));return{x:(e+M)*Math.cos(s)*Math.sin(c),y:(e+M)*(Math.sin(s)*Math.cos(i)-Math.sin(i)*Math.cos(s)*Math.cos(c))+z*Math.cos(i),z:(e+M)*(Math.sin(s)*Math.sin(i)+Math.cos(i)*Math.cos(s)*Math.cos(c))-r+z*Math.sin(i)}}function q(t,a){const n=Math.PI/180,s=Number(t.x),h=Number(t.y),M=Number(t.z),i=a[0]*n,o=a[1]*n,r=a[2]/Math.sqrt(1-a[3]*Math.sin(i)**2),c=s/r,e=h/r,z=M/r,u=Math.cos(i)-Math.sin(i)*e+Math.cos(i)*z,m=Math.sin(i)+Math.cos(i)*e+Math.sin(i)*z,f=Math.sqrt(u**2+c**2),x=a[3]*r*Math.sin(i),y=i,p=Math.atan(m/f-(x-a[3]*(a[2]/Math.sqrt(1-a[3]*Math.sin(y)**2))*Math.sin(y))/(r*f)),l=Math.atan(m/f-(x-a[3]*(a[2]/Math.sqrt(1-a[3]*Math.sin(p)**2))*Math.sin(p))/(r*f)),b=Math.atan(m/f-(x-a[3]*(a[2]/Math.sqrt(1-a[3]*Math.sin(l)**2))*Math.sin(l))/(r*f)),g=Math.atan(m/f-(x-a[3]*(a[2]/Math.sqrt(1-a[3]*Math.sin(b)**2))*Math.sin(b))/(r*f)),j=Math.atan(s/(r*u))+o;return{x:j/n,y:g/n,z:s/(Math.cos(g)*Math.sin(j-o))-a[2]/Math.sqrt(1-a[3]*Math.sin(g)**2),spatialReference:{wkid:4326}}}function N(t){return t&&c(t?.spatialReference)?1/Math.cos(Math.PI/2-2*Math.atan(Math.exp(-1*t.y/r.radius))):1}function d(t,a,n){const s=360/a,h=180/n;return{heading:(t.x-a/2)*s,pitch:90-(t.y-n/2)*h}}function w(t,a,n,s=e/2){const{heading:h,pitch:M}=I(t,s);return P(h,M,a,n)}function P(t,a,n,s){return{x:n/2+t/(360/n),y:s-a/(180/s),heading:t,pitch:a}}function I(a,n){const s=t(Math.acos(-a.z/n));return{heading:t(Math.atan2(a.x,a.y)),pitch:s}}function R(t,n,s=e/2){return[s*(Math.sin(a(t))*Math.sin(a(n))),s*(Math.cos(a(t))*Math.sin(a(n))),s*Math.cos(a(180-n))]}async function v(a,n,s){await i(n.spatialReference,a.spatialReference,null,s);const h=await o(n,a.spatialReference,s);let M=t(Math.atan2(h.y-a.y,h.x-a.x));return M=M>=0&&M<=90?90-M:M>90&&M<=180?360-M+90:90+Math.abs(M),M}function A(t,a,n){const s=Math.cos(n),h=Math.sin(n),M=[1,0,0,1,0,0],i=M[0]*s+M[2]*h,o=M[1]*s+M[3]*h,r=-M[0]*h+M[2]*s,c=-M[1]*h+M[3]*s;M[0]=i,M[1]=o,M[2]=r,M[3]=c;return[t*M[0]+a*M[2]+M[4],t*M[1]+a*M[3]+M[5]]}export{l as calculateRotationMatrix,b as computeHFOVAndVFOV,R as convertHeadingPitchToSphereVertex,P as convertOrientationToPixelLocation,d as convertPixelToHeadingPitch,I as convertSphereVertexToOrientation,w as convertSphereVertexToPixelLocation,j as geographicToLTP,v as getInitialAngle,g as getPlaneLineIntersectionPoint,N as getWebMercatorScalingFactor,m as linearEquationSolve,q as ltpToGeographic,u as projectiveTransform,z as projectiveTransform2,A as rotatePixel,f as scaleAndAddWithFactor,x as scaleWithFactor,y as transformMat3,p as transformMat4};
