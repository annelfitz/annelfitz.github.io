/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import"../../../geometry.js";import{deg2rad as t}from"../../../core/mathUtils.js";import{create as a}from"../../../core/libs/gl-matrix-2/factories/mat3f64.js";import{mul as e}from"../../../core/libs/gl-matrix-2/math/mat3.js";import{earth as r}from"../../../geometry/support/Ellipsoid.js";import{isWebMercator as i}from"../../../geometry/support/spatialReferenceUtils.js";import{webMercatorToGeographic as o,geographicToWebMercator as n}from"../../../geometry/support/webMercatorUtils.js";import c from"../core/cameraOrientationFactory.js";import{geographicToLTP as s,calculateRotationMatrix as m}from"./utils.js";import f from"../../../geometry/Point.js";function l(t,a){const{cameraOrientation:e,cameraLocation:r,pointsToTransform:i,rotationMatrix:o,scalingFactor:n}=g(t,a),c=new Array;return e?.isAdvanced?u(i,c,o,{...a,cameraOrientation:e,scalingFactor:n,cameraLocation:r}):h(i,c,o,{...a,cameraOrientation:e,scalingFactor:n,cameraLocation:r}),1===c.length?c[0]:c}function p(t,a,e){return l(t?a.map((t=>o(t))):a,e).map((t=>({...t,z:1})))}function u(t,a,e,r){const{cameraOrientation:i,cameraLocation:o,scalingFactor:n}=r,{principalOffsetPoint:c,focalLength:s,radialDistortionCoefficients:m,affineTransformations:f,tangentialDistortionCoefficients:l}=i;for(const p of t){const[t,r,u]=y(p,i,o,n),g=(e[0]*t+e[1]*r+e[2]*u)/(e[6]*t+e[7]*r+e[8]*u),h=(e[3]*t+e[4]*r+e[5]*u)/(e[6]*t+e[7]*r+e[8]*u),O=g**2+h**2;let d=0,x=0,M=0,b=0,R=0,j=0,F=0;m&&(d=m[0]??0,x=m[1]??0,M=m[2]??0),l&&(b=l[0],R=l[1]),c&&(j=c[0]??0,F=c[1]??0);const P=1+(d||0)*O+(x||0)*O*O+(M||0)*O*O*O;let z=g*P+(b||0)*(O+2*g**2)+2*(R||0)*g*h,L=h*P+(R||0)*(O+2*h**2)+2*(b||0)*g*h;z=-(s??0)*z+j,L=-(s??0)*L+F;const w=Number(f[0])+Number(f[1])*z+Number(f[2])*L,N=Number(f[3])+Number(f[4])*z+Number(f[5])*L;a.push({x:w,y:N})}}function g(t,a){const e=Array.isArray(t)||"items"in t?t:[t],r="string"==typeof a.cameraOrientation?c.getCameraOrientation(a.cameraOrientation):a.cameraOrientation,i=O({...a,cameraOrientation:r});let o=new f(a.cameraLocation);(o.spatialReference.isWGS84&&4!==r?.type||o.spatialReference.isGeographic)&&(o=n(o)),o.z||(o.z=a.cameraHeight);return{cameraOrientation:r,pointsToTransform:e,rotationMatrix:i,scalingFactor:d(o),cameraLocation:o}}function h(r,i,o,n){const{horizontalFieldOfView:c,verticalFieldOfView:s,cameraOrientation:m,cameraLocation:f,scalingFactor:l}=n,p=t(n.imageRotation??0),u=Math.sin(p),g=Math.cos(p),h=n.imageWidth||1,O=n.imageHeight||1,d=[Math.abs(g*h+u*O),Math.abs(g*O-u*h)],x={horizontal:1/(2*Math.tan(t(c)/2)),vertical:1/(2*Math.tan(t(s)/2))},M=a();M[0]=-x.horizontal,M[2]=.5,M[4]=x.vertical,M[5]=.5;const b=e(a(),o,M);for(const t of r){const[a,e,r]=y(t,m,f,l),o=(b[0]*a+b[1]*e+b[2]*r)/(b[6]*a+b[7]*e+b[8]*r),n=(b[3]*a+b[4]*e+b[5]*r)/(b[6]*a+b[7]*e+b[8]*r),c={x:o*d[0],y:n*d[1]};i.push({x:g*(c.x-d[0]/2)+u*(c.y-d[1]/2)+h/2,y:-u*(c.x-d[0]/2)+g*(c.y-d[1]/2)+O/2})}}function y(t,a,e,r){let i=new f(t);if(i.spatialReference.isGeographic)if(i.spatialReference.isWGS84&&4===a?.type){const{latitude:t,longitude:e,ellipsoidRadius:r,squaredEccentricity:o}=a;i=new f(s(i,[t,e,r,o]))}else i=n(i);const o=(i.z??0)-(e.z??0),c=(i.y-e.y)/r;return[(i.x-e.x)/r,c,o]}function O(t){const{cameraHeading:a,cameraPitch:e,cameraRoll:r,cameraOrientation:i}=t;if("OPK"===(i?.isAdvanced&&2===i.type?"OPK":"HPR")){const{omega:t,phi:a,kappa:e}=i;return m("OPK",[t,a,e])}return m("HPR",[a,e,r])}function d(t){return i(t?.spatialReference)?1/Math.cos(Math.PI/2-2*Math.atan(Math.exp(-1*t.y/r.radius))):1}export{d as getScalingFactor,l as worldToImage,p as worldToImageWithLTPFlag};
