/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import r from"../../core/Collection.js";import{makeHandle as t}from"../../core/handleUtils.js";import o from"../../core/Logger.js";import{LRUCache as i}from"../../core/LRUCache.js";import{getOrCreateMapValue as s}from"../../core/MapUtils.js";import{MultiOriginJSONMixin as a}from"../../core/MultiOriginJSONSupport.js";import{property as n}from"../../core/accessorSupport/decorators/property.js";import"../../core/has.js";import"../../core/RandomLCG.js";import{subclass as l}from"../../core/accessorSupport/decorators/subclass.js";import c from"../Layer.js";import{BlendLayer as p}from"../mixins/BlendLayer.js";import{ScaleRangeLayer as m}from"../mixins/ScaleRangeLayer.js";import{opacity as y}from"../support/commonProperties.js";import{layerLookupMap as d}from"../support/lazyLayerLoader.js";import u from"../support/OrderByInfo.js";import f from"../../portal/Portal.js";import h from"../../portal/PortalItem.js";import{getAttributeComparator as j}from"../../statistics/utils.js";class g{constructor(e,r){this.objectId=e,this.itemSource=r,this.count=0,this.layer=null,this.sortValue=void 0}}const _=new i(20,(e=>e.destroy()));let L=class extends(m(p(a(c)))){static clearLayerCache(){_.clear()}constructor(e){super(e),this._oidToReference=new Map,this._layerToReference=new Map,this._portals=new Map,this.layers=new r,this.maximumVisibleSublayers=10,this.opacity=1,this.title="Layers In View",this.type="catalog-dynamic-group",this.visible=!0}load(e){return this.addResolvingPromise(this.parent.load()),Promise.resolve(this)}get _orderBy(){return this.parent.orderBy?.find((e=>!e.valueExpression&&e.field))??new u({field:this.parent.objectIdField})}get _referenceComparator(){const e=this._orderBy,r=this.parent.fieldsIndex.get(e.field),t=j(r?.toJSON().type,"descending"===e.order);return(e,r)=>{const o=t(e.sortValue,r.sortValue);return o||e.objectId-e.objectId}}acquireLayer(e){const r=e.getObjectId(),o=s(this._oidToReference,r,(()=>this._createLayerReference(e)));return o.count++,t((()=>{o.count--,o.count||this._disposeLayerReference(o)}))}_createLayerReference(e){const r=e.getObjectId(),t=e.getAttribute(this.parent.itemSourceField),i=new g(r,t);if(_.get(t))return this._addLayer(_.pop(t),i,e),i;let s;try{s=JSON.parse(t)}catch(a){return o.getLogger(this).error(a),i}return this._createLayer(s).then((r=>{this._configureLayer(r,e),this.destroyed||0===i.count?(_.get(t)||_.put(i.itemSource,r),i.layer=null):this._addLayer(r,i,e)})).catch((()=>{})),i}_addLayer(e,r,t){this._layerToReference.set(e,r),r.sortValue=t.getAttribute(this._orderBy.field),r.layer=e,e.parent=this,this.layers.add(e),this.layers.sort(((e,r)=>this._referenceComparator(this._layerToReference.get(e),this._layerToReference.get(r))))}_disposeLayerReference(e){e.layer&&(this._layerToReference.delete(e.layer),this.layers.remove(e.layer),_.put(e.itemSource,e.layer)),this._oidToReference.delete(e.objectId)}async _createLayer(e){if(S(e)){const{itemId:r,portalUrl:t}=e,o=s(this._portals,t,(()=>new f({url:t})));return c.fromPortalItem(new h({id:r,portal:o}))}if(R(e))return c.fromArcGISServerUrl({url:e.url});return new(await d.UnsupportedLayer())}_configureLayer(e,r){const{parent:t}=this,o=r.getAttribute(t.itemNameField);o&&(e.title=o);const i=r.getAttribute(t.maxScaleField);null!=i&&"maxScale"in e&&(e.maxScale=i);const s=r.getAttribute(t.minScaleField);null!=s&&"minScale"in e&&(e.minScale=s)}};e([n()],L.prototype,"_orderBy",null),e([n()],L.prototype,"_referenceComparator",null),e([n({readOnly:!0})],L.prototype,"layers",void 0),e([n()],L.prototype,"maximumVisibleSublayers",void 0),e([n(y)],L.prototype,"opacity",void 0),e([n({type:String,json:{name:"title",write:!0}})],L.prototype,"title",void 0),e([n({json:{read:!1}})],L.prototype,"type",void 0),e([n({type:Boolean,json:{name:"visibility",write:!0}})],L.prototype,"visible",void 0),L=e([l("esri.layers.catalog.CatalogDynamicGroupLayer")],L);const b=L;function S(e){return"object"==typeof e&&null!=e&&"itemId"in e&&"portalUrl"in e}function R(e){return"object"==typeof e&&null!=e&&"url"in e}export{b as default};
