/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import"../../../geometry.js";import{isSome as e}from"../../../core/arrayUtils.js";import{isWKT2 as t}from"../../../geometry/support/spatialReferenceUtils.js";import{isSameTagIgnoreNS as n,getElementValue as r,getElements as s,getElement as a,getElementNumericValue as i,getElementNumericValues as l}from"./xmlUtilities.js";import o from"../rasterTransforms/PolynomialTransform.js";import f from"../../../geometry/SpatialReference.js";function u(e,t){if(!e||!t)return null;const n=[];for(let r=0;r<e.length;r++)n.push(e[r]),n.push(t[r]);return n}function c(e){const t=a(e,"GeodataXform"),n=d(i(t,"SpatialReference/WKID")||r(t,"SpatialReference/WKT"));if("typens:PolynomialXform"!==t.getAttribute("xsi:type"))return{spatialReference:n,transform:null};const s=i(t,"PolynomialOrder")??1,f=l(t,"CoeffX/Double"),c=l(t,"CoeffY/Double"),m=l(t,"InverseCoeffX/Double"),p=l(t,"InverseCoeffY/Double"),S=u(f,c),C=u(m,p);return{spatialReference:n,transform:S&&C&&S.length&&C.length?new o({spatialReference:n,polynomialOrder:s,forwardCoefficients:S,inverseCoefficients:C}):null}}function m(e){const t=i(e,"NoDataValue"),n=a(e,"Histograms/HistItem"),l=i(n,"HistMin"),o=i(n,"HistMax"),f=i(n,"BucketCount"),u=r(n,"HistCounts")?.split("|").map((e=>Number(e)));let c,m,d,p;s(e,"Metadata/MDI").forEach((e=>{const t=Number(e.textContent??e.nodeValue);switch(e.getAttribute("key").toUpperCase()){case"STATISTICS_MINIMUM":c=t;break;case"STATISTICS_MAXIMUM":m=t;break;case"STATISTICS_MEAN":d=t;break;case"STATISTICS_STDDEV":p=t}}));const S=i(e,"Metadata/SourceBandIndex");return{noDataValue:t,histogram:u?.length&&null!=l&&null!=o?{min:l,max:o,size:f||u.length,counts:u}:null,sourceBandIndex:S,statistics:null!=c&&null!=m?{min:c,max:m,avg:d,stddev:p}:null}}function d(e){if(!e)return null;let n=Number(e);if(!isNaN(n)&&0!==n)return new f({wkid:n});if(e=String(e).trim(),t(e))return new f({wkt2:e});const r=e.toUpperCase();if(r.startsWith("COMPD_CS")){if(!r.includes("VERTCS")||!r.includes("GEOGCS")&&!r.startsWith("PROJCS"))return null;const t=r.indexOf("VERTCS"),s=r.indexOf("PROJCS"),a=s>-1?s:r.indexOf("GEOGCS");if(-1===a)return null;const i=e.slice(a,e.lastIndexOf("]",t)+1).trim(),l=e.slice(t,e.lastIndexOf("]")).trim();n=p(i);const o=new f(n?{wkid:n}:{wkt:i}),u=p(l);return u&&(o.vcsWkid=u),o}return r.startsWith("GEOGCS")||r.startsWith("PROJCS")?(n=p(e),new f(0!==n?{wkid:n}:{wkt:e})):null}function p(e){const t=e.replaceAll("]","[").replaceAll('"',"").split("[").map((e=>e.trim())).filter((e=>""!==e)),n=t[t.length-1].split(","),r=n[0]?.toLowerCase();if(("epsg"===r||"esri"===r)&&e.endsWith('"]]')){const e=Number(n[1]);if(!isNaN(e)&&0!==e)return e}return 0}function S(t){if("pamdataset"!==t?.documentElement.tagName?.toLowerCase())return{};const a={spatialReference:null,transform:null,metadata:{},rasterBands:[],statistics:null,histograms:null};t.documentElement.childNodes.forEach((e=>{if(1===e.nodeType)if(n(e,"SRS")){if(!a.spatialReference){const t=r(e);a.spatialReference=d(t)}}else if(n(e,"Metadata"))if("xml:ESRI"===e.getAttribute("domain")){const{spatialReference:t,transform:n}=c(e);a.transform=n,a.spatialReference||(a.spatialReference=t)}else{s(e,"MDI").forEach((e=>a.metadata[e.getAttribute("key")]=r(e)))}else if(n(e,"PAMRasterBand")){const t=m(e);null!=t.sourceBandIndex&&null==a.rasterBands[t.sourceBandIndex]?a.rasterBands[t.sourceBandIndex]=t:a.rasterBands.push(t)}}));const i=a.rasterBands;if(i.length){const t=!!i[0].statistics;a.statistics=t?i.map((e=>e.statistics)).filter(e):null;const n=!!i[0].histogram;a.histograms=n?i.map((e=>e.histogram)).filter(e):null}return a}export{S as parsePAMInfo,d as parseSpatialReference};
