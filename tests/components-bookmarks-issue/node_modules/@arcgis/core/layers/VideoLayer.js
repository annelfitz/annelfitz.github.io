/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{_ as t}from"../chunks/tslib.es6.js";import"../geometry.js";import e from"../request.js";import{clamp as r}from"../core/mathUtils.js";import{MultiOriginJSONMixin as o}from"../core/MultiOriginJSONSupport.js";import{watch as i,initial as l}from"../core/reactiveUtils.js";import{property as s}from"../core/accessorSupport/decorators/property.js";import"../core/has.js";import"../core/Logger.js";import"../core/RandomLCG.js";import{reader as n}from"../core/accessorSupport/decorators/reader.js";import{subclass as p}from"../core/accessorSupport/decorators/subclass.js";import a from"../geometry/Polyline.js";import u from"../geometry/SpatialReference.js";import c from"./Layer.js";import{BlendLayer as m}from"./mixins/BlendLayer.js";import{CustomParametersMixin as y}from"./mixins/CustomParametersMixin.js";import{ScaleRangeLayer as d}from"./mixins/ScaleRangeLayer.js";import{url as h}from"./support/commonProperties.js";import f from"./support/PlaybackInfo.js";import{getVideoLayerCapabilities as g}from"./support/serviceCapabilitiesUtils.js";import v from"./support/TelemetryData.js";import j from"./support/TelemetryDisplay.js";import S from"./support/VideoFrame.js";import O from"./video/VideoController.js";import{getTelemetryData as b,getSensorTrailPoints as C,readVideoTimeExtent as T}from"./video/videoUtils.js";import U from"../geometry/Polygon.js";import x from"../geometry/Extent.js";let I=class extends(m(d(o(y(c))))){constructor(t){super(t),this._trailPoints=[],this.capabilities=null,this.connectionInfo=null,this.controller=new O,this.copyright=null,this.coverage=null,this.description=null,this.frame=null,this.frameCount=null,this.initialExtent=null,this.playbackInfo=null,this.posterUrl=null,this.protocol="hls",this.qualities=null,this.serviceItemId=null,this.sourceJSON=null,this.spatialReference=u.WGS84,this.telemetryDisplay=null,this.videoTimeExtent=null,this.title=null,this.type="video",this.url=null}initialize(){this.telemetryDisplay=new j({frameCenter:!0,frameOutline:!0,lineOfSight:!0,sensorLocation:!0,sensorTrail:!0}),this.addHandles([i((()=>this.metadata),(()=>this.notifyChange("telemetry"))),i((()=>this.telemetry?.sensorLocation),(t=>this._setSensorTrail(t)),l)])}load(t){const e=null!=t?t.signal:null;return this.addResolvingPromise(this._fetchService(e)),Promise.resolve(this)}get buffered(){return this.controller.buffered}readCapabilitiesFromService(t,e){return g(e)}readConnectionInfo(t,e){const r=e.connectionUrl;return this.controller.playerUrl=r&&this.protocol?r[this.protocol]:"",r}get currentTime(){return this.controller.currentTime}get duration(){return this.controller.duration}get ended(){return this.controller.ended}get loop(){return this.controller.loop}set loop(t){this.controller.loop=t}get metadata(){return this.controller?.currentMetadata}get muted(){return this.controller.muted}set muted(t){this.controller.muted=t}get playbackRate(){return this.controller.rate}set playbackRate(t){this.controller.rate=t}get playerUrl(){return this.controller.playerUrl}get playing(){return this.controller.playing}get state(){return this.controller.state}get telemetry(){return b(this.metadata)}get videoElement(){return this.controller?.element}get videoHeight(){return this.controller?.videoHeight}get videoWidth(){return this.controller?.videoWidth}get waiting(){return this.controller.waiting}play(){this.controller.play()}pause(){this.controller.pause()}reset(){this.controller.reset()}setCurrentTime(t){if(!this.duration)return;const e=r(t,0,this.duration);this.controller.setCurrentTime(e)}getCurrentFrame(){}toGround(t,e){return this.controller?.sensorModel?.metadataSupportsTransforms?this.controller.sensorModel.transformImageToGeo(t,e):null}toVideo(t){if(!this.controller?.sensorModel?.metadataSupportsTransforms)return null;const e=this.controller.sensorModel.transformGeoToImage(t.x,t.y,t.z);return{x:e[0],y:e[1]}}async _fetchService(t){if(this.sourceJSON)return void this.read(this.sourceJSON,{origin:"service",url:this.parsedUrl});const{data:r,ssl:o}=await e(this.parsedUrl.path,{query:{f:"json",...this.parsedUrl.query,...this.customParameters},signal:t});o&&(this.url=this.url.replace(/^http:/i,"https:")),this.sourceJSON=r,this.read(r,{origin:"service",url:this.parsedUrl})}_setSensorTrail(t){if(!t)return;const e=C(t,this._trailPoints);this._trailPoints=[...e];const r=this._trailPoints.map((t=>t.toArray())),o=new a({hasZ:t.hasZ,paths:[r]});this.telemetry.sensorTrail=o.clone()}};t([s({readOnly:!0})],I.prototype,"buffered",null),t([s({readOnly:!0,json:{read:!1}})],I.prototype,"capabilities",void 0),t([n("service","capabilities",["supportsCoverageQuery","supportsExportClip","supportsMensuration"])],I.prototype,"readCapabilitiesFromService",null),t([s({readOnly:!0})],I.prototype,"connectionInfo",void 0),t([n("connectionInfo",["connectionUrl"])],I.prototype,"readConnectionInfo",null),t([s()],I.prototype,"controller",void 0),t([s({type:String})],I.prototype,"copyright",void 0),t([s({type:U})],I.prototype,"coverage",void 0),t([s({type:Number})],I.prototype,"currentTime",null),t([s({type:String})],I.prototype,"description",void 0),t([s({type:Number})],I.prototype,"duration",null),t([s({type:Boolean})],I.prototype,"ended",null),t([s({type:S})],I.prototype,"frame",void 0),t([s({type:Number})],I.prototype,"frameCount",void 0),t([s({type:x})],I.prototype,"initialExtent",void 0),t([s({type:Boolean})],I.prototype,"loop",null),t([s({readOnly:!0})],I.prototype,"metadata",null),t([s({type:Boolean})],I.prototype,"muted",null),t([s({type:f})],I.prototype,"playbackInfo",void 0),t([s({type:Number})],I.prototype,"playbackRate",null),t([s({type:String})],I.prototype,"playerUrl",null),t([s({readOnly:!0})],I.prototype,"playing",null),t([s({readOnly:!0,json:{read:{source:"poster"}}})],I.prototype,"posterUrl",void 0),t([s({type:String})],I.prototype,"protocol",void 0),t([s({readOnly:!0})],I.prototype,"qualities",void 0),t([s({readOnly:!0})],I.prototype,"serviceItemId",void 0),t([s()],I.prototype,"sourceJSON",void 0),t([s()],I.prototype,"spatialReference",void 0),t([s({type:String})],I.prototype,"state",null),t([s({type:v})],I.prototype,"telemetry",null),t([s({type:j})],I.prototype,"telemetryDisplay",void 0),t([s({readOnly:!0,nonNullable:!1,json:{read:{reader:T,source:"time"}}})],I.prototype,"videoTimeExtent",void 0),t([s({readOnly:!0,json:{read:{source:"name"}}})],I.prototype,"title",void 0),t([s({readOnly:!0})],I.prototype,"type",void 0),t([s(h)],I.prototype,"url",void 0),t([s({readOnly:!0})],I.prototype,"videoElement",null),t([s({readOnly:!0})],I.prototype,"videoHeight",null),t([s({readOnly:!0})],I.prototype,"videoWidth",null),t([s({readOnly:!0})],I.prototype,"waiting",null),I=t([p("esri.layers.VideoLayer")],I);const P=I;export{P as default};
