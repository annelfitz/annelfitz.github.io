/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{substitute as e}from"../../../intl/substitute.js";import{numericTypes as t}from"../../../layers/support/fieldUtils.js";import"../../../popup/content/AttachmentsContent.js";import"../../../popup/content/Content.js";import"../../../popup/content/CustomContent.js";import"../../../popup/content/ExpressionContent.js";import"../../../popup/content/FieldsContent.js";import"../../../popup/content/MediaContent.js";import"../../../popup/content/RelationshipContent.js";import n from"../../../popup/content/TextContent.js";import o from"../../../popup/ExpressionInfo.js";import s from"../../../popup/FieldInfo.js";import i from"../../../popup/support/FieldInfoFormat.js";import{getFieldAndExpressionInfos as r,getContentFromFieldInfos as l}from"./utils.js";import{getStatisticInfos as p,getClusterField as u,getPredominantTypeExpression as a,clusterCountField as f}from"../../support/clusterUtils.js";import{isClusterCompatibleRenderer as m}from"../../../views/2d/layers/support/clusterUtils.js";function c(e){const{fieldName:n,label:o,type:r}=e,l=null!=r&&t.includes(r),p=new s({fieldName:n,label:o,visible:!0,format:l?{places:"integer"===r||"small-integer"===r?0:2,digitSeparator:!0}:null});return"date"===r&&(p.format=new i({dateFormat:"short-date-short-time"})),p}function d(e,t){const n=e?t.getField(e):null;return null!=n?n.alias||n.name:void 0}function y(t,n,o){const{attributeInfo:s,statisticType:i}=n,{field:r,normalizationField:l}=s;let p,u="";if("avg"===i?p=l?o.clusters.avgNormFieldLabel:o.clusters.avgFieldLabel:"type"===i&&(p=o.clusters.predominantFieldLabel),p){const n=s.valueExpression?s.valueExpressionTitle:d(r,t),o=l&&d(l,t);u=e(p,{fieldLabel:n||"",normFieldLabel:o||""})}return u}function F(t,n,o,s){const{attributeInfo:i,statisticType:r}=n,{field:l,normalizationField:p}=i;let u,a="";if("avg"===r?u=p?s.clusters.avgNormFieldSummary:s.clusters.avgFieldSummary:"type"===r&&(u=s.clusters.predominantFieldSummary),u){const n=i.valueExpression?i.valueExpressionTitle:d(l,t),s=p&&d(p,t);a=e(u,{fieldLabel:n||"",normFieldLabel:s||"",fieldValue:"{"+o+"}"})}return a}function I(t){return{fieldInfo:c({fieldName:f,label:t.clusters.numFeatures,type:"integer"}),fieldSummary:new n({text:e(t.clusters.countSummary,{count:`{${f}}`})})}}async function b(e,t,s){if(!m(t))return null;const i=p(e,t),r=s.clusters.predominantNoneValue,l="unique-value"===t.type?t.uniqueValueInfos??[]:[],{fieldInfo:f,fieldSummary:d}=I(s),b=[d],x=[f],j=[];for(const p of i){const{statisticType:t,attributeInfo:i}=p,f=u(i,t),m=y(e,p,s);if("avg"===t)b.push(new n({text:F(e,p,f,s)})),x.push(c({fieldName:f,label:m,type:"double"}));else if("type"===t){const t=`expression/${f}`;b.push(new n({text:F(e,p,t,s)})),j.push(new o({name:f,title:m,returnType:"string",expression:a(l,f,r)})),x.push(c({fieldName:t}))}}return{fieldInfos:x,expressionInfos:j,content:b}}async function x(e,t,n){if(!m(t))return null;const{fieldInfo:o,fieldSummary:s}=I(n),i=[s],p=[o],u=[],{fieldInfos:a,expressionInfos:f}=await r({renderer:t,layer:e,isFeatureReduction:!0}),c=await l(e,{fieldInfos:a,expressionInfos:f},!0);return i.push(...c),p.push(...a),u.push(...f),{fieldInfos:p,expressionInfos:u,content:i}}export{b as getContentAndInfos,x as getContentAndInfosForPieChart};
