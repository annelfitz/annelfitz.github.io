/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import e from"../../core/Error.js";import i from"../../renderers/support/AuthoringInfo.js";import s from"../../renderers/support/ClassBreakInfo.js";import o from"../../renderers/visualVariables/support/SizeStop.js";import{getSize as a}from"../../renderers/visualVariables/support/visualVariableUtils.js";import{createVisualVariable as n}from"./color.js";import{createVisualVariables as l,createContinuousRenderer as t}from"./size.js";import{verifyBasicFieldValidity as r,createStopValuesForAboveBelow as u,clampAboveAndBelowStopValues as p,createDefaultStopValues as m}from"./support/utils.js";import{verifyBinningParams as c}from"../support/binningUtils.js";import{isAnyDateField as d,getFieldsList as v}from"../support/utils.js";import{binningCapableLayerTypes as f,featureCapableLayerTypes as b,createLayerAdapter as y,getLayerTypeLabels as h}from"../support/adapters/support/layerUtils.js";import{getAboveAndBelowSymbols as w}from"../symbology/support/aboveAndBelowUtils.js";import{applyCIMSymbolColor as z}from"../../symbols/support/cimSymbolUtils.js";import{Symbol3DMaterial as g}from"../../symbols/support/Symbol3DMaterial.js";const V=2**53-1;async function O(i){if(!i?.layer||!(i.field||i.valueExpression||i.sqlExpression))throw new e("univariate-colorsize-visual-variables:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required");if(i.valueExpression&&!i.sqlExpression&&!i.view)throw new e("univariate-colorsize-visual-variables:missing-parameters","View is required when 'valueExpression' is specified");if("above-and-below"===i.theme&&i.sizeOptions?.sizeOptimizationEnabled)throw new e("univariate-colorsize-visual-variables:invalid-parameters","sizeOptimizationEnabled cannot be true for 'above-and-below' theme");i.forBinning&&c(i,"univariate-colorsize-visual-variables");const s={...i,layer:i.layer},o=i.forBinning?f:b,a=y(s.layer,o,i.forBinning);if(!a)throw new e("univariate-colorsize-visual-variables:invalid-parameters","'layer' must be one of these types: "+h(o).join(", "));if(s.layer=a,s.theme=s.theme||s.colorOptions?.theme?s.theme:"high-to-low","90-10"===s.theme)throw new e("univariate-colorsize-visual-variables:not-supported","Only 'high-to-low', 'above-and-below', 'above', 'below' themes are supported.");const n=null!=s.signal?{signal:s.signal}:null;await a.load(n);const l=await v({field:s.field,normalizationField:s.normalizationField,valueExpression:s.valueExpression}),t=r(a,l,"univariate-colorsize-visual-variables:invalid-parameters");if(t)throw t;return s}function x(e,i){const s={...e},{sizeOptions:o,theme:a}=s,n=s.legendOptions||s.sizeOptions?.legendOptions;return delete s.sizeOptions,delete s.colorOptions,{...s,...o,statistics:i||s.statistics,theme:"above-and-below"===a?null:a,legendOptions:n}}function S(e,i){const s={...e},o=s.colorOptions,a=s.theme||o?.theme,n=s.legendOptions||s.colorOptions?.legendOptions;return delete s.sizeOptions,delete s.colorOptions,{...s,...o,statistics:i||s.statistics,theme:a,legendOptions:n}}async function E(i){if(!i?.layer||!(i.field||i.valueExpression||i.sqlExpression))throw new e("univariate-colorsize-continuous-renderer:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required");if(i.valueExpression&&!i.sqlExpression&&!i.view)throw new e("univariate-colorsize-continuous-renderer:missing-parameters","View is required when 'valueExpression' is specified");i.forBinning&&c(i,"univariate-colorsize-continuous-renderer");const s={...i,layer:i.layer};s.symbolType=s.symbolType||"2d",s.colorOptions||(s.colorOptions={}),s.colorOptions.isContinuous=s.colorOptions.isContinuous??!1;const o=i.forBinning?f:b,a=y(s.layer,o,i.forBinning);if(!a)throw new e("univariate-colorsize-continuous-renderer:invalid-parameters","'layer' must be one of these types: "+h(o).join(", "));s.layer=a;const n=null!=s.signal?{signal:s.signal}:null;if(await a.load(n),"above-and-below"===s.theme&&s.symbolOptions){if(s.symbolType.includes("3d-volumetric"))throw new e("univariate-colorsize-continuous-renderer:invalid-parameters","'symbolOptions' is applicable for '2d' and '3d-flat' 'symbolType' only");if("point"!==a.geometryType&&"polygon"!==a.geometryType)throw new e("univariate-colorsize-continuous-renderer:invalid-parameters","'symbolOptions' only apply to layers with 'point' or 'polygon' geometryType")}const l=await v({field:s.field,normalizationField:s.normalizationField,valueExpression:s.valueExpression}),t=r(a,l,"univariate-colorsize-continuous-renderer:invalid-parameters");if(t)throw t;return s}function I(e){const i={...e},s={...i.sizeOptions};return delete i.sizeOptions,delete i.colorOptions,delete s.sizeOptimizationEnabled,{...i,...s}}function T(e,i){if("type"in e&&"cim"===e.type)z(e,i);else if("type"in e&&e.type.includes("3d")){e.symbolLayers.forEach((e=>{"material"in e&&null!=e.material&&"color"in e.material&&(e.material?e.material.color=i:e.material=new g({color:i}))}))}else"color"in e&&(e.color=i)}function j(e,i,s){if((i?.symbolStyle||i?.symbols)&&("point"===s||"polygon"===s))return i.symbols||w(i.symbolStyle);const o=e.classBreakInfos[0].symbol;return{above:o.clone(),below:o.clone()}}function q(e,i,o){const a=o.symbolOptions,n=o.layer,l=a?.symbols?"custom":a?.symbolStyle,t=o.colorOptions?.isContinuous;if(B(e,i,t),l||!t){const o=i.size.visualVariables[0].stops,{above:r,below:u}=j(e,a,n.geometryType);if(!t){const e=i.color.colorScheme.colors,s=e[0];T(r,e[e.length-1]),T(u,s)}e.classBreakInfos=[new s({minValue:-V,maxValue:o[2].value,symbol:u}),new s({minValue:o[2].value,maxValue:V,symbol:r})],l&&e.authoringInfo&&(e.authoringInfo.univariateSymbolStyle=l)}}function B(e,i,s=!0){const o=i?.authoringInfo?.clone(),a=o?.visualVariables?.some((e=>"reference-size"===e.sizeInfoType)),n=a?[]:i.size.visualVariables.map((e=>e.clone()));s?n.push(i.color.visualVariable.clone()):o.visualVariables=o.visualVariables?.filter((e=>"size"===e.type)),n.push(...e.visualVariables.filter((e=>"target"in e&&"outline"===e.target)).map((e=>e.clone()))),e.authoringInfo=o,e.visualVariables=n}function D(e){const i={...e},s=i.symbolType,o=!!s?.includes("3d-volumetric");delete i.symbolType,delete i.defaultSymbolEnabled;const a=i;return a.worldScale=o,o&&(a.sizeOptions={...a.sizeOptions},a.sizeOptions.axis="3d-volumetric-uniform"===s?"all":"height"),a}async function U(e,i,s,n){const l=i[0],t=i[1],r=Math.round((t-l)/2)+l,u=e.clone();u.stops=[new o({value:s[0],size:t}),new o({value:s[1],size:r}),new o({value:s[2],size:l}),new o({value:s[3],size:r}),new o({value:s[4],size:t})],e.stops=[new o({value:n[0],size:a(u,n[0])}),new o({value:n[1],size:a(u,n[1])}),new o({value:n[2],size:a(u,n[2])}),new o({value:n[3],size:a(u,n[3])}),new o({value:n[4],size:a(u,n[4])})]}async function C(e,i,s,o,a){const n=e.find((e=>"width-and-depth"!==e.axis&&!e.target)),l="number"==typeof n?.minSize?n?.minSize:null,t="number"==typeof n?.maxSize?n?.maxSize:null;if(null!=n?.minDataValue&&null!=l&&null!=t)if(o)if("above-and-below"===o){n.minDataValue=null,n.maxDataValue=null,n.minSize=null,n.maxSize=null;const e=u(s,a),o=p(e,s);await U(n,[l,t],e,o),i.stops.forEach(((e,i)=>e.value=o[i]))}else{const{minDataValue:e,maxDataValue:s}=n,o=m(e,s,5);i.stops.forEach(((e,i)=>e.value=o[i])),n.minDataValue=o[0],n.maxDataValue=o[o.length-1]}else n.minDataValue=i.stops[0].value,n.maxDataValue=i.stops[i.stops.length-1].value}function F(e,s,o){const{theme:a,minValue:n,maxValue:l}=e,t=s.authoringInfo.visualVariables[0].clone(),r=o.authoringInfo.visualVariables[0].clone(),{stops:u}=s.visualVariable;return"above-and-below"===a?(t.minSliderValue=r.minSliderValue=n??u[0].value,t.maxSliderValue=r.maxSliderValue=l??u.at(-1)?.value,r.theme="above-and-below"):a&&"high-to-low"!==a||"reference-size"!==r.sizeInfoType||2!==r.sizeStops?.length||(r.sizeStops[0].value=u[0].value,r.sizeStops[1].value=u.at(-1)?.value),new i({type:"univariate-color-size",univariateTheme:a,visualVariables:[t,r]})}async function k(e){const i=await O(e),s=await n(S(i)),{visualVariable:o,statistics:a}=s,t=await l(x(i,a)),r=t.visualVariables,u=e.layer,p=e.field?u.getField(e.field):null;return await C(r,o,a,i.theme,d(p)),{basemapId:t.basemapId,basemapTheme:t.basemapTheme,statistics:a,defaultValuesUsed:s.defaultValuesUsed,color:{visualVariable:o,colorScheme:s.colorScheme},size:{visualVariables:r,sizeScheme:t.sizeScheme},authoringInfo:F(i,s,t)}}async function A(e){return M(e)}async function M(e){const i=await E(e),{renderer:s,statistics:o,defaultValuesUsed:a}=await t(I(i)),n=D(i);n.statistics=o;const l=await k(n);return"above-and-below"===i.theme?q(s,l,i):B(s,l),{renderer:s,statistics:o,defaultValuesUsed:a,color:i.colorOptions?.isContinuous||"above-and-below"!==i.theme?l.color:null,size:l.size,basemapId:l.basemapId,basemapTheme:l.basemapTheme}}export{A as createContinuousRenderer,M as createRenderer,k as createVisualVariables};
