/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import e from"../../../Color.js";import"../../../symbols.js";import t from"../../../core/Collection.js";import"../../../core/has.js";import n from"../../../core/Error.js";import{formatDate as o,convertDateFormatToIntlOptions as i}from"../../../intl/date.js";import{round as l}from"../../../renderers/support/numberUtils.js";import r from"../../../renderers/support/pointCloud/PointSizeSplatAlgorithm.js";import s from"../../heuristics/outline.js";import a from"../../statistics/classBreaks.js";import m from"../../statistics/summaryStatistics.js";import{defaultBasemapGroups as u,isAnyDateField as c,getBasemapId as f,getBasemapGroup as d}from"../../support/utils.js";import p from"../../../symbols/edges/SketchEdges3D.js";import y from"../../../symbols/edges/SolidEdges3D.js";import{getTimeZoneFormattingOptions as h,shortTimeZoneName as w}from"../../../time/timeZoneUtils.js";import{getBackgroundColorTheme as b}from"../../../views/support/colorUtils.js";import g from"../../../symbols/MeshSymbol3D.js";import D from"../../../symbols/FillSymbol3DLayer.js";import j from"../../../symbols/SimpleFillSymbol.js";import S from"../../../symbols/PolygonSymbol3D.js";import v from"../../../symbols/ExtrudeSymbol3DLayer.js";import x from"../../../symbols/SimpleLineSymbol.js";import z from"../../../symbols/LineSymbol3D.js";import U from"../../../symbols/LineSymbol3DLayer.js";import V from"../../../symbols/PathSymbol3DLayer.js";import k from"../../../symbols/SimpleMarkerSymbol.js";import L from"../../../symbols/PointSymbol3D.js";import T from"../../../symbols/IconSymbol3DLayer.js";import I from"../../../symbols/ObjectSymbol3DLayer.js";const F=/^(\d+(\.\d+)?)\s*(%)$/i,B=[0,0,0,.4],C=new Set(["hours","minutes","seconds"]),M=[...u.light,...u.dark];function Z(e,t,n,l){if("string"==typeof e){const t=n.getField(e);if(t&&c(t))return t.alias||t.name}else if("number"==typeof e||e instanceof Date){const r=null!=t&&C.has(t),s=i(r?"short-date-short-time":"short-date");if(l&&r){const t=n.layer,{timeZone:i}=h("preferredTimeZone"in t?t.preferredTimeZone:null,"datesInUnknownTimezone"in t&&t.datesInUnknownTimezone,l.timeZone,s,"date");return o(e,{...s,timeZone:i,timeZoneName:w})}return o(e,s)}return e}function P(e,t,n){return e+t>0&&0>e-t&&n<0?0:e}function E(e,t,n,o,i){const l="90-10"===n&&t?{min:t.classBreakInfos[0].maxValue,max:t.classBreakInfos[t.classBreakInfos.length-1].minValue,avg:null,stddev:null}:e,{avg:r,stddev:s,min:a,max:m}=l,u=A(l,!!o,i??!0);let c=u?u[0]:a,f=u?u[1]:m;return u?{minDataValue:c,maxDataValue:f,defaultValuesUsed:!0}:("above"===n?c=P(r,s,a):"below"===n&&(f=P(r,s,a)),{minDataValue:c,maxDataValue:f,defaultValuesUsed:!1})}function A(e,t,n){let o,i;const l=R({statistics:e,isDate:t});return l.defaultValuesUsed?(o=l.min,i=l.max):!n||null!=e.avg&&e.stddev||(o=e.min,i=e.max),null!=o&&null!=i?[o,i]:null}function R(e){let t,n,o=e&&e.statistics;if(o||(o={}),null==o.min)if(e.isDate){const e=Y();t=e[0],n=e[1]}else t=0,n=100;else if(o.min===o.max)if(e.isDate){const e=Y(o.min);t=e[0],n=e[1]}else o.min<0?(t=2*o.min,n=0):o.min>0?(t=0,n=2*o.min):(t=0,n=100);return{min:null!=t?t:o.min,max:null!=n?n:o.max,defaultValuesUsed:null!=t||null!=n}}function Y(e){const t=("number"==typeof e?new Date(e):new Date).getUTCFullYear();let n=Date.UTC(t,0,1,12,0,0,0),o=Date.UTC(t,11,31,12,0,0,0);return"number"==typeof e&&(e<n&&(n=e),e>o&&(o=e)),[n,o]}function N(t,n){const o=[],i=t.length;for(let l=0;l<n;l++)o.push(new e(t[l%i]));return o}function W({minDataValue:e,maxDataValue:t,defaultValuesUsed:n},o,i,l=!0){return n||"above"===i||"below"===i||"90-10"===i?$(e,t,5):G(o,l)}function q(e,t){const{avg:n,stddev:o}=e,i=e.min,r=e.max;if(null==n||null==o){const[n,o]=A(e,t,!0);return $(n,o,5)}const s=P(n,o,i),a=r-s,m=s-i,u=Math.max(a,m);return l([s-u,s-u/2,s,u/2+s,s+u],{strictBounds:!0})}function O(e,t){const{min:n,max:o}=t,[i,r,s,a,m]=e,u=null!=n&&i<n,c=null!=o&&m>o;if(null==n||null==o||!u&&!c)return e;const f=u?n:i,d=c?o:m;return l([f,u?f+(s-f)/2:r,s,c?s+(d-s)/2:a,d],{strictBounds:!0})}function $(e,t,n){const o=(t-e)/(n-1),i=[e];for(let l=1;l<=n-2;l++)i.push(e+l*o);return i.push(t),l(i,{strictBounds:!0})}function G({min:e,max:t,avg:n,stddev:o},i=!0){if(null==e||null==t||null==n||null==o)return[];let r=n-o,s=n+o;r<e&&(r=e),s>t&&(s=t),i&&(n=r+(s-r)/2);let a=l([r,s],{strictBounds:!0});return r=a[0],s=a[1],a=[r,r+(n-r)/2,n,n+(s-n)/2,s],l(a,{strictBounds:!0})}function H(e,t,n){switch(t){case"point":case"multipoint":return n?"noDataSize"in e?e.noDataSize:null:"size"in e?e.size:null;case"polyline":return n?"noDataWidth"in e?e.noDataWidth:null:"width"in e?e.width:null;case"polygon":return"size"in e?e.size:null;default:return}}function J(e,t,n){switch(t){case"point":case"multipoint":case"polygon":{if(!("outline"in e))return null;const t={color:e.outline.color,width:e.outline.width};if(null!=n&&t.color){const e=t.color.clone();e.a=n,t.color=e}return t}default:return}}function K(e,n){const{type:o,size:i,color:l,outline:r}=n;let s;switch(e){case"point":case"multipoint":if("2d"===o)s=new k({color:l,size:i,outline:{color:r.color,width:r.width}});else if("3d-flat"===o)s=new L({symbolLayers:new t([new T({size:i,resource:{primitive:"circle"},material:{color:l},outline:{color:r.color,size:r.width}})])});else if(o?.includes("3d-volumetric")){const e="3d-volumetric-uniform"===o,r=new I({height:i,resource:{primitive:e?"sphere":"cylinder"},material:{color:l}});e||(r.width=n.widthAndDepth,r.depth=n.widthAndDepth),s=new L({symbolLayers:new t([r])})}break;case"polyline":"2d"===o?s=new x({color:l,width:i}):"3d-flat"===o?s=new z({symbolLayers:new t([new U({size:i,material:{color:l}})])}):"3d-volumetric"===o&&(s=new z({symbolLayers:new t([new V({width:"number"==typeof i?i:parseFloat(i),height:"number"==typeof i?i:parseFloat(i),material:{color:l}})])}));break;case"polygon":"2d"===o?s=new j({color:l,outline:{color:r.color,width:r.width}}):"3d-flat"===o?s=new S({symbolLayers:new t([new D({material:{color:l},outline:{color:r.color,size:r.width}})])}):"3d-volumetric"===o&&(s=new S({symbolLayers:new t([new v({size:i,material:{color:l}})])}));break;case"mesh":{const e=n.meshInfo?.colorMixMode,o=n.meshInfo?.edgesType;s=new g({symbolLayers:new t([new D({material:{color:l,colorMixMode:e||null},edges:"solid"===o?new y({color:B}):"sketch"===o?new p({color:B}):null})])});break}}return s}function Q(e,t,o){const i=X({layer:e,fields:t});if(i.length)return new n(o,"Unknown fields: "+i.join(", ")+". You can only use fields defined in the layer schema");const l=_({layer:e,fields:t});return l.length?new n(o,"Unsupported fields: "+l.join(", ")+". You can only use fields that are accessible to the renderer i.e. FieldUsageInfo.supportsRenderer must be true"):void 0}function X(e){const t=e.layer;return e.fields.filter((e=>!t.getField(e)))}function _(e){const t=e.layer;return e.fields.filter((e=>{const n=t.getFieldUsageInfo(e);return!n||!n.supportsRenderer}))}async function ee(e,t){const n={layer:e.layer,view:e.view,signal:e.signal},[o,i]=await Promise.all([a(e).catch(se),t?s(n).catch(se):null]),l=A({min:o?.minValue,max:o?.maxValue,avg:null,stddev:null},!1,!1);return{result:l?await a({...e,classificationMethod:"equal-interval",numClasses:1,analyzeData:!1,minValue:l[0],maxValue:l[1],normalizationTotal:l[0]+l[1]}):o,defaultValuesUsed:!!l,outlineResult:i}}function te(e){return m(e)}function ne(e,t){let{minSize:n,maxSize:o}=e;if("height"===t){n=((o-n)/2+n)/(2*2.3),o*=2}return{minSize:n,maxSize:o}}function oe(e){return F.test(e)}function ie(e){if(null==e)return;const t=e.match(F),n=Number(t[1]);return"%"===t[3]?new r({scaleFactor:n/100}):void 0}function le(e,t,n,o){e.startTime=t instanceof Date?t.getTime():t,e.endTime=n instanceof Date?n.getTime():n,e.units=o,e.field="string"==typeof t?t:"string"==typeof n?n:null}async function re(e,t){let n=null,o=null;if(!e&&!t)return{basemapId:n,basemapTheme:o};if(t&&(o=await b(t),e||(e=t.map?.basemap)),e&&(n=f(e,M,!1),n&&!o)){const e=d(n);null!=e&&(o=e)}return!n&&o&&(n="dark"===o?"dark-gray":"gray"),{basemapId:n,basemapTheme:o}}function se(e){const t=e.name?.toLowerCase();if(!t||t?.includes(":insufficient-info")||t?.includes(":insufficient-data"))return null;throw e}export{O as clampAboveAndBelowStopValues,N as createColors,W as createDataValues,$ as createDefaultStopValues,G as createStopValues,q as createStopValuesForAboveBelow,K as createSymbol,se as errorCallback,Z as formatDate,P as getBaseValueForAboveBelow,re as getBasemapInfo,ee as getClassBreaks,E as getDataRange,A as getDefaultDataRange,ie as getPointSizeAlgorithm,ne as getSizeRangeForAxis,te as getSummaryStatistics,J as getSymbolOutlineFromScheme,H as getSymbolSizeFromScheme,oe as isValidPointSize,le as updateAgeRendererAuthoringInfoVV,Q as verifyBasicFieldValidity};
