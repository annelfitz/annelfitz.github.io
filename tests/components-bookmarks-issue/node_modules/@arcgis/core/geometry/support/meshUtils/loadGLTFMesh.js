/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import e from"../../../Color.js";import t from"../../../request.js";import{getOrCreateMapValue as r}from"../../../core/MapUtils.js";import{hasScaling as o,rad2deg as n}from"../../../core/mathUtils.js";import{normalFromMat4 as s}from"../../../core/libs/gl-matrix-2/math/mat3.js";import{create as a}from"../../../core/libs/gl-matrix-2/factories/mat3f64.js";import{fromValues as i}from"../../../core/libs/gl-matrix-2/factories/vec3f64.js";import{fromValues as l}from"../../../core/libs/gl-matrix-2/factories/vec4f64.js";import u from"../MeshComponent.js";import c from"../MeshMaterialMetallicRoughness.js";import f from"../MeshTexture.js";import m from"../MeshTextureTransform.js";import{MeshVertexAttributes as p}from"../MeshVertexAttributes.js";import{BufferViewVec4f as g,BufferViewVec4u8 as x,BufferViewVec4u16 as d,BufferViewVec3u8 as T,BufferViewVec3f as h,BufferViewVec3u16 as v,BufferViewVec3f64 as w,BufferViewVec2f as b}from"../buffer/BufferView.js";import{d as j,c as y,e as M,f as C}from"../../../chunks/vec3.js";import{a as A,n as R,b as E}from"../../../chunks/vec4.js";import{createBuffer as B}from"../buffer/utils.js";import{georeferenceByTransform as F}from"./georeference.js";import{DefaultLoadingContext as $}from"../../../views/3d/glTF/DefaultLoadingContext.js";import{loadGLTF as S}from"../../../views/3d/glTF/loader.js";import{convertPrimitiveToTriangles as O}from"../../../views/3d/glTF/internal/indexUtils.js";import{isEncodedMeshTexture as k}from"../../../views/3d/glTF/internal/resourceUtils.js";import{colorGamma as U}from"../../../views/3d/webgl-engine/materials/DefaultMaterial_COLOR_GAMMA.js";import{TextureWrapMode as D}from"../../../views/webgl/enums.js";import{f as L,a as V}from"../../../chunks/vec33.js";import{f as _,a as I}from"../../../chunks/vec43.js";import{a as P,f as q}from"../../../chunks/vec2.js";async function N(e,t,r){const o=new $(z(r)),n=(await S(o,t,r,!0)).model,s=n.lods.shift(),a=new Map,i=new Map;n.textures.forEach(((e,t)=>a.set(t,H(e)))),n.materials.forEach(((e,t)=>i.set(t,J(e,a))));const l=Q(s);for(const p of l.parts)W(l,p,i);const{position:u,normal:c,tangent:f,color:m,texCoord0:g}=l.vertexAttributes,x={position:u.typedBuffer,normal:null!=c?c.typedBuffer:null,tangent:null!=f?f.typedBuffer:null,uv:null!=g?g.typedBuffer:null,color:null!=m?m.typedBuffer:null},d=F(x,e,r);return{transform:d.transform,vertexSpace:d.vertexSpace,components:l.components,spatialReference:e.spatialReference,vertexAttributes:new p({position:d.vertexAttributes.position,normal:d.vertexAttributes.normal,tangent:d.vertexAttributes.tangent,color:x.color,uv:x.uv})}}function z(e){const r=e?.resolveFile;return r?{busy:!1,request:async(e,o,n)=>{const s=r?.(e)??e,a="image"===o?"image":"binary"===o?"array-buffer":"json";return(await t(s,{responseType:a,signal:n?.signal,timeout:0})).data}}:null}function G(e,t){if(null==e)return"-";const o=e.typedBuffer;return`${r(t,o.buffer,(()=>t.size))}/${o.byteOffset}/${o.byteLength}`}function K(e){return null!=e?e.toString():"-"}function Q(e){let t=0;const has={color:!1,tangent:!1,normal:!1,texCoord0:!1},o=new Map,n=new Map,s=[];for(const a of e.parts){const{attributes:{position:e,normal:i,color:l,tangent:u,texCoord0:c}}=a,f=`\n      ${G(e,o)}/\n      ${G(i,o)}/\n      ${G(l,o)}/\n      ${G(u,o)}/\n      ${G(c,o)}/\n      ${K(a.transform)}\n    `;let m=!1;const p=r(n,f,(()=>(m=!0,{start:t,length:e.count})));m&&(t+=e.count),i&&(has.normal=!0),l&&(has.color=!0),u&&(has.tangent=!0),c&&(has.texCoord0=!0),s.push({gltf:a,writeVertices:m,region:p})}return{vertexAttributes:{position:B(w,t),normal:has.normal?B(h,t):null,tangent:has.tangent?B(g,t):null,color:has.color?B(x,t):null,texCoord0:has.texCoord0?B(b,t):null},parts:s,components:[]}}function H(e){return new f({data:(k(e.data),e.data),wrap:Z(e.parameters.wrap)})}function J(t,r){const o=new e(re(t.color,t.opacity)),s=t.emissiveFactor?new e(oe(t.emissiveFactor)):null,a=e=>e?new m({scale:e.scale?[e.scale[0],e.scale[1]]:[1,1],rotation:n(e.rotation??0),offset:e.offset?[e.offset[0],e.offset[1]]:[0,0]}):null;return new c({color:o,colorTexture:r.get(t.textureColor),normalTexture:r.get(t.textureNormal),emissiveColor:s,emissiveTexture:r.get(t.textureEmissive),occlusionTexture:r.get(t.textureOcclusion),alphaMode:Y(t.alphaMode),alphaCutoff:t.alphaCutoff,doubleSided:t.doubleSided,metallic:t.metallicFactor,roughness:t.roughnessFactor,metallicRoughnessTexture:r.get(t.textureMetallicRoughness),colorTextureTransform:a(t.colorTextureTransform),normalTextureTransform:a(t.normalTextureTransform),occlusionTextureTransform:a(t.occlusionTextureTransform),emissiveTextureTransform:a(t.emissiveTextureTransform),metallicRoughnessTextureTransform:a(t.metallicRoughnessTextureTransform)})}function W(e,t,r){t.writeVertices&&X(e,t);const{indices:o,attributes:n,primitiveType:s,material:a}=t.gltf;let i=O(o||n.position.count,s);const l=t.region.start;if(l){const e=new Uint32Array(i);for(let t=0;t<i.length;t++)e[t]+=l;i=e}e.components.push(new u({name:t.gltf.name,faces:i,material:r.get(a),shading:n.normal?"source":"flat",trustSourceNormals:!0}))}function X(e,t){const{position:r,normal:n,tangent:i,color:l,texCoord0:u}=e.vertexAttributes,c=t.region.start,{attributes:f,transform:m}=t.gltf,p=f.position.count;if(j(r.slice(c,p),f.position,m),null!=f.normal&&null!=n){const e=s(a(),m),t=n.slice(c,p);y(t,f.normal,e),o(e)&&M(t,t)}else null!=n&&L(n,0,0,1,{dstIndex:c,count:p});if(null!=f.tangent&&null!=i){const e=s(a(),m),t=i.slice(c,p);A(t,f.tangent,e),o(e)&&R(t,t)}else null!=i&&_(i,0,0,1,1,{dstIndex:c,count:p});if(null!=f.texCoord0&&null!=u?P(u.slice(c,p),f.texCoord0):null!=u&&q(u,0,0,{dstIndex:c,count:p}),null!=f.color&&null!=l){const e=f.color,t=l.slice(c,p);if(4===e.elementCount)e instanceof g?E(t,e,255):e instanceof x?I(t,e):e instanceof d&&E(t,e,1/256);else{_(t,255,255,255,255);const r=T.fromTypedArray(t.typedBuffer,t.typedBufferStride);e instanceof h?C(r,e,255):e instanceof T?V(r,e):e instanceof v&&C(r,e,1/256)}}else null!=l&&_(l.slice(c,p),255,255,255,255)}function Y(e){switch(e){case"OPAQUE":return"opaque";case"MASK":return"mask";case"BLEND":return"blend"}}function Z(e){return{horizontal:ee(e.s),vertical:ee(e.t)}}function ee(e){switch(e){case D.CLAMP_TO_EDGE:return"clamp";case D.MIRRORED_REPEAT:return"mirror";case D.REPEAT:return"repeat"}}function te(e){return e**(1/U)*255}function re(e,t){return l(te(e[0]),te(e[1]),te(e[2]),t)}function oe(e){return i(te(e[0]),te(e[1]),te(e[2]))}export{N as loadGLTFMesh};
