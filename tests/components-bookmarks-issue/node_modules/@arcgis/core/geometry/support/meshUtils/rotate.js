/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import e from"../../../core/Logger.js";import{fromMat4 as t}from"../../../core/libs/gl-matrix-2/math/mat3.js";import{create as r}from"../../../core/libs/gl-matrix-2/factories/mat3f64.js";import{fromRotationTranslationScaleOrigin as o,multiply as i,getScaling as s,scale as a,getTranslation as n,fromRotation as l}from"../../../core/libs/gl-matrix-2/math/mat4.js";import{create as c}from"../../../core/libs/gl-matrix-2/factories/mat4f64.js";import{setAxisAngle as m}from"../../../core/libs/gl-matrix-2/math/quat.js";import{create as f}from"../../../core/libs/gl-matrix-2/factories/quatf64.js";import{s as p,i as g,t as u,e as j}from"../../../chunks/vec32.js";import{ONES as x,ZEROS as b,create as d}from"../../../core/libs/gl-matrix-2/factories/vec3f64.js";import h from"../../Point.js";import{getSphericalPCPF as v}from"../../spatialReferenceEllipsoidUtils.js";import{computeTranslationToOriginAndRotation as A}from"../../projection/computeTranslationToOriginAndRotation.js";import{projectPointToVector as w}from"../../projection/projectPointToVector.js";import{create as R,angleRad as k,axis as y,fromMatrix as F}from"../axisAngleDegrees.js";import $ from"../MeshTransform.js";import{isMeshWithRelativeVertexSpace as P}from"../meshVertexSpaceUtils.js";import{usesLocalTangentPlaneOnECEFForOperations as S}from"./geographicUtils.js";import{projectToPCPF as T,projectNormalToPCPF as U,projectTangentToPCPF as q,projectFromPCPF as C,projectNormalFromPCPF as L,projectTangentFromPCPF as z}from"./projection.js";import{projectPointToVertexSpace as M}from"./vertexSpaceConversion.js";const V="esri.geometry.support.meshUtils.rotate";function D(e,t,r){if(!e.vertexAttributes?.position||0===t[3])return;const{spatialReference:o,vertexSpace:i}=e,s=r?.origin??e.anchor,a=r?.geographic,n=S(V,i,o,a);P(e)?E(e,t,s):n?O(e,t,s):B(e,t,s)}function E(t,r,l){t.transform??=new $;const{vertexSpace:c,transform:f,spatialReference:u}=t,[j,v,A]=c.origin,w=new h({x:j,y:v,z:A,spatialReference:u}),R=H;if(w.equals(l))p(R,0,0,0);else if(!M(R,l,t))return void e.getLogger(V).error(`Failed to project specified origin (wkid:${l.spatialReference.wkid}) to mesh (wkid:${u.wkid}) ${c.type} vertex space. Projection may be possible after calling projection.load().`);m(W,y(r),k(r));const P=o(I,W,b,x,R),{localMatrix:S}=f,T=i(I,P,S);f.scale=s(d(),T),a(T,T,g(H,f.scale)),f.rotation=F(T),f.translation=n(d(),T)}function O(e,r,o){const i=e.spatialReference,s=v(i),a=Q;w(o,a,s)||w(e.origin,a,s);const n=e.vertexAttributes.position,l=e.vertexAttributes.normal,c=e.vertexAttributes.tangent,m=new Float64Array(n.length),f=null!=l?new Float32Array(l.length):null,p=null!=c?new Float32Array(c.length):null;A(s,a,K,s),t(N,K);const g=J;u(y(J),y(r),N),g[3]=r[3],T(n,i,m),null!=l&&null!=f&&U(l,n,m,i,f),null!=c&&null!=p&&q(c,n,m,i,p),G(m,g,3,a),C(m,n,i),null!=l&&null!=f&&(G(f,g,3),L(f,n,m,i,l)),null!=c&&null!=p&&(G(p,g,4),z(p,n,m,i,c)),e.vertexAttributesChanged()}function B(t,r,o){const i=Q;if(!w(o,i,t.spatialReference)){const r=t.origin;i[0]=r.x,i[1]=r.y,i[2]=r.z,e.getLogger(V).error(`Failed to project specified origin (wkid:${o.spatialReference.wkid}) to mesh spatial reference (wkid:${t.spatialReference.wkid}). Projection may be possible after calling projection.load().`)}G(t.vertexAttributes.position,r,3,i),G(t.vertexAttributes.normal,r,3),G(t.vertexAttributes.tangent,r,4),t.vertexAttributesChanged()}function G(e,t,r,o=b){if(null!=e){l(K,k(t),y(t));for(let t=0;t<e.length;t+=r){for(let r=0;r<3;r++)H[r]=e[t+r]-o[r];j(H,H,K);for(let r=0;r<3;r++)e[t+r]=H[r]+o[r]}}}const H=d(),I=c(),J=R(),K=c(),N=r(),Q=d(),W=f();export{D as rotate};
