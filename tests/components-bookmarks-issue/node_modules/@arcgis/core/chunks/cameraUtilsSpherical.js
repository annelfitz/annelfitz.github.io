/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{Cyclical as t,cyclical2PI as e}from"../core/Cyclical.js";import{deg2rad as o,rad2deg as i,asinClamped as a}from"../core/mathUtils.js";import{fromRotation as r,rotate as n}from"../core/libs/gl-matrix-2/math/mat4.js";import{create as s}from"../core/libs/gl-matrix-2/factories/mat4f64.js";import{n as c,b as l,k as m,e as f,F as h,l as p,h as u}from"./vec32.js";import{fromValues as y,create as M}from"../core/libs/gl-matrix-2/factories/vec3f64.js";import{getReferenceEllipsoid as d}from"../geometry/ellipsoidUtils.js";import g from"../geometry/Extent.js";import j from"../geometry/SpatialReference.js";import{geographicToWebMercator as T}from"../geometry/support/webMercatorUtils.js";import{createDirectionUp as b,directionToHeadingTilt as x}from"../views/3d/support/cameraUtilsInternal.js";import{getLonDeltaForDistance as R}from"../views/3d/support/earthUtils.js";const I=y(0,0,1),P=c(M(),y(1,1,1)),U=new t(-180,180),v=s(),w=M(),q=M();function S(t,e,i,a=b()){l(w,t,I),0===m(w,w)&&l(w,t,P),r(v,-o(e),t),n(v,v,-o(i),w);const{up:s,direction:p}=a;return l(s,w,t),c(s,s),f(s,s,v),c(p,t),h(p,p),f(p,p,v),a}function _(t,e,o,i){const a=w,r=q;return c(a,t),l(q,a,I),0===m(q,q)&&l(q,a,P),l(r,q,a),x(e,o,i,a,r)}function k(t,e,i,r){const n={eye:M(),up:null,tilt:r,heading:i},s=w;s[0]=t[0],s[1]=t[2],s[2]=-t[1];const c=e,l=o(i),m=o(r),f=Math.sin(l),h=Math.cos(l),y=Math.sin(m),d=Math.cos(m),g=p(s);let j;if(Math.abs(m)<1e-8)j=c+g;else{const t=g/y,e=a(c/t),o=Math.PI-m-e;j=t*Math.sin(o)}const T=d*c,b=c*c*(y*y),x=h*h*b,R=j-T,I=R*R,P=x*(x+I-s[1]*s[1]);if(P<0)return u(n.eye,s,j/g),n.tilt=0,H(n,t);const U=Math.sqrt(P),v=s[1]*R,q=x+I;let S;if(S=h>0?-U+v:U+v,Math.abs(q)<1e-8)return g<1e-8?(n.eye[0]=0,n.eye[1]=0,n.eye[2]=c):u(n.eye,s,j/g),n.tilt=0,E(n.eye),H(n,t);n.eye[1]=S/q;const _=f*f*b,k=y*c,W=h*k*n.eye[1],z=n.eye[1]*n.eye[1],A=1-z,C=Math.sqrt(A),F=x*z+_-2*W*C*R+A*I;return Math.abs(F)<1e-8?(u(n.eye,s,j/g),n.tilt=0,E(n.eye),H(n,t)):(n.eye[0]=(A*(j*s[0]-T*s[0])-k*C*(s[0]*n.eye[1]*h+s[2]*f))/F,n.eye[2]=(A*(j*s[2]-T*s[2])-k*C*(s[2]*n.eye[1]*h-s[0]*f))/F,u(n.eye,n.eye,j),E(n.eye),H(n,t))}function E(t){const e=t[1];t[1]=-t[2],t[2]=e}function H(t,e){const o=S(e,t.heading,t.tilt);return t.up=o.up,t}function W(t,e,o){const r=p(e),n=Math.sqrt(o*o+r*r-2*o*r*Math.cos(Math.PI-t)),s=a(o/(n/Math.sin(t)));return i(t-s)}function z(t,e,i){const r=o(t),n=p(e);return a(i/(n/Math.sin(r)))+r}function A(t,a,r,n,s){let c,l,m,f;const h=a.latitude,p=d(t.spatialReference).radius,u=a.longitude,y=R(h,r,p)/2;c=u-y,l=u+y;const M=o(h),b=(1+Math.sin(M))/(1-Math.sin(M)),x=(b+1)*Math.tan(n/p/2),I=x*x;function P(t){const o=Math.PI/2;return(t=e.normalize(t,-o))>o&&(t=Math.PI-t),t}if(m=1.5*Math.PI-2*Math.atan(.5*(x+Math.sqrt(4*b+I))),f=m+n/p,m=P(m),f=P(f),f<m){const t=f;f=m,m=t}if(m=Math.max(i(m),-90),f=Math.min(i(f),90),l=U.monotonic(c,l),l-c>180){const t=(l-c-180)/2;c+=t,l-=t}const v=t.spatialReference&&t.spatialReference.isGeographic?t.spatialReference:j.WGS84;return s?(s.xmin=c,s.ymin=m,s.xmax=l,s.ymax=f,s.spatialReference=v):s=new g(c,m,l,f,v),t.spatialReference&&t.spatialReference.isWebMercator&&T(s,!1,s),s}const C=Object.freeze(Object.defineProperty({__proto__:null,directionToHeadingTilt:_,eyeForCenterWithHeadingTilt:k,eyeTiltToLookAtTilt:z,headingTiltToDirectionUp:S,lookAtTiltToEyeTilt:W,toExtent:A},Symbol.toStringTag,{value:"Module"}));export{z as a,C as c,_ as d,k as e,S as h,W as l,A as t};
