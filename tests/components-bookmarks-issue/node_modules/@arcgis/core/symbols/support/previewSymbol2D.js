/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import e from"../../Color.js";import{getColorLuminance as t}from"../../core/colorUtils.js";import a from"../../core/Error.js";import{loadFont as o}from"../../core/fontUtils.js";import{pt2px as i}from"../../core/screenUtils.js";import{getFill as l,getStroke as n,getDashArray as s,getPatternUrlWithColor as r}from"./gfxUtils.js";import{SymbolSizeDefaults as c,shapes as h,adjustColorBrightness as u}from"./previewUtils.js";import{renderSymbol as m}from"./renderUtils.js";import{backgroundPadding as p}from"./textUtils.js";const d="picture-fill",f="picture-marker",y="simple-fill",g="simple-line",w="simple-marker",v="text",x="Aa",b=c.size,M=c.maxSize,k=c.maxOutlineSize,L=c.lineWidth,z=225,j=document.createElement("canvas");function C(e,t){const a=j.getContext("2d"),o=[];t&&(t.weight&&o.push(t.weight),t.size&&o.push(t.size+"px"),t.family&&o.push(t.family)),a.font=o.join(" ");const{width:i,actualBoundingBoxLeft:l,actualBoundingBoxRight:n,actualBoundingBoxAscent:s,actualBoundingBoxDescent:r}=a.measureText(e);return{width:Math.ceil(Math.max(i,l+n)),height:Math.ceil(s+r),x:Math.floor(l),y:Math.floor((s-r)/2)}}function S(e){const t=e?.size;return{width:null!=t&&"object"==typeof t&&"width"in t?i(t.width):null,height:null!=t&&"object"==typeof t&&"height"in t?i(t.height):null}}async function B(e,t){const a=t.fill,o=e.color;if("pattern"===a?.type&&o&&e.type!==d){const e=await r(a.src,o.toCss(!0));a.src=e,t.fill=a}}async function U(e,t,a,i){if(!("font"in e)||!e.font||"text"!==t.shape.type)return;try{await o(e.font)}catch{}const{width:l,height:n}=S(i);if(!/[\uE600-\uE6FF]/.test(t.shape.text)){const{width:o,height:s,x:r,y:c}=C(t.shape.text,{weight:t.font?.weight,size:t.font?.size,family:t.font?.family});a[0]=l??o,a[1]=n??s,t.shape.x=r,t.shape.y=c;const h=null!=i?.rotation?i.rotation:"angle"in e?e.angle:null;if(h){const e=h*(Math.PI/180),t=Math.abs(Math.sin(e)),o=Math.abs(Math.cos(e));a[1]=a[0]*t+a[1]*o}}}function E(e,t,a,o,l){if(null!=e.haloColor&&null!=e.haloSize){l.masking??=a.map((()=>[]));const n=i(e.haloSize);o[0]+=n,o[1]+=n,a.unshift([{...t,fill:null,stroke:{color:e.haloColor,width:2*n,join:"round",cap:"round"}}]),l.masking.unshift([{shape:{type:"rect",x:0,y:0,width:o[0]+2*p,height:o[1]+2*p},fill:[255,255,255],stroke:null},{...t,fill:[0,0,0,0],stroke:null}])}null==e.backgroundColor&&null==e.borderLineColor||(o[0]+=2*p,o[1]+=2*p,a.unshift([{shape:{type:"rect",x:0,y:0,width:o[0],height:o[1]},fill:e.backgroundColor,stroke:{color:e.borderLineColor,width:i(e.borderLineSize)}}]),l.masking?.unshift([]))}function F(e,t){return e>t?"dark":"light"}function D(e,t){const a="number"==typeof t?.size?t?.size:null,o=null!=a?i(a):null,r=null!=t?.maxSize?i(t.maxSize):null,c=null!=t?.rotation?t.rotation:"angle"in e?e.angle:null,u=l(e);let m=n(e);"dark"!==A(e,245)||t?.ignoreWhiteSymbols||(m={width:.75,...m,color:"#bdc3c7"});const p={shape:null,fill:u,stroke:m,offset:[0,0]};m?.width&&(m.width=Math.min(m.width,k));const z=m?.width||0;let j=null!=t?.size&&(null==t?.scale||t?.scale),B=0,U=0,E=!1;switch(e.type){case w:{const a=e.style,{width:l,height:n}=S(t),s=l===n&&null!=l?l:null!=o?o:Math.min(i(e.size),r||M);switch(B=s,U=s,a){case"circle":p.shape={type:"circle",cx:0,cy:0,r:.5*s},j||(B+=z,U+=z);break;case"cross":p.shape={type:"path",path:[{command:"M",values:[0,.5*U]},{command:"L",values:[B,.5*U]},{command:"M",values:[.5*B,0]},{command:"L",values:[.5*B,U]}]};break;case"diamond":p.shape={type:"path",path:[{command:"M",values:[0,.5*U]},{command:"L",values:[.5*B,0]},{command:"L",values:[B,.5*U]},{command:"L",values:[.5*B,U]},{command:"Z",values:[]}]},j||(B+=z,U+=z);break;case"square":p.shape={type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[B,0]},{command:"L",values:[B,U]},{command:"L",values:[0,U]},{command:"Z",values:[]}]},j||(B+=z,U+=z),c&&(E=!0);break;case"triangle":p.shape={type:"path",path:[{command:"M",values:[.5*B,0]},{command:"L",values:[B,U]},{command:"L",values:[0,U]},{command:"Z",values:[]}]},j||(B+=z,U+=z),c&&(E=!0);break;case"x":p.shape={type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[B,U]},{command:"M",values:[B,0]},{command:"L",values:[0,U]}]},c&&(E=!0);break;case"path":p.shape={type:"path",path:e.path||""},j||(B+=z,U+=z),c&&(E=!0),j=!0}break}case g:{const{width:e,height:a}=S(t),i=s(m).reduce(((e,t)=>e+t),0),l=i&&Math.ceil(L/i),n=a??o??z,r=e??(i*l||L);m&&(m.width=n),B=r,U=n,j=!0,p.shape={type:"path",path:[{command:"M",values:[n/2,U/2]},{command:"L",values:[B-n/2,U/2]}]};break}case d:case y:{const e="object"==typeof t?.symbolConfig&&!!t?.symbolConfig?.isSquareFill,{width:a,height:i}=S(t);B=!e&&a!==i||null==a?null!=o?o:b:a,U=!e&&a!==i||null==i?B:i,j||(B+=z,U+=z),j=!0,p.shape=e?{type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[B,0]},{command:"L",values:[B,U]},{command:"L",values:[0,U]},{command:"L",values:[0,0]},{command:"Z",values:[]}]}:h.fill[0];break}case f:{const a=Math.min(i(e.width),r||M),l=Math.min(i(e.height),r||M),{width:n,height:s}=S(t),h=n===s&&null!=n?n:null!=o?o:Math.max(a,l),u=a/l;B=u<=1?Math.ceil(h*u):h,U=u<=1?h:Math.ceil(h/u),p.shape={type:"image",x:-Math.round(B/2),y:-Math.round(U/2),width:B,height:U,src:e.url||""},c&&(E=!0);break}case v:{const a=e,l=t?.overrideText||a.text||x,n=a.font,{width:s,height:c}=S(t),h=null!=c?c:null!=o?o:Math.min(i(n.size),r||M),{width:u,height:m}=C(l,{weight:n.weight,size:h,family:n.family}),d=/[\uE600-\uE6FF]/.test(l);B=s??(d?h:u),U=d?h:m;let f=.5*(d?h:m);d&&(f+=5),p.shape={type:"text",text:l,x:a.xoffset||0,y:a.yoffset||f,align:"middle",alignBaseline:a.verticalAlignment,decoration:n&&n.decoration,rotated:a.rotated,kerning:a.kerning},p.font=n&&{size:h,style:n.style,decoration:n.decoration,weight:n.weight,family:n.family};break}}return{shapeDescriptor:p,size:[B,U],renderOptions:{node:t?.node,scale:j,opacity:t?.opacity,rotation:c,useRotationSize:E,effectView:t?.effectView,ariaLabel:t?.ariaLabel}}}async function Z(e,t){const{shapeDescriptor:o,size:i,renderOptions:l}=D(e,t);if(!o.shape)throw new a("symbolPreview: renderPreviewHTML2D","symbol not supported.");await B(e,o),await U(e,o,i,t);const n=[[o]];if("object"==typeof t?.symbolConfig&&t?.symbolConfig?.applyColorModulation){const e=.6*i[0];n.unshift([{...o,offset:[-e,0],fill:u(o.fill,-.3)}]),n.push([{...o,offset:[e,0],fill:u(o.fill,.3)}]),i[0]+=2*e,l.scale=!1}return"text"===e.type&&E(e,o,n,i,l),m(n,i,l)}function A(a,o=z){const i=l(a),s=n(a),r=!i||"type"in i?null:new e(i),c=s?.color?new e(s?.color):null,h=r?F(t(r),o):null,u=c?F(t(c),o):null;return u?h?h===u?h:o>=z?"light":"dark":u:h}export{A as getContrastingBackgroundTheme,D as getRenderSymbolParameters,Z as previewSymbol2D};
