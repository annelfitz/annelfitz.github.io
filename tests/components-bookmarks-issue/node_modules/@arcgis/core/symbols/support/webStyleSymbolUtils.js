/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{isSymbol3D as t}from"../../symbols.js";import{isDevEnvironment as e,adjustStaticAGOUrl as r}from"../../core/devEnvironmentUtils.js";import l from"../../core/Error.js";import{urlToObject as o,removeFile as n}from"../../core/urlUtils.js";import s from"../../portal/Portal.js";import{f as m}from"../../chunks/persistableUrlUtils.js";import{fromJSON as i}from"./jsonUtils.js";import a from"./StyleOrigin.js";import{fetchStyle as u,requestJSON as p,makeCIMSymbolRef as f,Style2DUrlTemplate as y,symbolUrlFromStyleItem as c}from"./styleUtils.js";import{Thumbnail as b}from"./Thumbnail.js";function g(t,e,r,o){const n=t.name;return null==n?Promise.reject(new l("symbolstyleutils:style-symbol-reference-name-missing","Missing name in style symbol reference")):t.styleName&&"Esri2DPointSymbolsStyle"===t.styleName?d(n,e,o):u(t,e,o).then((t=>h(t,n,e,r,c,o)))}function j(t,e){return e.items.find((e=>e.name===t))}function h(u,y,c,g,h,d){const U=null!=c?.portal?c.portal:s.getDefault(),N={portal:U,url:o(u.baseUrl),origin:"portal-item"},w=j(y,u.data);if(!w){const t=`The symbol name '${y}' could not be found`;return Promise.reject(new l("symbolstyleutils:symbol-name-not-found",t,{symbolName:y}))}let S=m(h(w,g),N),D=w.thumbnail?.href??null;const O=w.thumbnail?.imageData;e()&&(S=r(S)??"",D=r(D));const P={portal:U,url:o(n(S)),origin:"portal-item"};return p(S,d).then((e=>{const r="cimRef"===g?f(e.data):e.data,l=i(r,P);if(l&&t(l)){if(D){const t=m(D,N);l.thumbnail=new b({url:t})}else O&&(l.thumbnail=new b({url:`data:image/png;base64,${O}`}));u.styleUrl?l.styleOrigin=new a({portal:c.portal,styleUrl:u.styleUrl,name:y}):u.styleName&&(l.styleOrigin=new a({portal:c.portal,styleName:u.styleName,name:y}))}return l}))}function d(t,e,r){const l=y.replaceAll(/\{SymbolName\}/gi,t),m=null!=e.portal?e.portal:s.getDefault();return p(l,r).then((t=>{const e=f(t.data);return i(e,{portal:m,url:o(n(l)),origin:"portal-item"})}))}export{h as fetchSymbolFromStyle,j as getStyleItemFromStyle,g as resolveWebStyleSymbol};
