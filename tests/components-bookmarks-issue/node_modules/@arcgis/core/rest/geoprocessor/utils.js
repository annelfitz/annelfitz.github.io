/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import e from"../../request.js";import r from"../../geometry/SpatialReference.js";import{normalizeCentralMeridian as t}from"../../geometry/support/normalizeUtils.js";import a from"../../layers/support/Field.js";import n from"../../layers/support/MapImage.js";import{parseUrl as o,encode as s}from"../utils.js";import i from"../support/DataFile.js";import u from"../support/FeatureSet.js";import m from"../support/LinearUnit.js";import c from"../support/ParameterValue.js";import{dataTypeJsonMap as f,multiValuePrefix as l}from"../support/parameterValueUtils.js";import p from"../support/RasterData.js";async function y(r,a,n,s,i){const u={},m={},c=[];return S(s,c,u),t(c).then((t=>{const{outSpatialReference:c,processExtent:f,processSpatialReference:l,returnColumnName:p,returnFeatureCollection:y,returnM:S,returnZ:d}=n,{path:N}=o(r);for(const e in u){const[r,a]=u[e];m[e]=t.slice(r,a)}const j=c?c.wkid||c:null,g=l?l.wkid||l:null,O="execute"===a?{returnColumnName:p||void 0,returnFeatureCollection:y||void 0,returnM:S||void 0,returnZ:d||void 0}:null,R=J({...f?{context:{extent:f,outSR:j,processSR:g}}:{"env:outSR":j,"env:processSR":g},...s,...O,f:"json"},null,m),v={...i,query:R};return e(`${N}/${a}`,v)}))}function S(e,r,t){for(const a in e){const n=e[a];if(n&&"object"==typeof n&&n instanceof u){const{features:e}=n;t[a]=[r.length,r.length+e.length],e.forEach((e=>{r.push(e.geometry)}))}}}async function d(e,t){switch(e){case"boolean":case"double":case"long":case"string":case"value-table":return t;case"date":return new Date(t);case"data-file":return i.fromJSON(t);case"linear-unit":return m.fromJSON(t);case"feature-record-set-layer":if("url"in t)return i.fromJSON(t);if("layerDefinition"in t){const e=new(0,(await import("../../layers/FeatureLayer.js")).default),{layerDefinition:a,featureSet:n}=t;return e.read({layerDefinition:a,featureSet:n},{origin:"portal-item"}),e.spatialReference=r.fromJSON(n.spatialReference??a.spatialReference??a.extent.spatialReference),e}return u.fromJSON(t);case"record-set":return"url"in t?i.fromJSON(t):u.fromJSON(t);case"raster-data":case"raster-data-layer":return"mapImage"in t?n.fromJSON(t.mapImage):p.fromJSON(t);case"field":return a.fromJSON(t)}}function N(e){return e.startsWith(l)}function j(e){return e.replace(l,"")}async function g(e){const r=f.fromJSON(e.dataType),{paramName:t}=e,a=N(r)?await Promise.all(e.value.map((e=>d(j(r),e)))):await d(r,e.value);return new c({dataType:r,paramName:t,value:a})}function J(e,r,t){for(const a in e){const r=e[a];Array.isArray(r)?e[a]=JSON.stringify(r.map((e=>J({item:e},!0).item))):r instanceof Date&&(e[a]=r.getTime())}return s(e,r,t)}export{S as collectGeometries,y as constructRequest,g as decode,J as gpEncode};
