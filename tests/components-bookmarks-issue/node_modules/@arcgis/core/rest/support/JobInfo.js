/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import t from"../../request.js";import"../../core/has.js";import{strict as s}from"../../core/jsonMap.js";import{JSONSupport as o}from"../../core/JSONSupport.js";import{onAbort as r,createAbortError as i}from"../../core/promiseUtils.js";import{property as a}from"../../core/accessorSupport/decorators/property.js";import"../../core/Logger.js";import"../../core/RandomLCG.js";import{enumeration as n}from"../../core/accessorSupport/decorators/enumeration.js";import{subclass as c}from"../../core/accessorSupport/decorators/subclass.js";import{parseUrl as u}from"../utils.js";import l from"../geoprocessor/GPOptions.js";import{gpEncode as p,decode as b}from"../geoprocessor/utils.js";import m from"./GPMessage.js";var j;const d=s()({esriJobCancelled:"job-cancelled",esriJobCancelling:"job-cancelling",esriJobDeleted:"job-deleted",esriJobDeleting:"job-deleting",esriJobTimedOut:"job-timed-out",esriJobExecuting:"job-executing",esriJobFailed:"job-failed",esriJobNew:"job-new",esriJobSubmitted:"job-submitted",esriJobSucceeded:"job-succeeded",esriJobWaiting:"job-waiting"},{ignoreUnknown:!1});let h=j=class extends o{constructor(e){super(e),this.jobId=null,this.jobStatus=null,this.messages=null,this.progress=null,this.requestOptions=null,this.sourceUrl=null,this._timer=void 0}async cancelJob(e){const{jobId:s,sourceUrl:o}=this,{path:r}=u(o),i={...this.requestOptions,...e,query:{f:"json"}};this._clearTimer();const a=`${r}/jobs/${s}/cancel`,{data:n}=await t(a,i),{messages:c,jobStatus:l,progress:p}=j.fromJSON(n);return this.set({messages:c,jobStatus:l,progress:p}),this}destroy(){clearInterval(this._timer)}async checkJobStatus(e){const{path:s}=u(this.sourceUrl),o={...this.requestOptions,...e,query:{f:"json"}},r=`${s}/jobs/${this.jobId}`,{data:i}=await t(r,o),{messages:a,jobStatus:n,progress:c}=j.fromJSON(i);return this.set({messages:a,jobStatus:n,progress:c}),this}async fetchResultData(e,s,o){s=l.from(s||{});const{returnColumnName:r,returnFeatureCollection:i,returnM:a,returnZ:n,outSpatialReference:c}=s,{path:m}=u(this.sourceUrl),j=p({returnColumnName:r||null,returnFeatureCollection:i||null,returnM:a||null,returnZ:n||null,outSR:c,returnType:"data",f:"json"},null),d={...this.requestOptions,...o,query:j},h=`${m}/jobs/${this.jobId}/results/${e}`,{data:g}=await t(h,d);return b(g)}async fetchResultImage(e,s,o){const{path:r}=u(this.sourceUrl),i={...s.toJSON(),f:"json"},a=p(i),n={...this.requestOptions,...o,query:a},c=`${r}/jobs/${this.jobId}/results/${e}`,{data:l}=await t(c,n);return b(l)}async fetchResultMapImageLayer(){const{path:e}=u(this.sourceUrl),t=e.indexOf("/GPServer/"),s=`${e.substring(0,t)}/MapServer/jobs/${this.jobId}`;return new(0,(await import("../../layers/MapImageLayer.js")).default)({url:s})}async waitForJobCompletion(e={}){const{interval:t=1e3,signal:s,statusCallback:o}=e;return new Promise(((e,a)=>{r(s,(()=>{this._clearTimer(),a(i())})),this._clearTimer();const n=setInterval((()=>{this._timer||a(i()),this.checkJobStatus(this.requestOptions).then((t=>{const{jobStatus:s}=t;switch(this.jobStatus=s,s){case"job-succeeded":this._clearTimer(),e(this);break;case"job-submitted":case"job-executing":case"job-waiting":case"job-new":o&&o(this);break;case"job-cancelled":case"job-cancelling":case"job-deleted":case"job-deleting":case"job-timed-out":case"job-failed":this._clearTimer(),a(this)}}))}),t);this._timer=n}))}_clearTimer(){clearInterval(this._timer),this._timer=void 0}};e([a()],h.prototype,"jobId",void 0),e([n(d,{ignoreUnknown:!1})],h.prototype,"jobStatus",void 0),e([a({type:[m]})],h.prototype,"messages",void 0),e([a()],h.prototype,"progress",void 0),e([a()],h.prototype,"requestOptions",void 0),e([a({json:{write:!0}})],h.prototype,"sourceUrl",void 0),h=j=e([c("esri.rest.support.JobInfo")],h);const g=h;export{g as default};
