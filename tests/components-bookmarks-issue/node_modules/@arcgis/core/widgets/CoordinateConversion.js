/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import t from"../core/Logger.js";import{maybeProperty as o}from"../core/maybe.js";import{property as i}from"../core/accessorSupport/decorators/property.js";import{cast as s}from"../core/accessorSupport/decorators/cast.js";import"../core/RandomLCG.js";import"../core/has.js";import{subclass as n}from"../core/accessorSupport/decorators/subclass.js";import r from"./Widget.js";import a from"./CoordinateConversion/CoordinateConversionViewModel.js";import l from"./CoordinateConversion/support/Conversion.js";import{globalCss as p}from"./support/globalCss.js";import{Heading as d}from"./support/Heading.js";import{legacyIcon as u}from"./support/legacyIcon.js";import{accessibleHandler as c}from"./support/decorators/accessibleHandler.js";import{messageBundle as h}from"./support/decorators/messageBundle.js";import{tsx as _}from"./support/jsxFactory.js";import{storeNode as m,isRTL as v}from"./support/widgetUtils.js";const g="esri-coordinate-conversion",b={base:g,captureMode:`${g}--capture-mode`,noBasemap:`${g}--no-basemap`,popup:`${g}__popup`,clipboardPopup:`${g}__clipboard-popup`,conversionList:`${g}__conversion-list`,conversionRow:`${g}__row`,coordDisplay:`${g}__display`,expanded:`${g}__conversions-view--expanded`,expandDown:`${g}__conversions-view--expand-down`,expandUp:`${g}__conversions-view--expand-up`,conversionsView:`${g}__conversions-view`,primarySelect:`${g}__select-primary`,rowSelect:`${g}__select-row`,toolDisplay:`${g}__tools`,modeToggle:`${g}__mode-toggle`,rowButton:`${g}__row-button`,backButton:`${g}__back-button`,convertButton:`${g}__button`,convertButtonSpan:`${g}__convert-button-span`,coordinateInput:`${g}__input-coordinate`,inputForm:`${g}__input-form`,inputFormGroup:`${g}__input-group`,rejectInput:`${g}__input-coordinate--rejected`,sectionHeading:`${g}__heading`,patternInput:`${g}__pattern-input`,settings:`${g}__settings`,settingsFormGroup:`${g}__settings-group`,settingsFormGroupHorizontal:`${g}__settings-group-horizontal`,previewCoordinate:`${g}__preview-coordinate`},y={settingsButton:!0,inputButton:!0,captureButton:!0,expandButton:!0},w=750,C=2500;let f=class extends r{constructor(e,t){super(e,t),this._popupMessage=null,this._popupTimeoutId=void 0,this._clipboardPopupTimeoutId=void 0,this._coordinateInput=null,this._badInput=!1,this._goToEnabled=!1,this._conversionFormat=null,this._settingsFormat=null,this._previewConversion=null,this._expanded=!1,this._clipboardPopupVisible=!1,this._popupVisible=!1,this._settingsVisible=!1,this._inputVisible=!1,this.headingLevel=4,this.messages=null,this.messagesCommon=null,this.orientation="auto",this.viewModel=new a,this.visibleElements={...y}}get conversions(){return this.viewModel.conversions}set conversions(e){this.viewModel.conversions=e}get currentLocation(){return this.viewModel.currentLocation}set currentLocation(e){this.viewModel.currentLocation=e}get formats(){return this.viewModel.formats}set formats(e){this.viewModel.formats=e}get goToOverride(){return this.viewModel.goToOverride}set goToOverride(e){this.viewModel.goToOverride=e}get icon(){return"coordinate-system"}set icon(e){this._overrideIfSome("icon",e)}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}get mode(){return this.viewModel.mode}set mode(e){this.viewModel.mode=e}set multipleConversions(e){!1===e&&(this._expanded=!1,this.conversions.splice(1,this.conversions.length-1)),this._set("multipleConversions",e)}get multipleConversions(){const e=this._get("multipleConversions");return"boolean"!=typeof e||e}get locationSymbol(){return this.viewModel.locationSymbol}set locationSymbol(e){this.viewModel.locationSymbol=e}get storageEnabled(){return this.viewModel.storageEnabled}set storageEnabled(e){this.viewModel.storageEnabled=e}get storageType(){return this.viewModel.storageType}set storageType(e){this.viewModel.storageType=e}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}castVisibleElements(e){return{...y,...e}}reverseConvert(e,t){return this.viewModel.reverseConvert(e,t)}render(){const e=this.viewModel?.state,t="disabled"===e?_("div",{key:"esri-coordinate__no-basemap"},this.messages?.noBasemap):null,o=!t&&this._inputVisible?this._renderInputForm():null,i=!t&&this._settingsVisible?this._renderSettings():null,s=t||o||i?null:this._renderConversionsView(),n=this._popupVisible?this._renderPopup():null,r={[b.captureMode]:"capture"===this.mode,[p.disabled]:"loading"===e,[b.noBasemap]:"disabled"===e};return _("div",{class:this.classes(b.base,p.widget,r)},n,t,s,i,o)}_addConversion(e){const t=e.target,o=x(t.options[t.options.selectedIndex]),i=I(t);if(null==o||null==i)return;const s=new l({format:o});t.options.selectedIndex=0,i>=0?(this.conversions.removeAt(i),this.conversions.add(s,i)):this.conversions.add(s)}_findSettingsFormat(){return this._settingsFormat||this.conversions.reduceRight(((e,t)=>{const o=t.format;return o?.hasDisplayProperties?o:e}),null)||this.formats.find((e=>e.hasDisplayProperties))}_hidePopup(){this._popupTimeoutId&&(clearTimeout(this._popupTimeoutId),this._popupTimeoutId=void 0),this._popupVisible=!1,this._popupMessage=null,this.scheduleRender()}_hideClipboardPopup(){this._clipboardPopupTimeoutId&&(clearTimeout(this._clipboardPopupTimeoutId),this._clipboardPopupTimeoutId=void 0),this._clipboardPopupVisible=!1,this.scheduleRender()}_onConvertComplete(){this._inputVisible=!1,this._coordinateInput.value=""}_onCopy(e){const t=T(e.currentTarget)?.displayCoordinate;null!=t&&(e.clipboardData?.setData("text/plain",t),this._showClipboardPopup(),e.preventDefault())}_processUserInput(e){const i=o(e,"key"),s=this.viewModel;if("Enter"!==i&&i)this._badInput&&(this._badInput=!1);else{const e=x(this._coordinateInput);if(!e)return;const o=this._coordinateInput.value;this._reverseConvert(o,e).then((e=>{"capture"===this.mode?s.resume():this.mode="capture",this.currentLocation=e,s.setLocation(e),this._onConvertComplete()})).catch((e=>{t.getLogger(this).error(e),this._showPopup(this.messages?.invalidCoordinate),this._badInput=!0}))}}async _reverseConvert(e,o){const i=this.viewModel,s=await o.reverseConvert(e);return this._goToEnabled&&s&&i.goToLocation(s).catch((e=>{t.getLogger(this).warn(e),this._showPopup(this.messages?.locationOffBasemap)})),s}_setInputFormat(e){const t=e.target,o=x(t[t.options.selectedIndex]);null!=o&&(this._conversionFormat=o)}_setPreviewConversion(){const e=this._findSettingsFormat(),t=this.viewModel;if(e){const o=this.conversions.find((t=>t.format===e));this._previewConversion=new l({format:e,position:{location:this.currentLocation,coordinate:o?.position?.coordinate}}),this._previewConversion.position?.coordinate||t.previewConversion(this._previewConversion)}}_setSettingsFormat(e){const t=e.target,o=x(t[t.options.selectedIndex]);null!=o&&(this._settingsFormat=o,this._setPreviewConversion())}_showClipboardPopup(){this._clipboardPopupVisible?clearTimeout(this._clipboardPopupTimeoutId):this._clipboardPopupVisible=!0,this.scheduleRender(),this._popupTimeoutId=setTimeout((()=>{this._popupTimeoutId=void 0,this._hideClipboardPopup()}),w)}_showPopup(e,t=C){this._popupMessage=e,this._popupVisible?clearTimeout(this._popupTimeoutId):this._popupVisible=!0,this.scheduleRender(),this._popupTimeoutId=setTimeout((()=>{this._popupTimeoutId=void 0,this._hidePopup()}),t)}_toggleGoTo(){this._goToEnabled=!this._goToEnabled}_updateCurrentPattern(e){e.stopPropagation();const t=e.target,o=this._findSettingsFormat();o&&(o.currentPattern=t.value)}_renderConversion(e,t){const{messages:o}=this;if(!o)return _("li",null);const{format:i}=e,s=i?.label??"",n=`${this.id}__list-item-${t}`,r=`${s} ${o.conversionOutputSuffix}`,a=0===t,l=a||this._expanded,d=a?this._renderFirstConversion(e):this._renderTools(t,e,n),u=a&&!e.displayCoordinate?o.noLocation:e.displayCoordinate,c=_("div",{"aria-label":u,class:b.coordDisplay,"data-conversion":e,role:"listitem",tabIndex:0,title:u??""},u),h=this._renderOptions(this.formats.filter((e=>e!==i)));return l?_("li",{"aria-label":r,class:b.conversionRow,id:n,key:e,role:"group",tabIndex:0,title:r},_("select",{"aria-controls":n,"aria-label":o.selectFormat,bind:this,class:this.classes(p.select,b.rowSelect),"data-index":t,onchange:this._addConversion,title:o.selectFormat},_("option",{"aria-label":s,selected:!0,title:s},s.toUpperCase()),h),c,d):null}_renderCopyButton(e){const t=this._clipboardPopupVisible&&this._renderClipboardPopup(),{messagesCommon:o}=this;return o?_("li",{"aria-label":o.copy,bind:this,class:this.classes(p.widgetButton,b.rowButton),"data-conversion":e,onclick:this._copyCoordinateOutput,oncopy:this._onCopy,onkeydown:this._copyCoordinateOutput,role:"button",tabIndex:0,title:o.copy},t,_("span",{"aria-hidden":"true",class:u.duplicate})):_("li",null)}_renderFirstConversion(e){const t=this.id,o={[u.down]:!this._expanded,[u.up]:this._expanded},{messages:i,messagesCommon:s,multipleConversions:n,visibleElements:r}=this;if(!s||!i)return _("ul",null);const a="live"===this.mode?i.captureMode:i.liveMode,l=this._expanded?s.collapse:s.expand,d=e.displayCoordinate&&"capture"===this.mode?this._renderCopyButton(e):null,c=n&&r.expandButton&&_("li",{"aria-controls":`${t}__${b.conversionList}`,"aria-label":l,bind:this,class:p.widgetButton,key:"esri-coordinate-conversion__expand-button",onclick:this._toggleExpand,onkeydown:this._toggleExpand,role:"button",tabIndex:0,title:l},_("span",{"aria-hidden":"true",class:this.classes(o)})),h=!n&&r.captureButton&&_("li",{"aria-label":a,bind:this,class:this.classes(p.widgetButton,b.modeToggle),key:"esri-coordinate-conversion__mode-toggle",onclick:this._toggleMode,onkeydown:this._toggleMode,role:"button",tabIndex:0,title:a},_("span",{"aria-hidden":"true",class:u.mapPin}));return _("ul",{class:b.toolDisplay},d,c,h)}_renderInputForm(){const e=this._conversionFormat||this.conversions.at(0).format,t=this.formats.findIndex((t=>t.name===e?.name)),o=this.id,i=`${o}__${b.coordinateInput}`,s=`${o}__${b.coordinateInput}__header`,n=this._renderOptions(this.formats,!0,t),r={[b.rejectInput]:this._badInput},{messages:a,messagesCommon:l,headingLevel:u}=this;return l&&a?_("div",{"aria-labelledby":s,class:b.inputForm,key:"esri-coordinate-conversion__input-form",role:"search"},_("div",{class:b.sectionHeading},_("div",{"aria-label":l.back,bind:this,class:this.classes(p.widgetButton,b.backButton),onclick:this._toggleInputVisibility,onkeydown:this._toggleInputVisibility,role:"button",tabIndex:0,title:l.back},this._renderBackIcon()),_(d,{class:p.heading,id:s,level:u},a.inputCoordTitle)),_("div",{class:b.inputFormGroup},_("select",{"aria-controls":i,"aria-label":a.selectFormat,bind:this,class:this.classes(p.select,b.rowSelect),onchange:this._setInputFormat,title:a.selectFormat},n),_("input",{afterCreate:m,"aria-labelledby":s,"aria-required":"true",bind:this,class:this.classes(b.coordinateInput,p.input,r),"data-format":e,"data-node-ref":"_coordinateInput",id:i,onkeydown:this._processUserInput,placeholder:a.inputCoordTitle,role:"textbox",spellcheck:!1,title:a.inputCoordTitle,type:"text"})),_("div",{class:b.inputFormGroup},_("label",{"aria-label":a.goTo},_("input",{bind:this,checked:this._goToEnabled,onclick:this._toggleGoTo,title:a.goTo,type:"checkbox"}),a.goTo),_("button",{"aria-label":a.convert,bind:this,class:this.classes(b.convertButton,p.button),onclick:this._processUserInput,title:a.convert,type:"button"},_("span",{class:b.convertButtonSpan},a.convert)))):_("div",null)}_renderConversionsView(){const{messages:e}=this;if(!e)return _("div",null);const t=`${this.id}__${b.conversionList}`,o=this._renderPrimaryTools(),i=this._renderOptions(this.formats),s=this.conversions.map(((e,t)=>this._renderConversion(e,t))).toArray(),n=this._expanded?_("div",{class:b.conversionRow},_("select",{"aria-controls":t,"aria-label":e.addConversion,bind:this,class:this.classes(p.select,b.primarySelect),"data-index":-1,onchange:this._addConversion,title:e.addConversion},_("option",{disabled:!0,selected:!0,value:""},e.addConversion),i),o):null,r={[b.expanded]:this._expanded,[b.expandUp]:"expand-up"===this.orientation,[b.expandDown]:"expand-down"===this.orientation};return _("div",{class:this.classes(b.conversionsView,r),key:"esri-coordinate-conversion__main-view"},_("ul",{"aria-expanded":this._expanded?"true":"false",class:b.conversionList,id:t},s),n)}_renderOptions(e,t,o){const i=this.conversions.at(0),s=i.format?.name;return e.map(((e,n)=>{const r=!(t||!i)&&(s===e.name||this.conversions.map((e=>e.format?.name)).includes(e.name));return _("option",{"aria-label":e.label,"data-format":e,disabled:r,key:e.name??"unnamed-format",selected:n===o,value:e.label},e.label.toUpperCase())})).toArray()}_renderPopup(){return _("div",{class:b.popup,role:"alert"},this._popupMessage)}_renderClipboardPopup(){const{messages:e}=this;return e?_("div",{class:this.classes(b.popup,b.clipboardPopup),role:"alert"},e.copySuccessMessage):_("div",null)}_renderPrimaryTools(){const{messages:e,visibleElements:t}=this;if(!e)return _("ul",null);const o="live"===this.mode?e.captureMode:e.liveMode,i=t.inputButton&&_("li",{bind:this,class:p.widgetButton,onclick:this._toggleInputVisibility,onkeydown:this._toggleInputVisibility,role:"button",tabIndex:0,title:e.inputCoordTitle},_("span",{"aria-hidden":"true",class:u.edit})),s=t.captureButton&&_("li",{bind:this,class:this.classes(p.widgetButton,b.modeToggle),onclick:this._toggleMode,onkeydown:this._toggleMode,role:"button",tabIndex:0,title:o},_("span",{"aria-hidden":"true",class:u.mapPin})),n=t.settingsButton&&_("li",{bind:this,class:p.widgetButton,onclick:this._toggleSettingsVisibility,onkeydown:this._toggleSettingsVisibility,role:"button",tabIndex:0,title:e.settingsTitle},_("span",{"aria-hidden":"true",class:u.settings2}));return _("ul",{class:b.toolDisplay},i,s,n)}_renderSettings(){const e=this.id,t=`${e}__${b.patternInput}`,o=`${e}__${b.patternInput}__header`,i=`${e}__${b.previewCoordinate}`,s=this.formats.filter((e=>e.hasDisplayProperties)),n=this._findSettingsFormat(),r=n?s.indexOf(n):-1,a=this._renderOptions(s,!0,r),l=n?.currentPattern,{messages:c,messagesCommon:h,headingLevel:m}=this;return h&&c?_("div",{"aria-labelledby":o,class:b.settings,key:b.settings},_("div",{class:b.sectionHeading},_("div",{bind:this,class:this.classes(p.widgetButton,b.backButton),onclick:this._toggleSettingsVisibility,onkeydown:this._toggleSettingsVisibility,role:"button",tabIndex:0,title:h.back},this._renderBackIcon()),_(d,{class:p.heading,id:o,level:m},c.settingsTitle)),_("div",{class:b.settingsFormGroup},_("label",{for:t},c.changeCoordinateDisplay),_("select",{"aria-label":c.selectFormat,bind:this,class:p.select,onchange:this._setSettingsFormat,title:c.selectFormat},a),_("div",{class:b.settingsFormGroupHorizontal},_("input",{"aria-controls":i,bind:this,class:this.classes(b.patternInput,p.input),id:t,oninput:this._updateCurrentPattern,spellcheck:!1,title:c.changeCoordinateDisplay,type:"text",value:l}),_("div",{"aria-controls":t,bind:this,class:p.widgetButton,onclick:this._setDefaultPattern,onkeydown:this._setDefaultPattern,role:"button",tabIndex:0,title:c.defaultPattern},_("span",{"aria-hidden":"true",class:u.refresh})))),_("div",{class:b.settingsFormGroup},_("label",null,h.preview,_("div",{class:b.previewCoordinate,id:i,tabIndex:0},this._previewConversion?.displayCoordinate)))):_("div",null)}_renderBackIcon(){return _("span",{"aria-hidden":"true",class:v(this.container)?u.rightArrow:u.leftArrows})}_renderTools(e,t,o){const i=t.displayCoordinate&&"capture"===this.mode?this._renderCopyButton(t):null,{messages:s}=this;return s?_("ul",{class:b.toolDisplay,role:"listitem"},i,_("li",{"aria-controls":o,"aria-label":s.removeConversion,bind:this,class:this.classes(p.widgetButton,b.rowButton),"data-index":e,key:`${o}__${p.widgetButton}`,onclick:this._removeConversion,onkeydown:this._removeConversion,role:"button",tabIndex:0,title:s.removeConversion},_("span",{"aria-hidden":"true",class:u.close}))):_("ul",null)}_copyCoordinateOutput(e){const t=e.target;if(!("createTextRange"in document.body)){const e=window.getSelection(),o=document.createRange();o.selectNodeContents(t),e?.removeAllRanges(),e?.addRange(o)}document.execCommand("copy")}_removeConversion(e){const t=I(e.currentTarget);null!=t&&this.conversions.removeAt(t)}_setDefaultPattern(e){e.stopPropagation();const t=this._findSettingsFormat();t&&(t.currentPattern=t.defaultPattern)}_toggleExpand(){this._expanded=!this._expanded}_toggleInputVisibility(){this._inputVisible=!this._inputVisible,this._popupVisible&&this._hidePopup(),this._inputVisible?this.viewModel.pause():this.viewModel.resume()}_toggleMode(){this.mode="live"===this.mode?"capture":"live"}_toggleSettingsVisibility(){this._settingsVisible=!this._settingsVisible,this._popupVisible&&this._hidePopup(),this._settingsVisible?(this._setPreviewConversion(),this.viewModel.pause()):this.viewModel.resume()}};function I(e){return e["data-index"]}function x(e){return e["data-format"]}function T(e){return e["data-conversion"]}e([i()],f.prototype,"conversions",null),e([i()],f.prototype,"currentLocation",null),e([i()],f.prototype,"formats",null),e([i()],f.prototype,"goToOverride",null),e([i()],f.prototype,"headingLevel",void 0),e([i()],f.prototype,"icon",null),e([i()],f.prototype,"label",null),e([i(),h("esri/widgets/CoordinateConversion/t9n/CoordinateConversion")],f.prototype,"messages",void 0),e([i(),h("esri/t9n/common")],f.prototype,"messagesCommon",void 0),e([i()],f.prototype,"mode",null),e([i()],f.prototype,"orientation",void 0),e([i()],f.prototype,"multipleConversions",null),e([i()],f.prototype,"locationSymbol",null),e([i()],f.prototype,"storageEnabled",null),e([i()],f.prototype,"storageType",null),e([i()],f.prototype,"view",null),e([i({type:a})],f.prototype,"viewModel",void 0),e([i()],f.prototype,"visibleElements",void 0),e([s("visibleElements")],f.prototype,"castVisibleElements",null),e([c()],f.prototype,"_copyCoordinateOutput",null),e([c()],f.prototype,"_removeConversion",null),e([c()],f.prototype,"_setDefaultPattern",null),e([c()],f.prototype,"_toggleExpand",null),e([c()],f.prototype,"_toggleInputVisibility",null),e([c()],f.prototype,"_toggleMode",null),e([c()],f.prototype,"_toggleSettingsVisibility",null),f=e([n("esri.widgets.CoordinateConversion")],f);const P=f;export{P as default};
