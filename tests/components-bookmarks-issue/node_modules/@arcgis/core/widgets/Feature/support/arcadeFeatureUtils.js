/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import e from"../../../core/Logger.js";import{eachAlways as r}from"../../../core/promiseUtils.js";import t from"../../../layers/FeatureLayer.js";import{applyTextFormattingHTML as a,htmlEntities as o}from"./featureUtils.js";import{globalCss as i}from"../../support/globalCss.js";const n="esri.widgets.Feature.support.arcadeFeatureUtils",s=()=>e.getLogger(n);function p(e){return"string"==typeof e?a(o(e)):Array.isArray(e)?c(e):"esri.arcade.Dictionary"===e?.declaredClass?u(e):e}function c(e){return`<ul class="esri-widget__list">${e.map((e=>`<li>${"string"==typeof e?a(o(e)):e}</li>`)).join("")}</ul>`}function u(e){const r=e.keys().map((r=>{const t=e.field(r);return`<tr><th>${r}</th><td>${"string"==typeof t?a(o(t)):t}</td></tr>`})).join("");return`<table class="${i.table}">${r}</table>`}function l(){return import("../../../arcade.js")}function d(e){return"createQuery"in e&&"queryFeatures"in e}async function f({graphic:e,view:r,options:t}){const{isAggregate:a,layer:o}=e;if(!a||!o||"2d"!==r?.type)return[];const i=await r.whenLayerView(o);if(!d(i))return[];const n=i.createQuery(),s=e.getObjectId();n.aggregateIds=null!=s?[s]:[];const{features:p}=await i.queryFeatures(n,t);return p}function y({layer:e,aggregatedFeatures:r,interceptor:a}){const{fields:o,objectIdField:i,geometryType:n,spatialReference:s,displayField:p}=e;return new t({fields:o,objectIdField:i,geometryType:n,spatialReference:s,displayField:p,interceptor:a,..."feature"===e.type?{templates:e.templates,typeIdField:e.typeIdField,types:e.types}:null,source:r})}async function g({expressionInfo:e,arcade:r,interceptor:t,spatialReference:a,map:o,graphic:i,location:n,view:p,options:c}){if(!e?.expression)return null;const{isAggregate:u}=i,l=(i.sourceLayer||i.layer)??void 0,d=u?"feature-reduction-popup":"popup",g=r.createArcadeProfile(d),m=r.createArcadeExecutor(e.expression,g).catch((r=>s().error("arcade-executor-error",{error:r,expressionInfo:e}))),[w,h]=await Promise.all([f({graphic:i,view:p,options:c}),m]);if(!h)return null;const F="feature-reduction-popup"===d?y({layer:l,aggregatedFeatures:w,interceptor:t}):void 0,$={..."feature-reduction-popup"===d?{$aggregatedFeatures:F}:{$datastore:l?.url,$layer:"feature"===l?.type||"subtype-sublayer"===l?.type?l:"scene"===l?.type&&null!=l.associatedLayer?l.associatedLayer:void 0,$map:o,$userInput:n,$graph:"knowledge-graph-sublayer"===l?.type?l?.parentCompositeLayer?.knowledgeGraph:void 0},$feature:i},v={abortSignal:c?.signal??void 0,interceptor:t??void 0,rawOutput:!0,spatialReference:a??void 0,timeZone:p?.timeZone};return await h.executeAsync($,v).catch((r=>s().error("arcade-execution-error",{error:r,graphic:i,expressionInfo:e}))).finally((()=>F?.destroy()))}async function m({expressionInfos:e,spatialReference:t,graphic:a,interceptor:o,map:i,view:n,location:s,options:c}){if(!e?.length)return{};const u=await l(),d={};for(const r of e)d[`expression/${r.name}`]=g({expressionInfo:r,arcade:u,interceptor:o,spatialReference:t,map:i,graphic:a,location:s,view:n,options:c});const f=await r(d),y={};for(const r in f)y[r]=p(f[r].value);return y}export{g as createCompiledExpression,m as createCompiledExpressions,l as loadArcade};
