/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{_ as t}from"../../../chunks/tslib.es6.js";import"../../../geometry.js";import e from"../../../Graphic.js";import o from"../../../core/Accessor.js";import{watch as r,initial as n}from"../../../core/reactiveUtils.js";import{throttle as i}from"../../../core/throttle.js";import{property as s}from"../../../core/accessorSupport/decorators/property.js";import"../../../core/has.js";import"../../../core/Logger.js";import"../../../core/RandomLCG.js";import{subclass as l}from"../../../core/accessorSupport/decorators/subclass.js";import"../../../popup/content/AttachmentsContent.js";import"../../../popup/content/Content.js";import"../../../popup/content/CustomContent.js";import"../../../popup/content/ExpressionContent.js";import p from"../../../popup/content/FieldsContent.js";import a from"../../../popup/content/MediaContent.js";import"../../../popup/content/RelationshipContent.js";import c from"../../../popup/content/TextContent.js";import m from"../../../popup/ElementExpressionInfo.js";import h from"../FeatureContent/FeatureContentViewModel.js";import d from"../FeatureFields/FeatureFieldsViewModel.js";import u from"../FeatureMedia/FeatureMediaViewModel.js";import{loadArcade as f,createCompiledExpression as y}from"../support/arcadeFeatureUtils.js";import _ from"../../../geometry/Point.js";const w=1;let j=class extends o{constructor(t){super(t),this._abortController=null,this.expressionInfo=null,this.graphic=null,this.contentElement=null,this.contentElementViewModel=null,this.interceptor=null,this.location=null,this.view=null,this._cancelQuery=()=>{const{_abortController:t}=this;t&&t.abort(),this._abortController=null},this._createVM=()=>{const t=this.contentElement?.type;this.contentElementViewModel?.destroy();const e="fields"===t?new d:"media"===t?new u:"text"===t?new h:null;this._set("contentElementViewModel",e)},this._compile=async()=>{this._cancelQuery();const t=new AbortController;this._abortController=t,await this._compileExpression(),this._abortController===t&&(this._abortController=null)},this._compileThrottled=i(this._compile,w,this),this._compileExpression=async()=>{const{expressionInfo:t,graphic:e,interceptor:o,spatialReference:r,map:n,location:i,view:s,_abortController:l}=this;if(!t||!e)return void this._set("contentElement",null);const m=await f();if(l!==this._abortController)return;const h=await y({arcade:m,expressionInfo:t,graphic:e,location:i,interceptor:o,map:n,spatialReference:r,view:s});if(!h||"esri.arcade.Dictionary"!==h.declaredClass)return void this._set("contentElement",null);const d=await h.castAsJsonAsync(l?.signal),u=d?.type,_="media"===u?a.fromJSON(d):"text"===u?c.fromJSON(d):"fields"===u?p.fromJSON(d):null;this._set("contentElement",_)},this.addHandles([r((()=>[this.expressionInfo,this.graphic,this.map,this.spatialReference,this.view]),(()=>this._compileThrottled()),n),r((()=>[this.contentElement]),(()=>this._createVM()),n)])}initialize(){this.addHandles(this._compileThrottled)}destroy(){this._cancelQuery(),this.contentElementViewModel?.destroy(),this._set("contentElementViewModel",null),this._set("contentElement",null)}get spatialReference(){return this.view?.spatialReference??null}set spatialReference(t){this._override("spatialReference",t)}get state(){const{_abortController:t,contentElement:e,contentElementViewModel:o}=this;return t?"loading":e||o?"ready":"disabled"}get map(){return this.view?.map??null}set map(t){this._override("map",t)}};t([s()],j.prototype,"_abortController",void 0),t([s({type:m})],j.prototype,"expressionInfo",void 0),t([s({type:e})],j.prototype,"graphic",void 0),t([s({readOnly:!0})],j.prototype,"contentElement",void 0),t([s({readOnly:!0})],j.prototype,"contentElementViewModel",void 0),t([s()],j.prototype,"interceptor",void 0),t([s({type:_})],j.prototype,"location",void 0),t([s()],j.prototype,"spatialReference",null),t([s({readOnly:!0})],j.prototype,"state",null),t([s()],j.prototype,"map",null),t([s()],j.prototype,"view",void 0),j=t([l("esri.widgets.Feature.FeatureExpression.FeatureExpressionViewModel")],j);const C=j;export{C as default};
