/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{_ as t}from"../../../chunks/tslib.es6.js";import e from"../../../core/Accessor.js";import{isSome as o}from"../../../core/arrayUtils.js";import{property as i}from"../../../core/accessorSupport/decorators/property.js";import{cast as r}from"../../../core/accessorSupport/decorators/cast.js";import"../../../core/has.js";import{subclass as a}from"../../../core/accessorSupport/decorators/subclass.js";import s from"../../../popup/FieldInfo.js";import l from"../../../popup/content/support/ChartMediaInfoValueSeries.js";import{substituteFieldsInLinksAndAttributes as n,fixTokens as p,substituteAttributes as d,getFixedFieldNames as u,getFixedFieldName as f,isRelatedField as c,isExpressionField as m,getFieldInfo as h,getFieldInfoLabel as b}from"../support/featureUtils.js";import{getRelatedFieldInfo as y}from"../support/relatedFeatureUtils.js";const I={chartAnimation:!0};let v=class extends e{constructor(t){super(t),this.abilities={...I},this.activeMediaInfoIndex=0,this.attributes=null,this.description=null,this.fieldInfoMap=null,this.formattedAttributes=null,this.expressionAttributes=null,this.isAggregate=!1,this.layer=null,this.mediaInfos=null,this.popupTemplate=null,this.relatedInfos=null,this.title=null}castAbilities(t){return{...I,...t}}get activeMediaInfo(){return this.formattedMediaInfos[this.activeMediaInfoIndex]||null}get formattedMediaInfos(){return this._formatMediaInfos()||[]}get formattedMediaInfoCount(){return this.formattedMediaInfos.length}setActiveMedia(t){this._setContentElementMedia(t)}next(){this._pageContentElementMedia(1)}previous(){this._pageContentElementMedia(-1)}_setContentElementMedia(t){const{formattedMediaInfoCount:e}=this,o=(t+e)%e;this.activeMediaInfoIndex=o}_pageContentElementMedia(t){const{activeMediaInfoIndex:e}=this,o=e+t;this._setContentElementMedia(o)}_formatMediaInfos(){const{mediaInfos:t,layer:e}=this,i=this.attributes??{},r=this.formattedAttributes??{},a=this.expressionAttributes??{},s=this.fieldInfoMap??new Map;return t?.map((t=>{const o=t?.clone();if(!o)return null;if(o.title=n({attributes:i,fieldInfoMap:s,globalAttributes:r,expressionAttributes:a,layer:e,text:o.title}),o.caption=n({attributes:i,fieldInfoMap:s,globalAttributes:r,expressionAttributes:a,layer:e,text:o.caption}),o.altText=n({attributes:i,fieldInfoMap:s,globalAttributes:r,expressionAttributes:a,layer:e,text:o.altText}),"image"===o.type){const{value:t}=o;return this._setImageValue({value:t,formattedAttributes:r,layer:e}),o.value.sourceURL?o:void 0}if("pie-chart"===o.type||"line-chart"===o.type||"column-chart"===o.type||"bar-chart"===o.type){const{value:t}=o;return this._setChartValue({value:t,chartType:o.type,attributes:i,formattedAttributes:r,layer:e,expressionAttributes:a}),o}return null})).filter(o)??[]}_setImageValue(t){const e=this.fieldInfoMap??new Map,{value:o,formattedAttributes:i,layer:r}=t,{linkURL:a,sourceURL:s}=o;if(s){const t=p(s,r);o.sourceURL=d({formattedAttributes:i,template:t,fieldInfoMap:e})}if(a){const t=p(a,r);o.linkURL=d({formattedAttributes:i,template:t,fieldInfoMap:e})}}_setChartValue(t){const{value:e,attributes:o,formattedAttributes:i,chartType:r,layer:a,expressionAttributes:s}=t,{popupTemplate:l,relatedInfos:n}=this,{fields:p,normalizeField:d}=e,m=a;e.fields=u(p,m),d&&(e.normalizeField=f(d,m));if(!p.some((t=>!!(null!=i[t]||c(t)&&n?.size))))return;const h=l?.fieldInfos??[];p.forEach(((t,a)=>{const l=e.colors?.[a];if(c(t))return void(e.series=[...e.series,...this._getRelatedChartInfos({fieldInfos:h,fieldName:t,formattedAttributes:i,chartType:r,value:e,color:l})]);const n=this._getChartOption({value:e,attributes:o,chartType:r,formattedAttributes:i,expressionAttributes:s,fieldName:t,fieldInfos:h,color:l});e.series.push(n)}))}_getRelatedChartInfos(t){const{fieldInfos:e,fieldName:o,formattedAttributes:i,chartType:r,value:a,color:s}=t,l=[],n=y(o),p=n&&this.relatedInfos?.get(n.layerId.toString());if(!p)return l;const{relatedFeatures:d,relation:u}=p;if(!u||!d)return l;const{cardinality:f}=u;d.forEach((t=>{const{attributes:p}=t;p&&Object.keys(p).forEach((t=>{t===n.fieldName&&l.push(this._getChartOption({value:a,attributes:p,formattedAttributes:i,fieldName:o,chartType:r,relatedFieldName:t,hasMultipleRelatedFeatures:d?.length>1,fieldInfos:e,color:s}))}))}));return"one-to-many"===f||"many-to-many"===f?l:[l[0]]}_getTooltip({label:t,value:e,chartType:o}){return"pie-chart"===o?`${t}`:`${t}: ${e}`}_getChartOption(t){const{value:e,attributes:o,formattedAttributes:i,expressionAttributes:r,fieldName:a,relatedFieldName:n,fieldInfos:p,chartType:d,hasMultipleRelatedFeatures:u,color:I}=t,v=this.layer,M=this.fieldInfoMap??new Map,{normalizeField:A,tooltipField:g}=e,x=A?c(A)?o[y(A).fieldName]:o[A]:null,_=m(a)&&r&&void 0!==r[a]?r[a]:n&&void 0!==o[n]?o[n]:void 0!==o[a]?o[a]:i[a],C=new l({fieldName:a,color:I,value:void 0===_?null:_&&x?_/x:_});if(c(a)){const t=M.get(a.toLowerCase()),e=g&&M.get(g.toLowerCase()),r=t?.fieldName??a,s=u&&g?y(g).fieldName:e?.fieldName??g,l=u&&s?o[s]:i[s]??t?.label??t?.fieldName??n,p=u&&n?o[n]:i[r];return C.tooltip=this._getTooltip({label:l,value:p,chartType:d}),C}const T=h(p,a),N=f(a,v),F=g&&void 0!==i[g]?i[g]:b(T||new s({fieldName:N}),this.popupTemplate?.expressionInfos),j=i[N];return C.tooltip=this._getTooltip({label:F,value:j,chartType:d}),C}};t([i()],v.prototype,"abilities",void 0),t([r("abilities")],v.prototype,"castAbilities",null),t([i()],v.prototype,"activeMediaInfoIndex",void 0),t([i({readOnly:!0})],v.prototype,"activeMediaInfo",null),t([i()],v.prototype,"attributes",void 0),t([i()],v.prototype,"description",void 0),t([i()],v.prototype,"fieldInfoMap",void 0),t([i()],v.prototype,"formattedAttributes",void 0),t([i()],v.prototype,"expressionAttributes",void 0),t([i({readOnly:!0})],v.prototype,"formattedMediaInfos",null),t([i()],v.prototype,"isAggregate",void 0),t([i()],v.prototype,"layer",void 0),t([i({readOnly:!0})],v.prototype,"formattedMediaInfoCount",null),t([i()],v.prototype,"mediaInfos",void 0),t([i()],v.prototype,"popupTemplate",void 0),t([i()],v.prototype,"relatedInfos",void 0),t([i()],v.prototype,"title",void 0),v=t([a("esri.widgets.Feature.FeatureMedia.FeatureMediaViewModel")],v);const M=v;export{M as default};
