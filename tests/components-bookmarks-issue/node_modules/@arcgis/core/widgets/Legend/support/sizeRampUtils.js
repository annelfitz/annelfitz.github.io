/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import e from"../../../Color.js";import{isSymbol3D as l}from"../../../symbols.js";import{round as t,numDigits as n,percentChange as o}from"../../../renderers/support/numberUtils.js";import{updateReferenceSizeSymbol as i}from"../../../smartMapping/renderers/support/referenceSizeUtils.js";import{applyCIMSymbolColor as s}from"../../../symbols/support/cimSymbolUtils.js";import{isVolumetricSymbol as r,getSymbolOutlineSize as a}from"../../../symbols/support/utils.js";import{getReferenceSizeAuthoringInfoVisualVariable as u,getSymbolForFlowRenderer as c,createStopLabel as m}from"./utils.js";import"../../support/widgetUtils.js";import{isDarkTheme as p}from"../../../support/themeUtils.js";import f from"../../../symbols/SimpleMarkerSymbol.js";import y from"../../../symbols/SimpleLineSymbol.js";const b=30,h=12,d=24,w=[255,255,255],S=[200,200,200],g=[128,128,128],v=20,z=5;function j(e){return"esri.symbols.SimpleMarkerSymbol"===e.declaredClass}function k(e){return"esri.symbols.PictureMarkerSymbol"===e.declaredClass}function V(e){return"esri.symbols.SimpleLineSymbol"===e.declaredClass}function x(e){return"esri.symbols.TextSymbol"===e.declaredClass}function I(e,l){const t=e.length-1;return e.map(((e,n)=>m(e,n,t,l)))}async function L(e,l,n,o,i,s,c){const m=l.legendOptions,p=m?.customValues,f=c||await D(e,n),y=l.stops,b=!!f,h=!!p,w=null!=l.minSize&&null!=l.maxSize,S=y&&y.length>1,g=!!l.target;if(!b||!h&&!(w||S&&!g))return;const v=r(f);let z=!1,j=null,k=null;j=v&&!S?t([l.minDataValue,l.maxDataValue]):p??await T(l,f,o,i?.type);const V=e?.authoringInfo,x="univariate-color-size"===V?.type,L=x&&"above-and-below"===V?.univariateTheme,q=!!u(e);if(!j&&S&&(j=y.map((e=>e.value)),z=y.some((e=>!!e.label)),"flow"===e.type&&(j=t(j)),z&&(k=y.map((e=>e.label)))),v&&null!=j&&j?.length>2&&!L&&(j=[j[0],j[j.length-1]]),!j)return null;x&&5!==j?.length&&(j=P({minSize:j[0],maxSize:j[j.length-1]}));const B=v?U(e,j):null,E=a(f),R=z?null:I(j,s);return(await Promise.all(j.map((async(t,s)=>{const r=v?B[s]:await H(l,f,t,o,i?.type);return{value:t,symbol:!q||"class-breaks"!==e.type&&"unique-value"!==e.type?O(L&&"class-breaks"===e.type?C(e,s):f,r):M(e,r,l.maxSize,n)??f,label:z?k[s]:R[s],size:q?d:r,outlineSize:E}})))).reverse()}function U(e,l){const t=e?.authoringInfo,n="univariate-color-size"===t?.type;let o=[h,b];if(n){const e=l[0],t=l[l.length-1],n=h,i=b;o=l.map((l=>n+(l-e)/(t-e)*(i-n)))}return n&&"below"===t?.univariateTheme&&o.reverse(),o}function M(l,t,n,o){const s="class-breaks"===l.type,r=s?l.classBreakInfos?.[0]?.symbol?.clone():l.uniqueValueInfos?.[0]?.symbol?.clone();return r&&"type"in r&&"cim"===r.type?(i(r,{color:o??(s?null:new e(S)),innerDotSize:t*(d/n)||1,outerRingSize:d}),r):null}function C(e,l){const t=e.classBreakInfos,n=t.length,o=n<2||!(l>=2)?t[0].symbol.clone():t[n-1].symbol.clone();return e.visualVariables.some((e=>"color"===e.type))&&(o.type.includes("3d")?B(o):E(o)),o}async function D(e,l){if("flow"===e.type)return c(e,l);if("pie-chart"===e.type)return new f({color:null,outline:e.outline?.width?e.outline:new y});let t=null,n=null;if("simple"===e.type)t=e.symbol;else if("class-breaks"===e.type){const l=e.classBreakInfos;t=l&&l[0]&&l[0].symbol,n=l.length>1}else if("unique-value"===e.type){const l=e.uniqueValueInfos;t=l?.[0]?.symbol,n=null!=l&&l.length>1}return!t||q(t)?null:(t=t.clone(),(l||n)&&(t.type.includes("3d")?B(t):E(t)),t)}function q(e){if(e){if(l(e)){return!!e.symbolLayers&&e.symbolLayers.some((e=>e&&"fill"===e.type))}return e.type.includes("fill")}return!1}function B(e){"line-3d"===e.type?e.symbolLayers.forEach((e=>{e.material={color:g}})):e.symbolLayers.forEach((e=>{"icon"!==e.type||e.resource?.href?e.material={color:S}:(e.material={color:w},e.outline={color:g,size:1.5})}))}function E(l){const t=p();if("cim"===l.type)s(l,new e(S));else if(l.type.includes("line"))l.color=g;else if(l.color=t?g:w,"simple-marker"===l.type)if(l.outline){const e=l.outline?.color?.toHex();"#ffffff"===e&&(l.outline.color=g)}else l.outline={color:g,width:1.5}}async function T(e,l,n,o){const i=(await import("../../../renderers/visualVariables/support/visualVariableUtils.js")).getSizeRangeAtScale(e,n,o),s=i&&P(i);if(!i||!s)return;let r=s.map((l=>R(l,e,i)));r=t(r);for(let t=1;t<r.length-1;t++){const i=await A(e,l,r[t],r[t-1],n,o);i&&(r[t]=i[0],s[t]=i[1])}return r}function P(e){const l=e.minSize,t=e.maxSize,n=z,o=(t-l)/(n-1),i=[];for(let s=0;s<n;s++)i.push(l+o*s);return i}function R(e,l,t){const n=t.minSize,o=t.maxSize,i=l.minDataValue,s=l.maxDataValue;let r;if(e<=n)r=i;else if(e>=o)r=s;else{r=(e-n)/(o-n)*(s-i)+i}return r}async function A(e,l,i,s,r,a){const u=await H(e,l,i,r,a),c=await H(e,l,s,r,a),m=n(i),p=m.fractional,f=v;let y=m.integer,b=null,h=null;i>0&&i<1&&(b=10**p,y=n(i*=b).integer);for(let n=y-1;n>=0;n--){const s=10**n;let m=Math.floor(i/s)*s,p=Math.ceil(i/s)*s;null!=b&&(m/=b,p/=b);let y=(m+p)/2;[,y]=t([m,y,p],{indexes:[1]});const d=await H(e,l,m,r,a),w=await H(e,l,p,r,a),S=await H(e,l,y,r,a),g=o(u,d,c,null),v=o(u,w,c,null),z=o(u,S,c,null);let j=g.previous<=f,k=v.previous<=f;if(j&&k&&(g.previous<=v.previous?(j=!0,k=!1):(k=!0,j=!1)),j?h=[m,d]:k?h=[p,w]:z.previous<=f&&(h=[y,S]),h)break}return h}async function H(e,l,t,n,o){const{getSize:i}=await import("../../../renderers/visualVariables/support/visualVariableUtils.js");return i(e,t,{scale:n,view:o,shape:"simple-marker"===l.type?l.style:null})}function O(e,t){const n=e.clone();if(l(n))r(n)||n.symbolLayers.forEach((e=>{"fill"!==e.type&&(e.size=t)}));else if(j(n))n.size=t;else if(k(n)){const e=n.width,l=n.height;n.height=t,n.width=t*(e/l)}else V(n)?n.width=t:x(n)&&n.font&&(n.font.size=t);return n}export{L as getRampStops,M as getReferenceSizeSymbol,b as realWorldMaxSize,h as realWorldMinSize};
