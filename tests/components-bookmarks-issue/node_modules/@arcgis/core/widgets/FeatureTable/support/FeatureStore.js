/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{_ as e}from"../../../chunks/tslib.es6.js";import t from"../../../Graphic.js";import r from"../../../core/Accessor.js";import{equals as s,isSome as i,remove as a}from"../../../core/arrayUtils.js";import o from"../../../core/Collection.js";import n from"../../../core/Error.js";import{clone as h}from"../../../core/lang.js";import u from"../../../core/Logger.js";import{property as c}from"../../../core/accessorSupport/decorators/property.js";import"../../../core/has.js";import{subclass as y}from"../../../core/accessorSupport/decorators/subclass.js";import{getEffectiveLayerCapabilities as l}from"../../../layers/support/layerUtils.js";import d from"../../../rest/support/AttachmentQuery.js";const p="esri.widgets.FeatureTable.support.FeatureStore";function m(e,t,r){u.getLogger(p).error(new n(e,t,r))}let _=class extends r{constructor(e){super(e),this._loaded=!1,this._loadError=!1,this._loading=!1,this._editOperationQueue=[],this._queryOperationQueue=[],this._objectIdCache=new o,this._hasStaleCache=!1,this.count=0,this.failures=new o,this.itemCache=new o,this.relatedRecordsEnabled=!1}destroy(){this.layer=null,this.itemCache?.destroy(),this.failures?.destroy(),this._set("itemCache",null)}set attachmentsEnabled(e){this._reset(),this._set("attachmentsEnabled",e),this.notifyChange("state")}set filterGeometry(e){this._reset(),this._set("filterGeometry",e),this.notifyChange("state")}set layer(e){this._reset(),this._set("layer",e),this.notifyChange("state")}set objectIds(e){this._reset(),this._set("objectIds",e||null),this.notifyChange("state")}get orderByFields(){return this._get("orderByFields")||[]}set orderByFields(e){const t=this.orderByFields;s(e,t)||(this.itemCache.removeAll(),this._hasStaleCache=!0,this._set("orderByFields",e))}get querying(){return this._queryOperationQueue.length>0}set returnGeometry(e){this._reset(),this._set("returnGeometry",e),this.notifyChange("state")}get state(){const{layer:e,_loaded:t,_loadError:r,_loading:s}=this;return r?"error":!e||e.loadError?"disabled":s?"loading":"loaded"===e.loadStatus&&t?"loaded":"ready"}get syncing(){return this._editOperationQueue.length>0}set timeExtent(e){this._reset(),this._set("timeExtent",e),this.notifyChange("state")}get where(){return this._get("where")||null}set where(e){this._reset(),this._set("where",e),this.notifyChange("state")}async load(){this._reset();const{layer:e}=this;if(e){this._loading=!0,this.notifyChange("state");try{await e.when(),await this._syncLayerInfo(),this._loading=!1,this._loaded=!0,this.notifyChange("state")}catch(t){throw this._reset(),this._loadError=!0,this.notifyChange("state"),m("store:load-error","An error occurred.",{error:t}),t}}}async refreshLayerInfo(){return this._syncLayerInfo()}async addItems(e){}async fetchItems(e){const{page:t,pageSize:r}=e,s=t*r,i=s+r,{layer:a,state:o}=this;if(!a||"loaded"!==o)return[];this.notifyChange("querying");const n=await this._query({start:s,num:i,page:t,pageSize:r});return this.notifyChange("state"),n}async verifyFeaturesByObjectId(e){const{layer:t,state:r}=this;if(!t||"loaded"!==r)return[];const{features:s}=await this._verifyFeaturesByObjectId(e);return e.map((e=>s.some((t=>t?.getObjectId()===e))))}async query(e){const{layer:t,state:r}=this;if(!t||"loaded"!==r)return[];this.notifyChange("querying");const s=await this._query(e);return this.notifyChange("state"),s}async removeItemAt(e){}async reset(){this._reset()}async updateItem(e){return this._update(e).then((()=>{}))}async deleteRowsByObjectId(e){const{layer:t}=this,{operations:r}=l(t);if(!r.supportsDelete||!("applyEdits"in t))throw new n("store:delete-error","Delete is not supported.");const s=e.map((e=>this.getItemByObjectId(e)?.feature)).filter(i);return this._queueEditOperation((()=>t.applyEdits({deleteFeatures:s})))}getLocalItemByKey(e){return this.getItemByObjectId(e)}getItemByObjectId(e){const{itemCache:t,layer:{objectIdField:r}}=this;return t.find((t=>t.feature?.attributes[r]===e))}getLocalItemAt(e){return this.itemCache.at(e)}at(e){return Promise.resolve(this.itemCache.at(e))}getObjectIdIndex(e){const{itemCache:t,layer:{objectIdField:r}}=this;return t.findIndex((t=>t.feature?.attributes[r]===e))}_reset(){this.itemCache.removeAll(),this.failures.removeAll(),this._editOperationQueue=[],this._queryOperationQueue=[],this._hasStaleCache=!1,this._loading=!1,this._loaded=!1,this._loadError=!1,this._set("count",0),this._objectIdCache.removeAll(),this.notifyChange("querying"),this.notifyChange("syncing"),this.notifyChange("state")}_getIdsFromFeatures(e){return e.map((e=>e.attributes[this.layer.objectIdField]))}_toFeatureData(e,t){const{layer:{objectIdField:r}}=this;return e.map((e=>{const{attributes:s}=e,i=s[r];return{objectId:i,feature:e,attachments:t?t[i]:null,relatedRecords:null}}))}async _update(e){const{layer:r}=this,{operations:s}=l(r);if(!s.supportsUpdate||!("applyEdits"in r))throw new n("store:update-error","Update is not supported.");const{index:i,name:a,value:o}=e,u=await this.at(i);if(!u?.feature)throw new n("store:update-error","Feature with provided 'objectId' not found.");const{feature:c}=u,y=h(c.attributes);y[a]=o;const d=new t({attributes:y}),p=r.applyEdits({updateFeatures:[d]}).then((e=>{const{updateFeatureResults:t}=e,r=t.find((e=>!!e.error));if(r)throw r.error;return t.length&&(c.attributes=y),e}));return this._queueEditOperation((()=>p))}async _query(e){const{refresh:t}=e;return!0===t?(this.itemCache.removeAll(),this._syncLayerInfo().then((()=>this._queryFeatureData(e)))):(this._hasStaleCache&&(await this._updateIds(),this._hasStaleCache=!1),this._queryFeatureData(e))}async _queryFeatureData(e){return this._queueQueryOperation((async()=>{const{features:t}=await this._queryFeatures(e),r=this._getIdsFromFeatures(t),s=await this._queryAttachments(r);return this._toFeatureData(t,s)||[]}))}async _syncLayerInfo(){await this._updateCount(),await this._updateIds()}async _updateCount(){await this._queryCount().then((e=>this._set("count",e)))}async _updateIds(){this.layer?.capabilities?.query?.supportsPagination||(this._objectIdCache.removeAll(),await this._queryForObjectIds().then((e=>this._objectIdCache.addMany(e))))}_queryCount(){const{filterGeometry:e,layer:t}=this,r=t.capabilities?.query?.supportsCacheHint,s=t.createQuery();return s.geometry=e,s.returnGeometry=!1,s.where=this._getWhere(),s.timeExtent=this._getTimeExtent(),s.objectIds=this.objectIds,r&&(s.cacheHint=!0),t.queryFeatureCount(s)}_queryForObjectIds(){const{filterGeometry:e,layer:t,orderByFields:r}=this,s=t.capabilities?.query,i=s?.supportsCacheHint,a=s?.supportsOrderBy,o=t.createQuery();return o.geometry=e,o.outFields=[t.objectIdField],o.returnGeometry=!1,o.where=this._getWhere(),o.timeExtent=this._getTimeExtent(),o.objectIds=this.objectIds,a&&(o.orderByFields=r),i&&(o.cacheHint=!0),t.queryObjectIds(o)}async _queryFeatures(e){const{layer:t}=this;if(!l(t)?.operations.supportsQuery)throw new n("store:query-error","Layer does not support query operation.");const{filterGeometry:r,orderByFields:s,returnGeometry:i}=this,a=this.layer?.capabilities?.query,{start:o,pageSize:h}=e,u=t.createQuery();return u.returnGeometry=i,a?.supportsPagination?(u.start=o,u.num=h,u.where=this._getWhere(),u.timeExtent=this._getTimeExtent(),u.objectIds=this.objectIds):u.objectIds=this.objectIds||this._getObjectIdsForPage(o,h??0),a?.supportsOrderBy&&(u.orderByFields=s),r&&(u.geometry=r),a?.supportsCacheHint&&(u.cacheHint=!0),t.queryFeatures(u)}async _verifyFeaturesByObjectId(e){const{layer:t}=this;if(!l(t)?.operations.supportsQuery)throw new n("store:query-error","Layer does not support query operation.");const{orderByFields:r}=this,s=this.layer?.capabilities?.query,i=t.createQuery();return i.where=this._getWhere(),i.timeExtent=this._getTimeExtent(),i.returnGeometry=!1,i.objectIds=e,i.outFields=[t.objectIdField],s?.supportsOrderBy&&(i.orderByFields=r),s?.supportsCacheHint&&(i.cacheHint=!0),t.queryFeatures(i)}_getObjectIdsForPage(e,t){const r=this._objectIdCache.toArray();return r.length>=e+t?r.slice(e,e+t):r.slice(e)}_queryAttachments(e){const{attachmentsEnabled:t,layer:r}=this,{capabilities:s}=r,i=s?.data.supportsAttachment,a=s?.operations?.supportsQueryAttachments;return t&&i&&a&&"queryAttachments"in r?r.queryAttachments(new d({objectIds:e,where:this._getWhere()})):Promise.resolve(null)}_syncLocalCache(e){e.forEach((e=>{if(e.feature){const t=e.feature.getObjectId();if(null!=t){const r=this.getObjectIdIndex(t);-1===r?this.itemCache.add(e):this.itemCache.splice(r,1,e)}}}))}_queueQueryOperation(e){return this._queryOperationQueue.push(e),this.notifyChange("querying"),e().then((t=>this._queryOperationQueue.includes(e)?(this._syncLocalCache(t),t):[])).catch((t=>{m("store:query-error","An error occurred.",{error:t});const r={error:t,retry:()=>{this.failures.remove(r),this._queueQueryOperation(e)},cancel:()=>this.failures.remove(r)};return this.failures.add(r),[]})).then((t=>(a(this._queryOperationQueue,e),this.notifyChange("querying"),t)))}_queueEditOperation(e){return this._editOperationQueue.push(e),this.notifyChange("syncing"),e().then((t=>(a(this._editOperationQueue,e),this.notifyChange("syncing"),t))).catch((t=>{m("store:edit-error","An error occurred.",{error:t});const r={error:t,retry:()=>{this.failures.remove(r),this._queueEditOperation(e)},cancel:()=>this.failures.remove(r)};throw this.failures.add(r),a(this._editOperationQueue,e),this.notifyChange("syncing"),t}))}_getWhere(){return this.where||this.layer?.definitionExpression||"1=1"}_getTimeExtent(){const e=this.layer;return this.timeExtent||e&&"timeExtent"in e&&e.timeExtent||null}};e([c()],_.prototype,"attachmentsEnabled",null),e([c({readOnly:!0})],_.prototype,"count",void 0),e([c({readOnly:!0})],_.prototype,"failures",void 0),e([c()],_.prototype,"filterGeometry",null),e([c({readOnly:!0})],_.prototype,"itemCache",void 0),e([c({value:null})],_.prototype,"layer",null),e([c({value:null})],_.prototype,"objectIds",null),e([c()],_.prototype,"orderByFields",null),e([c({readOnly:!0})],_.prototype,"querying",null),e([c()],_.prototype,"relatedRecordsEnabled",void 0),e([c({value:!1})],_.prototype,"returnGeometry",null),e([c({readOnly:!0})],_.prototype,"state",null),e([c({readOnly:!0})],_.prototype,"syncing",null),e([c()],_.prototype,"timeExtent",null),e([c()],_.prototype,"where",null),_=e([y(p)],_);const g=_;export{g as default};
