/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import t from"../../core/Logger.js";import{property as n}from"../../core/accessorSupport/decorators/property.js";import"../../core/has.js";import"../../core/RandomLCG.js";import{subclass as i}from"../../core/accessorSupport/decorators/subclass.js";import{convertDateFormatToIntlOptions as o}from"../../intl/date.js";import{convertNumberFormatToIntlOptions as a,formatNumber as l}from"../../intl/number.js";import{CodedValue as r}from"../../layers/support/CodedValue.js";import s from"../../layers/support/CodedValueDomain.js";import{isEditableLayer as u}from"../../layers/support/editableLayers.js";import{isNumericField as d,validateFieldValue as p,isStringField as c,isTimeOnlyField as m,isDateOnlyField as h,isTimestampOffsetField as f}from"../../layers/support/fieldUtils.js";import{getEffectiveLayerCapabilities as y}from"../../layers/support/layerUtils.js";import{isAnyDateField as v}from"../../smartMapping/support/utils.js";import g from"../FeatureForm/FieldInput.js";import _ from"./Grid/EditorColumn.js";import{dateFieldsWithStringFieldValue as F,getLabelForDateFieldValue as b,dateTimeIsInRange as C,getUnixFieldValueFromDateComponents as E,getISOFieldValueFromDateComponents as D,normalizeTimeOnlyString as I,prepareISOFieldValueForDateComponents as L,prepareUnixFieldValueForDateComponents as x}from"../support/dateUtils.js";import{legacyIcon as V}from"../support/legacyIcon.js";import{renderingSanitizer as w}from"../support/widgetUtils.js";const O={cancelEdit:"Escape"},R="esri-field-column",j={headerRoot:`${R}__header-root`,headerRootEditable:`${R}__header-root--editable`,headerRootMenuEnabled:`${R}__header-root--menu-enabled`,headerContent:`${R}__header-content`,headerLabel:`${R}__header-label`,input:`${R}__cell-input`,inputContainer:`${R}__cell__input-container`,dateInputContainer:`${R}__cell__date-input-container`},T=o("short-date-short-time"),A=o("short-date"),Z={useGrouping:!0,maximumFractionDigits:20};let q=class extends _{constructor(e){super(e),this._activeFieldInput=null,this.cellValueFormatFunction=({rowData:e,value:t})=>{if(this.formatFunction){const{template:e,field:n}=this;return this.formatFunction({template:e,field:n,value:w.sanitize(t)})}if(null===t)return"&nbsp;";const{field:n}=this,i=this._getDomainForFeature(e?.item?.feature);if(i){const e=this._getComputedDomain(t,i);if("date"===n.type&&"range"===i.type)return this._formatDateValueForDisplay(n,e);if(d(n)&&"range"===i.type){const e=this.template?.format,n=e?a(e):Z;return l(parseFloat(t),n)}return F.has(n.type)?"range"===i.type?w.sanitize(b(n,e)):w.sanitize(e):e}if("date"===n.type||F.has(n.type))return this._formatDateValueForDisplay(n,t);if(d(n)){const e=this.template?.format,n=e?a(e):Z;return l(parseFloat(t),n)}return w.sanitize(t)},this.cellValueValidatorFunction=({oldValue:e,value:n})=>{const{field:i}=this;if(this.required&&(null==n||""===n))return!1;if(d(i)&&p(i,n))return t.getLogger(this).warn("value-exceeds-valid-range","Field value exceeds valid range. Attempted edit was rejected."),!1;if(this._isAnyDateOrTimeField){const e=i.type,t=this._effectiveRange;if(!C({type:e,range:t,value:n}))return!1}return e!==n},this.editingEnabled=!1,this.expressionInfos=null,this.field=null,this.formatFunction=null,this.headerRenderFunction=e=>{const{root:t}=e,{editable:n,editingEnabled:i,headerMenuEnabled:o,menu:a,sortable:l}=this;if(!t.childElementCount){t.classList.add(j.headerRoot);const e=document.createElement("div");e.classList.add(j.headerContent),t.appendChild(e);const n=document.createElement("div");if(n.classList.add(V.locked),e.appendChild(n),l&&this.sortElement)e.appendChild(this.sortElement);else{const t=document.createElement("span");t.classList.add(j.headerLabel),t.textContent=this.label,e.appendChild(t)}a?.container&&e.appendChild(a.container)}i&&!n?t.classList.add(j.headerRootEditable):t.classList.remove(j.headerRootEditable),o&&a?.items?.length?t.classList.add(j.headerRootMenuEnabled):t.classList.remove(j.headerRootMenuEnabled)},this.inputRenderFunction=({root:e,column:n,rowData:i})=>{if(this.activeEditInfo||!this.editable)return;const o=this.getCellValue(n,i),{field:a}=this;if(d(a)&&p(a,o))return void t.getLogger(this).warn("value-exceeds-valid-range","Field value is beyond supported limit. Editing is disabled for this field value.");const l=i?.item.feature;if(!l)return;this._activeFieldInput=this._setUpFieldInput(l,o);const r=document.createElement("div");r.classList.add(j.inputContainer);const s=[],u="coded-value"===this._effectiveDomain?.type;if(this._isAnyDateOrTimeField&&!u){const e=document.createElement("div");e.classList.add(j.dateInputContainer);const t=this._setUpDateComponents(o),n=this._setUpDateActionBar();t.forEach((t=>e.appendChild(t))),r.appendChild(e),r.appendChild(n),s.push(...t)}else{const t=this.createInputElement({root:e,column:n,rowData:i,value:o});r.appendChild(t),s.push(t)}this._set("activeEditInfo",{column:n,inputs:s,root:e,rowData:i,oldValue:o}),this.removeCellContent(e),e.appendChild(r),this._syncRowEditingState(e,!0),this.grid?.generateCellPartNames();const c=s[0];c&&(c.focus(),c instanceof HTMLInputElement&&c.select())},this.layer=null,this.parseInputValueFunction=({inputs:e})=>{const{activeEditInfo:t,field:n,includeTime:i}=this;if(!t||!e.length)return null;const o=e[0];if(this._isAnyDateOrTimeField){const a=t.oldValue??void 0;if("coded-value"===this._effectiveDomain?.type)return null!=o.value?parseFloat(o.value):null;switch(n.type){case"date-only":{const e=o.value;return""!==e?e:null}case"time-only":{const e=I(o.value);return""!==e?e:null}case"timestamp-offset":{const t=i?e[1]:void 0,n=e.at(-1);return D({oldValue:a,dateComponent:o,timeComponent:t,timeZoneComponent:n,defaultTimeZone:this.timeZone})}case"date":{const{max:t,min:n}=this._effectiveRange;return E({oldValue:a,dateComponent:o,timeComponent:e[1],timeZone:this.timeZone??void 0,max:t,min:n})}}return null}const a=o.value,{required:l}=this;return l||""!==a?d(n)?parseFloat(a):c(n)?a.trim():a:null},this.sortable=!0,this.store=null,this.template=null,this.updateRowItemFunction=({rowData:e,column:t,value:n})=>{e&&t.path&&(e.item.feature.attributes[t.path]=n)},this.updateStoreItemFunction=async({rowData:e,column:t,value:n})=>{if(!e||!this.store||!t.path)return;const i=e.item.objectId,o=this.store.getObjectIdIndex(i)??e.index;await this.store.updateItem({index:o,name:t.path,value:n})}}get _effectiveDomain(){const e=this._activeFieldInput?.feature;return e?this._getDomainForFeature(e):null}get _effectiveRange(){return this._activeFieldInput?.range??{max:null,min:null}}get _isAnyDateOrTimeField(){const{field:e}=this;return v(e)||m(e)}get alias(){return this.field?.alias}get defaultValue(){return this.field?.defaultValue}get description(){return this.template?.description??this.field?.description??null}get editable(){const{editingEnabled:e,field:t,layer:n,template:i}=this;if(null==t||null==n)return!1;const o=u(n),a=y(n),l=a?.operations.supportsUpdate;return!!(t.editable&&o&&l&&"oid"!==t.type)&&(e?!(!1===i?.editable):!!i?.editable)}get header(){return this.template?.label||this.alias||this.path||null}get includeTime(){const{field:e,template:t}=this;return"time-only"===e.type||"date-only"!==e.type&&(!t?.input||"includeTime"in t.input&&!1!==t.input.includeTime)}get loadingMessage(){return this.messages?.loading||"..."}get maxLength(){const{field:e,template:t}=this,n=e?.length??-1,i=t?.input&&"maxLength"in t.input?t.input.maxLength:null;return null!=i&&!isNaN(i)&&i>=-1&&(-1===n||i<=n)?i:n}get minLength(){const{template:e,maxLength:t}=this,n=e?.input&&"minLength"in e.input?e.input.minLength:null;return t&&n<=t?n:null}get name(){return this.field?.name}get nullable(){return this.field?.nullable??!1}get path(){return this.field?.name}get required(){return!(!this.editable||this.field?.nullable&&!this._activeFieldInput?.required&&!this.template?.required)}createInputElement({value:e}){const{_effectiveDomain:t,field:n,maxLength:i,minLength:o,required:a}=this;let l;"coded-value"===t?.type?(l=this._createSelectElement(e,t.codedValues.map((({code:e,name:t})=>({value:e,name:t}))),a),l.onchange=()=>{l.onblur=null,s()}):(l=document.createElement("input"),l.type=d(n)?"number":"text",i>-1&&(l.maxLength=i),o>0&&(l.minLength=o)),l.classList.add(j.input),l.value=e,l.required=a;let r=!1;l.onkeydown=e=>{r=e.key===O.cancelEdit},l.onblur=()=>{l.onblur=null,s()};const s=()=>{r?this.cancel():this.submit()};return l}getCellValue({path:e},t){return e&&t?.item?.feature?.attributes?t.item.feature.attributes?.[e]:null}onEditComplete(){const e=this.activeEditInfo?.root;e&&this._syncRowEditingState(e,!1),this._activeFieldInput=null,super.onEditComplete()}_clearActiveEditValues(){this.activeEditInfo?.inputs?.forEach((e=>e.value=""))}_setUpDateActionBar(){const{cancel:e,clear:t,save:n}=this.messagesCommon,i=document.createElement("calcite-action-bar");return i.expandDisabled=!0,i.layout="horizontal",i.appendChild(this.createCalciteAction({text:n,icon:"save",click:()=>this.submit()})),this.required||i.appendChild(this.createCalciteAction({text:t,icon:"trash",click:()=>{this._clearActiveEditValues(),this.submit()}})),i.appendChild(this.createCalciteAction({text:e,icon:"x",click:()=>this.cancel()})),i}_formatDateValueForDisplay(e,t){const{timeZone:n,timeZoneName:i}=this;return null!=t?b(e,t,{...this._getDateFormatOptions(),timeZone:n??void 0,timeZoneName:i??void 0}):null}_setUpDateComponents(e){const{_effectiveRange:{max:t,min:n,rawMax:i,rawMin:o},field:a,required:l}=this,r=this._getDateFieldValuesForComponents(a,e),s=[];if(v(a)){const e=this.createDateComponent(),u=h(a)||f(a)?i:t,d=h(a)||f(a)?o:n,p=this._getDateFieldValuesForComponents(a,u??null),c=this._getDateFieldValuesForComponents(a,d??null);e.value=r.date??"",e.max=p.date??"",e.min=c.date??"",e.required=l,e.addEventListener("calciteInputDatePickerOpen",(()=>this._onDateComponentOpen(e))),s.push(e)}if(this.includeTime){const e=this.createTimeComponent();e.value=r.time??"",e.required=l,e.addEventListener("calciteInputTimePickerOpen",(()=>this._onDateComponentOpen(e))),s.push(e)}if("timestamp-offset"===a.type){const e=this.createTimeZoneComponent();e.value=r.timeZoneOffset??"0",e.addEventListener("calciteInputTimeZoneOpen",(()=>this._onDateComponentOpen(e))),s.push(e)}return s}_onDateComponentOpen(e){this.activeEditInfo?.inputs.forEach((t=>{t!==e&&"open"in t&&(t.open=!1)}))}_syncRowEditingState(e,t=!1){const n=this.grid?.getRowContainingNode(e);n&&(t?n.setAttribute("editing","true"):n.removeAttribute("editing"))}_getDateFieldValuesForComponents(e,t){switch(e.type){case"date":return x(t,this.timeZone??void 0);case"date-only":return{date:t};case"time-only":return{time:t};case"timestamp-offset":return L(t);default:return{}}}_createSelectElement(e,t,n=!1){let i=!1;const o=t.map((t=>{t.value===e&&(i=!0);const n=document.createElement("option");return n.text=t.name,n.value=t.value,n}));if(null!=e&&""!==e&&!i){const t=document.createElement("option");t.text=e,t.value=e,o.unshift(t)}if(!n&&null==e){const e=document.createElement("option");e.value="",o.unshift(e)}const a=document.createElement("select");return o.forEach((e=>a.add(e))),a.value=e,a}_setUpFieldInput(e,t){const{field:n,layer:i,timeZone:o}=this,a=new g({feature:e,field:n,initialFeature:e.clone(),layer:i,timeZone:o});return a.set("value",t),a}_isDomainCompatible(e){const{field:t}=this;if(e&&"coded-value"===e.type){const n=typeof e.codedValues[0].code;if("string"===n&&c(t)||"number"===n&&d(t))return!0}return!(!e||"range"!==e.type||!d(t))}_getDomainForFeature(e){const{layer:t,name:n,template:i}=this;if(!t||!e)return null;if("wfs"===t.type||"geojson"===t.type||"csv"===t.type)return null;if(i?.domain&&this._isDomainCompatible(i.domain))return i.domain;const{typeIdField:o}=t,a=o===n,l=this.field.domain;if(a&&!l)return new s({name:"__internal-type-based-coded-value-domain__",codedValues:t.types?.map((({id:e,name:t})=>new r({code:e,name:t})))});return o&&null!=n&&t.getFieldDomain(n,{feature:e})||l}_getComputedDomain(e,t){if(!t)return null;if("range"===t.type)return e;if("coded-value"===t.type){const n=t.codedValues.filter((t=>t.hasOwnProperty("code")&&t.code===e));return n&&n.length?n[0].name:e}return null}_getDateFormatOptions(){const{template:e}=this,t=e?.format?.dateFormat;return t?o(t):e?.input&&"includeTime"in e.input&&!1===e.input.includeTime?A:T}};e([n()],q.prototype,"_effectiveDomain",null),e([n()],q.prototype,"_activeFieldInput",void 0),e([n()],q.prototype,"_effectiveRange",null),e([n()],q.prototype,"_isAnyDateOrTimeField",null),e([n({readOnly:!0})],q.prototype,"alias",null),e([n()],q.prototype,"cellValueFormatFunction",void 0),e([n()],q.prototype,"cellValueValidatorFunction",void 0),e([n({readOnly:!0})],q.prototype,"defaultValue",null),e([n({readOnly:!0})],q.prototype,"description",null),e([n({readOnly:!0})],q.prototype,"editable",null),e([n()],q.prototype,"editingEnabled",void 0),e([n()],q.prototype,"expressionInfos",void 0),e([n()],q.prototype,"field",void 0),e([n()],q.prototype,"formatFunction",void 0),e([n({readOnly:!0})],q.prototype,"header",null),e([n()],q.prototype,"headerRenderFunction",void 0),e([n()],q.prototype,"includeTime",null),e([n()],q.prototype,"inputRenderFunction",void 0),e([n()],q.prototype,"layer",void 0),e([n({readOnly:!0})],q.prototype,"loadingMessage",null),e([n()],q.prototype,"maxLength",null),e([n()],q.prototype,"minLength",null),e([n({readOnly:!0})],q.prototype,"name",null),e([n({readOnly:!0})],q.prototype,"nullable",null),e([n()],q.prototype,"parseInputValueFunction",void 0),e([n({readOnly:!0})],q.prototype,"path",null),e([n({readOnly:!0})],q.prototype,"required",null),e([n()],q.prototype,"sortable",void 0),e([n()],q.prototype,"store",void 0),e([n()],q.prototype,"template",void 0),e([n()],q.prototype,"updateRowItemFunction",void 0),e([n()],q.prototype,"updateStoreItemFunction",void 0),q=e([i("esri.widgets.FeatureTable.FieldColumn")],q);const U=q;export{U as default};
