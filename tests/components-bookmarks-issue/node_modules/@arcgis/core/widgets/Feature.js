/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import"../intl.js";import{watch as t,on as s,initial as i}from"../core/reactiveUtils.js";import{property as n}from"../core/accessorSupport/decorators/property.js";import{cast as r}from"../core/accessorSupport/decorators/cast.js";import"../core/RandomLCG.js";import"../core/has.js";import{subclass as o}from"../core/accessorSupport/decorators/subclass.js";import l from"./Widget.js";import d from"./Feature/FeatureAttachments.js";import a from"./Feature/FeatureContent.js";import c from"./Feature/FeatureExpression.js";import p from"./Feature/FeatureFields.js";import u from"./Feature/FeatureMedia.js";import m from"./Feature/FeatureRelationship.js";import h from"./Feature/FeatureViewModel.js";import{css as v}from"./Feature/resources.js";import{FeatureContentMixin as y}from"./Feature/support/FeatureContentMixin.js";import{loadCalciteComponents as g}from"./support/componentsUtils.js";import{globalCss as w}from"./support/globalCss.js";import{Heading as _}from"./support/Heading.js";import"./support/widgetUtils.js";import{messageBundle as f}from"./support/decorators/messageBundle.js";import{tsx as M}from"./support/jsxFactory.js";import{substitute as E}from"../intl/substitute.js";var b;const j={title:!0,content:!0,lastEditedInfo:!0},C="relationship-handles";let F=b=class extends(y(l)){constructor(e,t){super(e,t),this._contentWidgets=[],this.flowItems=null,this.headingLevel=2,this.messages=null,this.messagesCommon=null,this.visibleElements={...j},this.viewModel=new h}initialize(){this.addHandles(t((()=>this.viewModel?.contentViewModels),(()=>this._setupContentWidgets()),i))}loadDependencies(){return g({notice:()=>import("@esri/calcite-components/dist/components/calcite-notice.js"),loader:()=>import("@esri/calcite-components/dist/components/calcite-loader.js")})}destroy(){this._destroyContentWidgets()}get graphic(){return this.viewModel.graphic}set graphic(e){this.viewModel.graphic=e}get defaultPopupTemplateEnabled(){return this.viewModel.defaultPopupTemplateEnabled}set defaultPopupTemplateEnabled(e){this.viewModel.defaultPopupTemplateEnabled=e}get isTable(){return this.viewModel.isTable}get icon(){return"polygon"}set icon(e){this._overrideIfSome("icon",e)}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}get spatialReference(){return this.viewModel.spatialReference}set spatialReference(e){this.viewModel.spatialReference=e}get timeZone(){return this.viewModel.timeZone}set timeZone(e){this.viewModel.timeZone=e}get title(){return this.viewModel.title}castVisibleElements(e){return{...j,...e}}get map(){return this.viewModel.map}set map(e){this.viewModel.map=e}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}setActiveMedia(e,t){return this.viewModel.setActiveMedia(e,t)}nextMedia(e){return this.viewModel.nextMedia(e)}previousMedia(e){return this.viewModel.previousMedia(e)}render(){const{state:e}=this.viewModel,t=M("div",{class:v.container,key:"container"},this._renderTitle(),"error"===e?this._renderError():"loading"===e?this._renderLoading():this._renderContentContainer());return M("div",{class:this.classes(v.base,w.widget)},t)}_renderError(){const{messagesCommon:e,messages:t,visibleElements:s}=this;return M("calcite-notice",{icon:"exclamation-mark-circle",kind:"danger",open:!0,scale:"s"},s.title?M("div",{key:"error-title",slot:"title"},e.errorMessage):null,M("div",{key:"error-message",slot:"message"},t.loadingError))}_renderLoading(){return M("div",{class:v.loadingSpinnerContainer,key:"loading-container"},M("calcite-loader",{inline:!0,label:""}))}_renderContentContainer(){const{visibleElements:e}=this;return e.content?M("div",{class:v.main},[this._renderContent(),this._renderLastEditInfo()]):null}_renderTitle(){const{visibleElements:e,title:t}=this;return e.title?M(_,{class:v.title,innerHTML:t,level:this.headingLevel}):null}_renderContent(){const e=this.viewModel.content,t="content";if(!e)return null;if(Array.isArray(e))return e.length?M("div",{class:v.contentNode,key:`${t}-content-elements`},e.map(this._renderContentElement,this)):null;if("string"==typeof e){const e=this._contentWidgets[0];return!e||e.destroyed?null:M("div",{class:this.classes(v.contentNode,v.contentNodeText),key:`${t}-content`},e.render())}return this.renderNodeContent(e)}_renderContentElement(e,t){const{visibleElements:s}=this;if("boolean"!=typeof s.content&&!s.content?.[e.type])return null;switch(e.type){case"attachments":return this._renderAttachments(t);case"custom":return this._renderCustom(e,t);case"fields":return this._renderFields(t);case"media":return this._renderMedia(t);case"text":return this._renderText(e,t);case"expression":return this._renderExpression(t);case"relationship":return this._renderRelationship(t);default:return null}}_renderAttachments(e){const t=this._contentWidgets[e];if(!t||t.destroyed)return null;const{state:s,attachmentInfos:i}=t.viewModel;return"loading"===s||i.length>0?M("div",{class:this.classes(v.contentElement),key:this._buildKey("attachments-element",e)},t.render()):null}_renderRelationship(e){const t=this._contentWidgets[e];return t&&!t.destroyed&&this.flowItems?M("div",{class:v.contentElement,key:this._buildKey("relationship-element",e)},t.render()):null}_renderExpression(e){const t=this._contentWidgets[e];return!t||t.destroyed?null:M("div",{class:v.contentElement,key:this._buildKey("expression-element",e)},t.render())}_renderCustom(e,t){const{creator:s}=e,i=this._contentWidgets[t];return!i||i.destroyed?null:s?M("div",{class:v.contentElement,key:this._buildKey("custom-element",t)},i.render()):null}_renderFields(e){const t=this._contentWidgets[e];return!t||t.destroyed?null:M("div",{class:v.contentElement,key:this._buildKey("fields-element",e)},t.render())}_renderMedia(e){const t=this._contentWidgets[e];return!t||t.destroyed?null:M("div",{class:v.contentElement,key:this._buildKey("media-element",e)},t.render())}_renderLastEditInfo(){const{visibleElements:e,messages:t}=this,{lastEditInfo:s}=this.viewModel;if(!s||!e.lastEditedInfo)return null;const{date:i,user:n}=s,r="edit"===s.type?n?t.lastEditedByUser:t.lastEdited:n?t.lastCreatedByUser:t.lastCreated,o=E(r,{date:i,user:n});return M("div",{class:this.classes(v.lastEditedInfo,v.contentElement),key:"edit-info-element"},o)}_renderText(e,t){const s=e.text,i=this._contentWidgets[t];return!i||i.destroyed?null:s?M("div",{class:this.classes(v.contentElement,v.text),key:this._buildKey("text-element",t)},i.render()):null}_buildKey(e,...t){return`${e}__${this.viewModel?.graphic?.uid||"0"}-${t.join("-")}`}_destroyContentWidget(e){e&&(e.viewModel=null,!e.destroyed&&e.destroy())}_destroyContentWidgets(){this.removeHandles(C),this._contentWidgets.forEach((e=>this._destroyContentWidget(e))),this._contentWidgets=[]}_addFeatureRelationshipHandles(e){const{flowItems:t,visibleElements:i}=this;this.addHandles([s((()=>e),"select-record",(({featureViewModel:e})=>{t&&(e.abilities={relationshipContent:!0},t.push(new b({flowItems:t,viewModel:e,visibleElements:i})))})),s((()=>e),"show-all-records",(()=>{if(!t)return;const{viewModel:s}=e;s.showAllEnabled=!0;const i=new m({visibleElements:{title:!1,description:!1},viewModel:s});this._addFeatureRelationshipHandles(i),t.push(i)}))],C)}_setupContentWidgets(){this._destroyContentWidgets();const{headingLevel:e,visibleElements:t}=this,s=this.viewModel?.content,{contentViewModels:i}=this.viewModel;if(Array.isArray(s))s.forEach(((s,n)=>{if("attachments"===s.type&&(this._contentWidgets[n]=new d({displayType:s.displayType,headingLevel:t.title?e+1:e,viewModel:i[n]})),"fields"===s.type&&(this._contentWidgets[n]=new p({viewModel:i[n]})),"media"===s.type&&(this._contentWidgets[n]=new u({viewModel:i[n]})),"text"===s.type&&(this._contentWidgets[n]=new a({viewModel:i[n]})),"custom"===s.type&&(this._contentWidgets[n]=new a({viewModel:i[n]})),"expression"===s.type&&(this._contentWidgets[n]=new c({viewModel:i[n]})),"relationship"===s.type){const e=new m({viewModel:i[n]});this._addFeatureRelationshipHandles(e),this._contentWidgets[n]=e}}),this);else{const e=i[0];e&&!e.destroyed&&(this._contentWidgets[0]=new a({viewModel:e}))}this.scheduleRender()}};e([n()],F.prototype,"graphic",null),e([n()],F.prototype,"defaultPopupTemplateEnabled",null),e([n()],F.prototype,"flowItems",void 0),e([n()],F.prototype,"headingLevel",void 0),e([n({readOnly:!0})],F.prototype,"isTable",null),e([n()],F.prototype,"icon",null),e([n()],F.prototype,"label",null),e([n(),f("esri/widgets/Feature/t9n/Feature")],F.prototype,"messages",void 0),e([n(),f("esri/t9n/common")],F.prototype,"messagesCommon",void 0),e([n()],F.prototype,"spatialReference",null),e([n()],F.prototype,"timeZone",null),e([n({readOnly:!0})],F.prototype,"title",null),e([n()],F.prototype,"visibleElements",void 0),e([r("visibleElements")],F.prototype,"castVisibleElements",null),e([n()],F.prototype,"map",null),e([n()],F.prototype,"view",null),e([n({type:h})],F.prototype,"viewModel",void 0),F=b=e([o("esri.widgets.Feature")],F);const W=F;export{W as default};
