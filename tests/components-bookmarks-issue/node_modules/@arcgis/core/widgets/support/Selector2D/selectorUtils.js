/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{whenOrAbort as e,ignoreAbortErrors as r}from"../../../core/promiseUtils.js";import{getDisplayFieldName as t}from"../../../layers/support/fieldUtils.js";import{isFeatureLayer as s,isKnowledgeGraphLayer as n,isLinkChartLayer as i,isMapNotesLayer as a,isGraphicsLayer as l}from"../../../layers/support/layerUtils.js";import{calculateTolerance as o}from"../../../renderers/support/clickToleranceUtils.js";import{createQueryGeometry as c}from"../../../views/support/drapedUtils.js";import{isSelectableLayerView2D as u}from"../../../views/support/layerViewUtils.js";async function y(){return import("../../../geometry/geometryEngineJSON.js")}async function d(){return y().then((({contains:e,intersects:r,overlaps:t,simplify:s})=>({contains:e,intersects:r,overlaps:t,simplify:s})))}async function p(r){const{currentSelection:t,selector:s,signal:n,sources:i,view:a}=r;if(!i?.length)return{added:[],removed:[]};const{layers:l,layerViews:o,graphicsLayers:c}=w(i),u=(await e(Promise.all([m(s,l,a,n),g(s,o,a,n),f(s,c,a)]),n)).flat();if(!t)return{added:u,removed:[]};const y=t.toArray(),d=u.filter((e=>!v(y,e))),p=y.filter((e=>!v(u,e)));return t.removeMany(p),t.addMany(d),{added:d,removed:p}}const f=async(e,r,t)=>b({candidates:r.flatMap((e=>e.graphics.toArray()))??[],selector:e,view:t}),m=async(e,t,s,n)=>{const i=await r(F({selector:e,signal:n,layers:t,view:s}));return i?h(i):[]},g=async(e,t,s,n)=>{const i=await r(j({selector:e,signal:n,layerViews:t,view:s}));return i?h(i):[]};function h(e){const r=[];for(let t=0;t<e.length;t++){const s=e[t];"fulfilled"===s.status&&r.push(...s.value)}return r}function w(e){const r=[],t=[],o=[];return e.forEach((e=>{s(e)?r.push(e):(n(e)||i(e))&&e.layers?.length?r.push(...e.layers.toArray()):a(e)&&e.sublayers?.length?o.push(...e.sublayers.toArray()):l(e)?o.push(e):u(e)&&t.push(e)})),{layers:r,layerViews:t,graphicsLayers:o}}function v(e,r){if(e.includes(r))return!0;const t=r.getObjectId(),s=null!=t,{layer:n,uid:i}=r;return s?e.some((e=>{if(n===e.layer)return t===e.getObjectId()})):e.some((e=>{if(n===e.layer)return i===e.uid}))}async function j(r){const{layerViews:t,selector:s,signal:n,view:i}=r;return e(Promise.allSettled(t.map((async e=>{const r=e.createQuery(),{geometry:t}=S(s,e.layer,i);return r.outFields=["*"],r.geometry=t,r.returnGeometry=!0,r.outSpatialReference=i.spatialReference,e.queryFeatures(r,{signal:n}).then((({features:e})=>e))}))),n)}async function F(r){const{layers:t,selector:s,signal:n,view:i}=r;return e(Promise.allSettled(t.map((async e=>e.queryFeatures(U(e.createQuery(),s,e,i),{signal:n}).then((({features:e})=>e))))),n)}function S(e,r,s){const n="displayField"in r?r.displayField:null,i=t({displayField:n,fields:r.fields}),a=[r.objectIdField];null!=i&&r.fieldsIndex.has(i)&&a.push(i);const l="renderer"in r?o({renderer:r.renderer}):0;return{geometry:"point"===e.type?c(e,l,s):e,outFields:a}}function U(e,r,t,s){const{outFields:n,geometry:i}=S(r,t,s);return e.outFields=n,e.geometry=i,e.returnGeometry=!0,e.outSpatialReference=s.spatialReference,e}async function b(e){const{selector:r,candidates:t,view:s}=e;if(!t?.length||!r)return[];const{spatialReference:n}=s,i=r,a=await d();return t.filter((e=>a.intersects(n,i,e.geometry)))}export{d as getGeometryEngineOperations,S as getQueryOptionsFromLayer,j as getSelectionFromFeatureLayerViews,F as getSelectionFromFeatureLayers,p as getSelectionFromGeometry,b as getSelectionFromGeometryEngine,y as importGeometryEngine};
