/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import t from"../../core/Evented.js";import s from"../../core/ObjectPool.js";import{when as r}from"../../core/reactiveUtils.js";import{property as o}from"../../core/accessorSupport/decorators/property.js";import"../../core/has.js";import"../../core/Logger.js";import"../../core/RandomLCG.js";import{subclass as l}from"../../core/accessorSupport/decorators/subclass.js";import{getEffectiveLayerCapabilities as a}from"../../layers/support/layerUtils.js";import i from"./TemplateItem.js";import n from"./TemplateItemGroup.js";import{getAllTemplatesForLayer as u}from"../support/templateUtils.js";var p;const m=({layer:e})=>({key:e,label:e.title??""}),y=({layer:e})=>({key:e.geometryType,label:e.geometryType??""});let c=p=class extends t.EventedAccessor{constructor(e){super(e),this._groupPool=new s(n),this._itemPool=new s(i),this.disabled=!1,this.disabledItemFunction=null,this.filterFunction=null,this.selectedItem=null}initialize(){this._get("groupBy")||(this.groupBy="layer")}get _featureTemplatesByLayer(){if(!this.layers)return new Map;const e=new Map;for(const t of this.layers)if("subtype-group"===t.type)for(const s of t.sublayers)e.set(s,u(s));else e.set(t,u(t));return e}set groupBy(e){if(this._set("groupBy",e),"function"!=typeof e)switch(e){case"layer":this._groupByFunction=m;break;case"geometry":this._groupByFunction=y;break;default:this._groupByFunction=null}else this._groupByFunction=t=>this._ensureGroupByObject(e(t))}set layers(e){const t="layers";if(this.removeHandles(t),e){const s=()=>this.notifyChange("state");this.addHandles(e.map((e=>r((()=>e.loadStatus),s))),t)}this._set("layers",e)}get layers(){return this._get("layers")}get state(){const{layers:e}=this;return e&&0!==e.length?e.some((e=>"loading"===e.loadStatus||"not-loaded"===e.loadStatus))?"loading":"ready":"disabled"}get numberOfFeatureTemplates(){return Array.from(this._featureTemplatesByLayer.values()).reduce(((e,t)=>e+t.length),0)}get items(){if(0===this.numberOfFeatureTemplates)return this._releasePreviousItems(),[];const e=this._featureTemplatesByLayer,t=[],s=null!=this.filterFunction?this.filterFunction:p._nullFilterFunction;for(const[l,i]of e)if(l.loaded||"subtype-sublayer"===l.type&&l.parent?.loaded){const e=a(l)?.operations;if(e?.supportsEditing&&e?.supportsAdd)for(const r of i)t.push({layer:l,template:r,matchesFilter:s({label:r.name})})}if(null==this._groupByFunction){const e=t.filter((({matchesFilter:e})=>e)).map((({template:e,layer:t})=>this._createItem(e,t)));return this._releasePreviousItems(),e}const r=new Map;for(const l of t){const{template:e,layer:t}=l,s=this._groupByFunction({template:e,layer:t}),{key:o,label:a}=null!=s.key?s:p.nullGroupBy;r.has(o)||r.set(o,{label:a,templateItemInfos:[]}),r.get(o)?.templateItemInfos.push(l)}const o=[];for(const l of r.values()){const{label:e,templateItemInfos:t}=l,r=t.filter((({matchesFilter:e})=>e)),a=s({label:e})?t:t.length>0?r:[];if(a.length>0){const t=a.map((({template:e,layer:t})=>this._createItem(e,t)));o.push(this._createGroup(e,t))}}return 1===o.length&&o[0].label===p.nullGroupBy.label?(this._releasePreviousItems(),o[0].items):(this._releasePreviousItems(),o)}refresh(){this.notifyChange("items")}select(e,{emit:t=!0}={}){const s=this.selectedItem,r=e?.clone()||null;this._set("selectedItem",r),t&&this.emit("select",{item:r,oldItem:s,template:r?.template??null})}_createItem(e,t){const s=this._itemPool.acquire(),r=this.disabledItemFunction?.({template:e,layer:t})??!1;return s.set({disabled:r,layer:t,template:e}),s}_createGroup(e,t){const s=this._groupPool.acquire();return s.set("label",e),s.items=t,s}_releasePreviousItems(){this._destroyItems(this._get("items"))}_destroyItems(e){if(!e)return;e[0]instanceof i?e.forEach((e=>this._destroyItem(e))):e.forEach((e=>this._destroyGroup(e)))}_destroyGroup(e){e.items.forEach((e=>this._destroyItem(e))),e.items.length=0,this._groupPool.release(e)}_destroyItem(e){e.layer=null,e.template=null,this._itemPool.release(e)}_ensureGroupByObject(e){return"string"==typeof e?{key:e,label:e}:e}};c.nullGroupBy={key:Symbol(),label:"Otherâ€‹"},c._nullFilterFunction=e=>!0,e([o()],c.prototype,"_featureTemplatesByLayer",null),e([o()],c.prototype,"_groupByFunction",void 0),e([o()],c.prototype,"disabled",void 0),e([o()],c.prototype,"disabledItemFunction",void 0),e([o()],c.prototype,"filterFunction",void 0),e([o()],c.prototype,"groupBy",null),e([o()],c.prototype,"layers",null),e([o()],c.prototype,"state",null),e([o({readOnly:!0})],c.prototype,"numberOfFeatureTemplates",null),e([o({readOnly:!0})],c.prototype,"items",null),e([o({readOnly:!0})],c.prototype,"selectedItem",void 0),c=p=e([l("esri.widgets.FeatureTemplates.FeatureTemplatesViewModel")],c);const h=c;export{h as default};
