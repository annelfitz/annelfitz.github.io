/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{_ as e}from"../../../chunks/tslib.es6.js";import"../../../geometry.js";import t from"../../../core/Accessor.js";import r from"../../../core/Error.js";import{property as n}from"../../../core/accessorSupport/decorators/property.js";import"../../../core/has.js";import"../../../core/Logger.js";import"../../../core/RandomLCG.js";import{subclass as o}from"../../../core/accessorSupport/decorators/subclass.js";import{fromUsng as i,fromUtm as a,fromMgrs as s,fromLatitudeLongitude as l,toUtm as c,toUsng as p,toMgrs as u,toLatitudeLongitude as m}from"../../../geometry/coordinateFormatter.js";import{isLoaded as d,project as h}from"../../../geometry/projection.js";import{equals as f}from"../../../geometry/support/spatialReferenceUtils.js";import{project as v}from"../../../geometry/support/webMercatorUtils.js";import{isValidPoint as g,fromXY as y,pointToCoordinate as w,getDegreePrecision as b}from"./coordinateConversionUtils.js";import S from"../../../geometry/SpatialReference.js";let P=class extends t{constructor(e){super(e),this.conversionInfo=null,this.coordinateSegments=null,this._currentPattern=void 0,this.defaultPattern=null,this.name=null,this.viewModel=null}get currentPattern(){return(this._currentPattern||this.defaultPattern)??""}set currentPattern(e){this._currentPattern=e}get label(){return this.name??""}set label(e){this._overrideIfSome("label",e)}get hasDisplayProperties(){return!(!this.defaultPattern||!this.coordinateSegments)}get spatialReference(){return"basemap"===this.name?this._viewSpatialReference:this.conversionInfo?.spatialReference??S.WGS84}set spatialReference(e){this._overrideIfSome("spatialReference",e)}get _viewSpatialReference(){return this.viewModel?.view?.spatialReference??S.WGS84}get _additionalCharactersPattern(){const e=this.coordinateSegments;if(!e)return null;const t=e.map((e=>e.alias)),r=this.currentPattern.replaceAll(new RegExp(`["nsew${t.join()}]`,"gi"),"").replaceAll(" ","");return new RegExp(`[${r}]`,"g")}get test(){return{additionalCharactersPattern:this._additionalCharactersPattern}}async convert(e){if(!g(e))throw new r("format:invalid-point","Could not convert invalid point.",{point:e});const t=this.conversionInfo?.convert;if(t)return Promise.resolve().then((()=>t(e)));const n=await this._project(e,this.spatialReference);return{location:n,coordinate:await this._getCoordinate(n)}}getConversionStrategy(){const e=this._viewSpatialReference;return this.conversionInfo?.convert||this.viewModel?.formatterAvailable||"xy"===this.name&&(e.isWebMercator||e.isWGS84)||"basemap"===this.name?"client":"server"}getDisplayCoordinate(e){if(!e)return null;if(!this.coordinateSegments||!this.currentPattern)return e;let t=this.currentPattern;const r=this._getSegmentMatches(e,!1);for(let n=this.coordinateSegments.length-1;n>=0;n--){const e=this.coordinateSegments[n];t=t.replace(e.alias,r[n])}return t}parseUserInput(e){const{defaultPattern:t,_additionalCharactersPattern:r,coordinateSegments:n}=this;if(!t||!r)return"";let o=t.replace(r,"");e=e.replace(r,"");const i=this._getSegmentMatches(e,!0);if(n)for(let a=n.length-1;a>=0;a--){const e=n[a];o=o.replace(e.alias,i[a])}return o}_getSegmentMatches(e,t){const r=new Array,{coordinateSegments:n}=this;if(!n)return r;for(let o=0;o<n.length;o++){const i=n[o],a=e.match(i.searchPattern);if(!a){r.push("");continue}let s=a[0];if(e=e.replace(s,"").trim(),i.substitution){const e=t?i.substitution.input(s):i.substitution.output(s);e&&(s=`${e}`)}r.push(s)}return r}async reverseConvert(e){const t=this.parseUserInput(e),n=this.conversionInfo?.reverseConvert;let o;if(n)o=n(t);else if("xy"===this.name||"basemap"===this.name)o=y(t,this.spatialReference);else if(this.viewModel?.formatterAvailable)switch(this.name){case"dd":case"ddm":case"dms":o=l(t,this.spatialReference);break;case"mgrs":{const e="automatic";o=s(t,this.spatialReference,e);break}case"utm":{const e="latitude-band-indicators";o=a(t,this.spatialReference,e);break}case"usng":o=i(t,this.spatialReference);break;default:o=null}if(!o)throw new r("format:invalid-input","Could not parse input into point.",{userInput:e});return this._project(o,this._viewSpatialReference)}async _getCoordinate(e){const t=this.viewModel?.view?.scale??0;if(!g(e))throw new r("format:invalid-point","Could not transform invalid point into coordinate.",{point:e});if(this.viewModel?.formatterAvailable||"basemap"===this.name||"xy"===this.name)switch(this.name){case"dd":case"ddm":case"dms":{const r=b(t);return m(e,this.name,r)}case"mgrs":return u(e,"automatic",5,!1);case"usng":return p(e,5,!1);case"utm":return c(e,"latitude-band-indicators",!0);default:return w(e,t)}return w(e,t)}async _project(e,t){if(f(e.spatialReference,t)||!t)return e;if(this.viewModel?.formatterAvailable&&d())return h(e,t);if(!this.viewModel?.formatterAvailable){const r=v(e,t);if(null!=r)return r}return null}};e([n()],P.prototype,"conversionInfo",void 0),e([n()],P.prototype,"coordinateSegments",void 0),e([n()],P.prototype,"currentPattern",null),e([n()],P.prototype,"_currentPattern",void 0),e([n()],P.prototype,"label",null),e([n()],P.prototype,"defaultPattern",void 0),e([n({readOnly:!0})],P.prototype,"hasDisplayProperties",null),e([n()],P.prototype,"name",void 0),e([n({type:S})],P.prototype,"spatialReference",null),e([n()],P.prototype,"viewModel",void 0),e([n({readOnly:!0})],P.prototype,"_viewSpatialReference",null),e([n({readOnly:!0})],P.prototype,"_additionalCharactersPattern",null),P=e([o("esri.widgets.CoordinateConversion.support.Format")],P);const _=P;export{_ as default};
