/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{ArcadeDate as n,createDateTimeZone as e}from"../ArcadeDate.js";import{ArcadeExecutionError as r,ExecutionErrorCodes as t}from"../executionError.js";import{H as o,N as u,g as a,c as s,n as i,k as l,m as c,j as f,l as m,K as d,Q as h,R as y}from"../../chunks/languageUtils.js";import{DateOnly as N}from"../../core/sql/DateOnly.js";import{TimeOnly as w}from"../../core/sql/TimeOnly.js";import{getLocale as g}from"../../intl/locale.js";import{DateTime as A}from"luxon";function k(n,e,r){return n+(T(r)?P:D)[e]}function T(n){return n%4==0&&(n%100!=0||n%400==0)}const D=[0,31,59,90,120,151,181,212,243,273,304,334],P=[0,31,60,91,121,152,182,213,244,274,305,335];function S(n){return null===n?n:!1===n.isValid?null:n}function Z(n,e){return""===n||"default"===n.toLowerCase().trim()?u(e):"z"===n||"Z"===n?"UTC":n}function p(n,e){return c(n)?n.toArcadeDate():m(n,u(e))}function C(T,D){T.today=function(e,r){return D(e,r,((t,a,s)=>{o(s,0,0,e,r);const i=new Date;return i.setHours(0,0,0,0),n.dateJSAndZoneToArcadeDate(i,u(e))}))},T.time=function(e,f){return D(e,f,((m,d,h)=>{switch(o(h,0,4,e,f),h.length){case 0:{const r=n.nowToArcadeDate(u(e));return new w(r.hour,r.minute,r.second,r.millisecond)}case 1:{if(i(h[0]))return h[0].clone();if(l(h[0]))return new w(h[0].hour,h[0].minute,h[0].second,h[0].millisecond);if(c(h[0]))return new w(0,0,0,0);if(s(h[0]))return w.fromString(h[0]);const n=a(h[0]);return!1===isNaN(n)?w.fromMilliseconds(n):null}case 2:return s(h[0])&&s(h[1])?w.fromString(h[0],h[1]):w.fromParts(a(h[0]),a(h[1]),0,0);case 3:return w.fromParts(a(h[0]),a(h[1]),a(h[2]),0);case 4:return w.fromParts(a(h[0]),a(h[1]),a(h[2]),a(h[3]))}throw new r(e,t.InvalidParameter,f)}))},T.dateonly=function(e,r){return D(e,r,((t,i,m)=>{if(o(m,0,3,e,r),3===m.length)return N.fromParts(a(m[0]),a(m[1])+1,a(m[2]));if(2===m.length){const n=f(m[1]);return""===n?null:"X"===n?N.fromSeconds(a(m[0])):"x"===n?N.fromMilliseconds(a(m[0])):N.fromString(f(m[0]),n)}if(1===m.length){if(s(m[0])){if(""===m[0].replaceAll(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,""))return null;if(!0===/^[0-9][0-9][0-9][0-9]$/.test(m[0]))return N.fromString(m[0]+"-01-01")}if(c(m[0]))return m[0].clone();if(l(m[0]))return N.fromParts(m[0].year,m[0].monthJS+1,m[0].day);const n=a(m[0]);return!1===isNaN(n)?N.fromMilliseconds(n):s(m[0])?N.fromString(m[0]):null}if(0===m.length){const r=n.nowToArcadeDate(u(e));return!1===r.isValid?null:N.fromParts(r.year,r.monthJS+1,r.day)}return null}))},T.changetimezone=function(a,s){return D(a,s,((i,l,d)=>{if(o(d,2,2,a,s),null===d[0])return null;if(c(d[0]))throw new r(a,t.CannotChangeTimeZoneDateOnly,s);if(c(d[0]))throw new r(a,t.CannotChangeTimeZoneTime,s);const h=m(d[0],u(a));if(null===h)throw new r(a,t.InvalidParameter,s);const y=e(Z(f(d[1]),a),!1);if(null===y)return null;const N=n.arcadeDateAndZoneToArcadeDate(h,y);return!1===N.isValid?null:N}))},T.timezone=function(e,r){return D(e,r,((t,a,s)=>{if(o(s,1,2,e,r),i(s[0]))return"Unknown";if(c(s[0]))return"Unknown";const l=m(s[0],u(e));if(null===l)return null;const f=l.timeZone;return"system"===f?n.systemTimeZoneCanonicalName:"utc"===f.toLowerCase()?"UTC":"unknown"===f.toLowerCase()?"Unknown":f}))},T.timezoneoffset=function(n,e){return D(n,e,((r,t,a)=>{o(a,1,1,n,e);const s=m(a[0],u(n));return null===s?null:60*s.timeZoneOffset*1e3}))},T.now=function(e,r){return D(e,r,((t,a,s)=>{o(s,0,0,e,r);const i=n.nowToArcadeDate(u(e));return!1===i.isValid?null:i}))},T.timestamp=function(e,r){return D(e,r,((t,u,a)=>{o(a,0,0,e,r);const s=n.nowUTCToArcadeDate();return!1===s.isValid?null:s}))},T.toutc=function(n,e){return D(n,e,((r,t,a)=>{o(a,1,1,n,e);const s=m(a[0],u(n));return null===s?null:s.toUTC()}))},T.tolocal=function(n,e){return D(n,e,((r,t,a)=>{o(a,1,1,n,e);const s=m(a[0],u(n));return null===s?null:s.toLocal()}))},T.day=function(n,e){return D(n,e,((r,t,a)=>{o(a,1,1,n,e);const s=p(a[0],u(n));return null===s?NaN:s.day}))},T.month=function(n,e){return D(n,e,((r,t,a)=>{o(a,1,1,n,e);const s=p(a[0],u(n));return null===s?NaN:s.monthJS}))},T.year=function(n,e){return D(n,e,((r,t,a)=>{o(a,1,1,n,e);const s=p(a[0],u(n));return null===s?NaN:s.year}))},T.hour=function(n,e){return D(n,e,((r,t,a)=>{if(o(a,1,1,n,e),i(a[0]))return a[0].hour;const s=m(a[0],u(n));return null===s?NaN:s.hour}))},T.second=function(n,e){return D(n,e,((r,t,a)=>{if(o(a,1,1,n,e),i(a[0]))return a[0].second;const s=m(a[0],u(n));return null===s?NaN:s.second}))},T.millisecond=function(n,e){return D(n,e,((r,t,a)=>{if(o(a,1,1,n,e),i(a[0]))return a[0].millisecond;const s=m(a[0],u(n));return null===s?NaN:s.millisecond}))},T.minute=function(n,e){return D(n,e,((r,t,a)=>{if(o(a,1,1,n,e),i(a[0]))return a[0].minute;const s=m(a[0],u(n));return null===s?NaN:s.minute}))},T.week=function(n,e){return D(n,e,((s,i,l)=>{o(l,1,2,n,e);const c=p(l[0],u(n));if(null===c)return NaN;const f=a(d(l[1],0));if(f<0||f>6)throw new r(n,t.InvalidParameter,e);const m=c.day,h=c.monthJS,y=c.year,N=c.dayOfWeekJS,w=k(m,h,y)-1,g=Math.floor(w/7);return N-f+(N-f<0?7:0)<w-7*g?g+1:g}))},T.weekday=function(n,e){return D(n,e,((r,t,a)=>{o(a,1,1,n,e);const s=p(a[0],u(n));return null===s?NaN:s.dayOfWeekJS}))},T.isoweekday=function(n,e){return D(n,e,((r,t,a)=>{o(a,1,1,n,e);const s=p(a[0],u(n));return null===s?NaN:s.dayOfWeekISO}))},T.isomonth=function(n,e){return D(n,e,((r,t,a)=>{o(a,1,1,n,e);const s=p(a[0],u(n));return null===s?NaN:s.monthISO}))},T.isoweek=function(n,e){return D(n,e,((r,t,a)=>{o(a,1,1,n,e);const s=p(a[0],u(n));return null===s?NaN:s.weekISO}))},T.isoyear=function(n,e){return D(n,e,((r,t,a)=>{o(a,1,1,n,e);const s=p(a[0],u(n));return null===s?NaN:s.yearISO}))},T.date=function(r,t){return D(r,t,((l,d,y)=>{if(o(y,0,8,r,t),3===y.length){if(c(y[0])&&i(y[1])&&s(y[2])){const t=e(Z(f(y[2])??"unknown",r),!1);return null===t?null:S(n.fromParts(y[0].year,y[0].month,y[0].day,y[1].hour,y[1].minute,y[1].second,y[1].millisecond,t))}return S(n.fromParts(a(y[0]),a(y[1])+1,a(y[2]),0,0,0,0,u(r)))}if(4===y.length)return S(n.fromParts(a(y[0]),a(y[1])+1,a(y[2]),a(y[3]),0,0,0,u(r)));if(5===y.length)return S(n.fromParts(a(y[0]),a(y[1])+1,a(y[2]),a(y[3]),a(y[4]),0,0,u(r)));if(6===y.length)return S(n.fromParts(a(y[0]),a(y[1])+1,a(y[2]),a(y[3]),a(y[4]),a(y[5]),0,u(r)));if(7===y.length)return S(n.fromParts(a(y[0]),a(y[1])+1,a(y[2]),a(y[3]),a(y[4]),a(y[5]),a(y[6]),u(r)));if(8===y.length){const t=e(Z(f(y[7])??"unknown",r),!1);return null===t?null:S(n.fromParts(a(y[0]),a(y[1])+1,a(y[2]),a(y[3]),a(y[4]),a(y[5]),a(y[6]),t))}if(2===y.length){if(c(y[0])&&s(y[1])){const t=e(Z(f(y[1])??"unknown",r),!1);return null===t?null:S(n.fromParts(y[0].year,y[0].month,y[0].day,0,0,0,0,t))}if(c(y[0])&&i(y[1]))return S(n.fromParts(y[0].year,y[0].month,y[0].day,y[1].hour,y[1].minute,y[1].second,y[1].millisecond,"unknown"));let t,o=f(y[1]);return""===o?null:(o=h(o,!0),t="X"===o?A.fromSeconds(a(y[0])):"x"===o?A.fromMillis(a(y[0])):A.fromFormat(f(y[0]),o,{locale:g(),numberingSystem:"latn"}),t.isValid?n.dateTimeToArcadeDate(t):null)}if(1===y.length){if(c(y[0]))return S(n.fromParts(y[0].year,y[0].month,y[0].day,0,0,0,0,"unknown"));if(s(y[0])){if(""===y[0].replaceAll(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,""))return null;if(!0===/^[0-9][0-9][0-9][0-9]$/.test(y[0]))return m(y[0]+"-01-01",u(r))}const e=a(y[0]);if(!1===isNaN(e)){const t=A.fromMillis(e);return t.isValid?n.dateTimeAndZoneToArcadeDate(t,u(r)):null}return m(y[0],u(r))}return 0===y.length?n.nowToArcadeDate(u(r)):null}))},T.datediff=function(e,r){return D(e,r,((t,a,s)=>{if(o(s,2,4,e,r),i(s[0]))return i(s[1])?s[0].difference(s[1],f(s[2])):NaN;if(i(s[1]))return NaN;if(c(s[0]))return c(s[1])?s[0].difference(s[1],f(s[2])):NaN;if(c(s[1]))return NaN;let l=m(s[0],u(e)),h=m(s[1],u(e));if(null===l||null===h)return NaN;let y=d(s[3],"");switch(""!==y&&null!==y?(y=Z(f(y),e),l=n.arcadeDateAndZoneToArcadeDate(l,y),h=n.arcadeDateAndZoneToArcadeDate(h,y)):l.timeZone!==h.timeZone&&(l.isUnknownTimeZone?l=n.arcadeDateAndZoneToArcadeDate(l,h.timeZone):h=(h.isUnknownTimeZone,n.arcadeDateAndZoneToArcadeDate(h,l.timeZone))),f(s[2]).toLowerCase()){case"days":case"day":case"d":return l.diff(h,"days");case"months":case"month":return l.diff(h,"months");case"minutes":case"minute":case"m":return"M"===s[2]?l.diff(h,"months"):l.diff(h,"minutes");case"seconds":case"second":case"s":return l.diff(h,"seconds");case"milliseconds":case"millisecond":case"ms":default:return l.diff(h);case"hours":case"hour":case"h":return l.diff(h,"hours");case"years":case"year":case"y":return l.diff(h,"years")}}))},T.dateadd=function(n,e){return D(n,e,((r,t,s)=>{o(s,2,3,n,e);let l=a(s[1]);if(isNaN(l)||l===1/0||l===-1/0)return i(s[0])||c(s[0])?s[0].clone():m(s[0],u(n));let d="milliseconds";switch(f(s[2]).toLowerCase()){case"days":case"day":case"d":d="days",l=c(s[0])?l:y(l);break;case"months":case"month":d="months",l=c(s[0])?l:y(l);break;case"minutes":case"minute":case"m":d="M"===s[2]?"months":"minutes";break;case"seconds":case"second":case"s":d="seconds";break;case"milliseconds":case"millisecond":case"ms":d="milliseconds";break;case"hours":case"hour":case"h":d="hours";break;case"years":case"year":case"y":d="years"}if(i(s[0]))return s[0].plus(d,l);if(c(s[0]))return s[0].plus(d,l);const h=m(s[0],u(n));return null===h?null:h.plus({[d]:l})}))}}export{C as registerFunctions};
