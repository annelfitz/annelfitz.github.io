/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import e from"../../config.js";import"../../geometry.js";import r from"../ArcadePortal.js";import t from"../Dictionary.js";import{ArcadeExecutionError as n,ExecutionErrorCodes as o}from"../executionError.js";import{H as a,j as i,c as s,w as p,K as l,o as c,N as f,b as u,k as m,m as g,n as h,v as d,p as w,a6 as y}from"../../chunks/languageUtils.js";import{getPortal as j}from"../portalUtils.js";import S from"../../geometry/Geometry.js";import{isLoaded as R,load as v,project as G}from"../../geometry/projection.js";import{webMercatorToGeographic as k,geographicToWebMercator as x}from"../../geometry/support/webMercatorUtils.js";import P from"../../portal/Portal.js";import b from"../../portal/PortalItem.js";import{project as I}from"../../rest/geometryService/project.js";import W from"../../rest/knowledgeGraph/Entity.js";import T from"../../rest/knowledgeGraph/GraphQueryStreaming.js";import D from"../../rest/knowledgeGraph/ObjectValue.js";import N from"../../rest/knowledgeGraph/Path.js";import q from"../../rest/knowledgeGraph/Relationship.js";import A from"../../rest/support/ProjectParameters.js";import U from"../../geometry/SpatialReference.js";let F=null;async function J(r){const t=e.geometryServiceUrl??"";if(!t){R()||await v();for(const e of r)e.container[e.indexer]=G(e.container[e.indexer],U.WGS84);return}const n=r.map((e=>e.container[e.indexer])),o=new A({geometries:n,outSpatialReference:U.WGS84}),a=await I(t,o);for(let e=0;e<a.length;e++){const t=r[e];t.container[t.indexer]=a[e]}}async function M(e,r){const t=new b({portal:e,id:r});return await t.load(),null===F&&(F=await import("../../rest/knowledgeGraphService.js")),await F.fetchKnowledgeGraph(t.url)}function Q(e,r,t,a,i){if(null===e)return null;if(s(e)||u(e))return e;if(m(e))return e.toJSDate();if(m(e))return e.toJSDate();if(g(e))return e.toStorageFormat();if(h(e))return e.toStorageString();if(d(e)){const n={};for(const o of e.keys())n[o]=Q(e.field(o),r,t,a,i),n[o]instanceof S&&i.push({container:n,indexer:o});return n}if(c(e)){const n=e.map((e=>Q(e,r,t,a,i)));for(let e=0;e<n.length;e++)n[e]instanceof S&&i.push({container:n,indexer:e});return n}if(w(e)){if(e.spatialReference.isWGS84)return e;if(e.spatialReference.isWebMercator&&r)return k(e);if(!r||!t)return e;throw new n(a,o.WrongSpatialReference,null)}}function E(e,r){if(!e)return e;if(e.spatialReference.isWGS84&&r.spatialReference.isWebMercator)return x(e);if(e.spatialReference.equals(r.spatialReference))return e;throw new n(r,o.WrongSpatialReference,null)}function K(e,r){if(!e)return null;const t={};for(const n in e)t[n]=V(e[n],r);return t}function V(e,r){return null===e?null:c(e)?e.map((e=>V(e,r))):e instanceof W?{graphTypeName:e.typeName,id:e.id,graphType:"entity",properties:K(e.properties,r)}:e instanceof D?{graphType:"object",properties:K(e.properties,r)}:e instanceof q?{graphTypeName:e.typeName,id:e.id,graphType:"relationship",originId:e.originId??null,destinationId:e.destinationId??null,properties:K(e.properties,r)}:e instanceof N?{graphType:"path",path:e.path?e.path.map((e=>V(e,r))):null}:w(e)?E(e,r):s(e)||u(e)||y(e)?e:null}function C(e){"async"===e.mode&&(e.functions.knowledgegraphbyportalitem=function(t,p){return e.standardFunctionAsync(t,p,((e,l,c)=>{if(a(c,2,2,t,p),null===c[0])throw new n(t,o.PortalRequired,p);if(c[0]instanceof r){const e=i(c[1]);let r;r=t.services?.portal?t.services.portal:P.getDefault();return M(j(c[0],r),e)}if(!1===s(c[0]))throw new n(t,o.InvalidParameter,p);const f=i(c[0]);return M(t.services?.portal??P.getDefault(),f)}))},e.signatures.push({name:"knowledgegraphbyportalitem",min:2,max:2}),e.functions.querygraph=function(r,i){return e.standardFunctionAsync(r,i,(async(e,u,m)=>{a(m,2,4,r,i);const g=m[0];if(!p(g))throw new n(r,o.InvalidParameter,i);const h=m[1];if(!s(h))throw new n(r,o.InvalidParameter,i);null===F&&(F=await import("../../rest/knowledgeGraphService.js"));let d=null;const w=l(m[2],null);if(!(w instanceof t||null===w))throw new n(r,o.InvalidParameter,i);if(w){let e=[];d=Q(w,!0,!1,r,e),e=e.filter((e=>!e.container[e.indexer].spatialReference.isWGS84)),e.length>0&&await J(e)}const y=new T({openCypherQuery:h,bindParameters:d});(g?.serviceDefinition?.currentVersion??11.3)>11.2&&(y.outputSpatialReference=r.spatialReference);const j=(await F.executeQueryStreaming(g,y)).resultRowsStream.getReader(),S=[];try{for(;;){const{done:e,value:t}=await j.read();if(e)break;if(c(t))for(const n of t)S.push(V(n,r));else{const e=[];for(const n of t)e.push(V(t[n],r));S.push(e)}}}catch(R){throw R}return t.convertJsonToArcade(S,f(r),!1,!0)}))},e.signatures.push({name:"querygraph",min:2,max:4}))}export{C as registerFunctions};
