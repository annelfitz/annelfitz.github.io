/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{version as n}from"../../kernel.js";import t from"../ArcadePortal.js";import e from"../Dictionary.js";import{ArcadeExecutionError as r,ExecutionErrorCodes as i}from"../executionError.js";import{cloneGeometry as a,convertSquareUnitsToCode as o,convertLinearUnitsToCode as l}from"../kernel.js";import{I as s,H as u,k as c,n as f,m as d,j as m,o as w,q as h,x as y,u as p,K as g,J as v,L as P,M as I,g as A,h as F,b as R,N as j}from"../../chunks/languageUtils.js";import{getPortal as x}from"../portalUtils.js";import{centroidPolyline as b,centroidMultiPoint as N,getMetersPerVerticalUnitForSR as O,segmentLength3d as S}from"./centroid.js";import{measureToCoordinate as D,pointToCoordinate as k,distanceToCoordinate as L}from"./measures.js";import{getMetersPerUnitForSR as M}from"../../core/unitUtils.js";import T from"../../geometry/Extent.js";import J from"../../geometry/Geometry.js";import{disjoint as Z,intersects as C,touches as U,crosses as E,within as q,contains as z,overlaps as W,equals as G,relate as H,intersect as K,union as V,difference as B,symmetricDifference as Q,clip as X,cut as Y,planarArea as $,geodesicArea as _,planarLength as nn,geodesicLength as tn,distance as en,densify as rn,geodesicDensify as an,generalize as on,buffer as ln,geodesicBuffer as sn,offset as un,rotate as cn,simplify as fn,isSimple as dn,convexHull as mn,nearestCoordinate as wn,nearestVertex as hn}from"../../geometry/geometryEngineAsync.js";import yn from"../../geometry/Multipoint.js";import pn from"../../geometry/Point.js";import gn from"../../geometry/Polygon.js";import vn from"../../geometry/Polyline.js";import{fromJSON as Pn}from"../../geometry/support/jsonUtils.js";import In from"../../portal/Portal.js";import{lookupUser as An}from"../../portal/support/utils.js";function Fn(t){return 0===n.indexOf("4.")?gn.fromExtent(t):new gn({spatialReference:t.spatialReference,rings:[[[t.xmin,t.ymin],[t.xmin,t.ymax],[t.xmax,t.ymax],[t.xmax,t.ymin],[t.xmin,t.ymin]]]})}function Rn(n,t,e){if(u(n,2,2,t,e),n[0]instanceof J&&n[1]instanceof J);else if(n[0]instanceof J&&null===n[1]);else if(n[1]instanceof J&&null===n[0]);else if(null!==n[0]||null!==n[1])throw new r(t,i.InvalidParameter,e)}async function jn(n,t){if("polygon"!==n.type&&"polyline"!==n.type&&"extent"!==n.type)return 0;let e=1;if(n.spatialReference.vcsWkid||n.spatialReference.latestVcsWkid){e=O(n.spatialReference)/M(n.spatialReference)}let r=0;if("polyline"===n.type)for(const a of n.paths)for(let n=1;n<a.length;n++)r+=S(a[n],a[n-1],e);else if("polygon"===n.type)for(const a of n.rings){for(let n=1;n<a.length;n++)r+=S(a[n],a[n-1],e);(a[0][0]!==a[a.length-1][0]||a[0][1]!==a[a.length-1][1]||void 0!==a[0][2]&&a[0][2]!==a[a.length-1][2])&&(r+=S(a[0],a[a.length-1],e))}else"extent"===n.type&&(r+=2*S([n.xmin,n.ymin,0],[n.xmax,n.ymin,0],e),r+=2*S([n.xmin,n.ymin,0],[n.xmin,n.ymax,0],e),r*=2,r+=4*Math.abs(g(n.zmax,0)*e-g(n.zmin,0)*e));const i=new vn({hasZ:!1,hasM:!1,spatialReference:n.spatialReference,paths:[[0,0],[0,r]]});return nn(i,t)}function xn(n){"async"===n.mode&&(n.functions.disjoint=function(t,e){return n.standardFunctionAsync(t,e,((n,r,i)=>(Rn(i=s(i),t,e),null===i[0]||null===i[1]||Z(i[0],i[1]))))},n.functions.intersects=function(t,e){return n.standardFunctionAsync(t,e,((n,r,i)=>(Rn(i=s(i),t,e),null!==i[0]&&null!==i[1]&&C(i[0],i[1]))))},n.functions.touches=function(t,e){return n.standardFunctionAsync(t,e,((n,r,i)=>(Rn(i=s(i),t,e),null!==i[0]&&null!==i[1]&&U(i[0],i[1]))))},n.functions.crosses=function(t,e){return n.standardFunctionAsync(t,e,((n,r,i)=>(Rn(i=s(i),t,e),null!==i[0]&&null!==i[1]&&E(i[0],i[1]))))},n.functions.within=function(t,e){return n.standardFunctionAsync(t,e,((n,r,i)=>(Rn(i=s(i),t,e),null!==i[0]&&null!==i[1]&&q(i[0],i[1]))))},n.functions.contains=function(t,e){return n.standardFunctionAsync(t,e,((n,r,i)=>(Rn(i=s(i),t,e),null!==i[0]&&null!==i[1]&&z(i[0],i[1]))))},n.functions.overlaps=function(t,e){return n.standardFunctionAsync(t,e,((n,r,i)=>(Rn(i=s(i),t,e),null!==i[0]&&null!==i[1]&&W(i[0],i[1]))))},n.functions.equals=function(t,e){return n.standardFunctionAsync(t,e,((n,r,i)=>(u(i,2,2,t,e),i[0]===i[1]||(i[0]instanceof J&&i[1]instanceof J?G(i[0],i[1]):(c(i[0])&&c(i[1])||!!(f(i[0])&&f(i[1])||d(i[0])&&d(i[1])))&&i[0].equals(i[1])))))},n.functions.relate=function(t,e){return n.standardFunctionAsync(t,e,((n,a,o)=>{if(o=s(o),u(o,3,3,t,e),o[0]instanceof J&&o[1]instanceof J)return H(o[0],o[1],m(o[2]));if(o[0]instanceof J&&null===o[1])return!1;if(o[1]instanceof J&&null===o[0])return!1;if(null===o[0]&&null===o[1])return!1;throw new r(t,i.InvalidParameter,e)}))},n.functions.intersection=function(t,e){return n.standardFunctionAsync(t,e,((n,r,i)=>(Rn(i=s(i),t,e),null===i[0]||null===i[1]?null:K(i[0],i[1]))))},n.functions.union=function(t,e){return n.standardFunctionAsync(t,e,((n,o,l)=>{const u=[];if(0===(l=s(l)).length)throw new r(t,i.WrongNumberOfParameters,e);if(1===l.length)if(w(l[0])){const n=s(l[0]);for(let a=0;a<n.length;a++)if(null!==n[a]){if(!(n[a]instanceof J))throw new r(t,i.InvalidParameter,e);u.push(n[a])}}else{if(!h(l[0])){if(l[0]instanceof J)return y(a(l[0]),t.spatialReference);if(null===l[0])return null;throw new r(t,i.InvalidParameter,e)}{const n=s(l[0].toArray());for(let a=0;a<n.length;a++)if(null!==n[a]){if(!(n[a]instanceof J))throw new r(t,i.InvalidParameter,e);u.push(n[a])}}}else for(let a=0;a<l.length;a++)if(null!==l[a]){if(!(l[a]instanceof J))throw new r(t,i.InvalidParameter,e);u.push(l[a])}return 0===u.length?null:V(u)}))},n.functions.difference=function(t,e){return n.standardFunctionAsync(t,e,((n,r,i)=>(Rn(i=s(i),t,e),null===i[0]?null:null===i[1]?a(i[0]):B(i[0],i[1]))))},n.functions.symmetricdifference=function(t,e){return n.standardFunctionAsync(t,e,((n,r,i)=>(Rn(i=s(i),t,e),null===i[0]&&null===i[1]?null:null===i[0]?a(i[1]):null===i[1]?a(i[0]):Q(i[0],i[1]))))},n.functions.clip=function(t,e){return n.standardFunctionAsync(t,e,((n,a,o)=>{if(o=s(o),u(o,2,2,t,e),!(o[1]instanceof T)&&null!==o[1])throw new r(t,i.InvalidParameter,e);if(null===o[0])return null;if(!(o[0]instanceof J))throw new r(t,i.InvalidParameter,e);return null===o[1]?null:X(o[0],o[1])}))},n.functions.cut=function(t,e){return n.standardFunctionAsync(t,e,((n,o,l)=>{if(l=s(l),u(l,2,2,t,e),!(l[1]instanceof vn)&&null!==l[1])throw new r(t,i.InvalidParameter,e);if(null===l[0])return[];if(!(l[0]instanceof J))throw new r(t,i.InvalidParameter,e);return null===l[1]?[a(l[0])]:Y(l[0],l[1])}))},n.functions.area=function(t,e){return n.standardFunctionAsync(t,e,(async(n,a,l)=>{if(u(l,1,2,t,e),null===(l=s(l))[0])return 0;if(p(l[0])){const n=await l[0].sumArea(o(g(l[1],-1)),!1,t.abortSignal);if(t.abortSignal.aborted)throw new r(t,i.Cancelled,e);return n}if(w(l[0])||h(l[0])){const n=v(l[0],t.spatialReference);return null===n?0:$(n,o(g(l[1],-1)))}if(!(l[0]instanceof J))throw new r(t,i.InvalidParameter,e);return $(l[0],o(g(l[1],-1)))}))},n.functions.areageodetic=function(t,e){return n.standardFunctionAsync(t,e,(async(n,a,l)=>{if(u(l,1,2,t,e),null===(l=s(l))[0])return 0;if(p(l[0])){const n=await l[0].sumArea(o(g(l[1],-1)),!0,t.abortSignal);if(t.abortSignal.aborted)throw new r(t,i.Cancelled,e);return n}if(w(l[0])||h(l[0])){const n=v(l[0],t.spatialReference);return null===n?0:_(n,o(g(l[1],-1)))}if(!(l[0]instanceof J))throw new r(t,i.InvalidParameter,e);return _(l[0],o(g(l[1],-1)))}))},n.functions.length=function(t,e){return n.standardFunctionAsync(t,e,(async(n,a,o)=>{if(u(o,1,2,t,e),null===(o=s(o))[0])return 0;if(p(o[0])){const n=await o[0].sumLength(l(g(o[1],-1)),!1,t.abortSignal);if(t.abortSignal.aborted)throw new r(t,i.Cancelled,e);return n}if(w(o[0])||h(o[0])){const n=P(o[0],t.spatialReference);return null===n?0:nn(n,l(g(o[1],-1)))}if(!(o[0]instanceof J))throw new r(t,i.InvalidParameter,e);return nn(o[0],l(g(o[1],-1)))}))},n.functions.length3d=function(t,e){return n.standardFunctionAsync(t,e,((n,a,o)=>{if(u(o,1,2,t,e),null===(o=s(o))[0])return 0;if(w(o[0])||h(o[0])){const n=P(o[0],t.spatialReference);return null===n?0:!0===n.hasZ?jn(n,l(g(o[1],-1))):nn(n,l(g(o[1],-1)))}if(!(o[0]instanceof J))throw new r(t,i.InvalidParameter,e);return!0===o[0].hasZ?jn(o[0],l(g(o[1],-1))):nn(o[0],l(g(o[1],-1)))}))},n.functions.lengthgeodetic=function(t,e){return n.standardFunctionAsync(t,e,(async(n,a,o)=>{if(u(o,1,2,t,e),null===(o=s(o))[0])return 0;if(p(o[0])){const n=await o[0].sumLength(l(g(o[1],-1)),!0,t.abortSignal);if(t.abortSignal.aborted)throw new r(t,i.Cancelled,e);return n}if(w(o[0])||h(o[0])){const n=P(o[0],t.spatialReference);return null===n?0:tn(n,l(g(o[1],-1)))}if(!(o[0]instanceof J))throw new r(t,i.InvalidParameter,e);return tn(o[0],l(g(o[1],-1)))}))},n.functions.distance=function(t,e){return n.standardFunctionAsync(t,e,((n,a,o)=>{o=s(o),u(o,2,3,t,e);let c=o[0];(w(o[0])||h(o[0]))&&(c=I(o[0],t.spatialReference));let f=o[1];if((w(o[1])||h(o[1]))&&(f=I(o[1],t.spatialReference)),!(c instanceof J))throw new r(t,i.InvalidParameter,e);if(!(f instanceof J))throw new r(t,i.InvalidParameter,e);return en(c,f,l(g(o[2],-1)))}))},n.functions.distancegeodetic=function(t,e){return n.standardFunctionAsync(t,e,((n,a,o)=>{o=s(o),u(o,2,3,t,e);const c=o[0],f=o[1];if(!(c instanceof pn))throw new r(t,i.InvalidParameter,e);if(!(f instanceof pn))throw new r(t,i.InvalidParameter,e);const d=new vn({paths:[],spatialReference:c.spatialReference});return d.addPath([c,f]),tn(d,l(g(o[2],-1)))}))},n.functions.densify=function(t,e){return n.standardFunctionAsync(t,e,((n,a,o)=>{if(o=s(o),u(o,2,3,t,e),null===o[0])return null;if(!(o[0]instanceof J))throw new r(t,i.InvalidParameter,e);const c=A(o[1]);if(isNaN(c))throw new r(t,i.InvalidParameter,e);if(c<=0)throw new r(t,i.InvalidParameter,e);return o[0]instanceof gn||o[0]instanceof vn?rn(o[0],c,l(g(o[2],-1))):o[0]instanceof T?rn(Fn(o[0]),c,l(g(o[2],-1))):o[0]}))},n.functions.densifygeodetic=function(t,e){return n.standardFunctionAsync(t,e,((n,a,o)=>{if(o=s(o),u(o,2,3,t,e),null===o[0])return null;if(!(o[0]instanceof J))throw new r(t,i.InvalidParameter,e);const c=A(o[1]);if(isNaN(c))throw new r(t,i.InvalidParameter,e);if(c<=0)throw new r(t,i.InvalidParameter,e);return o[0]instanceof gn||o[0]instanceof vn?an(o[0],c,l(g(o[2],-1))):o[0]instanceof T?an(Fn(o[0]),c,l(g(o[2],-1))):o[0]}))},n.functions.generalize=function(t,e){return n.standardFunctionAsync(t,e,((n,a,o)=>{if(o=s(o),u(o,2,4,t,e),null===o[0])return null;if(!(o[0]instanceof J))throw new r(t,i.InvalidParameter,e);const c=A(o[1]);if(isNaN(c))throw new r(t,i.InvalidParameter,e);return on(o[0],c,F(g(o[2],!0)),l(g(o[3],-1)))}))},n.functions.buffer=function(t,e){return n.standardFunctionAsync(t,e,((n,o,c)=>{if(c=s(c),u(c,2,3,t,e),null===c[0])return null;if(!(c[0]instanceof J))throw new r(t,i.InvalidParameter,e);const f=A(c[1]);if(isNaN(f))throw new r(t,i.InvalidParameter,e);return 0===f?a(c[0]):ln(c[0],f,l(g(c[2],-1)))}))},n.functions.buffergeodetic=function(t,e){return n.standardFunctionAsync(t,e,((n,o,c)=>{if(c=s(c),u(c,2,3,t,e),null===c[0])return null;if(!(c[0]instanceof J))throw new r(t,i.InvalidParameter,e);const f=A(c[1]);if(isNaN(f))throw new r(t,i.InvalidParameter,e);return 0===f?a(c[0]):sn(c[0],f,l(g(c[2],-1)))}))},n.functions.offset=function(t,e){return n.standardFunctionAsync(t,e,((n,a,o)=>{if(o=s(o),u(o,2,6,t,e),null===o[0])return null;if(!(o[0]instanceof gn||o[0]instanceof vn))throw new r(t,i.InvalidParameter,e);const c=A(o[1]);if(isNaN(c))throw new r(t,i.InvalidParameter,e);const f=A(g(o[4],10));if(isNaN(f))throw new r(t,i.InvalidParameter,e);const d=A(g(o[5],0));if(isNaN(d))throw new r(t,i.InvalidParameter,e);return un(o[0],c,l(g(o[2],-1)),m(g(o[3],"round")).toLowerCase(),f,d)}))},n.functions.rotate=function(t,e){return n.standardFunctionAsync(t,e,((n,a,o)=>{if(o=s(o),u(o,2,3,t,e),null===o[0])return null;if(!(o[0]instanceof J))throw new r(t,i.InvalidParameter,e);const l=o[0]instanceof T?gn.fromExtent(o[0]):o[0],c=A(o[1]);if(isNaN(c))throw new r(t,i.InvalidParameter,e);const f=g(o[2],null);if(null===f)return cn(l,c);if(f instanceof pn)return cn(l,c,f);throw new r(t,i.InvalidParameter,e)}))},n.functions.centroid=function(t,e){return n.standardFunctionAsync(t,e,((n,o,l)=>{if(l=s(l),u(l,1,1,t,e),null===l[0])return null;let c=l[0];if((w(l[0])||h(l[0]))&&(c=I(l[0],t.spatialReference)),null===c)return null;if(!(c instanceof J))throw new r(t,i.InvalidParameter,e);return c instanceof pn?y(a(c),t.spatialReference):c instanceof gn?c.centroid:c instanceof vn?b(c):c instanceof yn?N(c):c instanceof T?c.center:null}))},n.functions.measuretocoordinate=function(t,a){return n.standardFunctionAsync(t,a,((n,o,l)=>{if(l=s(l),u(l,2,2,t,a),null===l[0])return null;let c=l[0];if((w(l[0])||h(l[0]))&&(c=P(l[0],t.spatialReference)),null===c)return null;if(!(c instanceof J))throw new r(t,i.InvalidParameter,a);if(!(c instanceof vn))throw new r(t,i.InvalidParameter,a);if(R(!1===l[1]))throw new r(t,i.InvalidParameter,a);const f=D(c,l[1]);return f?e.convertObjectToArcadeDictionary(f,j(t),!1,!0):null}))},n.functions.pointtocoordinate=function(t,a){return n.standardFunctionAsync(t,a,((n,o,l)=>{if(l=s(l),u(l,2,2,t,a),null===l[0])return null;let c=l[0];if((w(l[0])||h(l[0]))&&(c=P(l[0],t.spatialReference)),null===c)return null;if(!(c instanceof J))throw new r(t,i.InvalidParameter,a);if(!(c instanceof vn))throw new r(t,i.InvalidParameter,a);const f=l[1];if(null===f)return null;if(!(f instanceof pn))throw new r(t,i.InvalidParameter,a);if(R(!1===l[1]))throw new r(t,i.InvalidParameter,a);const d=k(c,f);return d?e.convertObjectToArcadeDictionary(d,j(t),!1,!0):null}))},n.functions.distancetocoordinate=function(t,a){return n.standardFunctionAsync(t,a,((n,o,l)=>{if(l=s(l),u(l,2,2,t,a),null===l[0])return null;let c=l[0];if((w(l[0])||h(l[0]))&&(c=P(l[0],t.spatialReference)),null===c)return null;if(!(c instanceof J))throw new r(t,i.InvalidParameter,a);if(!(c instanceof vn))throw new r(t,i.InvalidParameter,a);if(R(!1===l[1]))throw new r(t,i.InvalidParameter,a);const f=L(c,l[1]);return f?e.convertObjectToArcadeDictionary(f,j(t),!1,!0):null}))},n.functions.multiparttosinglepart=function(t,e){return n.standardFunctionAsync(t,e,(async(n,o,l)=>{if(l=s(l),u(l,1,1,t,e),null===l[0])return null;if(!(l[0]instanceof J))throw new r(t,i.InvalidParameter,e);if(l[0]instanceof pn)return[y(a(l[0]),t.spatialReference)];if(l[0]instanceof T)return[y(a(l[0]),t.spatialReference)];const c=await fn(l[0]);if(c instanceof gn){const n=[],t=[];for(let e=0;e<c.rings.length;e++)if(c.isClockwise(c.rings[e])){const t=Pn({rings:[c.rings[e]],hasZ:!0===c.hasZ,hasM:!0===c.hasM,spatialReference:c.spatialReference.toJSON()});n.push(t)}else t.push({ring:c.rings[e],pt:c.getPoint(e,0)});for(let e=0;e<t.length;e++)for(let r=0;r<n.length;r++)if(n[r].contains(t[e].pt)){n[r].addRing(t[e].ring);break}return n}if(c instanceof vn){const n=[];for(let t=0;t<c.paths.length;t++){const e=Pn({paths:[c.paths[t]],hasZ:!0===c.hasZ,hasM:!0===c.hasM,spatialReference:c.spatialReference.toJSON()});n.push(e)}return n}if(l[0]instanceof yn){const n=[],e=y(a(l[0]),t.spatialReference);for(let t=0;t<e.points.length;t++)n.push(e.getPoint(t));return n}return null}))},n.functions.issimple=function(t,e){return n.standardFunctionAsync(t,e,((n,a,o)=>{if(o=s(o),u(o,1,1,t,e),null===o[0])return!0;if(!(o[0]instanceof J))throw new r(t,i.InvalidParameter,e);return dn(o[0])}))},n.functions.simplify=function(t,e){return n.standardFunctionAsync(t,e,((n,a,o)=>{if(o=s(o),u(o,1,1,t,e),null===o[0])return null;if(!(o[0]instanceof J))throw new r(t,i.InvalidParameter,e);return fn(o[0])}))},n.functions.convexhull=function(t,e){return n.standardFunctionAsync(t,e,((n,a,o)=>{if(o=s(o),u(o,1,1,t,e),null===o[0])return null;if(!(o[0]instanceof J))throw new r(t,i.InvalidParameter,e);return mn(o[0])}))},n.functions.getuser=function(a,o){return n.standardFunctionAsync(a,o,(async(n,l,s)=>{u(s,0,2,a,o);let c=g(s[1],""),f=!0===c;if(c=!0===c||!1===c?"":m(c),0===s.length||s[0]instanceof t){let n;n=a.services?.portal?a.services.portal:In.getDefault(),s.length>0&&(n=x(s[0],n));const t=await An(n,c,f);if(t){const n=JSON.parse(JSON.stringify(t));for(const t of["lastLogin","created","modified"])void 0!==n[t]&&null!==n[t]&&(n[t]=new Date(n[t]));return e.convertObjectToArcadeDictionary(n,j(a))}return null}let d=null;if(p(s[0])&&(d=s[0]),d){if(f=!1,c)return null;await d.load();const n=await d.getOwningSystemUrl();if(!n){if(!c){const n=await d.getIdentityUser();return n?e.convertObjectToArcadeDictionary({username:n},j(a)):null}return null}let r;r=a.services?.portal?a.services.portal:In.getDefault(),r=x(new t(n),r);const i=await An(r,c,f);if(i){const n=JSON.parse(JSON.stringify(i));for(const t of["lastLogin","created","modified"])void 0!==n[t]&&null!==n[t]&&(n[t]=new Date(n[t]));return e.convertObjectToArcadeDictionary(n,j(a))}return null}throw new r(a,i.InvalidParameter,o)}))},n.functions.nearestcoordinate=function(t,a){return n.standardFunctionAsync(t,a,(async(n,o,l)=>{if(l=s(l),u(l,2,2,t,a),!(l[0]instanceof J||null===l[0]))throw new r(t,i.InvalidParameter,a);if(!(l[1]instanceof pn||null===l[1]))throw new r(t,i.InvalidParameter,a);if(null===l[0]||null===l[1])return null;const c=await wn(l[0],l[1]);return null===c?null:e.convertObjectToArcadeDictionary({coordinate:c.coordinate,distance:c.distance,sideOfLine:0===c.distance?"straddle":c.isRightSide?"right":"left"},j(t),!1,!0)}))},n.functions.nearestvertex=function(t,a){return n.standardFunctionAsync(t,a,(async(n,o,l)=>{if(l=s(l),u(l,2,2,t,a),!(l[0]instanceof J||null===l[0]))throw new r(t,i.InvalidParameter,a);if(!(l[1]instanceof pn||null===l[1]))throw new r(t,i.InvalidParameter,a);if(null===l[0]||null===l[1])return null;const c=await hn(l[0],l[1]);return null===c?null:e.convertObjectToArcadeDictionary({coordinate:c.coordinate,distance:c.distance,sideOfLine:0===c.distance?"straddle":c.isRightSide?"right":"left"},j(t),!1,!0)}))})}export{xn as registerFunctions};
