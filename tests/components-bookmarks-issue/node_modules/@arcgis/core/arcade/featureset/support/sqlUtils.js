/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{ArcadeDate as e}from"../../ArcadeDate.js";import{SqlError as r,SqlErrorCodes as t}from"./errorsupport.js";import{FeatureServiceDatabaseType as a,isDate as s,isLuxonDate as n,isArcadeTime as c,isArcadeDate as i,isArcadeDateOnly as o}from"./shared.js";import{TimeOnly as l}from"../../../core/sql/TimeOnly.js";import{WhereClause as u}from"../../../core/sql/WhereClause.js";import{DateTime as d}from"luxon";function p(e,r){return h(e?.parseTree,r,e?.parameters)}function f(e,r,t){return h(e,r,t)}function m(e,r,t,s){return u.create(h(e.parseTree,a.Standardised,e.parameters,r,t),s,e.timeZone)}function g(e,r,t="AND"){return u.create("(("+p(e,a.Standardised)+")"+t+"("+p(r,a.Standardised)+"))",e.fieldsIndex,e.timeZone)}function h(e,l,u,d=null,p=null){let f,m,g,L;switch(e.type){case"interval":return F(h(e.value,l,u,d,p),e.qualifier,e.op);case"case-expression":{let r=" CASE ";"simple"===e.format&&(r+=h(e.operand,l,u,d,p));for(let t=0;t<e.clauses.length;t++)r+=" WHEN "+h(e.clauses[t].operand,l,u,d,p)+" THEN "+h(e.clauses[t].value,l,u,d,p);return null!==e.else&&(r+=" ELSE "+h(e.else,l,u,d,p)),r+=" END ",r}case"parameter":{const r=u[e.value.toLowerCase()];if("string"==typeof r){return"'"+u[e.value.toLowerCase()].toString().replaceAll("'","''")+"'"}if(s(r))return w(r,l);if(n(r))return w(r,l);if(c(r))return E(r,l);if(i(r))return T(r,l);if(o(r))return S(r,l);if(Array.isArray(r)){const e=[];for(let t=0;t<r.length;t++)"string"==typeof r[t]?e.push("'"+r[t].toString().replaceAll("'","''")+"'"):s(r[t])||n(r[t])?e.push(w(r[t],l)):c(r[t])?e.push(E(r[t],l)):i(r[t])?e.push(T(r[t],l)):o(r[t])?e.push(S(r[t],l)):e.push(r[t].toString());return e}return r.toString()}case"expression-list":m=[];for(const r of e.value)m.push(h(r,l,u,d,p));return m;case"unary-expression":return" ( NOT "+h(e.expr,l,u,d,p)+" ) ";case"binary-expression":switch(e.operator){case"AND":return" ("+h(e.left,l,u,d,p)+" AND "+h(e.right,l,u,d,p)+") ";case"OR":return" ("+h(e.left,l,u,d,p)+" OR "+h(e.right,l,u,d,p)+") ";case"IS":if("null"!==e.right.type)throw new r(t.UnsupportedIsRhs);return" ("+h(e.left,l,u,d,p)+" IS NULL )";case"ISNOT":if("null"!==e.right.type)throw new r(t.UnsupportedIsRhs);return" ("+h(e.left,l,u,d,p)+" IS NOT NULL )";case"IN":return f=[],"expression-list"===e.right.type?(f=h(e.right,l,u,d,p)," ("+h(e.left,l,u,d,p)+" IN ("+f.join(",")+")) "):(L=h(e.right,l,u,d,p),Array.isArray(L)?" ("+h(e.left,l,u,d,p)+" IN ("+L.join(",")+")) ":" ("+h(e.left,l,u,d,p)+" IN ("+L+")) ");case"NOT IN":return f=[],"expression-list"===e.right.type?(f=h(e.right,l,u,d,p)," ("+h(e.left,l,u,d,p)+" NOT IN ("+f.join(",")+")) "):(L=h(e.right,l,u,d,p),Array.isArray(L)?" ("+h(e.left,l,u,d,p)+" NOT IN ("+L.join(",")+")) ":" ("+h(e.left,l,u,d,p)+" NOT IN ("+L+")) ");case"BETWEEN":return g=h(e.right,l,u,d,p)," ("+h(e.left,l,u,d,p)+" BETWEEN "+g[0]+" AND "+g[1]+" ) ";case"NOTBETWEEN":return g=h(e.right,l,u,d,p)," ("+h(e.left,l,u,d,p)+" NOT BETWEEN "+g[0]+" AND "+g[1]+" ) ";case"LIKE":return""!==e.escape?" ("+h(e.left,l,u,d,p)+" LIKE "+h(e.right,l,u,d,p)+" ESCAPE '"+e.escape+"') ":" ("+h(e.left,l,u,d,p)+" LIKE "+h(e.right,l,u,d,p)+") ";case"NOT LIKE":return""!==e.escape?" ("+h(e.left,l,u,d,p)+" NOT LIKE "+h(e.right,l,u,d,p)+" ESCAPE '"+e.escape+"') ":" ("+h(e.left,l,u,d,p)+" NOT LIKE "+h(e.right,l,u,d,p)+") ";case"<>":case"<":case">":case">=":case"<=":case"=":case"*":case"-":case"+":case"/":return" ("+h(e.left,l,u,d,p)+" "+e.operator+" "+h(e.right,l,u,d,p)+") ";case"||":return" ("+h(e.left,l,u,d,p)+" "+(l===a.SqlServer?"+":e.operator)+" "+h(e.right,l,u,d,p)+") "}throw new r(t.UnsupportedOperator,{operator:e.operator});case"null":return"null";case"boolean":return!0===e.value?"1":"0";case"string":return"'"+e.value.toString().replaceAll("'","''")+"'";case"timestamp":return`timestamp '${e.value}'`;case"date":return`date '${e.value}'`;case"time":return`time '${e.value}'`;case"number":return e.value.toString();case"current-time":return A("date"===e.mode,l);case"column-reference":return d?d.toLowerCase()===e.column.toLowerCase()?"("+p+")":!0===e.delimited?`"${e.column.split('"').join('""')}"`:e.column:e.column;case"data-type":return e.value;case"function":{const r=h(e.args,l,u,d,p);return y(e.name,r,l)}}throw new r(t.UnsupportedSyntax,{node:e.type})}function y(e,s,n){switch(e.toLowerCase().trim()){case"cos":case"sin":case"tan":case"cosh":case"tanh":case"sinh":case"acos":case"asin":case"atan":case"floor":case"log10":case"log":case"abs":if(1!==s.length)throw new r(t.InvalidFunctionParameters,{function:e.toLowerCase().trim()});return`${e.toUpperCase().trim()}(${s[0]})`;case"ceiling":case"ceil":if(1!==s.length)throw new r(t.InvalidFunctionParameters,{function:"ceiling"});switch(n){case a.Standardised:case a.StandardisedNoInterval:}return"CEILING("+s[0]+")";case"mod":case"power":case"nullif":if(2!==s.length)throw new r(t.InvalidFunctionParameters,{function:e.toLowerCase().trim()});return`${e.toUpperCase().trim()}(${s[0]},${s[1]})`;case"round":if(2===s.length)return"ROUND("+s[0]+","+s[1]+")";if(1===s.length)return"ROUND("+s[0]+")";throw new r(t.InvalidFunctionParameters,{function:"round"});case"truncate":if(s.length<1||s.length>2)throw new r(t.InvalidFunctionParameters,{function:"truncate"});return n===a.SqlServer?"ROUND("+s[0]+(1===s.length?"0":","+s[1])+",1)":"TRUNCATE("+s[0]+(1===s.length?")":","+s[1]+")");case"char_length":case"len":if(1!==s.length)throw new r(t.InvalidFunctionParameters,{function:"char_length"});switch(n){case a.SqlServer:return"LEN("+s[0]+")";case a.Oracle:return"LENGTH("+s[0]+")";default:return"CHAR_LENGTH("+s[0]+")"}case"coalesce":case"concat":{if(s.length<1)throw new r(t.InvalidFunctionParameters,{function:e.toLowerCase()});let a=e.toUpperCase().trim()+"(";for(let e=0;e<s.length;e++)0!==e&&(a+=","),a+=s[e];return a+=")",a}case"lower":case"lcase":if(1!==s.length)throw new r(t.InvalidFunctionParameters,{function:"lower"});return"LOWER("+s[0]+")";case"upper":case"ucase":if(1!==s.length)throw new r(t.InvalidFunctionParameters,{function:"upper"});return"UPPER("+s[0]+")";case"substring":{let e="";switch(n){case a.Oracle:return e="SUBSTR("+s[0]+","+s[1],3===s.length&&(e+=","+s[2]),e+=")",e;case a.SqlServer:return e=3===s.length?"SUBSTRING("+s[0]+","+s[1]+","+s[2]+")":"SUBSTRING("+s[0]+",  "+s[1]+", LEN("+s[0]+") - "+s[1]+")",e;default:return e="SUBSTRING("+s[0]+" FROM "+s[1],3===s.length&&(e+=" FOR "+s[2]),e+=")",e}}case"extract":return"EXTRACT("+s[0].replaceAll("'","")+" FROM "+s[1]+")";case"cast":{let e="";switch(n){case a.Oracle:switch(s[1].type){case"date":e="DATE";break;case"float":e="DOUBLE";break;case"integer":e="INTEGER";break;case"real":e="REAL";break;case"smallint":e="SMALLINT";break;case"timestamp":e="TIMESTAMP";break;case"varchar":e="VARCHAR("+s[1].size.toString()+")"}return`CAST(${s[0]} AS ${e})`;case a.Postgres:switch(s[1].type){case"date":e="DATE";break;case"float":e="DOUBLE PRECISION";break;case"integer":e="INT";break;case"real":e="REAL";break;case"smallint":e="SMALLINT";break;case"timestamp":e="TIMESTAMP";break;case"varchar":e="VARCHAR("+s[1].size.toString()+")"}return`CAST(${s[0]} AS ${e})`;case a.SqlServer:switch(s[1].type){case"date":e="DATE";break;case"float":e="FLOAT";break;case"integer":e="INT";break;case"real":e="REAL";break;case"smallint":e="SMALLINT";break;case"timestamp":e="DATETIME";break;case"varchar":e="VARCHAR("+s[1].size.toString()+")"}return`CAST(${s[0]} AS ${e})`;default:switch(s[1].type){case"date":e="DATE";break;case"float":e="FLOAT";break;case"integer":e="INTEGER";break;case"real":e="REAL";break;case"smallint":e="SMALLINT";break;case"timestamp":e="TIMESTAMP";break;case"varchar":e="VARCHAR("+s[1].size.toString()+")"}return`CAST(${s[0]} AS ${e})`}}}throw new r(t.InvalidFunctionParameters,{function:e})}function T(e,r){const t=e.toDateTime(),s=0===t.hour&&0===t.minute&&0===t.second&&0===t.millisecond;switch(r){case a.FILEGDB:case a.Standardised:case a.StandardisedNoInterval:return s?`date '${t.toFormat("yyyy-LL-dd")}'`:`timestamp '${t.toFormat("yyyy-LL-dd HH:mm:ss")}'`;case a.Oracle:return s?`TO_DATE('${t.toFormat("yyyy-LL-dd")}','YYYY-MM-DD')`:`TO_DATE('${t.toFormat("yyyy-LL-dd HH:mm:ss")}','YYYY-MM-DD HH24:MI:SS')`;case a.SqlServer:return`'${t.toFormat(s?"yyyy-LL-dd":"yyyy-LL-dd HH:mm:ss")}'`;case a.PGDB:return`#${t.toFormat(s?"LL-dd-yyyy":"LL-dd-yyyy HH:mm:ss")}#`;case a.Postgres:return`TIMESTAMP '${t.toFormat(s?"yyyy-LL-dd":"yyyy-LL-dd HH:mm:ss")}'`;default:return`timestamp '${t.toFormat("yyyy-LL-dd HH:mm:ss")}'`}}function S(e,r){switch(r){case a.FILEGDB:case a.Standardised:case a.StandardisedNoInterval:return e.toSQLWithKeyword();case a.Oracle:return`TO_DATE('${e.toFormat("Y-MM-DD")}'`;case a.SqlServer:return`'${e.toFormat("Y-MM-DD")}'`;case a.PGDB:return`#${e.toFormat("Y-MM-DD")}#`;case a.Postgres:return`TIMESTAMP '${e.toFormat("Y-MM-DD")}'`;default:return e.toSQLWithKeyword()}}function E(e,r){switch(e instanceof l&&(e=e.toStorageString()),r){case a.Oracle:return`TO_DATE('${e}', 'HH24:MI:SS')`;case a.SqlServer:return`'${e}'`;case a.FILEGDB:case a.Standardised:case a.StandardisedNoInterval:case a.Postgres:default:return`time '${e}'`}}function w(r,t){return T(e.dateTimeToArcadeDate(n(r)?r:d.fromJSDate(r)),t)}function A(e,r){switch(r){case a.FILEGDB:case a.Standardised:case a.StandardisedNoInterval:case a.Oracle:return e?"CURRENT_DATE":"CURRENT_TIMESTAMP";case a.SqlServer:return e?"CAST(GETDATE() AS DATE)":"GETDATE()";case a.PGDB:case a.Postgres:default:return e?"CURRENT_DATE":"CURRENT_TIMESTAMP"}}function L(e,r,t={}){const a={},s={},n={esriFieldTypeSmallInteger:"integer",esriFieldTypeInteger:"integer",esriFieldTypeBigInteger:"integer",esriFieldTypeSingle:"double",esriFieldTypeDouble:"double",esriFieldTypeString:"string",esriFieldTypeTimeOnly:"time-only",esriFieldTypeDateOnly:"date-only",esriFieldTypeTimestampOffset:"timestamp-offset",esriFieldTypeDate:"date",esriFieldTypeOID:"integer",esriFieldTypeGUID:"guid",esriFieldTypeGlobalID:"guid",oid:"integer",long:"integer","small-integer":"integer",integer:"integer","big-integer":"integer",single:"double","time-only":"time-only","date-only":"date-only","timestamp-offset":"timestemp-offset",double:"double",date:"date",guid:"guid","global-id":"guid",string:"string"};for(const c of r){const e=c.type?n[c.type]:void 0;a[c.name.toLowerCase()]=void 0===e?"":e}for(const c in t){const e=n[t[c]];s[c.toLowerCase()]=void 0===e?"":e}switch(I(a,e.parseTree,e.parameters,s)){case"double":return"double";case"integer":return"integer";case"date":return"date";case"date-only":return"date-only";case"time-only":return"time-only";case"timestamp-offset":return"timestamp-offset";case"string":return"string";case"global-id":case"guid":return"guid"}return""}function I(e,a,n,l){let u;switch(a.type){case"interval":return"integer";case"case-expression":{const r=[];if("simple"===a.format){for(let t=0;t<a.clauses.length;t++)r.push(I(e,a.clauses[t].value,n,l));null!==a.else&&r.push(I(e,a.else,n,l))}else{for(let t=0;t<a.clauses.length;t++)r.push(I(e,a.else,n,l));null!==a.else&&r.push(I(e,a.else,n,l))}return b(r)}case"parameter":{const e=l[a.value.toLowerCase()];if(void 0===e&&n){const e=n[a.value.toLowerCase()];if(void 0===e)return"";if(null===e)return"";if("string"==typeof e||e instanceof String)return"string";if("boolean"==typeof e)return"boolean";if(s(e))return"date";if(i(e))return"date";if(o(e))return"date-only";if(c(e))return"time-only";if("number"==typeof e)return e%1==0?"integer":"double"}return void 0===e?"":e}case"expression-list":{const r=[];for(const t of a.value)r.push(I(e,t,n,l));return r}case"unary-expression":return"boolean";case"binary-expression":switch(a.operator){case"AND":case"OR":case"IN":case"NOT IN":case"BETWEEN":case"NOTBETWEEN":case"LIKE":case"NOT LIKE":case"<>":case"<":case">":case">=":case"<=":case"=":return"boolean";case"IS":case"ISNOT":if("null"!==a.right.type)throw new r(t.UnsupportedIsRhs);return"boolean";case"*":case"-":case"+":case"/":return b([I(e,a.left,n,l),I(e,a.right,n,l)]);case"||":return"string";default:throw new r(t.UnsupportedOperator,{operator:a.operator})}case"null":return"";case"boolean":return"boolean";case"string":return"string";case"number":return null===a.value?"":a.value%1==0?"integer":"double";case"date":return"date";case"timestamp":return a.withtimezone?"timestamp-offset":"date";case"time":return"time-only";case"current-time":return"date";case"column-reference":{const r=e[a.column.toLowerCase()];return void 0===r?"":r}case"function":switch(a.name.toLowerCase()){case"cast":switch(a.args?.value[1]?.value.type??""){case"integer":case"smallint":return"integer";case"real":case"float":return"double";case"date":case"timestamp":return!0===a.args?.value[1]?.value?.withtimezone?"timestamp-offset":"date";case"time":return"time-only";case"varchar":return"string";default:return""}case"position":case"extract":case"char_length":case"mod":return"integer";case"round":if(u=I(e,a.args,n,l),Array.isArray(u)){if(u.length<=0)return"double";u=u[0]}return u;case"sign":return"integer";case"ceiling":case"floor":case"abs":return u=I(e,a.args,n,l),Array.isArray(u)&&(u=b(u)),"integer"===u||"double"===u?u:"double";case"area":case"length":case"log":case"log10":case"sin":case"cos":case"tan":case"asin":case"acos":case"atan":case"cosh":case"sinh":case"tanh":case"power":return"double";case"substring":case"trim":case"concat":case"lower":case"upper":return"string";case"truncate":return"double";case"nullif":case"coalesce":return u=I(e,a.args,n,l),Array.isArray(u)?u.length>0?u[0]:"":u}return""}throw new r(t.UnsupportedSyntax,{node:a.type})}const N={boolean:1,string:2,integer:3,double:4,date:5};function b(e){if(e){let r="";for(const t of e)""!==t&&(r=""===r||N[r]<N[t]?t:r);return r}return""}function v(e,r){return O(e.parseTree,r)}function D(e){return"column-reference"===e?.parseTree.type}function O(e,r){if(null==e)return!1;switch(e.type){case"when-clause":return O(e.operand,r)||O(e.value,r);case"case-expression":for(const t of e.clauses)if(O(t,r))return!0;return!("simple"!==e.format||!O(e.operand,r))||!(null===e.else||!O(e.else,r));case"parameter":case"null":case"boolean":case"date":case"timestamp":case"time":case"string":case"number":return!1;case"expression-list":for(const t of e.value)if(O(t,r))return!0;return!1;case"unary-expression":return O(e.expr,r);case"binary-expression":return O(e.left,r)||O(e.right,r);case"column-reference":return r.toLowerCase()===e.column.toLowerCase();case"function":return O(e.args,r)}return!1}function R(e){let r="";return r+=e.period.toUpperCase(),r}function F(e,r,t){let a="";return a="interval-period"===r.type?R(r):R(r.start)+" TO "+R(r.end),"INTERVAL "+t+" "+e+" "+a}export{S as arcadeDateOnlyToSqlString,T as arcadeDateToSqlString,g as combine,F as convertIntervalToSql,D as isSingleField,w as makeSqlFromDateTimeParameter,E as makeTimeString,A as makeToday,L as predictType,m as reformulateWithoutField,v as scanForField,p as toWhereClause,f as toWhereClauseFromTree,y as translateFunctionToDatabaseSpecific};
