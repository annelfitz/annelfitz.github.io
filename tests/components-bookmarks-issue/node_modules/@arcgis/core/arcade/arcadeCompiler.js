/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{ArcadeModule as e}from"./ArcadeModule.js";import{ArcadeModuleLoader as n}from"./ArcadeModuleLoader.js";import t from"./Dictionary.js";import{ArcadeExecutionError as o,ExecutionErrorCodes as r,ArcadeCompilationError as l,ArcadeUncompilableError as a}from"./executionError.js";import s from"./Feature.js";import{NativeFunction as i,ArcadeFunction as u,ScopeMarshalledFunction as c,wrapModuleScopedResponse as p}from"./FunctionWrapper.js";import{i as m,x as g,y as f,z as d,A as h,B as y,C as b,D as w,b as S,o as v,q as x,r as F,c as M,v as $,p as C,j as A,a as I,g as _,E as O,F as k,G as E}from"../chunks/languageUtils.js";import{addFunctionDeclaration as G}from"./treeAnalysis.js";import{A as B}from"../chunks/array.js";import{registerFunctions as N}from"./functions/date.js";import{registerFunctions as j,geometryMember as L}from"./functions/geometry.js";import{registerFunctions as R}from"./functions/geomsync.js";import{registerFunctions as D}from"./functions/maths.js";import{registerFunctions as U}from"./functions/stats.js";import{registerFunctions as P}from"./functions/string.js";import{isPromiseLike as Z}from"../core/promiseUtils.js";import K from"../geometry/Geometry.js";import T from"../geometry/SpatialReference.js";class q extends u{constructor(e,n){super(),this.paramCount=n,this.fn=e}createFunction(e){return(...n)=>{if(n.length!==this.paramCount)throw new o(e,r.WrongNumberOfParameters,null);return this.fn(...n)}}call(e,n){return this.fn(...n.arguments)}marshalledCall(e,n,t,o){return o(e,n,((n,r,l)=>{l=l.map((n=>!m(n)||n instanceof c?n:p(n,e,o)));const a=this.call(t,{arguments:l});return Z(a)?a.then((e=>p(e,t,o))):a}))}}function W(e,n){const t=[];for(let o=0;o<n.arguments.length;o++)t.push(V(e,n.arguments[o]));return t}function z(e,n,t){try{return t(e,null,n.arguments)}catch(o){throw o}}function V(e,n){try{switch(n.type){case"EmptyStatement":return"lc.voidOperation";case"VariableDeclarator":return me(e,n);case"VariableDeclaration":return pe(e,n);case"BlockStatement":case"Program":return le(e,n);case"FunctionDeclaration":return ce(e,n);case"ImportDeclaration":return se(e,n);case"ExportNamedDeclaration":return ie(e,n);case"ReturnStatement":return ae(e,n);case"IfStatement":return re(e,n);case"ExpressionStatement":return te(e,n);case"AssignmentExpression":return ne(e,n);case"UpdateExpression":return X(e,n);case"BreakStatement":return"break";case"ContinueStatement":return"continue";case"TemplateLiteral":return he(e,n);case"TemplateElement":return JSON.stringify(n.value?n.value.cooked:"");case"ForStatement":return Q(e,n);case"ForInStatement":return H(e,n);case"WhileStatement":return ee(e,n);case"Identifier":return we(e,n);case"MemberExpression":return ge(e,n);case"Literal":return null===n.value||void 0===n.value?"null":JSON.stringify(n.value);case"CallExpression":return Se(e,n);case"UnaryExpression":return fe(e,n);case"BinaryExpression":return ye(e,n);case"LogicalExpression":return be(e,n);case"ArrayExpression":return de(e,n);case"ObjectExpression":return J(e,n);case"Property":return Y(e,n);case"Array":throw new l(e,r.NeverReach,n);default:throw new l(e,r.Unrecognized,n)}}catch(t){throw t}}function J(e,n){let t="lang.dictionary([";for(let o=0;o<n.properties.length;o++){const r=n.properties[o];ue(r.key.name);o>0&&(t+=","),t+="lang.strCheck("+("Identifier"===r.key.type?"'"+r.key.name+"'":V(e,r.key))+",'ObjectExpression'),lang.aCheck("+V(e,r.value)+", 'ObjectExpression')"}return t+="])",t}function Y(e,n){throw new l(e,r.NeverReach,n)}function H(e,n){const t=Ae(e),o=Ae(e),r=Ae(e);let l="var "+t+" = "+V(e,n.right)+";\n";"VariableDeclaration"===n.left.type&&(l+=V(e,n.left));let a="VariableDeclaration"===n.left.type?n.left.declarations[0].id.name:n.left.name;a=a.toLowerCase(),ue(a);let s="";null!==e.localScope&&(void 0!==e.localScope[a]?s="lscope['"+a+"']":void 0!==e.localScope._SymbolsMap[a]&&(s="lscope['"+e.localScope._SymbolsMap[a]+"']"));let i="";if(""===s)if(void 0!==e.globalScope[a])s="gscope['"+a+"']";else if(void 0!==e.globalScope._SymbolsMap[a])s="gscope['"+e.globalScope._SymbolsMap[a]+"']";else if(null!==e.localScope)if(e.undeclaredGlobalsInFunctions.has(a))s="gscope['"+e.undeclaredGlobalsInFunctions.get(a).manglename+"']",i=e.undeclaredGlobalsInFunctions.get(a).manglename;else{const t={manglename:Ce(e),node:n.left};e.undeclaredGlobalsInFunctions.set(a,t),s="gscope['"+t.manglename+"']",i=t.manglename}return i&&(l+="lang.chkAssig('"+i+"',runtimeCtx); \n"),l+="if ("+t+"===null) {  lastStatement = lc.voidOperation; }\n ",l+="else if (lc.isArray("+t+") || lc.isString("+t+")) {",l+="var "+o+"="+t+".length; \n",l+="for(var "+r+"=0; "+r+"<"+o+"; "+r+"++) {\n",l+=s+"="+r+";\n",l+=V(e,n.body),l+="\n}\n",l+=" lastStatement = lc.voidOperation; \n",l+=" \n}\n",l+="else if (lc.isImmutableArray("+t+")) {",l+="var "+o+"="+t+".length(); \n",l+="for(var "+r+"=0; "+r+"<"+o+"; "+r+"++) {\n",l+=s+"="+r+";\n",l+=V(e,n.body),l+="\n}\n",l+=" lastStatement = lc.voidOperation; \n",l+=" \n}\n",l+="else if (( "+t+" instanceof lang.Dictionary) || ( "+t+" instanceof lang.Feature)) {",l+="var "+o+"="+t+".keys(); \n",l+="for(var "+r+"=0; "+r+"<"+o+".length; "+r+"++) {\n",l+=s+"="+o+"["+r+"];\n",l+=V(e,n.body),l+="\n}\n",l+=" lastStatement = lc.voidOperation; \n",l+=" \n}\n",e.isAsync&&(l+="else if (lc.isFeatureSet("+t+")) {",l+="var "+o+"="+t+".iterator(runtimeCtx.abortSignal); \n",l+="for(var "+r+"=lang. graphicToFeature( yield "+o+".next(),"+t+", runtimeCtx); "+r+"!=null; "+r+"=lang. graphicToFeature( yield "+o+".next(),"+t+", runtimeCtx)) {\n",l+=s+"="+r+";\n",l+=V(e,n.body),l+="\n}\n",l+=" lastStatement = lc.voidOperation; \n",l+=" \n}\n"),l+="else { lastStatement = lc.voidOperation; } \n",l}function Q(e,n){let t="lastStatement = lc.voidOperation; \n";null!==n.init&&(t+=V(e,n.init)+"; ");const o=Ae(e),l=Ae(e);return t+="var "+o+" = true; ",t+="\n do { ",null!==n.update&&(t+=" if ("+o+"===false) {\n "+V(e,n.update)+"  \n}\n "+o+"=false; \n"),null!==n.test&&(t+="var "+l+" = "+V(e,n.test)+"; ",t+="if ("+l+"===false) { break; } else if ("+l+"!==true) { lang.error('"+r.BooleanConditionRequired+"');   }\n"),t+=V(e,n.body),null!==n.update&&(t+="\n "+V(e,n.update)),t+="\n"+o+" = true; \n} while(true);  lastStatement = lc.voidOperation; ",t}function X(e,n){let t=null,l="";if("MemberExpression"===n.argument.type)return t=V(e,n.argument.object),!0===n.argument.computed?l=V(e,n.argument.property):(l="'"+n.argument.property.name+"'",ue(n.argument.property.name)),"lang.memberupdate("+t+","+l+",'"+n.operator+"',"+n.prefix+")";if(t=n.argument.name.toLowerCase(),ue(t),null!==e.localScope){if(void 0!==e.localScope[t])return"lang.update(lscope, '"+t+"','"+n.operator+"',"+n.prefix+")";if(void 0!==e.localScope._SymbolsMap[t])return"lang.update(lscope, '"+e.localScope._SymbolsMap[t]+"','"+n.operator+"',"+n.prefix+")"}if(void 0!==e.globalScope[t])return"lang.update(gscope, '"+t+"','"+n.operator+"',"+n.prefix+")";if(void 0!==e.globalScope._SymbolsMap[t])return"lang.update(gscope, '"+e.globalScope._SymbolsMap[t]+"','"+n.operator+"',"+n.prefix+")";if(null!==e.localScope){if(e.undeclaredGlobalsInFunctions.has(t))return"lang.update(gscope,lang.chkAssig( '"+e.undeclaredGlobalsInFunctions.get(t).manglename+"',runtimeCtx),'"+n.operator+"',"+n.prefix+")";const o={manglename:Ce(e),node:n.argument};return e.undeclaredGlobalsInFunctions.set(t,o),"lang.update(gscope, lang.chkAssig('"+o.manglename+"',runtimeCtx),'"+n.operator+"',"+n.prefix+")"}throw new o(e,r.InvalidIdentifier,n)}function ee(e,n){let t="lastStatement = lc.voidOperation; \n";const o=Ae(e);return t+=`\n  var ${o} = true;\n    do {\n      ${o} = ${V(e,n.test)};\n      if (${o}==false) {\n        break;\n      }\n      if (${o}!==true) {\n        lang.error('${r.BooleanConditionRequired}');\n      }\n      ${V(e,n.body)}\n    }\n    while (${o} !== false);\n    lastStatement = lc.voidOperation;\n  `,t}function ne(e,n){const t=V(e,n.right);let l=null,a="";if("MemberExpression"===n.left.type)return l=V(e,n.left.object),!0===n.left.computed?a=V(e,n.left.property):(a="'"+n.left.property.name+"'",ue(n.left.property.name)),"lang.assignmember("+l+","+a+",'"+n.operator+"',"+t+")";if(l=n.left.name.toLowerCase(),ue(l),null!==e.localScope){if(void 0!==e.localScope[l])return"lscope['"+l+"']=lang.assign("+t+",'"+n.operator+"', lscope['"+l+"'])";if(void 0!==e.localScope._SymbolsMap[l])return"lscope['"+e.localScope._SymbolsMap[l]+"']=lang.assign("+t+",'"+n.operator+"', lscope['"+e.localScope._SymbolsMap[l]+"'])"}if(void 0!==e.globalScope[l])return"gscope['"+l+"']=lang.assign("+t+",'"+n.operator+"', gscope['"+l+"'])";if(void 0!==e.globalScope._SymbolsMap[l])return"gscope['"+e.globalScope._SymbolsMap[l]+"']=lang.assign("+t+",'"+n.operator+"', gscope['"+e.globalScope._SymbolsMap[l]+"'])";if(null!==e.localScope){if(e.undeclaredGlobalsInFunctions.has(l))return"gscope[lang.chkAssig('"+e.undeclaredGlobalsInFunctions.get(l).manglename+"',runtimeCtx)]=lang.assign("+t+",'"+n.operator+"', gscope['"+e.undeclaredGlobalsInFunctions.get(l).manglename+"'])";const o={manglename:Ce(e),node:n.argument};return e.undeclaredGlobalsInFunctions.set(l,o),"gscope[lang.chkAssig('"+o.manglename+"',runtimeCtx)]=lang.assign("+t+",'"+n.operator+"', gscope['"+o.manglename+"'])"}throw new o(e,r.InvalidIdentifier,n)}function te(e,n){return"AssignmentExpression"===n.expression.type?"lastStatement = lc.voidOperation; "+V(e,n.expression)+"; \n ":(n.expression.type,"lastStatement = "+V(e,n.expression)+"; ")}function oe(e,n){return"BlockStatement"===n.type?V(e,n):"ReturnStatement"===n.type||"BreakStatement"===n.type||"ContinueStatement"===n.type?V(e,n)+"; ":"UpdateExpression"===n.type?"lastStatement = "+V(e,n)+"; ":"ExpressionStatement"===n.type?V(e,n):"ObjectExpression"===n.type?"lastStatement = "+V(e,n)+"; ":V(e,n)+"; "}function re(e,n){if("AssignmentExpression"===n.test.type||"UpdateExpression"===n.test.type)throw new l(e,r.BooleanConditionRequired,n);return`if (lang.mustBoolean(${V(e,n.test)}, runtimeCtx) === true) {\n    ${oe(e,n.consequent)}\n  } `+(null!==n.alternate?"IfStatement"===n.alternate.type?" else "+re(e,n.alternate):` else {\n      ${oe(e,n.alternate)}\n    }\n`:" else {\n      lastStatement = lc.voidOperation;\n    }\n")}function le(e,n){let t="";for(let o=0;o<n.body.length;o++)"EmptyStatement"!==n.body[o].type&&("ReturnStatement"===n.body[o].type||"BreakStatement"===n.body[o].type||"ContinueStatement"===n.body[o].type?t+=V(e,n.body[o])+"; \n":"UpdateExpression"===n.body[o].type||"ObjectExpression"===n.body[o].type?t+="lastStatement = "+V(e,n.body[o])+"; \n":t+=V(e,n.body[o])+" \n");return t}function ae(e,n){if(null===n.argument)return"return lc.voidOperation";return"return "+V(e,n.argument)}function se(e,n){const t=n.specifiers[0].local.name.toLowerCase();ue(t);const o=e.libraryResolver?.loadLibrary(t),r=Ce(e);void 0===e.moduleFactory[o.uri]&&(e.moduleFactory[o.uri]=Ke(o.syntax,{interceptor:e.interceptor,services:e.services,moduleFactory:e.moduleFactory,lrucache:e.lrucache,timeZone:e.timeZone??null,libraryResolver:e.libraryResolver,customfunctions:e.customfunctions,vars:{}},e.isAsync)),e.moduleFactoryMap[r]=o.uri;let l="";if(l=e.isAsync?"(yield lang.loadModule('"+r+"', runtimeCtx) ); ":"lang.loadModule('"+r+"', runtimeCtx); ",void 0!==e.globalScope[t])return"gscope['"+t+"']="+l;if(void 0!==e.globalScope._SymbolsMap[t])return"gscope['"+e.globalScope._SymbolsMap[t]+"']="+l;let a="";return e.undeclaredGlobalsInFunctions.has(t)?(a=e.undeclaredGlobalsInFunctions.get(t).manglename,e.undeclaredGlobalsInFunctions.delete(t)):a=Ce(e),e.globalScope._SymbolsMap[t]=a,e.mangleMap[t]=a,"gscope[lang.setAssig('"+a+"', runtimeCtx)]="+l}function ie(e,n){const t=V(e,n.declaration);if("FunctionDeclaration"===n.declaration.type)e.exports[n.declaration.id.name.toLowerCase()]="function";else if("VariableDeclaration"===n.declaration.type)for(const o of n.declaration.declarations)e.exports[o.id.name.toLowerCase()]="variable";return t}function ue(e){if("iif"===e)throw new a;if("decode"===e)throw new a;if("when"===e)throw new a;if("defaultvalue"===e)throw new a}function ce(e,n){const t=n.id.name.toLowerCase();ue(t);let o="",r=!1;void 0!==e.globalScope[t]?o=t:void 0!==e.globalScope._SymbolsMap[t]?o=e.globalScope._SymbolsMap[t]:e.undeclaredGlobalsInFunctions.has(t)?(o=e.undeclaredGlobalsInFunctions.get(t).manglename,e.globalScope._SymbolsMap[t]=o,e.mangleMap[t]=o,e.undeclaredGlobalsInFunctions.delete(t),r=!0):(o=Ce(e),e.globalScope._SymbolsMap[t]=o,e.mangleMap[t]=o);const l={isAsync:e.isAsync,console:e.console,exports:e.exports,undeclaredGlobalsInFunctions:e.undeclaredGlobalsInFunctions,customfunctions:e.customfunctions,moduleFactory:e.moduleFactory,moduleFactoryMap:e.moduleFactoryMap,libraryResolver:e.libraryResolver,lrucache:e.lrucache,interceptor:e.interceptor,services:e.services,symbols:e.symbols,mangleMap:e.mangleMap,localScope:{_SymbolsMap:{}},depthCounter:e.depthCounter,globalScope:e.globalScope};let a="new lang.UserDefinedCompiledFunction( lang.functionDepthchecker(function() { var lastStatement = lc.voidOperation; \n   var lscope = runtimeCtx.localStack[runtimeCtx.localStack.length-1];\n";for(let s=0;s<n.params.length;s++){const t=n.params[s].name.toLowerCase();ue(t);const o=Ce(e);l.localScope._SymbolsMap[t]=o,l.mangleMap[t]=o,a+="lscope['"+o+"']=arguments["+s.toString()+"];\n"}return!0===e.isAsync?(a+="return lang.__awaiter(this, void 0, void 0, function* () {\n",a+=le(l,n.body)+"\n return lastStatement; ",a+="});  }",a+=", runtimeCtx),"+n.params.length+")",a+="\n lastStatement = lc.voidOperation; \n"):(a+=le(l,n.body)+"\n return lastStatement; }, runtimeCtx),"+n.params.length+")",a+="\n lastStatement = lc.voidOperation; \n"),r?"gscope[lang.setAssig('"+o+"', runtimeCtx)]="+a:"gscope['"+o+"']="+a}function pe(e,n){const t=[];for(let o=0;o<n.declarations.length;o++)t.push(V(e,n.declarations[o]));return t.join("\n")+" \n lastStatement=  lc.voidOperation; \n"}function me(e,n){let t=null===n.init?null:V(e,n.init);t===y&&(t=null);const o=n.id.name.toLowerCase();if(ue(o),null!==e.localScope){if(void 0!==e.localScope[o])return"lscope['"+o+"']="+t+"; ";if(void 0!==e.localScope._SymbolsMap[o])return"lscope['"+e.localScope._SymbolsMap[o]+"']="+t+"; ";{const n=Ce(e);return e.localScope._SymbolsMap[o]=n,e.mangleMap[o]=n,"lscope['"+n+"']="+t+"; "}}if(void 0!==e.globalScope[o])return"gscope['"+o+"']="+t+"; ";if(void 0!==e.globalScope._SymbolsMap[o])return"gscope['"+e.globalScope._SymbolsMap[o]+"']="+t+"; ";if(e.undeclaredGlobalsInFunctions.has(o)){const n=e.undeclaredGlobalsInFunctions.get(o).manglename;return e.globalScope._SymbolsMap[o]=n,e.mangleMap[o]=n,e.undeclaredGlobalsInFunctions.delete(o),"gscope[lang.setAssig('"+n+"', runtimeCtx)]="+t+"; "}const r=Ce(e);return e.globalScope._SymbolsMap[o]=r,e.mangleMap[o]=r,"gscope['"+r+"']="+t+"; "}function ge(e,n){try{let t;return!0===n.computed?t=V(e,n.property):(t="'"+n.property.name+"'",ue(n.property.name)),"lang.member("+V(e,n.object)+","+t+")"}catch(t){throw t}}function fe(e,n){try{return"lang.unary("+V(e,n.argument)+",'"+n.operator+"')"}catch(t){throw t}}function de(e,n){try{const t=[];for(let o=0;o<n.elements.length;o++)"Literal"===n.elements[o].type?t.push(V(e,n.elements[o])):t.push("lang.aCheck("+V(e,n.elements[o])+",'ArrayExpression')");return"["+t.join(",")+"]"}catch(t){throw t}}function he(e,n){try{const t=[];let o=0;for(const r of n.quasis)t.push(r.value?JSON.stringify(r.value.cooked):JSON.stringify("")),!1===r.tail&&(t.push(n.expressions[o]?"lang.castString(lang.aCheck("+V(e,n.expressions[o])+", 'TemplateLiteral'))":""),o++);return"(["+t.join(",")+"]).join('')"}catch(t){throw t}}function ye(e,n){try{return"lang.binary("+V(e,n.left)+","+V(e,n.right)+",'"+n.operator+"')"}catch(t){throw t}}function be(e,n){try{if("AssignmentExpression"===n.left.type||"UpdateExpression"===n.left.type)throw new l(e,r.LogicalExpressionOnlyBoolean,n);if("AssignmentExpression"===n.right.type||"UpdateExpression"===n.right.type)throw new l(e,r.LogicalExpressionOnlyBoolean,n);if("&&"===n.operator||"||"===n.operator)return"(lang.logicalCheck("+V(e,n.left)+") "+n.operator+" lang.logicalCheck("+V(e,n.right)+"))";throw new l(null,r.LogicExpressionOrAnd,null)}catch(t){throw t}}function we(e,n){try{const t=n.name.toLowerCase();if(ue(t),null!==e.localScope){if(void 0!==e.localScope[t])return"lscope['"+t+"']";if(void 0!==e.localScope._SymbolsMap[t])return"lscope['"+e.localScope._SymbolsMap[t]+"']"}if(void 0!==e.globalScope[t])return"gscope['"+t+"']";if(void 0!==e.globalScope._SymbolsMap[t])return"gscope['"+e.globalScope._SymbolsMap[t]+"']";if(null!==e.localScope){if(e.undeclaredGlobalsInFunctions.has(t))return"gscope[lang.chkAssig('"+e.undeclaredGlobalsInFunctions.get(t).manglename+"',runtimeCtx)]";const o={manglename:Ce(e),node:n.argument};return e.undeclaredGlobalsInFunctions.set(t,o),"gscope[lang.chkAssig('"+o.manglename+"',runtimeCtx)]"}throw new l(e,r.InvalidIdentifier,n)}catch(t){throw t}}function Se(e,n){try{if("MemberExpression"===n.callee.type){let t;!0===n.callee.computed?t=V(e,n.callee.property):(t="'"+n.callee.property.name+"'",ue(n.callee.property.name));let o="[";for(let r=0;r<n.arguments.length;r++)r>0&&(o+=", "),o+=V(e,n.arguments[r]);return o+="]",e.isAsync?"(yield lang.callModuleFunction("+V(e,n.callee.object)+","+o+","+t+",runtimeCtx))":"lang.callModuleFunction("+V(e,n.callee.object)+","+o+","+t+",runtimeCtx)"}if("Identifier"!==n.callee.type)throw new l(e,r.FunctionNotFound,n);const t=n.callee.name.toLowerCase();if("iif"===t)return ve(e,n);if("when"===t)return Fe(e,n);if("defaultvalue"===t)return xe(e,n);if("decode"===t)return Me(e,n);let o="";if(null!==e.localScope&&(void 0!==e.localScope[t]?o="lscope['"+t+"']":void 0!==e.localScope._SymbolsMap[t]&&(o="lscope['"+e.localScope._SymbolsMap[t]+"']")),""===o)if(void 0!==e.globalScope[t])o="gscope['"+t+"']";else if(void 0!==e.globalScope._SymbolsMap[t])o="gscope['"+e.globalScope._SymbolsMap[t]+"']";else if(null!==e.localScope)if(e.undeclaredGlobalsInFunctions.has(t))o="gscope[lang.chkAssig('"+e.undeclaredGlobalsInFunctions.get(t).manglename+"',runtimeCtx)]";else{const r={manglename:Ce(e),node:n.argument};e.undeclaredGlobalsInFunctions.set(t,r),o="gscope[lang.chkAssig('"+r.manglename+"',runtimeCtx)]"}if(""!==o){let t="[";for(let o=0;o<n.arguments.length;o++)o>0&&(t+=", "),t+=V(e,n.arguments[o]);return t+="]",e.isAsync?"(yield lang.callfunc("+o+","+t+",runtimeCtx) )":"lang.callfunc("+o+","+t+",runtimeCtx)"}throw new l(e,r.FunctionNotFound,n)}catch(t){throw t}}function ve(e,n){try{if(3!==n.arguments.length)throw new l(e,r.WrongNumberOfParameters,n);const t=Ae(e);return`${e.isAsync?"(yield (function() { \n return lang.__awaiter(this, void 0, void 0, function* () {":"function() {"}\n        var ${t} = ${V(e,n.arguments[0])};\n\n        if (${t} === true) {\n          return  ${V(e,n.arguments[1])};\n        }\n        else if (${t} === false) {\n          return ${V(e,n.arguments[2])};\n        }\n        else {\n          lang.error('ExecutionErrorCodes.BooleanConditionRequired');\n        }\n      ${e.isAsync?"})}()))":"}()"}`}catch(t){throw t}}function xe(e,n){try{if(n.arguments.length<2||n.arguments.length>3)throw new l(e,r.WrongNumberOfParameters,n);const t=Ae(e),o=Ae(e),a=Ae(e),s=Ae(e);return 3===n.arguments.length?`${e.isAsync?"(yield (function() { \n return lang.__awaiter(this, void 0, void 0, function* () {":"function() {"}\n      var ${t} = ${V(e,n.arguments[0])};\n      var ${o} = ${V(e,n.arguments[1])};\n      var ${a} = [];\n      if (lang.isImmutableArray(${o})) {\n        ${a} = ${o}.toArray();\n      } else if (lang.isArray(${o})) {\n        ${a} = ${o};\n      } else {\n        lang.error('${r.InvalidParameter}');\n      }\n      if (${t} === null) {\n        return ${V(e,n.arguments[2])};\n      }\n      for (var ${s} of ${a}) {\n        if (lang.isFeature(${t})) {\n          if (lang.isString(${s}) === false) {\n            return ${V(e,n.arguments[2])};\n          }\n          if (!${t}.hasField(${s})) {\n            return ${V(e,n.arguments[2])};\n          }\n          ${t} = ${t}.field(${s});\n        } else if (lang.isDictionary(${t})) {\n          if (lang.isString(${s}) === false) {\n            return  ${V(e,n.arguments[2])};\n          }\n          if (!${t}.hasField(${s})) {\n            return  ${V(e,n.arguments[2])};\n          }\n          ${t} = ${t}.field(${s});\n        } else if (lang.isGeometry(${t})) {\n          if (lang.isString(${s}) === false) {\n            return ${V(e,n.arguments[2])};\n          }\n          ${t} = lang.geometryMember(${t}, ${s}, null, null, 2);\n          if (${t} === null) {\n            return  ${V(e,n.arguments[2])};\n          }\n          if (${t} && ${t}.keystate === "notfound") {\n            return  ${V(e,n.arguments[2])};\n          }\n        } else if (lang.isArray(${t})) {\n          if (lang.isNumber(${s}) === false) {\n            return  ${V(e,n.arguments[2])};\n          }\n          ${t} = ${t}[${s}];\n          if (${t} === null || ${t} === undefined) {\n            return ${V(e,n.arguments[2])};\n          }\n        } else if (lang.isImmutableArray(${t})) {\n          if (lang.isNumber(${s}) === false) {\n            return  ${V(e,n.arguments[2])};\n          }\n          ${t} = ${t}.get(${s});\n          if (${t} === null || ${t} === undefined) {\n            return  ${V(e,n.arguments[2])};\n          }\n        } else {\n          return  ${V(e,n.arguments[2])};\n        }\n      }\n      return ${t};\n      ${e.isAsync?"})}()))":"}()"}`:`${e.isAsync?"(yield (function() { \n return lang.__awaiter(this, void 0, void 0, function* () {":"function() {"}\n        var ${t} = ${V(e,n.arguments[0])};\n        if (${t} === null) {\n          return  ${V(e,n.arguments[1])};\n        }\n        if (${t} === "") {\n          return  ${V(e,n.arguments[1])};\n        }\n        if (${t} === undefined) {\n          return  ${V(e,n.arguments[1])};\n        }\n        return ${t};\n      ${e.isAsync?"})}()))":"}()"}`}catch(t){throw t}}function Fe(e,n){try{if(n.arguments.length<3)throw new l(e,r.WrongNumberOfParameters,n);if(n.arguments.length%2==0)throw new l(e,r.WrongNumberOfParameters,n);const t=Ae(e);let o="var ";for(let r=0;r<n.arguments.length-1;r+=2)o+=`${t} = lang.mustBoolean(${V(e,n.arguments[r])}, runtimeCtx);\n      if (${t} === true ) {\n        return ${V(e,n.arguments[r+1])}\n      }\n`;return`${e.isAsync?"(yield (function() { \n return lang.__awaiter(this, void 0, void 0, function* () {":"function() {"}\n        ${o}\n        return ${V(e,n.arguments[n.arguments.length-1])}\n        ${e.isAsync?"})}()))":"}()"}`}catch(t){throw t}}function Me(e,n){try{if(n.arguments.length<2)throw new l(e,r.WrongNumberOfParameters,n);if(2===n.arguments.length)return`(${V(e,n.arguments[1])})`;if((n.arguments.length-1)%2==0)throw new l(e,r.WrongNumberOfParameters,n);const t=Ae(e),o=Ae(e);let a="var ";for(let r=1;r<n.arguments.length-1;r+=2)a+=`${o} = ${V(e,n.arguments[r])};\n      if (lang.binary(${o}, ${t}, "==") === true ) {\n        return ${V(e,n.arguments[r+1])}\n      }\n`;return`${e.isAsync?"(yield (function() { \n return lang.__awaiter(this, void 0, void 0, function* () {":"function() {"}\n        var ${t} = ${V(e,n.arguments[0])};\n        ${a}\n        return ${V(e,n.arguments[n.arguments.length-1])}\n        ${e.isAsync?"})}()))":"}()"}`}catch(t){throw t}}const $e={};function Ce(e){return e.symbols.symbolCounter++,"_T"+e.symbols.symbolCounter.toString()}function Ae(e){return e.symbols.symbolCounter++,"_Tvar"+e.symbols.symbolCounter.toString()}N($e,z),P($e,z),D($e,z),j($e,z),U($e,z),$e.iif=function(e,n){try{return z(e,n,((t,l,a)=>{throw new o(e,r.Unrecognized,n)}))}catch(t){throw t}},$e.decode=function(e,n){try{return z(e,n,((t,l,a)=>{throw new o(e,r.Unrecognized,n)}))}catch(t){throw t}},$e.when=function(e,n){try{return z(e,n,((t,l,a)=>{throw new o(e,r.Unrecognized,n)}))}catch(t){throw t}},$e.defaultvalue=function(e,n){try{return z(e,n,((t,l,a)=>{throw new o(e,r.Unrecognized,n)}))}catch(t){throw t}};const Ie={};for(const Te in $e)Ie[Te]=new i($e[Te]);R($e,z);for(const Te in $e)$e[Te]=new i($e[Te]);const _e=function(){};_e.prototype=$e;const Oe=function(){};function ke(e,n,t){const o={};e||(e={}),t||(t={}),o._SymbolsMap={},o.textformatting=1,o.infinity=1,o.pi=1;for(const r in n)o[r]=1;for(const r in t)o[r]=1;for(const r in e)o[r]=1;return o}function Ee(e,n,o,r){const l=o?new Oe:new _e;e||(e={}),n||(n={});const a=new t({newline:"\n",tab:"\t",singlequote:"'",doublequote:'"',forwardslash:"/",backwardslash:"\\"});a.immutable=!1,l._SymbolsMap={textformatting:1,infinity:1,pi:1},l.textformatting=a,l.infinity=Number.POSITIVE_INFINITY,l.pi=Math.PI;for(const t in n)l[t]=n[t],l._SymbolsMap[t]=1;for(const t in e)l._SymbolsMap[t]=1,e[t]&&"esri.Graphic"===e[t].declaredClass?l[t]=s.createFromGraphic(e[t],r??null):l[t]=e[t];return l}Oe.prototype=Ie;const Ge={fixSpatialReference:g,parseArguments:W,standardFunction:z};function Be(e,n){const t={mode:n,compiled:!0,functions:{},signatures:[],standardFunction:z,standardFunctionAsync:z,evaluateIdentifier:je};for(let o=0;o<e.length;o++)e[o].registerFunctions(t);if("sync"===n){for(const e in t.functions)$e[e]=new i(t.functions[e]),_e.prototype[e]=$e[e];for(let e=0;e<t.signatures.length;e++)G(t.signatures[e],"sync")}else{for(const e in t.functions)Ie[e]=new i(t.functions[e]),Oe.prototype[e]=Ie[e];for(let e=0;e<t.signatures.length;e++)G(t.signatures[e],"async")}}function Ne(e,n){return e(n)}function je(e,n){const t=n.name;if("_SymbolsMap"===t)throw new o(e,r.InvalidIdentifier,null);if(e.localStack.length>0){if("_t"!==t.substr(0,2).toLowerCase()&&void 0!==e.localStack[e.localStack.length-1][t])return e.localStack[e.localStack.length-1][t];const n=e.mangleMap[t];if(void 0!==n&&void 0!==e.localStack[e.localStack.length-1][n])return e.localStack[e.localStack.length-1][n]}if("_t"!==t.substr(0,2).toLowerCase()&&void 0!==e.globalScope[t])return e.globalScope[t];if(1===e.globalScope._SymbolsMap[t])return e.globalScope[t];const l=e.mangleMap[t];return void 0!==l?e.globalScope[l]:void 0}Be([B],"sync"),Be([B],"async");let Le=0;const Re={isNumber:e=>S(e),isArray:e=>v(e),isImmutableArray:e=>x(e),isFeature:e=>F(e),isString:e=>M(e),isDictionary:e=>$(e),isGeometry:e=>C(e),geometryMember:(e,n,t,o,r=1)=>L(e,n,t,o,r),error(e){throw new o(null,e,null)},__awaiter:(e,n,t,o)=>new Promise(((t,r)=>{function l(e){try{s(o.next(e))}catch(n){r(n)}}function a(e){try{s(o.throw(e))}catch(n){r(n)}}function s(e){e.done?t(e.value):e.value?.then?e.value.then(l,a):(Le++,Le%100==0?setTimeout((()=>{Le=0,l(e.value)}),0):l(e.value))}s((o=o.apply(e,n||[])).next())})),functionDepthchecker:(e,n)=>function(){if(n.depthCounter.depth++,n.localStack.push([]),n.depthCounter.depth>64)throw new o(null,r.MaximumCallDepth,null);const t=e.apply(this,arguments);return Z(t)?t.then((e=>(n.depthCounter.depth--,n.localStack.length=n.localStack.length-1,e))):(n.depthCounter.depth--,n.localStack.length=n.localStack.length-1,t)},chkAssig(e,n){if(void 0===n.gdefs[e])throw new o(n,r.InvalidIdentifier,null);return e},mustBoolean(e,n){if(!0===e||!1===e)return e;throw new o(n,r.BooleanConditionRequired,null)},setAssig:(e,n)=>(n.gdefs[e]=1,e),castString:e=>A(e),aCheck(e,n){if(m(e)){if("ArrayExpression"===n)throw new o(null,r.NoFunctionInArray,null);if("ObjectExpression"===n)throw new o(null,r.NoFunctionInDictionary,null);throw new o(null,r.NoFunctionInTemplateLiteral,null)}return e===y?null:e},Dictionary:t,Feature:s,UserDefinedCompiledFunction:q,dictionary(e){const n={},l=new Map;for(let t=0;t<e.length;t+=2){if(m(e[t+1]))throw new o(null,r.NoFunctionInDictionary,null);if(!1===M(e[t]))throw new o(null,r.KeyMustBeString,null);let a=e[t].toString();const s=a.toLowerCase();l.has(s)?a=l.get(s):l.set(s,a),e[t+1]===y?n[a]=null:n[a]=e[t+1]}const a=new t(n);return a.immutable=!1,a},strCheck(e){if(!1===M(e))throw new o(null,r.KeyMustBeString,null);return e},unary(e,n){if(I(e)){if("!"===n)return!e;if("-"===n)return-1*_(e);if("+"===n)return 1*_(e);if("~"===n)return~_(e);throw new o(null,r.UnsupportedUnaryOperator,null)}if("-"===n)return-1*_(e);if("+"===n)return 1*_(e);if("~"===n)return~_(e);throw new o(null,r.UnsupportedUnaryOperator,null)},logicalCheck(e){if(!1===I(e))throw new o(null,r.LogicExpressionOrAnd,null);return e},logical(e,n,t){if(I(e)&&I(n))switch(t){case"||":return e||n;case"&&":return e&&n;default:throw new o(null,r.LogicExpressionOrAnd,null)}throw new o(null,r.LogicExpressionOrAnd,null)},binary(e,n,t){switch(t){case"|":case"<<":case">>":case">>>":case"^":case"&":return E(_(e),_(n),t);case"==":case"=":return k(e,n);case"!=":return!k(e,n);case"<":case">":case"<=":case">=":return O(e,n,t);case"+":return M(e)||M(n)?A(e)+A(n):_(e)+_(n);case"-":return _(e)-_(n);case"*":return _(e)*_(n);case"/":return _(e)/_(n);case"%":return _(e)%_(n);default:throw new o(null,r.UnsupportedOperator,null)}},assign(e,n,t){switch(n){case"=":return e===y?null:e;case"/=":return _(t)/_(e);case"*=":return _(t)*_(e);case"-=":return _(t)-_(e);case"+=":return M(t)||M(e)?A(t)+A(e):_(t)+_(e);case"%=":return _(t)%_(e);default:throw new o(null,r.UnsupportedOperator,null)}},update(e,n,t,o){const r=_(e[n]);return e[n]="++"===t?r+1:r-1,!1===o?r:"++"===t?r+1:r-1},graphicToFeature:(e,n,t)=>null===e?null:s.createFromGraphicLikeObject(e.geometry,e.attributes,n,t.timeZone),memberupdate(e,n,l,a){let s;if(v(e)){if(!S(n))throw new o(null,r.ArrayAccessorMustBeNumber,null);if(n<0&&(n=e.length+n),n<0||n>=e.length)throw new o(null,r.OutOfBounds,null);s=_(e[n]),e[n]="++"===l?s+1:s-1}else if(e instanceof t){if(!1===M(n))throw new o(null,r.KeyAccessorMustBeString,null);if(!0!==e.hasField(n))throw new o(null,r.FieldNotFound,null,{key:n});s=_(e.field(n)),e.setField(n,"++"===l?s+1:s-1)}else if(F(e)){if(!1===M(n))throw new o(null,r.KeyAccessorMustBeString,null);if(!0!==e.hasField(n))throw new o(null,r.FieldNotFound,null);s=_(e.field(n)),e.setField(n,"++"===l?s+1:s-1)}else{if(x(e))throw new o(null,r.Immutable,null);if(!(e instanceof Ze))throw new o(null,r.InvalidIdentifier,null);if(!1===M(n))throw new o(null,r.ModuleAccessorMustBeString,null);if(!0!==e.hasGlobal(n))throw new o(null,r.ModuleExportNotFound,null);s=_(e.global(n)),e.setGlobal(n,"++"===l?s+1:s-1)}return!1===a?s:"++"===l?s+1:s-1},assignmember(e,n,l,a){if(v(e)){if(!S(n))throw new o(null,r.ArrayAccessorMustBeNumber,null);if(n<0&&(n=e.length+n),n<0||n>e.length)throw new o(null,r.OutOfBounds,null);if(n===e.length){if("="!==l)throw new o(null,r.OutOfBounds,null);e[n]=this.assign(a,l,e[n])}else e[n]=this.assign(a,l,e[n])}else if(e instanceof t){if(!1===M(n))throw new o(null,r.KeyAccessorMustBeString,null);if(!0===e.hasField(n))e.setField(n,this.assign(a,l,e.field(n)));else{if("="!==l)throw new o(null,r.FieldNotFound,null);e.setField(n,this.assign(a,l,null))}}else if(F(e)){if(!1===M(n))throw new o(null,r.KeyAccessorMustBeString,null);if(!0===e.hasField(n))e.setField(n,this.assign(a,l,e.field(n)));else{if("="!==l)throw new o(null,r.FieldNotFound,null);e.setField(n,this.assign(a,l,null))}}else{if(x(e))throw new o(null,r.Immutable,null);if(!(e instanceof Ze))throw new o(null,r.InvalidIdentifier,null);if(!1===M(n))throw new o(null,r.ModuleAccessorMustBeString,null);if(!e.hasGlobal(n))throw new o(null,r.ModuleExportNotFound,null);e.setGlobal(n,this.assign(a,l,e.global(n)))}},member(e,n){if(null===e)throw new o(null,r.MemberOfNull,null);if(e instanceof t||F(e)){if(M(n))return e.field(n);throw new o(null,r.InvalidMemberAccessKey,null)}if(e instanceof K){if(M(n))return L(e,n,null,null);throw new o(null,r.InvalidMemberAccessKey,null)}if(v(e)){if(S(n)&&isFinite(n)&&Math.floor(n)===n){if(n<0&&(n=e.length+n),n>=e.length||n<0)throw new o(null,r.OutOfBounds,null);return e[n]}throw new o(null,r.InvalidMemberAccessKey,null)}if(M(e)){if(S(n)&&isFinite(n)&&Math.floor(n)===n){if(n<0&&(n=e.length+n),n>=e.length||n<0)throw new o(null,r.OutOfBounds,null);return e[n]}throw new o(null,r.InvalidMemberAccessKey,null)}if(x(e)){if(S(n)&&isFinite(n)&&Math.floor(n)===n){if(n<0&&(n=e.length()+n),n>=e.length()||n<0)throw new o(null,r.OutOfBounds,null);return e.get(n)}throw new o(null,r.InvalidMemberAccessKey,null)}if(e instanceof Ze){if(M(n))return e.global(n);throw new o(null,r.InvalidMemberAccessKey,null)}throw new o(null,r.InvalidMemberAccessKey,null)},callfunc:(e,n,t)=>e.call(t,{arguments:n,preparsed:!0}),loadModule(e,n){const t=n.moduleFactoryMap[e];if(n.moduleSingletons[t])return n.moduleSingletons[t];const o=n.moduleFactory[t]({vars:{},moduleSingletons:n.moduleSingletons,depthCounter:n.depthCounter,console:n.console,abortSignal:n.abortSignal,isAsync:n.isAsync,services:n.services,lrucache:n.lrucache,timeZone:n.timeZone??null,interceptor:n.interceptor},n.spatialReference);return n.moduleSingletons[t]=o,o},callModuleFunction(e,n,t,l){if(!(e instanceof Ze))throw new o(null,r.FunctionNotFound,null);const a=e.global(t);if(!1===m(a))throw new o(null,r.CallNonFunction,null);return a.call(l,{preparsed:!0,arguments:n})}};function De(e){console.log(e)}function Ue(e,t,a=!1){null===t&&(t={vars:{},customfunctions:{}});let s=null;e.usesModules&&(s=new n(null,e.loadedModules));const i={isAsync:a,globalScope:ke(t.vars,a?Ie:$e,t.customfunctions),moduleFactory:{},moduleFactoryMap:{},undeclaredGlobalsInFunctions:new Map,customfunctions:t.customfunctions,libraryResolver:s,localScope:null,mangleMap:{},depthCounter:{depth:1},exports:{},console:De,lrucache:t.lrucache,timeZone:t.timeZone??null,interceptor:t.interceptor,services:t.services,symbols:{symbolCounter:0}};let u=V(i,e);""===u&&(u="lc.voidOperation; "),i.undeclaredGlobalsInFunctions.size>0&&i.undeclaredGlobalsInFunctions.forEach((e=>{throw new l(t,r.InvalidIdentifier,e.node)}));let c="";c=a?"var runtimeCtx=this.prepare(context, true);\n var lc = this.lc;  var lang = this.lang; var gscope=runtimeCtx.globalScope; \nreturn lang.__awaiter(this, void 0, void 0, function* () {\n\n function mainBody() {\n var lastStatement=lc.voidOperation;\n return lang.__awaiter(this, void 0, void 0, function* () {\n"+u+"\n return lastStatement; }); } \n return this.postProcess(yield mainBody()); }); ":"var runtimeCtx=this.prepare(context, false);\n var lc = this.lc;  var lang = this.lang; var gscope=runtimeCtx.globalScope; \n function mainBody() {\n var lastStatement=lc.voidOperation;\n "+u+"\n return lastStatement; } \n return this.postProcess(mainBody()); ";const p=i.moduleFactory,g=i.moduleFactoryMap,S=i.exports,v={};for(const n in S)v[n]=void 0!==i.mangleMap[n]?i.mangleMap[n]:n;const x={lc:f,lang:Re,mangles:i.mangleMap,postProcess(e){if(e instanceof d&&(e=e.value),e instanceof h&&(e=e.value),e===y&&(e=null),e===b)throw new o(null,r.IllegalResult,null);if(e===w)throw new o(null,r.IllegalResult,null);if(m(e))throw new o(null,r.IllegalResult,null);return e},prepare(e,n){let t=e.spatialReference;null==t&&(t=T.WebMercator);const o=Ee(e.vars,e.customfunctions,n,e.timeZone);return{localStack:[],isAsync:n,moduleFactory:p,moduleFactoryMap:g,mangleMap:this.mangles,moduleSingletons:{},exports:S,gdefs:{},exportmangle:v,spatialReference:t,globalScope:o,abortSignal:void 0===e.abortSignal||null===e.abortSignal?{aborted:!1}:e.abortSignal,localScope:null,services:e.services,console:e.console??De,lrucache:e.lrucache,timeZone:e.timeZone??null,interceptor:e.interceptor,symbols:{symbolCounter:0},depthCounter:{depth:1}}}};return new Function("context","spatialReference",c).bind(x)}async function Pe(){return Be([await import("./functions/geomasync.js")],"async"),!0}class Ze extends e{constructor(e){super(null),this.moduleContext=e}hasGlobal(e){return void 0===this.moduleContext.exports[e]&&(e=e.toLowerCase()),void 0!==this.moduleContext.exports[e]}setGlobal(e,n){const t=this.moduleContext.globalScope,l=e.toLowerCase();if(m(n))throw new o(null,r.AssignModuleFunction,null);t[this.moduleContext.exportmangle[l]]=n}global(e){const n=this.moduleContext.globalScope;e=e.toLowerCase();const t=n[this.moduleContext.exportmangle[e]];if(void 0===t)throw new o(null,r.InvalidIdentifier,null);if(m(t)&&!(t instanceof c)){const o=new c;return o.fn=t,o.parameterEvaluator=z,o.context=this.moduleContext,n[this.moduleContext.exportmangle[e]]=o,o}return t}}function Ke(e,t,o=!1){const r={isAsync:o,moduleFactory:t.moduleFactory,moduleFactoryMap:{},libraryResolver:new n(null,e.loadedModules),globalScope:ke(t.vars,o?Ie:$e,t.customfunctions),customfunctions:t.customfunctions,localScope:null,mangleMap:{},undeclaredGlobalsInFunctions:new Map,depthCounter:{depth:1},exports:{},console:De,lrucache:t.lrucache,timeZone:t.timeZone??null,interceptor:t.interceptor,services:t.services,symbols:{symbolCounter:0}};let l=V(r,e);""===l&&(l="lc.voidOperation; ");let a="";a=o?"var runtimeCtx=this.prepare(context, true);\n var lc = this.lc;  var lang = this.lang; var gscope=runtimeCtx.globalScope; \nreturn lang.__awaiter(this, void 0, void 0, function* () {\n\n function mainBody() {\n var lastStatement=lc.voidOperation;\n return lang.__awaiter(this, void 0, void 0, function* () {\n"+l+"\n return lastStatement; }); } \n yield mainBody(); \n return this.prepareModule(runtimeCtx); }); ":"var runtimeCtx=this.prepare(context, false);\n var lc = this.lc;  var lang = this.lang; var gscope=runtimeCtx.globalScope; \n function mainBody() {\n var lastStatement=lc.voidOperation;\n "+l+"\n return lastStatement; } \n mainBody(); \n return this.prepareModule(runtimeCtx); ";const s=r.moduleFactory,i=r.moduleFactoryMap,u=r.exports,c={};for(const n in u)c[n]=void 0!==r.mangleMap[n]?r.mangleMap[n]:n;const p={lc:f,lang:Re,mangles:r.mangleMap,prepareModule:e=>new Ze(e),prepare(e,n){let t=e.spatialReference;null==t&&(t=new T({wkid:102100}));const o=Ee(e.vars,e.customfunctions,n,e.timeZone);return{localStack:[],isAsync:n,exports:u,exportmangle:c,gdefs:{},moduleFactory:s,moduleFactoryMap:i,moduleSingletons:e.moduleSingletons,mangleMap:this.mangles,spatialReference:t,globalScope:o,abortSignal:void 0===e.abortSignal||null===e.abortSignal?{aborted:!1}:e.abortSignal,localScope:null,services:e.services,console:e.console??De,lrucache:e.lrucache,timeZone:e.timeZone??null,interceptor:e.interceptor,symbols:{symbolCounter:0},depthCounter:e.depthCounter}}};return new Function("context","spatialReference",a).bind(p)}export{q as UserDefinedCompiledFunction,Ue as compileScript,Pe as enableAsyncSupport,Ne as executeScript,Be as extend,Ge as functionHelper};
