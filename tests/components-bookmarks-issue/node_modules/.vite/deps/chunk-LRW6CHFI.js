import {
  p
} from "./chunk-VTH4DAHQ.js";
import {
  S
} from "./chunk-SLQA5YBV.js";
import {
  Q
} from "./chunk-UMXV3EBO.js";
import {
  U,
  t3 as t
} from "./chunk-SAYWXQVM.js";
import {
  a
} from "./chunk-JGDJR5EV.js";
import {
  s
} from "./chunk-7RBRCL6S.js";

// node_modules/@arcgis/core/layers/support/associatedFeatureServiceUtils.js
async function s2(e, r) {
  const n = p(e);
  if (!n)
    throw new s("invalid-url", "Invalid scene service url");
  const o = { ...r, sceneServerUrl: n.url.path, layerId: n.sublayer ?? void 0 };
  if (o.sceneLayerItem ?? (o.sceneLayerItem = await l(o)), null == o.sceneLayerItem)
    return f(o.sceneServerUrl.replace("/SceneServer", "/FeatureServer"), o);
  const i = await y(o);
  if (!(i == null ? void 0 : i.url))
    throw new s("related-service-not-found", "Could not find feature service through portal item relationship");
  o.featureServiceItem = i;
  const s3 = await f(i.url, o);
  return s3.portalItem = i, s3;
}
async function l(e) {
  const r = (await c(e)).serviceItemId;
  if (!r)
    return null;
  const t2 = new S({ id: r, apiKey: e.apiKey }), a2 = await u(e);
  null != a2 && (t2.portal = new Q({ url: a2 }));
  try {
    return t2.load({ signal: e.signal });
  } catch (s3) {
    return a(s3), null;
  }
}
async function c(e) {
  if (e.rootDocument)
    return e.rootDocument;
  const t2 = { query: { f: "json", ...e.customParameters, token: e.apiKey }, responseType: "json", signal: e.signal };
  try {
    const n = await U(e.sceneServerUrl, t2);
    e.rootDocument = n.data;
  } catch {
    e.rootDocument = {};
  }
  return e.rootDocument;
}
async function u(t2) {
  var _a;
  const a2 = (_a = t) == null ? void 0 : _a.findServerInfo(t2.sceneServerUrl);
  if (a2 == null ? void 0 : a2.owningSystemUrl)
    return a2.owningSystemUrl;
  const o = t2.sceneServerUrl.replace(/(.*\/rest)\/.*/i, "$1") + "/info";
  try {
    const e = (await U(o, { query: { f: "json" }, responseType: "json", signal: t2.signal })).data.owningSystemUrl;
    if (e)
      return e;
  } catch (i) {
    a(i);
  }
  return null;
}
async function f(e, n) {
  var _a, _b, _c;
  const o = p(e);
  if (!o)
    throw new s("invalid-feature-service-url", "Invalid feature service url");
  const i = o.url.path, s3 = n.layerId;
  if (null == s3)
    return { serverUrl: i };
  const l2 = c(n), u2 = n.featureServiceItem ? await n.featureServiceItem.fetchData("json") : null, f2 = (_c = ((_a = u2 == null ? void 0 : u2.layers) == null ? void 0 : _a[0]) || ((_b = u2 == null ? void 0 : u2.tables) == null ? void 0 : _b[0])) == null ? void 0 : _c.customParameters, y2 = (e2) => {
    const t2 = { query: { f: "json", ...f2 }, responseType: "json", authMode: e2, signal: n.signal };
    return U(i, t2);
  }, m = y2("anonymous").catch(() => y2("no-prompt")), [p2, d] = await Promise.all([m, l2]), v = d == null ? void 0 : d.layers, w = p2.data && p2.data.layers;
  if (!Array.isArray(w))
    throw new Error("expected layers array");
  if (Array.isArray(v))
    for (let r = 0; r < Math.min(v.length, w.length); r++) {
      if (v[r].id === s3)
        return { serverUrl: i, layerId: w[r].id };
    }
  else if (null != s3 && s3 < w.length)
    return { serverUrl: i, layerId: w[s3].id };
  throw new Error("could not find matching associated sublayer");
}
async function y({ sceneLayerItem: e, signal: r }) {
  if (!e)
    return null;
  try {
    const t2 = (await e.fetchRelatedItems({ relationshipType: "Service2Service", direction: "reverse" }, { signal: r })).find((e2) => "Feature Service" === e2.type) || null;
    if (!t2)
      return null;
    const n = new S({ portal: t2.portal, id: t2.id });
    return await n.load(), n;
  } catch (t2) {
    return a(t2), null;
  }
}

export {
  s2 as s
};
//# sourceMappingURL=chunk-LRW6CHFI.js.map
