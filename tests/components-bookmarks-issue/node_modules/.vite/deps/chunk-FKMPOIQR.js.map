{
  "version": 3,
  "sources": ["../../@arcgis/core/views/interactive/snapping/SnappingDragPipelineStep.js"],
  "sourcesContent": ["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.30/esri/copyright.txt for details.\n*/\nimport{abortMaybe as n,removeMaybe as e}from\"../../../core/maybe.js\";import{ignoreAbortErrors as t,debounce as o}from\"../../../core/promiseUtils.js\";import{watch as r}from\"../../../core/reactiveUtils.js\";import{pointEquals as i}from\"../../../layers/graphics/dehydratedFeatureComparison.js\";import{clonePoint as l}from\"../../../layers/graphics/hydratedFeatures.js\";import{absoluteHeightElevationInfo as a}from\"../../../support/elevationInfoUtils.js\";import{EventPipeline as s}from\"../dragEventPipeline.js\";import{SnappingContext as u}from\"./SnappingContext.js\";import{TaskPriority as c,ImmediateTask as p}from\"../../support/Scheduler.js\";function f({predicate:o=(()=>!0),snappingManager:i,snappingContext:l,updatingHandles:u,useZ:c=!0}){const p=new s;if(null==i)return{snappingStep:[y,p],cancelSnapping:y};let f,Z=null,j=null,z=null;const T=()=>{Z=n(Z),i.doneSnapping(),j?.frameTask.remove(),j=null,f=e(f),z=null},k=d(i,c,p);let w=null,I=null,U=null;return{snappingStep:[n=>{if(!o(n))return n;const{action:e}=n;if(\"start\"===e){const{info:e}=n,t=m(i.view);if(j=g(l,n,t),j.context.selfSnappingZ=null,!c&&null!=e){const n=S(l.coordinateHelper,e.handle.component);null!=n&&(j.context.selfSnappingZ={value:n,elevationInfo:l.elevationInfo??a})}}if(null!=j){const{context:o,originalScenePos:l,originalPos:a}=j,{mapEnd:s,mapStart:p,scenePoints:d}=n,m=x(a,v(s,p)),g=v(p,a),S={...n,action:\"update\"},y=j.context,T=P(l,d),C=i.update({point:m,scenePoint:T,context:o});if(U=C,h(s,C,g,c),w=m,I=T,\"end\"!==e){const{frameTask:n}=j;null==Z&&(Z=new AbortController),z=e=>{u.addPromise(t(k({frameTask:n,event:S,context:y,point:m,scenePoint:T,delta:g,getLastState:()=>({point:w,scenePoint:I,updatePoint:e.forceUpdate?null:U})},Z.signal)))},z({forceUpdate:!1}),null==f&&(f=r((()=>i.options.effectiveEnabled),(()=>z?.({forceUpdate:!0}))))}}return\"end\"===e&&T(),n},p],cancelSnapping:n=>(T(),n)}}function d(n,e,t){return o((async({frameTask:o,point:r,scenePoint:l,context:a,event:s,delta:u,getLastState:c},p)=>{const f=await o.schedule((()=>n.snap({point:r,scenePoint:l,context:a,signal:p})),p);if(f.valid){let l=await o.schedule((()=>f.apply()),p);const d=c();null!=d.point&&r!==d.point&&(l=n.update({point:d.point,scenePoint:d.scenePoint,context:a})),null!=d.updatePoint&&i(l,d.updatePoint)||(h(s.mapEnd,l,u,e),t.execute(s))}}))}function m(n){return\"3d\"===n.type?n.resourceController.scheduler.registerTask(c.SNAPPING):p}function g(n,e,t){return{context:new u({editGeometryOperations:n.editGeometryOperations,elevationInfo:n.elevationInfo,pointer:n.pointer,vertexHandle:null!=e.info?e.info.handle:null,excludeFeature:n.excludeFeature,feature:n.feature,visualizer:n.visualizer}),originalPos:null!=e.snapOrigin?n.coordinateHelper.vectorToDehydratedPoint(e.snapOrigin):e.mapStart,originalScenePos:null!=e.scenePoints?e.scenePoints.sceneStart:null,frameTask:t}}function x(n,[e,t,o]){const r=l(n);return r.x+=e,r.y+=t,r.hasZ&&(r.z+=o),r}function P(n,e){return null==n||null==e?null:x(n,v(e.sceneEnd,e.sceneStart))}function v(n,e){const t=n.hasZ&&e.hasZ?n.z-e.z:0;return[n.x-e.x,n.y-e.y,t]}function h(n,e,[t,o,r],i){n.x=e.x+t,n.y=e.y+o,i&&n.hasZ&&e.hasZ&&(n.z=e.z+r)}function S(n,e){if(!n.hasZ())return null;const t=e.vertices;let o=null;for(const r of t){const e=n.getZ(r.pos);if(null!=o&&null!=e&&Math.abs(e-o)>1e-6)return null;null==o&&(o=e)}return o}function y(n){return n}export{f as createSnapDragEventPipelineStep};\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAI6nB,SAAS,EAAE,EAAC,WAAU,IAAG,MAAI,MAAI,iBAAgB,GAAE,iBAAgBA,IAAE,iBAAgB,GAAE,MAAK,IAAE,KAAE,GAAE;AAAC,QAAM,IAAE,IAAI;AAAE,MAAG,QAAM;AAAE,WAAM,EAAC,cAAa,CAAC,GAAE,CAAC,GAAE,gBAAe,EAAC;AAAE,MAAIC,IAAE,IAAE,MAAK,IAAE,MAAK,IAAE;AAAK,QAAM,IAAE,MAAI;AAAC,QAAE,EAAE,CAAC,GAAE,EAAE,aAAa,GAAE,uBAAG,UAAU,UAAS,IAAE,MAAKA,KAAE,EAAEA,EAAC,GAAE,IAAE;AAAA,EAAI,GAAEC,KAAEC,GAAE,GAAE,GAAE,CAAC;AAAE,MAAIC,KAAE,MAAKC,KAAE,MAAK,IAAE;AAAK,SAAM,EAAC,cAAa,CAAC,OAAG;AAAC,QAAG,CAAC,EAAE,CAAC;AAAE,aAAO;AAAE,UAAK,EAAC,QAAOC,GAAC,IAAE;AAAE,QAAG,YAAUA,IAAE;AAAC,YAAK,EAAC,MAAKA,GAAC,IAAE,GAAE,IAAE,EAAE,EAAE,IAAI;AAAE,UAAG,IAAE,EAAEN,IAAE,GAAE,CAAC,GAAE,EAAE,QAAQ,gBAAc,MAAK,CAAC,KAAG,QAAMM,IAAE;AAAC,cAAMC,KAAE,EAAEP,GAAE,kBAAiBM,GAAE,OAAO,SAAS;AAAE,gBAAMC,OAAI,EAAE,QAAQ,gBAAc,EAAC,OAAMA,IAAE,eAAcP,GAAE,iBAAe,EAAC;AAAA,MAAE;AAAA,IAAC;AAAC,QAAG,QAAM,GAAE;AAAC,YAAK,EAAC,SAAQQ,IAAE,kBAAiBR,IAAE,aAAYS,GAAC,IAAE,GAAE,EAAC,QAAO,GAAE,UAASC,IAAE,aAAYP,GAAC,IAAE,GAAEQ,KAAEC,GAAEH,IAAE,EAAE,GAAEC,EAAC,CAAC,GAAEG,KAAE,EAAEH,IAAED,EAAC,GAAEK,KAAE,EAAC,GAAG,GAAE,QAAO,SAAQ,GAAEC,KAAE,EAAE,SAAQC,KAAE,EAAEhB,IAAEG,EAAC,GAAE,IAAE,EAAE,OAAO,EAAC,OAAMQ,IAAE,YAAWK,IAAE,SAAQR,GAAC,CAAC;AAAE,UAAG,IAAE,GAAE,EAAE,GAAE,GAAEK,IAAE,CAAC,GAAET,KAAEO,IAAEN,KAAEW,IAAE,UAAQV,IAAE;AAAC,cAAK,EAAC,WAAUC,GAAC,IAAE;AAAE,gBAAM,MAAI,IAAE,IAAI,oBAAiB,IAAE,CAAAD,OAAG;AAAC,YAAE,WAAW,EAAEJ,GAAE,EAAC,WAAUK,IAAE,OAAMO,IAAE,SAAQC,IAAE,OAAMJ,IAAE,YAAWK,IAAE,OAAMH,IAAE,cAAa,OAAK,EAAC,OAAMT,IAAE,YAAWC,IAAE,aAAYC,GAAE,cAAY,OAAK,EAAC,GAAE,GAAE,EAAE,MAAM,CAAC,CAAC;AAAA,QAAC,GAAE,EAAE,EAAC,aAAY,MAAE,CAAC,GAAE,QAAML,OAAIA,KAAEE,GAAG,MAAI,EAAE,QAAQ,kBAAmB,MAAI,uBAAI,EAAC,aAAY,KAAE,EAAG;AAAA,MAAE;AAAA,IAAC;AAAC,WAAM,UAAQG,MAAG,EAAE,GAAE;AAAA,EAAC,GAAE,CAAC,GAAE,gBAAe,QAAI,EAAE,GAAE,GAAE;AAAC;AAAC,SAASH,GAAE,GAAEG,IAAE,GAAE;AAAC,SAAO,EAAG,OAAM,EAAC,WAAU,GAAE,OAAM,GAAE,YAAWN,IAAE,SAAQS,IAAE,OAAM,GAAE,OAAM,GAAE,cAAa,EAAC,GAAE,MAAI;AAAC,UAAMR,KAAE,MAAM,EAAE,SAAU,MAAI,EAAE,KAAK,EAAC,OAAM,GAAE,YAAWD,IAAE,SAAQS,IAAE,QAAO,EAAC,CAAC,GAAG,CAAC;AAAE,QAAGR,GAAE,OAAM;AAAC,UAAID,KAAE,MAAM,EAAE,SAAU,MAAIC,GAAE,MAAM,GAAG,CAAC;AAAE,YAAME,KAAE,EAAE;AAAE,cAAMA,GAAE,SAAO,MAAIA,GAAE,UAAQH,KAAE,EAAE,OAAO,EAAC,OAAMG,GAAE,OAAM,YAAWA,GAAE,YAAW,SAAQM,GAAC,CAAC,IAAG,QAAMN,GAAE,eAAa,EAAEH,IAAEG,GAAE,WAAW,MAAI,EAAE,EAAE,QAAOH,IAAE,GAAEM,EAAC,GAAE,EAAE,QAAQ,CAAC;AAAA,IAAE;AAAA,EAAC,CAAE;AAAC;AAAC,SAAS,EAAE,GAAE;AAAC,SAAM,SAAO,EAAE,OAAK,EAAE,mBAAmB,UAAU,aAAa,EAAE,QAAQ,IAAE;AAAC;AAAC,SAAS,EAAE,GAAEA,IAAE,GAAE;AAAC,SAAM,EAAC,SAAQ,IAAIA,GAAE,EAAC,wBAAuB,EAAE,wBAAuB,eAAc,EAAE,eAAc,SAAQ,EAAE,SAAQ,cAAa,QAAMA,GAAE,OAAKA,GAAE,KAAK,SAAO,MAAK,gBAAe,EAAE,gBAAe,SAAQ,EAAE,SAAQ,YAAW,EAAE,WAAU,CAAC,GAAE,aAAY,QAAMA,GAAE,aAAW,EAAE,iBAAiB,wBAAwBA,GAAE,UAAU,IAAEA,GAAE,UAAS,kBAAiB,QAAMA,GAAE,cAAYA,GAAE,YAAY,aAAW,MAAK,WAAU,EAAC;AAAC;AAAC,SAASM,GAAE,GAAE,CAACN,IAAE,GAAE,CAAC,GAAE;AAAC,QAAM,IAAE,EAAE,CAAC;AAAE,SAAO,EAAE,KAAGA,IAAE,EAAE,KAAG,GAAE,EAAE,SAAO,EAAE,KAAG,IAAG;AAAC;AAAC,SAAS,EAAE,GAAEA,IAAE;AAAC,SAAO,QAAM,KAAG,QAAMA,KAAE,OAAKM,GAAE,GAAE,EAAEN,GAAE,UAASA,GAAE,UAAU,CAAC;AAAC;AAAC,SAAS,EAAE,GAAEA,IAAE;AAAC,QAAM,IAAE,EAAE,QAAMA,GAAE,OAAK,EAAE,IAAEA,GAAE,IAAE;AAAE,SAAM,CAAC,EAAE,IAAEA,GAAE,GAAE,EAAE,IAAEA,GAAE,GAAE,CAAC;AAAC;AAAC,SAAS,EAAE,GAAEA,IAAE,CAAC,GAAE,GAAE,CAAC,GAAE,GAAE;AAAC,IAAE,IAAEA,GAAE,IAAE,GAAE,EAAE,IAAEA,GAAE,IAAE,GAAE,KAAG,EAAE,QAAMA,GAAE,SAAO,EAAE,IAAEA,GAAE,IAAE;AAAE;AAAC,SAAS,EAAE,GAAEA,IAAE;AAAC,MAAG,CAAC,EAAE,KAAK;AAAE,WAAO;AAAK,QAAM,IAAEA,GAAE;AAAS,MAAI,IAAE;AAAK,aAAU,KAAK,GAAE;AAAC,UAAMA,KAAE,EAAE,KAAK,EAAE,GAAG;AAAE,QAAG,QAAM,KAAG,QAAMA,MAAG,KAAK,IAAIA,KAAE,CAAC,IAAE;AAAK,aAAO;AAAK,YAAM,MAAI,IAAEA;AAAA,EAAE;AAAC,SAAO;AAAC;AAAC,SAAS,EAAE,GAAE;AAAC,SAAO;AAAC;",
  "names": ["l", "f", "k", "d", "w", "I", "e", "n", "o", "a", "p", "m", "x", "g", "S", "y", "T"]
}
