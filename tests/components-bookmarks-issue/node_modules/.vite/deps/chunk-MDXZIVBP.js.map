{
  "version": 3,
  "sources": ["../../@arcgis/core/views/3d/webgl-engine/effects/ssao/SSAOBlurTechnique.js", "../../@arcgis/core/views/3d/webgl-engine/effects/ssao/SSAONoiseData.js", "../../@arcgis/core/views/3d/webgl-engine/effects/ssao/SSAOParameters.js", "../../@arcgis/core/views/3d/webgl-engine/effects/ssao/SSAOTechnique.js", "../../@arcgis/core/views/3d/webgl-engine/effects/ssao/SSAO.js", "../../@arcgis/core/views/3d/webgl-engine/core/shaderLibrary/shading/EvaluateAmbientOcclusion.glsl.js", "../../@arcgis/core/views/3d/webgl-engine/core/shaderLibrary/shading/EvaluateSceneLighting.glsl.js"],
  "sourcesContent": ["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.30/esri/copyright.txt for details.\n*/\nimport{ReloadableShaderModule as r}from\"../../core/shaderTechnique/ReloadableShaderModule.js\";import{ShaderTechnique as e}from\"../../core/shaderTechnique/ShaderTechnique.js\";import{Default3D as i}from\"../../lib/DefaultVertexAttributeLocations.js\";import{Program as o}from\"../../lib/Program.js\";import{S as t}from\"../../../../../chunks/SSAOBlur.glsl.js\";import{makePipelineState as s,defaultColorWriteParams as l}from\"../../../../webgl/renderState.js\";class a extends e{initializeProgram(r){return new o(r.rctx,a.shader.get().build(),i)}initializePipeline(){return s({colorWrite:l})}}a.shader=new r(t,(()=>import(\"../../shaders/SSAOBlur.glsl.js\")));export{a as SSAOBlurTechnique};\n", "/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.30/esri/copyright.txt for details.\n*/\nconst e=\"eXKEvZaUc66cjIKElE1jlJ6MjJ6Ufkl+jn2fcXp5jBx7c6KEflSGiXuXeW6OWs+tfqZ2Yot2Y7Zzfo2BhniEj3xoiXuXj4eGZpqEaHKDWjSMe7palFlzc3BziYOGlFVzg6Zzg7CUY5JrjFF7eYJ4jIKEcyyEonSXe7qUfqZ7j3xofqZ2c4R5lFZ5Y0WUbppoe1l2cIh2ezyUho+BcHN2cG6DbpqJhqp2e1GcezhrdldzjFGUcyxjc3aRjDyEc1h7Sl17c6aMjH92pb6Mjpd4dnqBjMOEhqZleIOBYzB7gYx+fnqGjJuEkWlwnCx7fGl+c4hjfGyRe5qMlNOMfnqGhIWHc6OMi4GDc6aMfqZuc6aMzqJzlKZ+lJ6Me3qRfoFue0WUhoR5UraEa6qMkXiPjMOMlJOGe7JrUqKMjK6MeYRzdod+Sl17boiPc6qEeYBlcIh2c1WEe7GDiWCDa0WMjEmMdod+Y0WcdntzhmN8WjyMjKJjiXtzgYxYaGd+a89zlEV7e2GJfnd+lF1rcK5zc4p5cHuBhL6EcXp5eYB7fnh8iX6HjIKEeaxuiYOGc66RfG2Ja5hzjlGMjEmMe9OEgXuPfHyGhPeEdl6JY02McGuMfnqGhFiMa3WJfnx2l4hwcG1uhmN8c0WMc39og1GBbrCEjE2EZY+JcIh2cIuGhIWHe0mEhIVrc09+gY5+eYBlnCyMhGCDl3drfmmMgX15aGd+gYx+fnuRfnhzY1SMsluJfnd+hm98WtNrcIuGh4SEj0qPdkqOjFF7jNNjdnqBgaqUjMt7boeBhnZ4jDR7c5pze4GGjEFrhLqMjHyMc0mUhKZze4WEa117kWlwbpqJjHZ2eX2Bc09zeId+e0V7WlF7jHJ2l72BfId8l3eBgXyBe897jGl7c66cgW+Xc76EjKNbgaSEjGx4fId8jFFjgZB8cG6DhlFziZhrcIh2fH6HgUqBgXiPY8dahGFzjEmMhEFre2dxhoBzc5SGfleGe6alc7aUeYBlhKqUdlp+cH5za4OEczxza0Gcc4J2jHZ5iXuXjH2Jh5yRjH2JcFx+hImBjH+MpddCl3dreZeJjIt8ZW18bm1zjoSEeIOBlF9oh3N7hlqBY4+UeYFwhLJjeYFwaGd+gUqBYxiEYot2fqZ2ondzhL6EYyiEY02Ea0VjgZB8doaGjHxoc66cjEGEiXuXiXWMiZhreHx8frGMe75rY02Ec5pzfnhzlEp4a3VzjM+EhFFza3mUY7Zza1V5e2iMfGyRcziEhDyEkXZ2Y4OBnCx7g5t2eyBjgV6EhEFrcIh2dod+c4Z+nJ5zjm15jEmUeYxijJp7nL6clIpjhoR5WrZraGd+fnuRa6pzlIiMg6ZzfHx5foh+eX1ufnB5eX1ufnB5aJt7UqKMjIh+e3aBfm5lbYSBhGFze6J4c39oc0mUc4Z+e0V7fKFVe0WEdoaGY02Ec4Z+Y02EZYWBfH6HgU1+gY5+hIWUgW+XjJ57ebWRhFVScHuBfJ6PhBx7WqJzlM+Ujpd4gHZziX6HjHmEgZN+lJt5boiPe2GJgX+GjIGJgHZzeaxufnB5hF2JtdN7jJ57hp57hK6ElFVzg6ZzbmiEbndzhIWHe3uJfoFue3qRhJd2j3xoc65zlE1jc3p8lE1jhniEgXJ7e657vZaUc3qBh52BhIF4aHKDa9drgY5+c52GWqZzbpqJe8tjnM+UhIeMfo2BfGl+hG1zSmmMjKJjZVaGgX15c1lze0mEp4OHa3mUhIWHhDyclJ6MeYOJkXiPc0VzhFiMlKaEboSJa5Jze41re3qRhn+HZYWBe0mEc4p5fnORbox5lEp4hGFjhGGEjJuEc1WEhLZjeHeGa7KlfHx2hLaMeX1ugY5+hIWHhKGPjMN7c1WEho1zhoBzZYx7fnhzlJt5exyUhFFziXtzfmmMa6qMYyiEiXxweV12kZSMeWqXSl17fnhzxmmMrVGEe1mcc4p5eHeGjK6MgY5+doaGa6pzlGV7g1qBh4KHkXiPeW6OaKqafqZ2eXZ5e1V7jGd7boSJc3BzhJd2e0mcYot2h1RoY8dahK6EQmWEWjx7e1l2lL6UgXyBdnR4eU9zc0VreX1umqaBhld7fo2Bc6KEc5Z+hDyEcIeBWtNrfHyGe5qMhMuMe5qMhEGEbVVupcNzg3aHhIF4boeBe0mEdlptc39ofFl5Y8uUlJOGiYt2UmGEcyxjjGx4jFF7a657ZYWBnElzhp57iXtrgZN+tfOEhIOBjE2HgU1+e8tjjKNbiWCDhE15gUqBgYN7fnqGc66ce9d7iYSBj0qPcG6DnGGcT3eGa6qMZY+JlIiMl4hwc3aRdnqBlGV7eHJ2hLZjfnuRhDyEeX6MSk17g6Z+c6aUjHmEhIF4gXyBc76EZW18fGl+fkl+jCxrhoVwhDyUhIqGlL2DlI6EhJd2tdN7eYORhEGMa2Faa6pzc3Bzc4R5lIRznM+UY9eMhDycc5Z+c4p5c4iGY117pb6MgXuPrbJafnx2eYOJeXZ5e657hDyEcziElKZjfoB5eHeGj4WRhGGEe6KGeX1utTStc76EhFGJnCyMa5hzfH6HnNeceYB7hmN8gYuMhIVrczSMgYF8h3N7c5pza5hzjJqEYIRdgYuMlL2DeYRzhGGEeX1uhLaEc4iGeZ1zdl6JhrVteX6Me2iMfm5lWqJzSpqEa6pzdnmchHx2c6OMhNdrhoR5g3aHczxzeW52gV6Ejm15frGMc0Vzc4Z+l3drfniJe+9rWq5rlF1rhGGEhoVwe9OEfoh+e7pac09+c3qBY0lrhDycdnp2lJ6MiYOGhGCDc3aRlL2DlJt5doaGdnp2gYF8gWeOjF2Uc4R5c5Z+jEmMe7KEc4mEeYJ4dmyBe0mcgXiPbqJ7eYB7fmGGiYSJjICGlF1reZ2PnElzbpqJfH6Hc39oe4WEc5eJhK6EhqyJc3qBgZB8c09+hEmEaHKDhFGJc5SGiXWMUpaEa89zc6OMnCyMiXtrho+Be5qMc7KEjJ57dmN+hKGPjICGbmiEe7prdod+hGCDdnmchBx7eX6MkXZ2hGGEa657hm98jFFjY5JreYOJgY2EjHZ2a295Y3FajJ6Mc1J+YzB7e4WBjF2Uc4R5eV12gYxzg1qBeId+c9OUc5pzjFFjgY5+hFiMlIaPhoR5lIpjjIKBlNdSe7KEeX2BfrGMhIqGc65zjE2UhK6EklZ+QmWEeziMWqZza3VzdnR4foh+gYF8n3iJiZhrnKp7gYF8eId+lJ6Me1lrcIuGjKJjhmN8c66MjFF7a6prjJ6UnJ5zezyUfruRWlF7nI5zfHyGe657h4SEe8tjhBx7jFFjc09+c39ojICMeZeJeXt+YzRzjHZ2c0WEcIeBeXZ5onSXkVR+gYJ+eYFwdldzgYF7eX2BjJ6UiXuXlE1jh4SEe1mchLJjc4Z+hqZ7eXZ5bm1zlL6Ue5p7iWeGhKqUY5pzjKJjcIeBe8t7gXyBYIRdlEp4a3mGnK6EfmmMZpqEfFl5gYxzjKZuhGFjhoKGhHx2fnx2eXuMe3aBiWeGvbKMe6KGa5hzYzB7gZOBlGV7hmN8hqZlYot2Y117a6pzc6KEfId8foB5rctrfneJfJ6PcHN2hFiMc5pzjH92c0VzgY2EcElzdmCBlFVzg1GBc65zY4OBboeBcHiBeYJ4ewxzfHx5lIRzlEmEnLKEbk1zfJ6PhmN8eYBljBiEnMOEiXxwezyUcIeBe76EdsKEeX2BdnR4jGWUrXWMjGd7fkl+j4WRlEGMa5Jzho+BhDyEfnqMeXt+g3aHlE1jczClhNN7ZW18eHx8hGFjZW18iXWMjKJjhH57gYuMcIuGWjyMe4ZtjJuExmmMj4WRdntzi4GDhFFzYIRdnGGcjJp7Y0F7e4WEkbCGiX57fnSHa657a6prhBCMe3Z+SmmMjH92eHJ2hK6EY1FzexhrvbKMnI5za4OEfnd+eXuMhImBe897hLaMjN+EfG+BeIOBhF1+eZeJi4GDkXZ2eXKEgZ6Ejpd4c2GHa1V5e5KUfqZuhCx7jKp7lLZrg11+hHx2hFWUoot2nI5zgbh5mo9zvZaUe3qRbqKMfqZ2kbCGhFiM\";export{e as noiseData};\n", "/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.30/esri/copyright.txt for details.\n*/\nimport{create as s}from\"../../../../../core/libs/gl-matrix-2/factories/vec2f64.js\";import{NoParameters as e}from\"../../core/shaderModules/interfaces.js\";class r extends e{constructor(){super(...arguments),this.projScale=1}}class t extends r{constructor(){super(...arguments),this.intensity=1}}class c extends e{}class o extends c{constructor(){super(...arguments),this.blurSize=s()}}export{o as BlurDrawParameters,r as BlurPassParameters,c as SSAODrawParameters,t as SSAOPassParameters};\n", "/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.30/esri/copyright.txt for details.\n*/\nimport{ReloadableShaderModule as e}from\"../../core/shaderTechnique/ReloadableShaderModule.js\";import{ShaderTechnique as r}from\"../../core/shaderTechnique/ShaderTechnique.js\";import{Default3D as i}from\"../../lib/DefaultVertexAttributeLocations.js\";import{Program as o}from\"../../lib/Program.js\";import{S as t}from\"../../../../../chunks/SSAO.glsl.js\";import{makePipelineState as s,defaultColorWriteParams as a}from\"../../../../webgl/renderState.js\";class l extends r{initializeProgram(e){return new o(e.rctx,l.shader.get().build(),i)}initializePipeline(){return s({colorWrite:a})}}l.shader=new e(t,(()=>import(\"../../shaders/SSAO.glsl.js\")));export{l as SSAOTechnique};\n", "/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.30/esri/copyright.txt for details.\n*/\nimport{_ as e}from\"../../../../../chunks/tslib.es6.js\";import{clamp as t}from\"../../../../../core/mathUtils.js\";import{disposeMaybe as r}from\"../../../../../core/maybe.js\";import{watch as s,syncAndInitial as i}from\"../../../../../core/reactiveUtils.js\";import{Milliseconds as o}from\"../../../../../core/time.js\";import{property as a}from\"../../../../../core/accessorSupport/decorators/property.js\";import\"../../../../../core/has.js\";import\"../../../../../core/Logger.js\";import\"../../../../../core/RandomLCG.js\";import{subclass as n}from\"../../../../../core/accessorSupport/decorators/subclass.js\";import{set as m}from\"../../../../../core/libs/gl-matrix-2/math/vec2.js\";import{ColorFormat as u}from\"../../../webgl/formats.js\";import{distanceFadeEnd as c,distanceFadeStart as l}from\"../../core/shaderLibrary/shading/ScreenSpaceConstants.js\";import{SyncRenderPlugin as h,ConsumesDepthNormal as p,ConsumesNone as _}from\"../RenderPlugin.js\";import{SSAOBlurTechnique as d}from\"./SSAOBlurTechnique.js\";import{noiseData as b}from\"./SSAONoiseData.js\";import{SSAOPassParameters as x,BlurDrawParameters as f}from\"./SSAOParameters.js\";import{SSAOTechnique as T}from\"./SSAOTechnique.js\";import{RenderFeature as w}from\"../../lib/RenderFeature.js\";import{RenderSlot as S}from\"../../lib/RenderSlot.js\";import{g as q}from\"../../../../../chunks/SSAO.glsl.js\";import{TextureWrapMode as P,PixelFormat as j,DepthStencilAttachment as g,ClearBufferBit as R}from\"../../../../webgl/enums.js\";import{Texture as v}from\"../../../../webgl/Texture.js\";import{TextureDescriptor as y}from\"../../../../webgl/TextureDescriptor.js\";const A=2;let C=class extends h{constructor(e){super(e),this._context=null,this._passParameters=new x,this._drawParameters=new f,this.produces=new Map([[S.SSAO,()=>this._produces()]])}_getCameraElevation(){return this._context?.renderContext.bindParameters.camera.relativeElevation??1/0}_produces(){return null!=this._enableTime&&null!=this._context&&this._getCameraElevation()<c}consumes(){return this._produces()?p:_}initializeRenderContext(e){this._context=e,this.addHandles([s((()=>this.view.qualitySettings.ambientOcclusion||this._context?.isFeatureEnabled(w.SSAO)),(e=>e?this._enable():this._disable()),i)])}uninitializeRenderContext(){this._disable(),this._context=null}_disable(){this._passParameters.noiseTexture=r(this._passParameters.noiseTexture),this._enableTime=null}destroy(){this._disable()}_enable(){if(null!=this._enableTime||!this._context)return;const e=Uint8Array.from(atob(b),(e=>e.charCodeAt(0))),t=new y;t.wrapMode=P.CLAMP_TO_EDGE,t.pixelFormat=j.RGB,t.wrapMode=P.REPEAT,t.hasMipmap=!0,t.width=32,t.height=32,this._passParameters.noiseTexture=new v(this._context.renderContext.rctx,t,e),null==this._ssaoTechnique&&(this._ssaoTechnique=this._context.techniqueRepository.acquire(T)),null==this._blurTechnique&&(this._blurTechnique=this._context.techniqueRepository.acquire(d)),this._enableTime=o(0),this._context?.requestRender()}renderNode(e,r,s){const i=e.bindParameters,o=s?.get(\"normals\"),a=o?.getTexture(),n=o?.getTexture(g);if(null==this._enableTime||null==this._context||!a||!n)return;if(!this._ssaoTechnique.compiled||!this._blurTechnique.compiled)return this._enableTime=e.time,void this._context.requestRender();0===this._enableTime&&(this._enableTime=e.time);const h=e.rctx,p=i.camera,_=this.view.qualitySettings.fadeDuration,d=p.relativeElevation,b=t((c-d)/(c-l),0,1),x=_>0?Math.min(_,e.time-this._enableTime)/_:1,f=x*b;this._passParameters.normalTexture=a,this._passParameters.depthTexture=n,this._passParameters.projScale=1/p.computeScreenPixelSizeAtDist(1),this._passParameters.intensity=4*O/q(p)**6*f;const T=p.fullViewport[2],w=p.fullViewport[3],S=Math.round(T/A),P=Math.round(w/A),j=this._context.fbos,v=j.acquire(T,w,\"ssao input\",u.RG);h.unbindTexture(v.fbo.colorTexture),h.bindFramebuffer(v.fbo),h.setViewport(0,0,T,w),h.bindTechnique(this._ssaoTechnique,i,this._passParameters,this._drawParameters),h.screen.draw();const y=j.acquire(S,P,\"ssao blur\",u.RED);h.unbindTexture(y.fbo.colorTexture),h.bindFramebuffer(y.fbo),this._drawParameters.colorTexture=v.getTexture(),m(this._drawParameters.blurSize,0,A/w),h.bindTechnique(this._blurTechnique,i,this._passParameters,this._drawParameters),h.setViewport(0,0,S,P),h.screen.draw(),v.release();const C=j.acquire(S,P,\"ssao\",u.RED);return h.unbindTexture(C.fbo.colorTexture),h.bindFramebuffer(C.fbo),h.setViewport(0,0,T,w),h.setClearColor(1,1,1,0),h.clear(R.COLOR_BUFFER_BIT),this._drawParameters.colorTexture=y.getTexture(),m(this._drawParameters.blurSize,A/T,0),h.bindTechnique(this._blurTechnique,i,this._passParameters,this._drawParameters),h.setViewport(0,0,S,P),h.screen.draw(),h.setViewport4fv(p.fullViewport),y.release(),x<1&&this._context.requestRender(),C}};e([a({constructOnly:!0})],C.prototype,\"view\",void 0),e([a()],C.prototype,\"_context\",void 0),C=e([n(\"esri.views.3d.webgl-engine.effects.ssao.SSAO\")],C);const O=.5;export{C as SSAO,A as blurSizePixels};\n", "/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.30/esri/copyright.txt for details.\n*/\nimport{glsl as e}from\"../../shaderModules/interfaces.js\";import{Texture2DPassUniform as s}from\"../../shaderModules/Texture2DPassUniform.js\";import{blurSizePixels as r}from\"../../../effects/ssao/SSAO.js\";function t(t,o){const a=t.fragment;o.receiveAmbientOcclusion?(a.uniforms.add(new s(\"ssaoTex\",((e,s)=>s.ssao?.getTexture()))),a.constants.add(\"blurSizePixelsInverse\",\"float\",1/r),a.code.add(e`float evaluateAmbientOcclusionInverse() {\nvec2 ssaoTextureSizeInverse = 1.0 / vec2(textureSize(ssaoTex, 0));\nreturn texture(ssaoTex, gl_FragCoord.xy * blurSizePixelsInverse * ssaoTextureSizeInverse).r;\n}\nfloat evaluateAmbientOcclusion() {\nreturn 1.0 - evaluateAmbientOcclusionInverse();\n}`)):a.code.add(e`float evaluateAmbientOcclusionInverse() { return 1.0; }\nfloat evaluateAmbientOcclusion() { return 0.0; }`)}export{t as EvaluateAmbientOcclusion};\n", "/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.30/esri/copyright.txt for details.\n*/\nimport{neverReached as i}from\"../../../../../../core/compilerUtils.js\";import{EvaluateAmbientLighting as n}from\"./EvaluateAmbientLighting.glsl.js\";import{EvaluateAmbientOcclusion as e}from\"./EvaluateAmbientOcclusion.glsl.js\";import{addMainLightDirection as o,addMainLightIntensity as t,MainLighting as a}from\"./MainLighting.glsl.js\";import{PhysicallyBasedRendering as r}from\"./PhysicallyBasedRendering.glsl.js\";import{PBRMode as l}from\"./PhysicallyBasedRenderingParameters.glsl.js\";import{PiUtils as c}from\"./PiUtils.glsl.js\";import{BooleanPassUniform as d}from\"../../shaderModules/BooleanPassUniform.js\";import{FloatPassUniform as s}from\"../../shaderModules/FloatPassUniform.js\";import{glsl as m}from\"../../shaderModules/interfaces.js\";import{ambientBoost as g}from\"../../../lighting/SceneLighting.js\";function u(i){i.constants.add(\"ambientBoostFactor\",\"float\",g)}function h(i){i.uniforms.add(new s(\"lightingGlobalFactor\",((i,n)=>n.lighting.globalFactor)))}function p(g,p){const v=g.fragment;switch(g.include(e,p),p.pbrMode!==l.Disabled&&g.include(r,p),g.include(n,p),g.include(c),v.code.add(m`\n    const float GAMMA_SRGB = 2.1;\n    const float INV_GAMMA_SRGB = 0.4761904;\n    ${p.pbrMode===l.Disabled?\"\":\"const vec3 GROUND_REFLECTANCE = vec3(0.2);\"}\n  `),u(v),h(v),o(v),v.code.add(m`\n    float additionalDirectedAmbientLight(vec3 vPosWorld) {\n      float vndl = dot(${p.spherical?m`normalize(vPosWorld)`:m`vec3(0.0, 0.0, 1.0)`}, mainLightDirection);\n      return smoothstep(0.0, 1.0, clamp(vndl * 2.5, 0.0, 1.0));\n    }\n  `),t(v),v.code.add(m`vec3 evaluateAdditionalLighting(float ambientOcclusion, vec3 vPosWorld) {\nfloat additionalAmbientScale = additionalDirectedAmbientLight(vPosWorld);\nreturn (1.0 - ambientOcclusion) * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor * mainLightIntensity;\n}`),p.pbrMode){case l.Disabled:case l.WaterOnIntegratedMesh:case l.Water:g.include(a),v.code.add(m`vec3 evaluateSceneLighting(vec3 normalWorld, vec3 albedo, float shadow, float ssao, vec3 additionalLight)\n{\nvec3 mainLighting = evaluateMainLighting(normalWorld, shadow);\nvec3 ambientLighting = calculateAmbientIrradiance(normalWorld, ssao);\nvec3 albedoLinear = pow(albedo, vec3(GAMMA_SRGB));\nvec3 totalLight = mainLighting + ambientLighting + additionalLight;\ntotalLight = min(totalLight, vec3(PI));\nvec3 outColor = vec3((albedoLinear / PI) * totalLight);\nreturn pow(outColor, vec3(INV_GAMMA_SRGB));\n}`);break;case l.Normal:case l.Schematic:v.code.add(m`const float fillLightIntensity = 0.25;\nconst float horizonLightDiffusion = 0.4;\nconst float additionalAmbientIrradianceFactor = 0.02;\nvec3 evaluateSceneLightingPBR(vec3 normal, vec3 albedo, float shadow, float ssao, vec3 additionalLight, vec3 viewDir, vec3 normalGround, vec3 mrr, vec3 _emission, float additionalAmbientIrradiance)\n{\nvec3 viewDirection = -viewDir;\nvec3 h = normalize(viewDirection + mainLightDirection);\nPBRShadingInfo inputs;\ninputs.NdotL = clamp(dot(normal, mainLightDirection), 0.001, 1.0);\ninputs.NdotV = clamp(abs(dot(normal, viewDirection)), 0.001, 1.0);\ninputs.NdotH = clamp(dot(normal, h), 0.0, 1.0);\ninputs.VdotH = clamp(dot(viewDirection, h), 0.0, 1.0);\ninputs.NdotNG = clamp(dot(normal, normalGround), -1.0, 1.0);\nvec3 reflectedView = normalize(reflect(viewDirection, normal));\ninputs.RdotNG = clamp(dot(reflectedView, normalGround), -1.0, 1.0);\ninputs.albedoLinear = pow(albedo, vec3(GAMMA_SRGB));\ninputs.ssao = ssao;\ninputs.metalness = mrr[0];\ninputs.roughness = clamp(mrr[1] * mrr[1], 0.001, 0.99);`),v.code.add(m`inputs.f0 = (0.16 * mrr[2] * mrr[2]) * (1.0 - inputs.metalness) + inputs.albedoLinear * inputs.metalness;\ninputs.f90 = vec3(clamp(dot(inputs.f0, vec3(50.0 * 0.33)), 0.0, 1.0));\ninputs.diffuseColor = inputs.albedoLinear * (vec3(1.0) - inputs.f0) * (1.0 - inputs.metalness);`),p.useFillLights?v.uniforms.add(new d(\"hasFillLights\",((i,n)=>n.enableFillLights))):v.constants.add(\"hasFillLights\",\"bool\",!1),v.code.add(m`vec3 ambientDir = vec3(5.0 * normalGround[1] - normalGround[0] * normalGround[2], - 5.0 * normalGround[0] - normalGround[2] * normalGround[1], normalGround[1] * normalGround[1] + normalGround[0] * normalGround[0]);\nambientDir = ambientDir != vec3(0.0) ? normalize(ambientDir) : normalize(vec3(5.0, -1.0, 0.0));\ninputs.NdotAmbDir = hasFillLights ? abs(dot(normal, ambientDir)) : 1.0;\nvec3 mainLightIrradianceComponent = inputs.NdotL * (1.0 - shadow) * mainLightIntensity;\nvec3 fillLightsIrradianceComponent = inputs.NdotAmbDir * mainLightIntensity * fillLightIntensity;\nvec3 ambientLightIrradianceComponent = calculateAmbientIrradiance(normal, ssao) + additionalLight;\ninputs.skyIrradianceToSurface = ambientLightIrradianceComponent + mainLightIrradianceComponent + fillLightsIrradianceComponent ;\ninputs.groundIrradianceToSurface = GROUND_REFLECTANCE * ambientLightIrradianceComponent + mainLightIrradianceComponent + fillLightsIrradianceComponent ;`),v.uniforms.add(new s(\"lightingSpecularStrength\",((i,n)=>n.lighting.mainLight.specularStrength)),new s(\"lightingEnvironmentStrength\",((i,n)=>n.lighting.mainLight.environmentStrength))),v.code.add(m`vec3 horizonRingDir = inputs.RdotNG * normalGround - reflectedView;\nvec3 horizonRingH = normalize(viewDirection + horizonRingDir);\ninputs.NdotH_Horizon = dot(normal, horizonRingH);\nvec3 mainLightRadianceComponent = lightingSpecularStrength * normalDistribution(inputs.NdotH, inputs.roughness) * mainLightIntensity * (1.0 - shadow);\nvec3 horizonLightRadianceComponent = lightingEnvironmentStrength * normalDistribution(inputs.NdotH_Horizon, min(inputs.roughness + horizonLightDiffusion, 1.0)) * mainLightIntensity * fillLightIntensity;\nvec3 ambientLightRadianceComponent = lightingEnvironmentStrength * calculateAmbientRadiance(ssao) + additionalLight;\nfloat normalDirectionModifier = mix(1., min(mix(0.1, 2.0, (inputs.NdotNG + 1.) * 0.5), 1.0), clamp(inputs.roughness * 5.0, 0.0 , 1.0));\ninputs.skyRadianceToSurface = (ambientLightRadianceComponent + horizonLightRadianceComponent) * normalDirectionModifier + mainLightRadianceComponent;\ninputs.groundRadianceToSurface = 0.5 * GROUND_REFLECTANCE * (ambientLightRadianceComponent + horizonLightRadianceComponent) * normalDirectionModifier + mainLightRadianceComponent;\ninputs.averageAmbientRadiance = ambientLightIrradianceComponent[1] * (1.0 + GROUND_REFLECTANCE[1]);`),v.code.add(m`\n        vec3 reflectedColorComponent = evaluateEnvironmentIllumination(inputs);\n        vec3 additionalMaterialReflectanceComponent = inputs.albedoLinear * additionalAmbientIrradiance;\n        vec3 emissionComponent = _emission == vec3(0.0) ? _emission : pow(_emission, vec3(GAMMA_SRGB));\n        vec3 outColorLinear = reflectedColorComponent + additionalMaterialReflectanceComponent + emissionComponent;\n        ${p.pbrMode!==l.Schematic||p.hasColorTexture?m`vec3 outColor = pow(blackLevelSoftCompression(outColorLinear, inputs), vec3(INV_GAMMA_SRGB));`:m`vec3 outColor = pow(max(vec3(0.0), outColorLinear - 0.005 * inputs.averageAmbientRadiance), vec3(INV_GAMMA_SRGB));`}\n        return outColor;\n      }\n    `);break;case l.Simplified:case l.TerrainWithWater:g.include(a),v.code.add(m`const float roughnessTerrain = 0.5;\nconst float specularityTerrain = 0.5;\nconst vec3 fresnelReflectionTerrain = vec3(0.04);\nvec3 evaluatePBRSimplifiedLighting(vec3 n, vec3 c, float shadow, float ssao, vec3 al, vec3 vd, vec3 nup) {\nvec3 viewDirection = -vd;\nvec3 h = normalize(viewDirection + mainLightDirection);\nfloat NdotL = clamp(dot(n, mainLightDirection), 0.001, 1.0);\nfloat NdotV = clamp(abs(dot(n, viewDirection)), 0.001, 1.0);\nfloat NdotH = clamp(dot(n, h), 0.0, 1.0);\nfloat NdotNG = clamp(dot(n, nup), -1.0, 1.0);\nvec3 albedoLinear = pow(c, vec3(GAMMA_SRGB));\nfloat lightness = 0.3 * albedoLinear[0] + 0.5 * albedoLinear[1] + 0.2 * albedoLinear[2];\nvec3 f0 = (0.85 * lightness + 0.15) * fresnelReflectionTerrain;\nvec3 f90 =  vec3(clamp(dot(f0, vec3(50.0 * 0.33)), 0.0, 1.0));\nvec3 mainLightIrradianceComponent = (1. - shadow) * NdotL * mainLightIntensity;\nvec3 ambientLightIrradianceComponent = calculateAmbientIrradiance(n, ssao) + al;\nvec3 ambientSky = ambientLightIrradianceComponent + mainLightIrradianceComponent;\nvec3 indirectDiffuse = ((1.0 - NdotNG) * mainLightIrradianceComponent + (1.0 + NdotNG ) * ambientSky) * 0.5;\nvec3 outDiffColor = albedoLinear * (1.0 - f0) * indirectDiffuse / PI;\nvec3 mainLightRadianceComponent = normalDistribution(NdotH, roughnessTerrain) * mainLightIntensity;\nvec2 dfg = prefilteredDFGAnalytical(roughnessTerrain, NdotV);\nvec3 specularColor = f0 * dfg.x + f90 * dfg.y;\nvec3 specularComponent = specularityTerrain * specularColor * mainLightRadianceComponent;\nvec3 outColorLinear = outDiffColor + specularComponent;\nvec3 outColor = pow(outColorLinear, vec3(INV_GAMMA_SRGB));\nreturn outColor;\n}`);break;default:i(p.pbrMode);case l.COUNT:}}export{p as EvaluateSceneLighting,u as addAmbientBoostFactor,h as addLightingGlobalFactor};\n"],
  "mappings": "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",
  "names": ["a", "r", "_", "t", "e", "r", "n", "t", "c", "o", "l", "r", "e", "_", "t", "A", "c", "e", "t", "o", "l", "a", "r", "s", "i", "n", "h", "p", "_", "d", "O", "S", "v", "y", "C", "t", "o", "a", "e", "s", "A", "u", "i", "o", "n", "p", "v", "t", "r", "a", "s"]
}
