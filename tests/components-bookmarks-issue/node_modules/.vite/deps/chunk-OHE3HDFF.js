import {
  o as o2
} from "./chunk-TPLOIZC7.js";
import {
  U
} from "./chunk-SAYWXQVM.js";
import {
  o
} from "./chunk-TXBMNSNF.js";
import {
  a3 as a2
} from "./chunk-I2RC5KWA.js";
import {
  e
} from "./chunk-2F6FFF5T.js";
import {
  L
} from "./chunk-JGDJR5EV.js";
import {
  a
} from "./chunk-7RBRCL6S.js";

// node_modules/@arcgis/core/versionManagement/support/versionManagementUtils.js
var t = o2();
var n = /* @__PURE__ */ new Map();
var o3 = /* @__PURE__ */ new Map();
var s = /* @__PURE__ */ new Map();
async function a3(r, t2, o5) {
  if (!r || !o5)
    return false;
  if (!t2)
    return true;
  const s2 = new URL(r).host;
  let a5 = n.get(s2);
  if (!a5) {
    const t3 = r.replace(/\/FeatureServer/i, "/VersionManagementServer").replace(/\/\d*$/, "");
    a5 = (await U(t3, { responseType: "json", query: { f: "json" } })).data.defaultVersionName;
  }
  return a5 === t2;
}
async function i(e2, r, n2 = false) {
  var _a, _b;
  if (!e2 || !r)
    return true;
  const s2 = e2.replace(/\/FeatureServer/i, "/VersionManagementServer").replace(/\/\d*$/, ""), a5 = (_a = o3.get(s2)) == null ? void 0 : _a.entries();
  if (a5) {
    for (const [o5, i2] of a5)
      if (i2.name === r) {
        const e3 = !((_b = i2.stack) == null ? void 0 : _b.hasForwardEdits());
        if (!e3 && n2) {
          const [{ deleteForwardEdits: e4 }, { default: r2 }] = await Promise.all([import("./deleteForwardEdits-KTYPUSX2.js"), import("./DeleteForwardEditsParameters-WC4SV7O4.js")]);
          return e4(s2, o5, new r2({ sessionId: t, moment: i2.moment }));
        }
        return e3;
      }
  }
  return true;
}
function c(e2, r) {
  var _a;
  if (!e2)
    return false;
  const t2 = e2.replace(/\/FeatureServer/i, "/VersionManagementServer").replace(/\/\d*$/, ""), n2 = (_a = o3.get(t2)) == null ? void 0 : _a.entries();
  if (n2) {
    for (const [o5, s2] of n2)
      if (s2.name === r) {
        return "edit" === s2.lockType;
      }
  }
  return false;
}

// node_modules/@arcgis/core/layers/mixins/EditBusLayer.js
var o4 = new o.EventEmitter();
function l(e2) {
  return o4.on("apply-edits", new WeakRef(e2));
}
function a4(e2) {
  return o4.on("update-moment", new WeakRef(e2));
}
function h(e2, t2, i2 = null, d = false) {
  const r = L();
  return d = null == t2 || d, o4.emit("apply-edits", { serviceUrl: e2, layerId: t2, gdbVersion: i2, mayReceiveServiceEdits: d, result: r.promise }), r;
}
function c2(e2, t2, i2 = null, s2) {
  o4.emit("update-moment", { serviceUrl: e2, layerId: t2, gdbVersion: i2, moment: s2 });
}
var u = Symbol();
function m(e2) {
  return null != e2 && "object" == typeof e2 && u in e2;
}
function p(e2) {
  return null != e2 && "object" == typeof e2 && "gdbVersion" in e2;
}
function b(e2, t2, i2) {
  const s2 = new URL(e2).host, d = n.get(s2), n2 = (e3) => !e3 || e3 === d;
  return n2(t2) && n2(i2) || t2 === i2;
}
var g = (t2) => {
  var s2;
  let r = class extends t2 {
    constructor(...e2) {
      super(...e2), this[s2] = true, this._applyEditsHandler = (e3) => {
        const { serviceUrl: t3, layerId: s3, gdbVersion: d, mayReceiveServiceEdits: r2, result: o5 } = e3, l2 = t3 === this.url, a5 = null != s3 && null != this.layerId && s3 === this.layerId, h2 = p(this), c3 = p(this) && b(t3, d, this.gdbVersion);
        if (!l2 || h2 && !c3 || !a5 && !r2)
          return;
        const u2 = o5.then((e4) => {
          var _a;
          if (a5 && (e4.addedFeatures.length || e4.updatedFeatures.length || e4.deletedFeatures.length || e4.addedAttachments.length || e4.updatedAttachments.length || e4.deletedAttachments.length))
            return this.emit("edits", a(e4)), e4;
          const t4 = (_a = e4.editedFeatures) == null ? void 0 : _a.find(({ layerId: e5 }) => e5 === this.layerId);
          if (t4) {
            const { adds: s4, updates: d2, deletes: r3 } = t4.editedFeatures, n2 = { edits: null, addedAttachments: [], deletedAttachments: [], updatedAttachments: [], addedFeatures: s4 ? s4.map(({ attributes: e5 }) => ({ objectId: this.objectIdField && e5[this.objectIdField], globalId: this.globalIdField && e5[this.globalIdField] })) : [], deletedFeatures: r3 ? r3.map(({ attributes: e5 }) => ({ objectId: this.objectIdField && e5[this.objectIdField], globalId: this.globalIdField && e5[this.globalIdField] })) : [], updatedFeatures: d2 ? d2.map(({ current: { attributes: e5 } }) => ({ objectId: this.objectIdField && e5[this.objectIdField], globalId: this.globalIdField && e5[this.globalIdField] })) : [], editedFeatures: a(e4.editedFeatures), exceededTransferLimit: false, historicMoment: a(e4.historicMoment) };
            return this.emit("edits", n2), n2;
          }
          return { edits: null, addedAttachments: [], deletedAttachments: [], updatedAttachments: [], addedFeatures: [], deletedFeatures: [], updatedFeatures: [], editedFeatures: a(e4.editedFeatures), exceededTransferLimit: false, historicMoment: a(e4.historicMoment) };
        }).then((e4) => ("historicMoment" in this && this.historicMoment !== e4.historicMoment && c(t3, d) && (this.historicMoment = e4.historicMoment), e4));
        this.emit("apply-edits", { result: u2 });
      }, this._updateMomentHandler = (e3) => {
        const { serviceUrl: t3, gdbVersion: i2, moment: s3 } = e3, d = t3 === this.url, r2 = p(this), n2 = p(this) && b(t3, i2, this.gdbVersion), o5 = p(this) && !b(t3, this.gdbVersion, null);
        d && r2 && n2 && o5 && "historicMoment" in this && this.historicMoment !== s3 && (this.historicMoment = s3);
      }, this.when().then(() => {
        this.addHandles(l(this._applyEditsHandler)), "historicMoment" in this && this.addHandles(a4(this._updateMomentHandler));
      }, () => {
      });
    }
  };
  return s2 = u, r = e([a2("esri.layers.mixins.EditBusLayer")], r), r;
};

export {
  t,
  n,
  o3 as o,
  s,
  a3 as a,
  i,
  c,
  l,
  a4 as a2,
  h,
  c2,
  m,
  b,
  g
};
//# sourceMappingURL=chunk-OHE3HDFF.js.map
