{
  "version": 3,
  "sources": ["../../@arcgis/core/layers/graphics/sources/WFSSourceWorker.js"],
  "sourcesContent": ["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.30/esri/copyright.txt for details.\n*/\nimport{createTask as e}from\"../../../core/asyncUtils.js\";import t from\"../../../core/Error.js\";import r from\"../../../core/Logger.js\";import{throwIfAborted as a,isAbortError as s}from\"../../../core/promiseUtils.js\";import o from\"../../../core/Warning.js\";import{equals as n}from\"../../../geometry/support/spatialReferenceUtils.js\";import{convertFromGeometry as i,convertToGeometry as u}from\"../featureConversionUtils.js\";import l from\"../data/FeatureStore.js\";import{checkProjectionSupport as h,project as c}from\"../data/projectionSupport.js\";import{QueryEngine as m}from\"../data/QueryEngine.js\";import{validateGeoJSON as p,createOptimizedFeatures as d}from\"./geojson/geojson.js\";import{mixAttributes as g}from\"./support/sourceUtils.js\";import{getGetFeatureSpatialReference as f,getFeatureCount as y,getFeature as _}from\"../../ogc/wfsUtils.js\";import x from\"../../support/FieldsIndex.js\";import{utc as C}from\"../../../time/timeZoneUtils.js\";const w=\"esri.layers.WFSLayer\";class R{constructor(){this._customParameters=null,this._queryEngine=null,this._supportsPagination=!0}destroy(){this._queryEngine?.destroy(),this._queryEngine=null}async load(e,r={}){const{getFeatureUrl:s,getFeatureOutputFormat:o,fields:n,geometryType:i,featureType:u,maxRecordCount:c,maxTotalRecordCount:p,maxPageCount:d,objectIdField:g,customParameters:y}=e,{spatialReference:_,getFeatureSpatialReference:w}=f(s,u,e.spatialReference);try{await h(w,_)}catch{throw new t(\"unsupported-projection\",\"Projection not supported\",{inSpatialReference:w,outSpatialReference:_})}a(r),this._customParameters=y,this._featureType=u,this._fieldsIndex=x.fromLayerJSON({fields:n,dateFieldsTimeReference:n.some((e=>\"esriFieldTypeDate\"===e.type))?{timeZoneIANA:C}:null}),this._geometryType=i,this._getFeatureUrl=s,this._getFeatureOutputFormat=o,this._getFeatureSpatialReference=w,this._maxRecordCount=c,this._maxTotalRecordCount=p,this._maxPageCount=d,this._objectIdField=g,this._spatialReference=_;let R=await this._snapshotFeatures(r);if(R.errors.length>0&&(this._supportsPagination=!1,R=await this._snapshotFeatures(r),R.errors.length>0))throw R.errors[0];return this._queryEngine=new m({fieldsIndex:this._fieldsIndex,geometryType:i,hasM:!1,hasZ:!1,objectIdField:g,spatialReference:_,timeInfo:null,featureStore:new l({geometryType:i,hasM:!1,hasZ:!1})}),this._queryEngine.featureStore.addMany(R.features),{warnings:T(R),extent:(await this._queryEngine.fetchRecomputedExtents()).fullExtent}}async applyEdits(){throw new t(\"wfs-source:editing-not-supported\",\"applyEdits() is not supported on WFSLayer\")}async queryFeatures(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQuery(e,t.signal)}async queryFeatureCount(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForCount(e,t.signal)}async queryObjectIds(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForIds(e,t.signal)}async queryExtent(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForExtent(e,t.signal)}async querySnapping(e,t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForSnapping(e,t.signal)}async refresh(t){return this._customParameters=t.customParameters,this._maxRecordCount=t.maxRecordCount,this._maxTotalRecordCount=t.maxTotalRecordCount,this._maxPageCount=t.maxPageCount,this._snapshotTask?.abort(),this._snapshotTask=e((e=>this._snapshotFeatures({signal:e}))),this._snapshotTask.promise.then((e=>{this._queryEngine.featureStore.clear(),this._queryEngine.featureStore.addMany(e.features);for(const t of T(e))r.getLogger(w).warn(new o(\"wfs-layer:refresh-warning\",t.message,t.details));e.errors?.length&&r.getLogger(w).warn(new o(\"wfs-layer:refresh-error\",\"Refresh completed with errors\",{errors:e.errors}))}),(()=>{this._queryEngine.featureStore.clear()})),await this._waitSnapshotComplete(),{extent:(await this._queryEngine.fetchRecomputedExtents()).fullExtent}}async _waitSnapshotComplete(){if(this._snapshotTask&&!this._snapshotTask.finished){try{await this._snapshotTask.promise}catch{}return this._waitSnapshotComplete()}}async _snapshotFeatures(e){const t=e?.signal,r=this._maxTotalRecordCount,o=this._maxPageCount,n=this._supportsPagination?await y(this._getFeatureUrl,this._featureType.typeName,{customParameters:this._customParameters,signal:t}):void 0;let i=[];const u=[];if(null==n)try{i=await this._singleQuery(t)}catch(l){s(l)||u.push(l)}else{const e=Math.min(n,r),a=F(this,Math.max(1,Math.min(Math.ceil(e/this._maxRecordCount),o)),t);await Promise.allSettled(Array.from({length:10}).map((()=>S(a,i,u))))}return a(t),{features:i,totalRecordCount:n,maxTotalRecordCount:r,maxPageCount:o,errors:u}}async _singleQuery(e){const t=await _(this._getFeatureUrl,this._featureType.typeName,this._getFeatureSpatialReference,this._getFeatureOutputFormat,{customParameters:this._customParameters,signal:e});return this._processGeoJSON(t,{signal:e})}async _pageQuery(e,t){const r=e*this._maxRecordCount,a=await _(this._getFeatureUrl,this._featureType.typeName,this._getFeatureSpatialReference,this._getFeatureOutputFormat,{customParameters:this._customParameters,startIndex:r,count:this._maxRecordCount,signal:t});return this._processGeoJSON(a,{startIndex:r,signal:t})}_processGeoJSON(e,t){p(e,this._getFeatureSpatialReference.wkid);const{startIndex:r,signal:s}=t;a(s);const o=d(e,{geometryType:this._geometryType,hasZ:!1,objectIdField:this._objectIdField});if(!n(this._spatialReference,this._getFeatureSpatialReference))for(const a of o)null!=a.geometry&&(a.geometry=i(c(u(a.geometry,this._geometryType,!1,!1),this._getFeatureSpatialReference,this._spatialReference)));let l=r??1;for(const a of o){const e={};g(this._fieldsIndex,e,a.attributes,!0),a.attributes=e,null==e[this._objectIdField]&&(a.objectId=e[this._objectIdField]=l++)}return o}}function*F(e,t,r){for(let a=0;a<t;a++)yield e._pageQuery(a,r)}async function S(e,t,r){let a=e.next();for(;!a.done;){try{const e=await a.value;t.push(...e)}catch(o){s(o)||r.push(o)}a=e.next()}}function T(e){const t=[];return null!=e.totalRecordCount&&(e.features.length<e.totalRecordCount&&t.push({name:\"wfs-layer:maxRecordCount-too-low\",message:`Could only fetch ${e.features.length} of ${e.totalRecordCount} in ${e.maxPageCount} queries. Try increasing the value of WFSLayer.maxRecordCount.`,details:{recordCount:e.features.length,totalRecordCount:e.totalRecordCount}}),e.totalRecordCount>e.maxTotalRecordCount&&t.push({name:\"wfs-layer:large-dataset\",message:`The number of ${e.totalRecordCount} features exceeds the maximum allowed of ${e.maxTotalRecordCount}.`,details:{recordCount:e.features.length,totalRecordCount:e.totalRecordCount,maxTotalRecordCount:e.maxTotalRecordCount}})),t}export{R as default};\n"],
  "mappings": "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",
  "names": ["s", "n", "i", "p", "d", "w", "e", "R", "_a", "t"]
}
