{
  "version": 3,
  "sources": ["../../@arcgis/core/views/3d/support/MemoryManagedView.js", "../../@arcgis/core/views/3d/support/MemoryController.js"],
  "sourcesContent": ["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.30/esri/copyright.txt for details.\n*/\nfunction e(e){return\"usedMemory\"in e&&\"unloadedMemory\"in e&&\"ignoresMemoryFactor\"in e}export{e as isMemoryManagedView};\n", "/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.30/esri/copyright.txt for details.\n*/\nimport{_ as e}from\"../../../chunks/tslib.es6.js\";import t from\"../../../core/Accessor.js\";import i from\"../../../core/Logger.js\";import{MemCacheStorage as s,MemCache as a}from\"../../../core/MemCache.js\";import{addFrameTask as r}from\"../../../core/scheduling.js\";import{property as o}from\"../../../core/accessorSupport/decorators/property.js\";import\"../../../core/has.js\";import\"../../../core/RandomLCG.js\";import{subclass as h}from\"../../../core/accessorSupport/decorators/subclass.js\";import{isMemoryManagedView as y}from\"./MemoryManagedView.js\";function l(e){return new p({view:e})}const d=.1,u=1,m=1,n=.75,c=.6,_=1.3;let p=class extends t{constructor(e){super(e),this._quality=1,this._usedMemory=0,this._updating=!1,this._stableQuality=0,this._downscaleMemoryUsed=0,this._canFastRecover=!1,this._memoryPredicted=0,this._cacheStorage=new s,this._warnMemoryUsage=null,this._numQualityChanges=0,this._maxMemory=750,this._additionalCacheMemory=0,this.addHandles(r({prepare:()=>this._updateMemory()}))}destroy(){this._cacheStorage.destroy()}get maxMemory(){return this._maxMemory}set maxMemory(e){null==e||e<=0||(this._stableQuality=0,this._canFastRecover=!1,this._maxMemory<e&&this._updateQuality(u),this._maxMemory=e)}get additionalCacheMemory(){return this._additionalCacheMemory}set additionalCacheMemory(e){null!=e&&(this._additionalCacheMemory=e)}get memoryFactor(){return this._quality}get updating(){return this._updating}get usedMemory(){return this._usedMemory}get usedCacheMemory(){return this._cacheStorage.size}newCache(e,t){return new a(e,this._cacheStorage,t)}resetStableQuality(){this._stableQuality=0}disableMemCache(){this.additionalCacheMemory=-4096}update(){if(this._memoryPredicted<=0&&!this._updating)return;let e=this._layersUpdating();if(this._memoryPredicted<c&&this._canFastRecover)this._downscaleMemoryUsed=0,this._stableQuality=0,this._canFastRecover=!1,this._updateQuality(u);else if(e)(this._memoryPredicted>1.1*m||this._usedMemory>m)&&(this._stableQuality>0?(this._downscaleMemoryUsed=0,this._updateQuality(this._stableQuality)):this._quality>d&&this._downscaleMemoryUsed<this._usedMemory&&(this._updateQuality(this._quality/_),this._downscaleMemoryUsed=this._usedMemory,this._canFastRecover=!1));else if(this._downscaleMemoryUsed=0,this._usedMemory>m)this._stableQuality=0,this._canFastRecover=!1,e=this._updateQuality(this._quality/_),this._downscaleMemoryUsed=this._memoryPredicted;else if(this._stableQuality!==this._quality)if(this._usedMemory<n&&this._quality<u){this._stableQuality=this._quality;const t=.05;e=this._updateQuality(this._quality+t)}else this._quality<1&&(this._canFastRecover=!0);this._updating=e}_updateQuality(e){return(e=Math.min(Math.max(e,d),u))!==this._quality&&(this._quality=e,++this._numQualityChanges,!0)}_layersUpdating(){return this.view.allLayerViews.some((e=>!!e.updating))}_updateMemory(){if(!this.view)return;this.view._stage?.renderer?.tick();const e=this.view._stage?.renderer?.usedMemory;let t=(this.view.basemapTerrain?.usedMemory??0)+(e?e.fbos+e.edges+e.plugins:0),s=0;this.view.allLayerViews&&this.view.allLayerViews.forEach((e=>{if(y(e)){const i=e.ignoresMemoryFactor?this._quality:1;t+=e.usedMemory*i,s+=e.unloadedMemory*i}}));const a=null==this._warnMemoryUsage||Math.round(10*t)!==Math.round(10*this._warnMemoryUsage),r=1048576*this.maxMemory;if(t>r&&a){this._warnMemoryUsage=t;const e=e=>(e/1048576).toLocaleString(void 0,{maximumFractionDigits:1})+\" MB\",a=Math.round(100*this._quality);i.getLogger(this).warn(`Memory Limit exceeded! Limit: ${e(r)} Current: ${e(t)} Projected: ${e(t+s)} Quality: ${a}%`)}this._usedMemory=t/r,this._memoryPredicted=(t+s)/r;const o=r-t;this._cacheStorage.maxSize=Math.max(0,o+1048576*this.additionalCacheMemory)}get test(){const e=this;return{cacheStorage:this._cacheStorage,resetQualityChanges:()=>{const t=e._numQualityChanges;return e._numQualityChanges=0,t},disableMemCache:()=>e.disableMemCache()}}};e([o({constructOnly:!0})],p.prototype,\"view\",void 0),e([o()],p.prototype,\"maxMemory\",null),e([o()],p.prototype,\"additionalCacheMemory\",null),e([o({readOnly:!0})],p.prototype,\"memoryFactor\",null),e([o({readOnly:!0})],p.prototype,\"updating\",null),e([o({readOnly:!0})],p.prototype,\"usedMemory\",null),e([o({readOnly:!0})],p.prototype,\"usedCacheMemory\",null),e([o()],p.prototype,\"_quality\",void 0),e([o()],p.prototype,\"_usedMemory\",void 0),e([o()],p.prototype,\"_updating\",void 0),e([o()],p.prototype,\"_stableQuality\",void 0),e([o()],p.prototype,\"_maxMemory\",void 0),e([o()],p.prototype,\"_additionalCacheMemory\",void 0),p=e([h(\"esri.views.3d.support.MemoryController\")],p);export{d as minQuality,l as newMemoryController};\n"],
  "mappings": "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",
  "names": ["e", "e", "n", "a", "r"]
}
